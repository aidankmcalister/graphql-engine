<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">-- | Migrations for the Hasura catalog.</span><span>
</span><span id="line-4"></span><span class="hs-comment">--</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- To add a new migration:</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">--   1. Bump the catalog version number in @src-rsr/catalog_version.txt@.</span><span>
</span><span id="line-8"></span><span class="hs-comment">--   2. Add a migration script in the @src-rsr/migrations/@ directory with the name</span><span>
</span><span id="line-9"></span><span class="hs-comment">--      @&lt;old version&gt;_to_&lt;new version&gt;.sql@.</span><span>
</span><span id="line-10"></span><span class="hs-comment">--   3. Create a downgrade script in the @src-rsr/migrations/@ directory with the name</span><span>
</span><span id="line-11"></span><span class="hs-comment">--      @&lt;new version&gt;_to_&lt;old version&gt;.sql@.</span><span>
</span><span id="line-12"></span><span class="hs-comment">--   4. If making a new release, add the mapping from application version to catalog</span><span>
</span><span id="line-13"></span><span class="hs-comment">--      schema version in @src-rsr/catalog_versions.txt@.</span><span>
</span><span id="line-14"></span><span class="hs-comment">--   5. If appropriate, add the change to @server/src-rsr/initialise.sql@ for fresh installations</span><span>
</span><span id="line-15"></span><span class="hs-comment">--      of hasura.</span><span>
</span><span id="line-16"></span><span class="hs-comment">--</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- The Template Haskell code in this module will automatically compile the new migration script into</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- the @graphql-engine@ executable.</span><span>
</span><span id="line-19"></span><span class="hs-comment">--</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- NOTE: Please have a look at the `server/documentation/migration-guidelines.md` before adding any new migration</span><span>
</span><span id="line-21"></span><span class="hs-comment">--       if you haven't already looked at it</span><span>
</span><span id="line-22"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html"><span class="hs-identifier">Hasura.Server.Migrate</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationResult"><span class="hs-identifier">MigrationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Hasura.Server.Migrate.html#migrateCatalog"><span class="hs-identifier">migrateCatalog</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Hasura.Server.Migrate.LatestVersion.html#latestCatalogVersion"><span class="hs-identifier">latestCatalogVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Hasura.Server.Migrate.html#downgradeCatalog"><span class="hs-identifier">downgradeCatalog</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">where</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html"><span class="hs-identifier">Control.Monad.Trans.Control</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier">MonadBaseControl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.html/Data.Aeson.html"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html"><span class="hs-identifier">Data.FileEmbed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html#makeRelativeToProject"><span class="hs-identifier">makeRelativeToProject</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/insert-ordered-containers-0.2.5.3-dcb71999c8104475fd299533bb40a6c15ee8a9411f3a03b68aa99a14a4143c19/share/doc/html/src/Data.HashMap.Strict.InsOrd.html/Data.HashMap.Strict.InsOrd.html"><span class="hs-identifier">Data.HashMap.Strict.InsOrd</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InsOrdHashMap</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.IO</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TIO</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.html/Database.PG.Query.html"><span class="hs-identifier">Database.PG.Query</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PG</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html"><span class="hs-identifier">Hasura.Backends.Postgres.Connection.MonadTx</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Execute.Types.html"><span class="hs-identifier">Hasura.Backends.Postgres.Execute.Types</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html"><span class="hs-identifier">Hasura.Backends.Postgres.SQL.Types</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier">Hasura</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Logging.html#LogLevel"><span class="hs-identifier">LogLevel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier">ToEngineLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.LegacyCatalog.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.LegacyCatalog</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.ApiLimit.html"><span class="hs-identifier">Hasura.RQL.Types.ApiLimit</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html"><span class="hs-identifier">Hasura.RQL.Types.BackendType</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.CustomTypes.html"><span class="hs-identifier">Hasura.RQL.Types.CustomTypes</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.OpenTelemetry.html"><span class="hs-identifier">Hasura.RQL.Types.OpenTelemetry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.OpenTelemetry.html#emptyOpenTelemetryConfig"><span class="hs-identifier">emptyOpenTelemetryConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SourceCustomization.html"><span class="hs-identifier">Hasura.RQL.Types.SourceCustomization</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Init.html"><span class="hs-identifier">Hasura.Server.Init</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Init.Config.html#DowngradeOptions"><span class="hs-identifier">DowngradeOptions</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Init.Arg.html#databaseUrlOption"><span class="hs-identifier">databaseUrlOption</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Init.Config.html#_envVar"><span class="hs-identifier">_envVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html"><span class="hs-identifier">Hasura.Server.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Logging.html#StartupLog"><span class="hs-identifier">StartupLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.Internal.html"><span class="hs-identifier">Hasura.Server.Migrate.Internal</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.LatestVersion.html"><span class="hs-identifier">Hasura.Server.Migrate.LatestVersion</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.Version.html"><span class="hs-identifier">Hasura.Server.Migrate.Version</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Lib</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Syntax</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.Types.Extended.html/Network.Types.Extended.html"><span class="hs-identifier">Network.Types.Extended</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Directory</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">doesFileExist</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">data</span><span> </span><span id="MigrationResult"><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationResult"><span class="hs-identifier hs-var">MigrationResult</span></a></span></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="MRNothingToDo"><span class="annot"><a href="Hasura.Server.Migrate.html#MRNothingToDo"><span class="hs-identifier hs-var">MRNothingToDo</span></a></span></span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MRInitialized"><span class="annot"><a href="Hasura.Server.Migrate.html#MRInitialized"><span class="hs-identifier hs-var">MRInitialized</span></a></span></span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-comment">-- | old catalog version</span></span><span>
</span><span id="line-71"></span><span>    </span><span id="MRMigrated"><span class="annot"><a href="Hasura.Server.Migrate.html#MRMigrated"><span class="hs-identifier hs-var">MRMigrated</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MRMaintanenceMode"><span class="annot"><a href="Hasura.Server.Migrate.html#MRMaintanenceMode"><span class="hs-identifier hs-var">MRMaintanenceMode</span></a></span></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688022243"><span id="local-6989586621688022249"><span id="local-6989586621688022253"><span class="annot"><span class="annottext">Int -&gt; MigrationResult -&gt; ShowS
[MigrationResult] -&gt; ShowS
MigrationResult -&gt; String
(Int -&gt; MigrationResult -&gt; ShowS)
-&gt; (MigrationResult -&gt; String)
-&gt; ([MigrationResult] -&gt; ShowS)
-&gt; Show MigrationResult
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; MigrationResult -&gt; ShowS
showsPrec :: Int -&gt; MigrationResult -&gt; ShowS
$cshow :: MigrationResult -&gt; String
show :: MigrationResult -&gt; String
$cshowList :: [MigrationResult] -&gt; ShowS
showList :: [MigrationResult] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688022258"><span id="local-6989586621688022265"><span class="annot"><span class="annottext">MigrationResult -&gt; MigrationResult -&gt; Bool
(MigrationResult -&gt; MigrationResult -&gt; Bool)
-&gt; (MigrationResult -&gt; MigrationResult -&gt; Bool)
-&gt; Eq MigrationResult
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: MigrationResult -&gt; MigrationResult -&gt; Bool
== :: MigrationResult -&gt; MigrationResult -&gt; Bool
$c/= :: MigrationResult -&gt; MigrationResult -&gt; Bool
/= :: MigrationResult -&gt; MigrationResult -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier hs-type">ToEngineLog</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationResult"><span class="hs-identifier hs-type">MigrationResult</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-76"></span><span>  </span><span id="local-6989586621688022298"><span class="annot"><span class="annottext">toEngineLog :: MigrationResult -&gt; (LogLevel, EngineLogType Hasura, Value)
</span><a href="#local-6989586621688022298"><span class="hs-identifier hs-var hs-var hs-var">toEngineLog</span></a></span></span><span> </span><span id="local-6989586621688022300"><span class="annot"><span class="annottext">MigrationResult
</span><a href="#local-6989586621688022300"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><span class="annottext">StartupLog -&gt; (LogLevel, EngineLogType Hasura, Value)
forall a impl.
ToEngineLog a impl =&gt;
a -&gt; (LogLevel, EngineLogType impl, Value)
</span><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var">toEngineLog</span></a></span><span>
</span><span id="line-78"></span><span>      </span><span class="annot"><span class="annottext">(StartupLog -&gt; (LogLevel, EngineLogType Hasura, Value))
-&gt; StartupLog -&gt; (LogLevel, EngineLogType Hasura, Value)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html#StartupLog"><span class="hs-identifier hs-type">StartupLog</span></a></span><span>
</span><span id="line-79"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">slLogLevel :: LogLevel
</span><a href="#local-6989586621688022302"><span class="hs-identifier hs-var">slLogLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>          </span><span class="annot"><span class="annottext">slKind :: Text
</span><a href="#local-6989586621688022304"><span class="hs-identifier hs-var">slKind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;catalog_migrate&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>          </span><span class="annot"><span class="annottext">slInfo :: Value
</span><a href="#local-6989586621688022305"><span class="hs-identifier hs-var">slInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">J.toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Value) -&gt; Text -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MigrationResult
</span><a href="#local-6989586621688022300"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-82"></span><span>            </span><span class="annot"><span class="annottext">MigrationResult
</span><a href="Hasura.Server.Migrate.html#MRNothingToDo"><span class="hs-identifier hs-var">MRNothingToDo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-83"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Already at the latest catalog version (&quot;</span></span><span>
</span><span id="line-84"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.Server.Migrate.LatestVersion.html#latestCatalogVersionString"><span class="hs-identifier hs-var">latestCatalogVersionString</span></a></span><span>
</span><span id="line-85"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;); nothing to do.&quot;</span></span><span>
</span><span id="line-86"></span><span>            </span><span class="annot"><span class="annottext">MigrationResult
</span><a href="Hasura.Server.Migrate.html#MRInitialized"><span class="hs-identifier hs-var">MRInitialized</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-87"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Successfully initialized the catalog (at version &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.Server.Migrate.LatestVersion.html#latestCatalogVersionString"><span class="hs-identifier hs-var">latestCatalogVersionString</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;).&quot;</span></span><span>
</span><span id="line-88"></span><span>            </span><span class="annot"><a href="Hasura.Server.Migrate.html#MRMigrated"><span class="hs-identifier hs-type">MRMigrated</span></a></span><span> </span><span id="local-6989586621688022308"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688022308"><span class="hs-identifier hs-var">oldVersion</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Successfully migrated from catalog version &quot;</span></span><span>
</span><span id="line-90"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688022308"><span class="hs-identifier hs-var">oldVersion</span></a></span><span>
</span><span id="line-91"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; to version &quot;</span></span><span>
</span><span id="line-92"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.Server.Migrate.LatestVersion.html#latestCatalogVersionString"><span class="hs-identifier hs-var">latestCatalogVersionString</span></a></span><span>
</span><span id="line-93"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-94"></span><span>            </span><span class="annot"><span class="annottext">MigrationResult
</span><a href="Hasura.Server.Migrate.html#MRMaintanenceMode"><span class="hs-identifier hs-var">MRMaintanenceMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Catalog migrations are skipped because the graphql-engine is in maintenance mode&quot;</span></span><span>
</span><span id="line-96"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-comment">-- A migration and (hopefully) also its inverse if we have it.</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- Polymorphic because `m` can be any `MonadTx`, `MonadIO` when</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- used in the `migrations` function below.</span><span>
</span><span id="line-101"></span><span class="hs-keyword">data</span><span> </span><span id="MigrationPair"><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-var">MigrationPair</span></a></span></span><span> </span><span id="local-6989586621688022020"><span class="annot"><a href="#local-6989586621688022020"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MigrationPair"><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-var">MigrationPair</span></a></span></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="mpMigrate"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MigrationPair m -&gt; m ()
</span><a href="Hasura.Server.Migrate.html#mpMigrate"><span class="hs-identifier hs-var hs-var">mpMigrate</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621688022020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>    </span><span id="mpDown"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MigrationPair m -&gt; Maybe (m ())
</span><a href="Hasura.Server.Migrate.html#mpDown"><span class="hs-identifier hs-var hs-var">mpDown</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688022020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="annot"><a href="Hasura.Server.Migrate.html#migrateCatalog"><span class="hs-identifier hs-type">migrateCatalog</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688022024"><span class="annot"><a href="#local-6989586621688022024"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#MonadTx"><span class="hs-identifier hs-type">MonadTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022024"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688022024"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688022024"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-112"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConnConfiguration"><span class="hs-identifier hs-type">SourceConnConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><a href="Hasura.SQL.Types.html#ExtensionsSchema"><span class="hs-identifier hs-type">ExtensionsSchema</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><a href="#local-6989586621688022024"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationResult"><span class="hs-identifier hs-type">MigrationResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataWithResourceVersion"><span class="hs-identifier hs-type">MetadataWithResourceVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span id="migrateCatalog"><span class="annot"><span class="annottext">migrateCatalog :: forall (m :: * -&gt; *).
(MonadTx m, MonadIO m, MonadBaseControl IO m) =&gt;
Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; ExtensionsSchema
-&gt; MaintenanceMode ()
-&gt; UTCTime
-&gt; m (MigrationResult, MetadataWithResourceVersion)
</span><a href="Hasura.Server.Migrate.html#migrateCatalog"><span class="hs-identifier hs-var hs-var">migrateCatalog</span></a></span></span><span> </span><span id="local-6989586621688022434"><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022434"><span class="hs-identifier hs-var">maybeDefaultSourceConfig</span></a></span></span><span> </span><span id="local-6989586621688022435"><span class="annot"><span class="annottext">ExtensionsSchema
</span><a href="#local-6989586621688022435"><span class="hs-identifier hs-var">extensionsSchema</span></a></span></span><span> </span><span id="local-6989586621688022436"><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621688022436"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span> </span><span id="local-6989586621688022437"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688022437"><span class="hs-identifier hs-var">migrationTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>  </span><span id="local-6989586621688022438"><span class="annot"><a href="#local-6989586621688022438"><span class="hs-identifier hs-var">catalogSchemaExists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaName -&gt; m Bool
forall (m :: * -&gt; *). MonadTx m =&gt; SchemaName -&gt; m Bool
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#doesSchemaExist"><span class="hs-identifier hs-var">doesSchemaExist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SchemaName
</span><a href="Hasura.Backends.Postgres.SQL.Types.html#SchemaName"><span class="hs-identifier hs-var">SchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;hdb_catalog&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>  </span><span id="local-6989586621688022441"><span class="annot"><a href="#local-6989586621688022441"><span class="hs-identifier hs-var">versionTableExists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#doesTableExist"><span class="hs-identifier hs-type">doesTableExist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;hdb_catalog&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;hdb_version&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>  </span><span id="local-6989586621688022444"><span class="annot"><a href="#local-6989586621688022444"><span class="hs-identifier hs-var">metadataTableExists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#doesTableExist"><span class="hs-identifier hs-type">doesTableExist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;hdb_catalog&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;hdb_metadata&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>  </span><span id="local-6989586621688022445"><span class="annot"><a href="#local-6989586621688022445"><span class="hs-identifier hs-var">migrationResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-keyword">if</span><span>
</span><span id="line-123"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="#local-6989586621688022436"><span class="hs-identifier hs-type">maintenanceMode</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-124"></span><span>          </span><span class="hs-keyword">if</span><span>
</span><span id="line-125"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621688022438"><span class="hs-identifier hs-type">catalogSchemaExists</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-126"></span><span>                </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-type">throw500</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;unexpected: hdb_catalog schema not found in maintenance mode&quot;</span></span><span>
</span><span id="line-127"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621688022441"><span class="hs-identifier hs-type">versionTableExists</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>                </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-type">throw500</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;unexpected: hdb_catalog.hdb_version table not found in maintenance mode&quot;</span></span><span>
</span><span id="line-129"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621688022444"><span class="hs-identifier hs-type">metadataTableExists</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-130"></span><span>                </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-type">throw500</span></a></span><span>
</span><span id="line-131"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;the \&quot;hdb_catalog.hdb_metadata\&quot; table is expected to exist and contain&quot;</span></span><span>
</span><span id="line-132"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot; the metadata of the graphql-engine&quot;</span></span><span>
</span><span id="line-133"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MRMaintanenceMode"><span class="hs-identifier hs-type">MRMaintanenceMode</span></a></span><span>
</span><span id="line-134"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621688022438"><span class="hs-identifier hs-type">catalogSchemaExists</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-135"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m MigrationResult
</span><a href="#local-6989586621688022449"><span class="hs-identifier hs-var">initialize</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-136"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688022441"><span class="hs-identifier hs-var">versionTableExists</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-137"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m MigrationResult
</span><a href="#local-6989586621688022449"><span class="hs-identifier hs-var">initialize</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-138"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; m MigrationResult
</span><a href="#local-6989586621688022450"><span class="hs-identifier hs-var">migrateFrom</span></a></span><span> </span><span class="annot"><span class="annottext">(MetadataCatalogVersion -&gt; m MigrationResult)
-&gt; m MetadataCatalogVersion -&gt; m MigrationResult
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataCatalogVersion -&gt; m MetadataCatalogVersion
forall a. TxE QErr a -&gt; m a
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-var">liftTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataCatalogVersion
</span><a href="Hasura.Server.Migrate.Internal.html#getCatalogVersion"><span class="hs-identifier hs-var">getCatalogVersion</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span id="local-6989586621688022454"><span class="annot"><a href="#local-6989586621688022454"><span class="hs-identifier hs-var">metadataWithVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-type">liftTx</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataAndResourceVersionFromCatalog"><span class="hs-identifier hs-type">fetchMetadataAndResourceVersionFromCatalog</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688022445"><span class="hs-identifier hs-type">migrationResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688022454"><span class="hs-identifier hs-type">metadataWithVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- initializes the catalog, creating the schema if necessary</span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><a href="#local-6989586621688022449"><span class="hs-identifier hs-type">initialize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688022024"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationResult"><span class="hs-identifier hs-type">MigrationResult</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621688022449"><span class="annot"><span class="annottext">initialize :: Bool -&gt; m MigrationResult
</span><a href="#local-6989586621688022449"><span class="hs-identifier hs-var hs-var">initialize</span></a></span></span><span> </span><span id="local-6989586621688022456"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688022456"><span class="hs-identifier hs-var">createSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-145"></span><span>      </span><span class="annot"><span class="annottext">TxE QErr () -&gt; m ()
forall a. TxE QErr a -&gt; m a
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-var">liftTx</span></a></span><span>
</span><span id="line-146"></span><span>        </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; m ()) -&gt; TxE QErr () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TxE QErr () -&gt; TxE QErr ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688022456"><span class="hs-identifier hs-var">createSchema</span></a></span><span>
</span><span id="line-147"></span><span>        </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; TxE QErr ()) -&gt; TxE QErr () -&gt; TxE QErr ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr) -&gt; Query -&gt; () -&gt; Bool -&gt; TxE QErr ()
forall (m :: * -&gt; *) r e.
(MonadIO m, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#unitQE"><span class="hs-identifier hs-var">PG.unitQE</span></a></span><span> </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;CREATE SCHEMA hdb_catalog&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-148"></span><span>      </span><span class="annot"><span class="annottext">ExtensionsSchema -&gt; m ()
forall (m :: * -&gt; *). MonadTx m =&gt; ExtensionsSchema -&gt; m ()
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#enablePgcryptoExtension"><span class="hs-identifier hs-var">enablePgcryptoExtension</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionsSchema
</span><a href="#local-6989586621688022435"><span class="hs-identifier hs-var">extensionsSchema</span></a></span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><span class="annottext">Query -&gt; m ()
forall (m :: * -&gt; *). MonadTx m =&gt; Query -&gt; m ()
</span><a href="Hasura.Server.Migrate.html#multiQ"><span class="hs-identifier hs-var">multiQ</span></a></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html#makeRelativeToProject"><span class="hs-identifier hs-type">makeRelativeToProject</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;src-rsr/initialise.sql&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#sqlFromFile"><span class="hs-identifier hs-type">PG.sqlFromFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>      </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621688022465"><span class="hs-identifier hs-var">updateCatalogVersion</span></a></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022466"><span class="annot"><span class="annottext">emptyMetadata' :: Metadata
</span><a href="#local-6989586621688022466"><span class="hs-identifier hs-var hs-var hs-var">emptyMetadata'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022434"><span class="hs-identifier hs-var">maybeDefaultSourceConfig</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-153"></span><span>            </span><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#emptyMetadata"><span class="hs-identifier hs-var">emptyMetadata</span></a></span><span>
</span><span id="line-154"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688022468"><span class="annot"><span class="annottext">SourceConnConfiguration ('Postgres 'Vanilla)
</span><a href="#local-6989586621688022468"><span class="hs-identifier hs-var">defaultSourceConfig</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-155"></span><span>              </span><span class="hs-comment">-- insert metadata with default source</span><span>
</span><span id="line-156"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022469"><span class="annot"><span class="annottext">defaultSourceMetadata :: AnyBackend SourceMetadata
</span><a href="#local-6989586621688022469"><span class="hs-identifier hs-var hs-var">defaultSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-157"></span><span>                    </span><span class="annot"><span class="annottext">SourceMetadata ('Postgres 'Vanilla) -&gt; AnyBackend SourceMetadata
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span>
</span><span id="line-158"></span><span>                      </span><span class="annot"><span class="annottext">(SourceMetadata ('Postgres 'Vanilla) -&gt; AnyBackend SourceMetadata)
-&gt; SourceMetadata ('Postgres 'Vanilla) -&gt; AnyBackend SourceMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
SourceName
-&gt; BackendSourceKind b
-&gt; Tables b
-&gt; Functions b
-&gt; NativeQueries b
-&gt; StoredProcedures b
-&gt; LogicalModels b
-&gt; SourceConnConfiguration b
-&gt; Maybe QueryTagsConfig
-&gt; SourceCustomization
-&gt; Maybe (HealthCheckConfig b)
-&gt; SourceMetadata b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-var">SourceMetadata</span></a></span><span>
</span><span id="line-159"></span><span>                        </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>                        </span><span class="annot"><span class="annottext">SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span>
</span><span id="line-161"></span><span>                        </span><span class="annot"><span class="annottext">BackendSourceKind ('Postgres 'Vanilla)
</span><a href="Hasura.RQL.Types.BackendType.html#PostgresVanillaKind"><span class="hs-identifier hs-var">PostgresVanillaKind</span></a></span><span>
</span><span id="line-162"></span><span>                        </span><span class="annot"><span class="annottext">InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
InsOrdHashMap QualifiedTable (TableMetadata ('Postgres 'Vanilla))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-163"></span><span>                        </span><span class="annot"><span class="annottext">InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (FunctionMetadata ('Postgres 'Vanilla))
InsOrdHashMap
  QualifiedFunction (FunctionMetadata ('Postgres 'Vanilla))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-164"></span><span>                        </span><span class="annot"><span class="annottext">NativeQueries ('Postgres 'Vanilla)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-165"></span><span>                        </span><span class="annot"><span class="annottext">InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (StoredProcedureMetadata ('Postgres 'Vanilla))
InsOrdHashMap
  QualifiedFunction (StoredProcedureMetadata ('Postgres 'Vanilla))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-166"></span><span>                        </span><span class="annot"><span class="annottext">LogicalModels ('Postgres 'Vanilla)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-167"></span><span>                        </span><span class="annot"><span class="annottext">SourceConnConfiguration ('Postgres 'Vanilla)
</span><a href="#local-6989586621688022468"><span class="hs-identifier hs-var">defaultSourceConfig</span></a></span><span>
</span><span id="line-168"></span><span>                        </span><span class="annot"><span class="annottext">Maybe QueryTagsConfig
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-169"></span><span>                        </span><span class="annot"><span class="annottext">SourceCustomization
</span><a href="Hasura.RQL.Types.SourceCustomization.html#emptySourceCustomization"><span class="hs-identifier hs-var">emptySourceCustomization</span></a></span><span>
</span><span id="line-170"></span><span>                        </span><span class="annot"><span class="annottext">Maybe (HealthCheckConfig ('Postgres 'Vanilla))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-171"></span><span>                  </span><span id="local-6989586621688022475"><span class="annot"><span class="annottext">sources :: InsOrdHashMap SourceName BackendSourceMetadata
</span><a href="#local-6989586621688022475"><span class="hs-identifier hs-var hs-var">sources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
forall k v. Hashable k =&gt; k -&gt; v -&gt; InsOrdHashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/insert-ordered-containers-0.2.5.3-dcb71999c8104475fd299533bb40a6c15ee8a9411f3a03b68aa99a14a4143c19/share/doc/html/src/Data.HashMap.Strict.InsOrd.html/Data.HashMap.Strict.InsOrd.html#singleton"><span class="hs-identifier hs-var">InsOrdHashMap.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span> </span><span class="annot"><span class="annottext">(BackendSourceMetadata
 -&gt; InsOrdHashMap SourceName BackendSourceMetadata)
-&gt; BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata -&gt; BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-var">BackendSourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
</span><a href="#local-6989586621688022469"><span class="hs-identifier hs-var">defaultSourceMetadata</span></a></span><span>
</span><span id="line-172"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#emptyMetadata"><span class="hs-identifier hs-var">emptyMetadata</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-identifier hs-var">_metaSources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688022475"><span class="hs-identifier hs-type">sources</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><span class="annottext">TxE QErr () -&gt; m ()
forall a. TxE QErr a -&gt; m a
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-var">liftTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; m ()) -&gt; TxE QErr () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Metadata -&gt; TxE QErr ()
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#insertMetadataInCatalog"><span class="hs-identifier hs-var">insertMetadataInCatalog</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688022466"><span class="hs-identifier hs-var">emptyMetadata'</span></a></span><span>
</span><span id="line-175"></span><span>      </span><span class="annot"><span class="annottext">MigrationResult -&gt; m MigrationResult
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MigrationResult
</span><a href="Hasura.Server.Migrate.html#MRInitialized"><span class="hs-identifier hs-var">MRInitialized</span></a></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-comment">-- migrates an existing catalog to the latest version from an existing verion</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><a href="#local-6989586621688022450"><span class="hs-identifier hs-type">migrateFrom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688022024"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationResult"><span class="hs-identifier hs-type">MigrationResult</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621688022450"><span class="annot"><span class="annottext">migrateFrom :: MetadataCatalogVersion -&gt; m MigrationResult
</span><a href="#local-6989586621688022450"><span class="hs-identifier hs-var hs-var">migrateFrom</span></a></span></span><span> </span><span id="local-6989586621688022480"><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022480"><span class="hs-identifier hs-var">previousVersion</span></a></span></span><span>
</span><span id="line-180"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022480"><span class="hs-identifier hs-var">previousVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; MetadataCatalogVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="Hasura.Server.Migrate.LatestVersion.html#latestCatalogVersion"><span class="hs-identifier hs-var">latestCatalogVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MigrationResult -&gt; m MigrationResult
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MigrationResult
</span><a href="Hasura.Server.Migrate.html#MRNothingToDo"><span class="hs-identifier hs-var">MRNothingToDo</span></a></span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-182"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022481"><span class="annot"><span class="annottext">upMigrations :: [(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022481"><span class="hs-identifier hs-var hs-var">upMigrations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; Bool
-&gt; MaintenanceMode ()
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
forall (m :: * -&gt; *).
(MonadIO m, MonadTx m) =&gt;
Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; Bool
-&gt; MaintenanceMode ()
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
</span><a href="Hasura.Server.Migrate.html#migrations"><span class="hs-identifier hs-var">migrations</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022434"><span class="hs-identifier hs-var">maybeDefaultSourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621688022436"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span>
</span><span id="line-183"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
forall {b} {b}. Ord b =&gt; b -&gt; [(b, b)] -&gt; [(b, b)]
</span><a href="#local-6989586621688022483"><span class="hs-identifier hs-var">neededMigrations</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022480"><span class="hs-identifier hs-var">previousVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022481"><span class="hs-identifier hs-var">upMigrations</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-184"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-185"></span><span>              </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m MigrationResult
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span>
</span><span id="line-186"></span><span>                </span><span class="annot"><span class="annottext">(Text -&gt; m MigrationResult) -&gt; Text -&gt; m MigrationResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Cannot use database previously used with a newer version of graphql-engine (expected&quot;</span></span><span>
</span><span id="line-187"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; a catalog version &lt;=&quot;</span></span><span>
</span><span id="line-188"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.Server.Migrate.LatestVersion.html#latestCatalogVersionString"><span class="hs-identifier hs-var">latestCatalogVersionString</span></a></span><span>
</span><span id="line-189"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;, but the current version&quot;</span></span><span>
</span><span id="line-190"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; is &quot;</span></span><span>
</span><span id="line-191"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022480"><span class="hs-identifier hs-var">previousVersion</span></a></span><span>
</span><span id="line-192"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;).&quot;</span></span><span>
</span><span id="line-193"></span><span>            </span><span id="local-6989586621688022487"><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022487"><span class="hs-identifier hs-var">migrationsToBeApplied</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>              </span><span class="annot"><span class="annottext">((MetadataCatalogVersion, MigrationPair m) -&gt; m ())
-&gt; [(MetadataCatalogVersion, MigrationPair m)] -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MigrationPair m -&gt; m ()
forall (m :: * -&gt; *). MigrationPair m -&gt; m ()
</span><a href="Hasura.Server.Migrate.html#mpMigrate"><span class="hs-identifier hs-var">mpMigrate</span></a></span><span> </span><span class="annot"><span class="annottext">(MigrationPair m -&gt; m ())
-&gt; ((MetadataCatalogVersion, MigrationPair m) -&gt; MigrationPair m)
-&gt; (MetadataCatalogVersion, MigrationPair m)
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(MetadataCatalogVersion, MigrationPair m) -&gt; MigrationPair m
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022487"><span class="hs-identifier hs-var">migrationsToBeApplied</span></a></span><span>
</span><span id="line-195"></span><span>              </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621688022465"><span class="hs-identifier hs-var">updateCatalogVersion</span></a></span><span>
</span><span id="line-196"></span><span>              </span><span class="annot"><span class="annottext">MigrationResult -&gt; m MigrationResult
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(MigrationResult -&gt; m MigrationResult)
-&gt; (Text -&gt; MigrationResult) -&gt; Text -&gt; m MigrationResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; MigrationResult
</span><a href="Hasura.Server.Migrate.html#MRMigrated"><span class="hs-identifier hs-var">MRMigrated</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m MigrationResult) -&gt; Text -&gt; m MigrationResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022480"><span class="hs-identifier hs-var">previousVersion</span></a></span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-198"></span><span>        </span><span id="local-6989586621688022483"><span class="annot"><span class="annottext">neededMigrations :: b -&gt; [(b, b)] -&gt; [(b, b)]
</span><a href="#local-6989586621688022483"><span class="hs-identifier hs-var hs-var">neededMigrations</span></a></span></span><span> </span><span id="local-6989586621688022496"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621688022496"><span class="hs-identifier hs-var">prevVersion</span></a></span></span><span> </span><span id="local-6989586621688022497"><span class="annot"><span class="annottext">[(b, b)]
</span><a href="#local-6989586621688022497"><span class="hs-identifier hs-var">upMigrations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-199"></span><span>          </span><span class="annot"><span class="annottext">((b, b) -&gt; Bool) -&gt; [(b, b)] -&gt; [(b, b)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">dropWhile</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; b -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621688022496"><span class="hs-identifier hs-var">prevVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(b -&gt; Bool) -&gt; ((b, b) -&gt; b) -&gt; (b, b) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(b, b) -&gt; b
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(b, b)]
</span><a href="#local-6989586621688022497"><span class="hs-identifier hs-var">upMigrations</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>    </span><span id="local-6989586621688022465"><span class="annot"><span class="annottext">updateCatalogVersion :: m ()
</span><a href="#local-6989586621688022465"><span class="hs-identifier hs-var hs-var">updateCatalogVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; UTCTime -&gt; m ()
forall (m :: * -&gt; *). MonadTx m =&gt; Text -&gt; UTCTime -&gt; m ()
</span><a href="Hasura.Server.Migrate.Internal.html#setCatalogVersion"><span class="hs-identifier hs-var">setCatalogVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.Server.Migrate.LatestVersion.html#latestCatalogVersionString"><span class="hs-identifier hs-var">latestCatalogVersionString</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688022437"><span class="hs-identifier hs-var">migrationTime</span></a></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="annot"><a href="Hasura.Server.Migrate.html#downgradeCatalog"><span class="hs-identifier hs-type">downgradeCatalog</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688022136"><span class="annot"><a href="#local-6989586621688022136"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688022136"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#MonadTx"><span class="hs-identifier hs-type">MonadTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022136"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConnConfiguration"><span class="hs-identifier hs-type">SourceConnConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#DowngradeOptions"><span class="hs-identifier hs-type">DowngradeOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><a href="#local-6989586621688022136"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationResult"><span class="hs-identifier hs-type">MigrationResult</span></a></span><span>
</span><span id="line-210"></span><span id="downgradeCatalog"><span class="annot"><span class="annottext">downgradeCatalog :: forall (m :: * -&gt; *).
(MonadIO m, MonadTx m) =&gt;
Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; DowngradeOptions -&gt; UTCTime -&gt; m MigrationResult
</span><a href="Hasura.Server.Migrate.html#downgradeCatalog"><span class="hs-identifier hs-var hs-var">downgradeCatalog</span></a></span></span><span> </span><span id="local-6989586621688022556"><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022556"><span class="hs-identifier hs-var">defaultSourceConfig</span></a></span></span><span> </span><span id="local-6989586621688022557"><span class="annot"><span class="annottext">DowngradeOptions
</span><a href="#local-6989586621688022557"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621688022558"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688022558"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>  </span><span id="local-6989586621688022559"><span class="annot"><a href="#local-6989586621688022559"><span class="hs-identifier hs-var">currentCatalogVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataCatalogVersion -&gt; m MetadataCatalogVersion
forall a. TxE QErr a -&gt; m a
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-var">liftTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataCatalogVersion
</span><a href="Hasura.Server.Migrate.Internal.html#getCatalogVersion"><span class="hs-identifier hs-var">getCatalogVersion</span></a></span><span>
</span><span id="line-212"></span><span>  </span><span id="local-6989586621688022560"><span class="annot"><a href="#local-6989586621688022560"><span class="hs-identifier hs-var">targetVersionFloat</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">MetadataCatalogVersion</span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-type">onLeft</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">readEither</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.unpack</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Config.html#dgoTargetVersion"><span class="hs-identifier hs-var">dgoTargetVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022557"><span class="hs-identifier hs-type">opts</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688022565"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688022565"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; m MetadataCatalogVersion
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m MetadataCatalogVersion)
-&gt; Text -&gt; m MetadataCatalogVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Unexpected: couldn't convert &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DowngradeOptions -&gt; Text
</span><a href="Hasura.Server.Init.Config.html#dgoTargetVersion"><span class="hs-identifier hs-var">dgoTargetVersion</span></a></span><span> </span><span class="annot"><span class="annottext">DowngradeOptions
</span><a href="#local-6989586621688022557"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; to a float, error: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688022565"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="#local-6989586621688022566"><span class="hs-identifier hs-type">downgradeFrom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022559"><span class="hs-identifier hs-type">currentCatalogVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022560"><span class="hs-identifier hs-type">targetVersionFloat</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-comment">-- downgrades an existing catalog to the specified version</span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><a href="#local-6989586621688022566"><span class="hs-identifier hs-type">downgradeFrom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688022136"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationResult"><span class="hs-identifier hs-type">MigrationResult</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621688022566"><span class="annot"><span class="annottext">downgradeFrom :: MetadataCatalogVersion
-&gt; MetadataCatalogVersion -&gt; m MigrationResult
</span><a href="#local-6989586621688022566"><span class="hs-identifier hs-var hs-var">downgradeFrom</span></a></span></span><span> </span><span id="local-6989586621688022567"><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022567"><span class="hs-identifier hs-var">previousVersion</span></a></span></span><span> </span><span id="local-6989586621688022568"><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022568"><span class="hs-identifier hs-var">targetVersion</span></a></span></span><span>
</span><span id="line-220"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022567"><span class="hs-identifier hs-var">previousVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; MetadataCatalogVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022568"><span class="hs-identifier hs-var">targetVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MigrationResult -&gt; m MigrationResult
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MigrationResult
</span><a href="Hasura.Server.Migrate.html#MRNothingToDo"><span class="hs-identifier hs-var">MRNothingToDo</span></a></span><span>
</span><span id="line-221"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; Either Text [m ()]
</span><a href="#local-6989586621688022569"><span class="hs-identifier hs-var">neededDownMigrations</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022568"><span class="hs-identifier hs-var">targetVersion</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-223"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688022570"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688022570"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-224"></span><span>              </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m MigrationResult
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span>
</span><span id="line-225"></span><span>                </span><span class="annot"><span class="annottext">(Text -&gt; m MigrationResult) -&gt; Text -&gt; m MigrationResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;This downgrade path (from &quot;</span></span><span>
</span><span id="line-226"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022567"><span class="hs-identifier hs-var">previousVersion</span></a></span><span>
</span><span id="line-227"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; to &quot;</span></span><span>
</span><span id="line-228"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DowngradeOptions -&gt; Text
</span><a href="Hasura.Server.Init.Config.html#dgoTargetVersion"><span class="hs-identifier hs-var">dgoTargetVersion</span></a></span><span> </span><span class="annot"><span class="annottext">DowngradeOptions
</span><a href="#local-6989586621688022557"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-229"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;) is not supported, because &quot;</span></span><span>
</span><span id="line-230"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688022570"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-231"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621688022571"><span class="annot"><span class="annottext">[m ()]
</span><a href="#local-6989586621688022571"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>              </span><span class="annot"><span class="annottext">[m ()] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="annot"><span class="annottext">[m ()]
</span><a href="#local-6989586621688022571"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-233"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DowngradeOptions -&gt; Bool
</span><a href="Hasura.Server.Init.Config.html#dgoDryRun"><span class="hs-identifier hs-var">dgoDryRun</span></a></span><span> </span><span class="annot"><span class="annottext">DowngradeOptions
</span><a href="#local-6989586621688022557"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; UTCTime -&gt; m ()
forall (m :: * -&gt; *). MonadTx m =&gt; Text -&gt; UTCTime -&gt; m ()
</span><a href="Hasura.Server.Migrate.Internal.html#setCatalogVersion"><span class="hs-identifier hs-var">setCatalogVersion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DowngradeOptions -&gt; Text
</span><a href="Hasura.Server.Init.Config.html#dgoTargetVersion"><span class="hs-identifier hs-var">dgoTargetVersion</span></a></span><span> </span><span class="annot"><span class="annottext">DowngradeOptions
</span><a href="#local-6989586621688022557"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688022558"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-235"></span><span>              </span><span class="annot"><span class="annottext">MigrationResult -&gt; m MigrationResult
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; MigrationResult
</span><a href="Hasura.Server.Migrate.html#MRMigrated"><span class="hs-identifier hs-var">MRMigrated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DowngradeOptions -&gt; Text
</span><a href="Hasura.Server.Init.Config.html#dgoTargetVersion"><span class="hs-identifier hs-var">dgoTargetVersion</span></a></span><span> </span><span class="annot"><span class="annottext">DowngradeOptions
</span><a href="#local-6989586621688022557"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-237"></span><span>        </span><span id="local-6989586621688022569"><span class="annot"><span class="annottext">neededDownMigrations :: MetadataCatalogVersion -&gt; Either Text [m ()]
</span><a href="#local-6989586621688022569"><span class="hs-identifier hs-var hs-var">neededDownMigrations</span></a></span></span><span> </span><span id="local-6989586621688022575"><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022575"><span class="hs-identifier hs-var">newVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-238"></span><span>          </span><span class="annot"><span class="annottext">MetadataCatalogVersion
-&gt; MetadataCatalogVersion
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
-&gt; Either Text [m ()]
</span><a href="#local-6989586621688022576"><span class="hs-identifier hs-var">downgrade</span></a></span><span>
</span><span id="line-239"></span><span>            </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022567"><span class="hs-identifier hs-var">previousVersion</span></a></span><span>
</span><span id="line-240"></span><span>            </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022575"><span class="hs-identifier hs-var">newVersion</span></a></span><span>
</span><span id="line-241"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; Bool
-&gt; MaintenanceMode ()
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
forall (m :: * -&gt; *).
(MonadIO m, MonadTx m) =&gt;
Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; Bool
-&gt; MaintenanceMode ()
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
</span><a href="Hasura.Server.Migrate.html#migrations"><span class="hs-identifier hs-var">migrations</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022556"><span class="hs-identifier hs-var">defaultSourceConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DowngradeOptions -&gt; Bool
</span><a href="Hasura.Server.Init.Config.html#dgoDryRun"><span class="hs-identifier hs-var">dgoDryRun</span></a></span><span> </span><span class="annot"><span class="annottext">DowngradeOptions
</span><a href="#local-6989586621688022557"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
forall a. MaintenanceMode a
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><a href="#local-6989586621688022576"><span class="hs-identifier hs-type">downgrade</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-244"></span><span>          </span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-245"></span><span>          </span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-246"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-type">MigrationPair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022136"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621688022136"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-248"></span><span>        </span><span id="local-6989586621688022576"><span class="annot"><span class="annottext">downgrade :: MetadataCatalogVersion
-&gt; MetadataCatalogVersion
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
-&gt; Either Text [m ()]
</span><a href="#local-6989586621688022576"><span class="hs-identifier hs-var hs-var">downgrade</span></a></span></span><span> </span><span id="local-6989586621688022579"><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022579"><span class="hs-identifier hs-var">lower</span></a></span></span><span> </span><span id="local-6989586621688022580"><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022580"><span class="hs-identifier hs-var">upper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)] -&gt; Either Text [m ()]
</span><a href="#local-6989586621688022581"><span class="hs-identifier hs-var">skipFutureDowngrades</span></a></span><span>
</span><span id="line-249"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-250"></span><span>            </span><span class="hs-comment">-- We find the list of downgrade scripts to run by first</span><span>
</span><span id="line-251"></span><span>            </span><span class="hs-comment">-- dropping any downgrades which correspond to newer versions</span><span>
</span><span id="line-252"></span><span>            </span><span class="hs-comment">-- of the schema than the one we're running currently.</span><span>
</span><span id="line-253"></span><span>            </span><span class="hs-comment">-- Then we take migrations as needed until we reach the target</span><span>
</span><span id="line-254"></span><span>            </span><span class="hs-comment">-- version, dropping any remaining migrations from the end of the</span><span>
</span><span id="line-255"></span><span>            </span><span class="hs-comment">-- (reversed) list.</span><span>
</span><span id="line-256"></span><span>            </span><span class="annot"><a href="#local-6989586621688022581"><span class="hs-identifier hs-type">skipFutureDowngrades</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688022582"><span class="hs-identifier hs-type">dropOlderDowngrades</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-type">MigrationPair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022136"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621688022136"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-257"></span><span>            </span><span id="local-6989586621688022581"><span class="annot"><span class="annottext">skipFutureDowngrades :: [(MetadataCatalogVersion, MigrationPair m)] -&gt; Either Text [m ()]
</span><a href="#local-6989586621688022581"><span class="hs-identifier hs-var hs-var">skipFutureDowngrades</span></a></span></span><span> </span><span id="local-6989586621688022583"><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022583"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022567"><span class="hs-identifier hs-var">previousVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; MetadataCatalogVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022579"><span class="hs-identifier hs-var">lower</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)] -&gt; Either Text [m ()]
</span><a href="#local-6989586621688022582"><span class="hs-identifier hs-var">dropOlderDowngrades</span></a></span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022583"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-258"></span><span>            </span><span class="annot"><a href="#local-6989586621688022581"><span class="hs-identifier hs-var">skipFutureDowngrades</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text [m ()]
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;the starting version is unrecognized.&quot;</span></span><span>
</span><span id="line-259"></span><span>            </span><span class="annot"><a href="#local-6989586621688022581"><span class="hs-identifier hs-var">skipFutureDowngrades</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621688022584"><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022584"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MigrationPair m
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621688022585"><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022585"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022584"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; MetadataCatalogVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022579"><span class="hs-identifier hs-var">lower</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)] -&gt; Either Text [m ()]
</span><a href="#local-6989586621688022582"><span class="hs-identifier hs-var">dropOlderDowngrades</span></a></span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022585"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-261"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)] -&gt; Either Text [m ()]
</span><a href="#local-6989586621688022581"><span class="hs-identifier hs-var">skipFutureDowngrades</span></a></span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022585"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span>            </span><span id="local-6989586621688022582"><span class="annot"><span class="annottext">dropOlderDowngrades :: [(MetadataCatalogVersion, MigrationPair m)] -&gt; Either Text [m ()]
</span><a href="#local-6989586621688022582"><span class="hs-identifier hs-var hs-var">dropOlderDowngrades</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text [m ()]
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;the target version is unrecognized.&quot;</span></span><span>
</span><span id="line-264"></span><span>            </span><span class="annot"><a href="#local-6989586621688022582"><span class="hs-identifier hs-var">dropOlderDowngrades</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621688022586"><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022586"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-type">MigrationPair</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">mpDown :: forall (m :: * -&gt; *). MigrationPair m -&gt; Maybe (m ())
</span><a href="Hasura.Server.Migrate.html#mpDown"><span class="hs-identifier hs-var">mpDown</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (m ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-265"></span><span>              </span><span class="annot"><span class="annottext">Text -&gt; Either Text [m ()]
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Either Text [m ()]) -&gt; Text -&gt; Either Text [m ()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;there is no available migration back to version &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022586"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-266"></span><span>            </span><span class="annot"><a href="#local-6989586621688022582"><span class="hs-identifier hs-var">dropOlderDowngrades</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621688022587"><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022587"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-type">MigrationPair</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">mpDown :: forall (m :: * -&gt; *). MigrationPair m -&gt; Maybe (m ())
</span><a href="Hasura.Server.Migrate.html#mpDown"><span class="hs-identifier hs-var">mpDown</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688022588"><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621688022588"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621688022589"><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022589"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022587"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion -&gt; MetadataCatalogVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MetadataCatalogVersion
</span><a href="#local-6989586621688022580"><span class="hs-identifier hs-var">upper</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[m ()] -&gt; Either Text [m ()]
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621688022588"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-268"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621688022588"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; [m ()] -&gt; [m ()]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([m ()] -&gt; [m ()]) -&gt; Either Text [m ()] -&gt; Either Text [m ()]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)] -&gt; Either Text [m ()]
</span><a href="#local-6989586621688022582"><span class="hs-identifier hs-var">dropOlderDowngrades</span></a></span><span> </span><span class="annot"><span class="annottext">[(MetadataCatalogVersion, MigrationPair m)]
</span><a href="#local-6989586621688022589"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="annot"><a href="Hasura.Server.Migrate.html#migrations"><span class="hs-identifier hs-type">migrations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688022115"><span class="annot"><a href="#local-6989586621688022115"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688022115"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#MonadTx"><span class="hs-identifier hs-type">MonadTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022115"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-273"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConnConfiguration"><span class="hs-identifier hs-type">SourceConnConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-275"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-type">MigrationPair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022115"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-277"></span><span id="migrations"><span class="annot"><span class="annottext">migrations :: forall (m :: * -&gt; *).
(MonadIO m, MonadTx m) =&gt;
Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; Bool
-&gt; MaintenanceMode ()
-&gt; [(MetadataCatalogVersion, MigrationPair m)]
</span><a href="Hasura.Server.Migrate.html#migrations"><span class="hs-identifier hs-var hs-var">migrations</span></a></span></span><span> </span><span id="local-6989586621688022682"><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022682"><span class="hs-identifier hs-var">maybeDefaultSourceConfig</span></a></span></span><span> </span><span id="local-6989586621688022683"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688022683"><span class="hs-identifier hs-var">dryRun</span></a></span></span><span> </span><span id="local-6989586621688022684"><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621688022684"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-comment">-- We need to build the list of migrations at compile-time so that we can compile the SQL</span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-comment">-- directly into the executable using `Q.sqlFromFile`. The GHC stage restriction makes</span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-comment">-- doing this a little bit awkward (we can&#8217;t use any definitions in this module at</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-comment">-- compile-time), but putting a `let` inside the splice itself is allowed.</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-special">$</span><span class="hs-special">(</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022691"><span class="annot"><a href="#local-6989586621688022691"><span class="hs-identifier hs-var hs-var">migrationFromFile</span></a></span></span><span> </span><span id="local-6989586621688022692"><span class="annot"><a href="#local-6989586621688022692"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621688022693"><span class="annot"><a href="#local-6989586621688022693"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-283"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022694"><span class="annot"><a href="#local-6989586621688022694"><span class="hs-identifier hs-var hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;src-rsr/migrations/&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621688022692"><span class="hs-identifier hs-type">from</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;_to_&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621688022693"><span class="hs-identifier hs-type">to</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;.sql&quot;</span></span><span>
</span><span id="line-284"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[|</span><span class="annot"><a href="#local-6989586621688022685"><span class="hs-identifier hs-type">runTxOrPrint</span></a></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html#makeRelativeToProject"><span class="hs-identifier hs-type">makeRelativeToProject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022694"><span class="hs-identifier hs-type">path</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#sqlFromFile"><span class="hs-identifier hs-type">PG.sqlFromFile</span></a></span><span class="hs-special">)</span><span class="hs-special">|]</span><span>
</span><span id="line-285"></span><span>         </span><span id="local-6989586621688022695"><span class="annot"><a href="#local-6989586621688022695"><span class="hs-identifier hs-var hs-var">migrationFromFileMaybe</span></a></span></span><span> </span><span id="local-6989586621688022696"><span class="annot"><a href="#local-6989586621688022696"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621688022697"><span class="annot"><a href="#local-6989586621688022697"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-286"></span><span>           </span><span id="local-6989586621688022698"><span class="annot"><a href="#local-6989586621688022698"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html#makeRelativeToProject"><span class="hs-identifier hs-type">makeRelativeToProject</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;src-rsr/migrations/&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621688022696"><span class="hs-identifier hs-type">from</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;_to_&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621688022697"><span class="hs-identifier hs-type">to</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;.sql&quot;</span></span><span>
</span><span id="line-287"></span><span>           </span><span id="local-6989586621688022699"><span class="annot"><a href="#local-6989586621688022699"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.runIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">doesFileExist</span></span><span> </span><span class="annot"><a href="#local-6989586621688022698"><span class="hs-identifier hs-type">path</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>           </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621688022699"><span class="hs-identifier hs-type">exists</span></a></span><span>
</span><span id="line-289"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[|</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688022685"><span class="hs-identifier hs-type">runTxOrPrint</span></a></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#sqlFromFile"><span class="hs-identifier hs-type">PG.sqlFromFile</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022698"><span class="hs-identifier hs-type">path</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">|]</span><span>
</span><span id="line-290"></span><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[|</span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">|]</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>         </span><span id="local-6989586621688022701"><span class="annot"><a href="#local-6989586621688022701"><span class="hs-identifier hs-var hs-var">migrationsFromFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688022702"><span class="annot"><a href="#local-6989586621688022702"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">MetadataCatalogVersion</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-293"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022703"><span class="annot"><a href="#local-6989586621688022703"><span class="hs-identifier hs-var hs-var">from</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pred</span></span><span> </span><span class="annot"><a href="#local-6989586621688022702"><span class="hs-identifier hs-type">to</span></a></span><span>
</span><span id="line-294"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[|</span><span>
</span><span id="line-295"></span><span>                 </span><span class="hs-special">(</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TH.lift</span></span><span> </span><span class="annot"><a href="#local-6989586621688022703"><span class="hs-identifier hs-type">from</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-296"></span><span>                   </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-type">MigrationPair</span></a></span><span>
</span><span id="line-297"></span><span>                     </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688022691"><span class="hs-identifier hs-type">migrationFromFile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621688022703"><span class="hs-identifier hs-type">from</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621688022702"><span class="hs-identifier hs-type">to</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>                     </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688022695"><span class="hs-identifier hs-type">migrationFromFileMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621688022702"><span class="hs-identifier hs-type">to</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="annot"><a href="#local-6989586621688022703"><span class="hs-identifier hs-type">from</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>                 </span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>                 </span><span class="hs-special">|]</span><span>
</span><span id="line-301"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TH.listE</span></span><span>
</span><span id="line-302"></span><span>           </span><span class="hs-comment">-- version 0.8 is the only non-integral catalog version</span><span>
</span><span id="line-303"></span><span>           </span><span class="hs-comment">-- The 40_to_41 migration is consciously omitted from below because its contents</span><span>
</span><span id="line-304"></span><span>           </span><span class="hs-comment">-- have been moved to the `0_to_1.sql` because the `40_to_41` migration only contained</span><span>
</span><span id="line-305"></span><span>           </span><span class="hs-comment">-- source catalog changes and we'd like to keep source catalog migrations in a different</span><span>
</span><span id="line-306"></span><span>           </span><span class="hs-comment">-- path than metadata catalog migrations.</span><span>
</span><span id="line-307"></span><span>           </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">[|</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion08"><span class="hs-identifier hs-type">MetadataCatalogVersion08</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-type">MigrationPair</span></a></span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688022691"><span class="hs-identifier hs-type">migrationFromFile</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;08&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;1&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">|]</span><span>
</span><span id="line-308"></span><span>           </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621688022701"><span class="hs-identifier hs-type">migrationsFromFile</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">]</span><span>
</span><span id="line-309"></span><span>             </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="hs-special">[|</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-type">MigrationPair</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.Internal.html#from3To4"><span class="hs-identifier hs-type">from3To4</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">|]</span><span>
</span><span id="line-310"></span><span>           </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688022701"><span class="hs-identifier hs-type">migrationsFromFile</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="annot"><span class="hs-number">5</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="annot"><span class="hs-number">40</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621688022701"><span class="hs-identifier hs-type">migrationsFromFile</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="annot"><span class="hs-number">42</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>             </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="hs-special">[|</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="annot"><span class="hs-number">42</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#MigrationPair"><span class="hs-identifier hs-type">MigrationPair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022686"><span class="hs-identifier hs-type">from42To43</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621688022687"><span class="hs-identifier hs-type">from43To42</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">|]</span><span>
</span><span id="line-312"></span><span>           </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621688022701"><span class="hs-identifier hs-type">migrationsFromFile</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Server.Migrate.Version.html#MetadataCatalogVersion"><span class="hs-identifier hs-type">MetadataCatalogVersion</span></a></span><span> </span><span class="annot"><span class="hs-number">44</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.LatestVersion.html#latestCatalogVersion"><span class="hs-identifier hs-type">latestCatalogVersion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-313"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><a href="#local-6989586621688022685"><span class="hs-identifier hs-type">runTxOrPrint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#Query"><span class="hs-identifier hs-type">PG.Query</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688022115"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>    </span><span id="local-6989586621688022685"><span class="annot"><span class="annottext">runTxOrPrint :: Query -&gt; m ()
</span><a href="#local-6989586621688022685"><span class="hs-identifier hs-var hs-var">runTxOrPrint</span></a></span></span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688022683"><span class="hs-identifier hs-var">dryRun</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-318"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; (Query -&gt; IO ()) -&gt; Query -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO ()
</span><span class="hs-identifier hs-var">TIO.putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO ()) -&gt; (Query -&gt; Text) -&gt; Query -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#getQueryText"><span class="hs-identifier hs-var">PG.getQueryText</span></a></span><span>
</span><span id="line-319"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Query -&gt; m ()
forall (m :: * -&gt; *). MonadTx m =&gt; Query -&gt; m ()
</span><a href="Hasura.Server.Migrate.html#multiQ"><span class="hs-identifier hs-var">multiQ</span></a></span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span>    </span><span id="local-6989586621688022686"><span class="annot"><span class="annottext">from42To43 :: m ()
</span><a href="#local-6989586621688022686"><span class="hs-identifier hs-var hs-var">from42To43</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621688022684"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode () -&gt; MaintenanceMode () -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; MaintenanceMode ()
forall a. a -&gt; MaintenanceMode a
</span><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-var">MaintenanceModeEnabled</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>        </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cannot migrate to catalog version 43 in maintenance mode&quot;</span></span><span>
</span><span id="line-324"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022709"><span class="annot"><span class="annottext">query :: Query
</span><a href="#local-6989586621688022709"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html#makeRelativeToProject"><span class="hs-identifier hs-type">makeRelativeToProject</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;src-rsr/migrations/42_to_43.sql&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#sqlFromFile"><span class="hs-identifier hs-type">PG.sqlFromFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688022683"><span class="hs-identifier hs-var">dryRun</span></a></span><span>
</span><span id="line-326"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; (Query -&gt; IO ()) -&gt; Query -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO ()
</span><span class="hs-identifier hs-var">TIO.putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO ()) -&gt; (Query -&gt; Text) -&gt; Query -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#getQueryText"><span class="hs-identifier hs-var">PG.getQueryText</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Query
</span><a href="#local-6989586621688022709"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-327"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>          </span><span id="local-6989586621688022710"><span class="annot"><a href="#local-6989586621688022710"><span class="hs-identifier hs-var">metadataV2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m MetadataNoSources
forall (m :: * -&gt; *). MonadTx m =&gt; m MetadataNoSources
</span><a href="Hasura.RQL.DDL.Schema.LegacyCatalog.html#fetchMetadataFromHdbTables"><span class="hs-identifier hs-var">fetchMetadataFromHdbTables</span></a></span><span>
</span><span id="line-329"></span><span>          </span><span class="annot"><a href="Hasura.Server.Migrate.html#multiQ"><span class="hs-identifier hs-type">multiQ</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022709"><span class="hs-identifier hs-type">query</span></a></span><span>
</span><span id="line-330"></span><span>          </span><span id="local-6989586621688022712"><span class="annot"><a href="#local-6989586621688022712"><span class="hs-identifier hs-var">defaultSourceConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-331"></span><span>            </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-type">onNothing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022682"><span class="hs-identifier hs-type">maybeDefaultSourceConfig</span></a></span><span>
</span><span id="line-332"></span><span>              </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-type">throw400</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-type">NotSupported</span></a></span><span>
</span><span id="line-333"></span><span>              </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;cannot migrate to catalog version 43 without --database-url or env var &quot;</span></span><span>
</span><span id="line-334"></span><span>              </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-type">tshow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Init.Config.html#_envVar"><span class="hs-identifier hs-var">_envVar</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Arg.html#databaseUrlOption"><span class="hs-identifier hs-type">databaseUrlOption</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022714"><span class="annot"><a href="#local-6989586621688022714"><span class="hs-identifier hs-var hs-var">metadataV3</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-336"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataNoSources"><span class="hs-identifier hs-type">MetadataNoSources</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688022716"><span id="local-6989586621688022717"><span id="local-6989586621688022718"><span id="local-6989586621688022719"><span id="local-6989586621688022720"><span id="local-6989586621688022721"><span id="local-6989586621688022722"><span id="local-6989586621688022723"><span class="annot"><span class="annottext">QueryCollections
MetadataAllowlist
RemoteSchemas
InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (FunctionMetadata ('Postgres 'Vanilla))
CronTriggers
Actions
CustomTypes
_mnsTables :: InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
_mnsFunctions :: InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (FunctionMetadata ('Postgres 'Vanilla))
_mnsRemoteSchemas :: RemoteSchemas
_mnsQueryCollections :: QueryCollections
_mnsAllowlist :: MetadataAllowlist
_mnsCustomTypes :: CustomTypes
_mnsActions :: Actions
_mnsCronTriggers :: CronTriggers
_mnsCronTriggers :: MetadataNoSources -&gt; CronTriggers
_mnsActions :: MetadataNoSources -&gt; Actions
_mnsCustomTypes :: MetadataNoSources -&gt; CustomTypes
_mnsAllowlist :: MetadataNoSources -&gt; MetadataAllowlist
_mnsQueryCollections :: MetadataNoSources -&gt; QueryCollections
_mnsRemoteSchemas :: MetadataNoSources -&gt; RemoteSchemas
_mnsFunctions :: MetadataNoSources
-&gt; InsOrdHashMap
     (FunctionName ('Postgres 'Vanilla))
     (FunctionMetadata ('Postgres 'Vanilla))
_mnsTables :: MetadataNoSources
-&gt; InsOrdHashMap
     (TableName ('Postgres 'Vanilla))
     (TableMetadata ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022716"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataNoSources
</span><a href="#local-6989586621688022710"><span class="hs-identifier hs-var">metadataV2</span></a></span><span>
</span><span id="line-337"></span><span>                    </span><span id="local-6989586621688022732"><span class="annot"><span class="annottext">defaultSourceMetadata :: BackendSourceMetadata
</span><a href="#local-6989586621688022732"><span class="hs-identifier hs-var hs-var">defaultSourceMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-338"></span><span>                      </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata -&gt; BackendSourceMetadata
</span><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-var">BackendSourceMetadata</span></a></span><span>
</span><span id="line-339"></span><span>                        </span><span class="annot"><span class="annottext">(AnyBackend SourceMetadata -&gt; BackendSourceMetadata)
-&gt; AnyBackend SourceMetadata -&gt; BackendSourceMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceMetadata ('Postgres 'Vanilla) -&gt; AnyBackend SourceMetadata
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span>
</span><span id="line-340"></span><span>                        </span><span class="annot"><span class="annottext">(SourceMetadata ('Postgres 'Vanilla) -&gt; AnyBackend SourceMetadata)
-&gt; SourceMetadata ('Postgres 'Vanilla) -&gt; AnyBackend SourceMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; BackendSourceKind ('Postgres 'Vanilla)
-&gt; InsOrdHashMap
     (TableName ('Postgres 'Vanilla))
     (TableMetadata ('Postgres 'Vanilla))
-&gt; InsOrdHashMap
     (FunctionName ('Postgres 'Vanilla))
     (FunctionMetadata ('Postgres 'Vanilla))
-&gt; NativeQueries ('Postgres 'Vanilla)
-&gt; InsOrdHashMap
     (FunctionName ('Postgres 'Vanilla))
     (StoredProcedureMetadata ('Postgres 'Vanilla))
-&gt; LogicalModels ('Postgres 'Vanilla)
-&gt; SourceConnConfiguration ('Postgres 'Vanilla)
-&gt; Maybe QueryTagsConfig
-&gt; SourceCustomization
-&gt; Maybe (HealthCheckConfig ('Postgres 'Vanilla))
-&gt; SourceMetadata ('Postgres 'Vanilla)
forall (b :: BackendType).
SourceName
-&gt; BackendSourceKind b
-&gt; Tables b
-&gt; Functions b
-&gt; NativeQueries b
-&gt; StoredProcedures b
-&gt; LogicalModels b
-&gt; SourceConnConfiguration b
-&gt; Maybe QueryTagsConfig
-&gt; SourceCustomization
-&gt; Maybe (HealthCheckConfig b)
-&gt; SourceMetadata b
</span><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-var">SourceMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceKind ('Postgres 'Vanilla)
</span><a href="Hasura.RQL.Types.BackendType.html#PostgresVanillaKind"><span class="hs-identifier hs-var">PostgresVanillaKind</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022716"><span class="hs-identifier hs-var">_mnsTables</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (FunctionMetadata ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022717"><span class="hs-identifier hs-var">_mnsFunctions</span></a></span><span> </span><span class="annot"><span class="annottext">NativeQueries ('Postgres 'Vanilla)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (StoredProcedureMetadata ('Postgres 'Vanilla))
InsOrdHashMap
  QualifiedFunction (StoredProcedureMetadata ('Postgres 'Vanilla))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">LogicalModels ('Postgres 'Vanilla)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">SourceConnConfiguration ('Postgres 'Vanilla)
PostgresConnConfiguration
</span><a href="#local-6989586621688022712"><span class="hs-identifier hs-var">defaultSourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe QueryTagsConfig
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">SourceCustomization
</span><a href="Hasura.RQL.Types.SourceCustomization.html#emptySourceCustomization"><span class="hs-identifier hs-var">emptySourceCustomization</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (HealthCheckConfig ('Postgres 'Vanilla))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-341"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
-&gt; RemoteSchemas
-&gt; QueryCollections
-&gt; MetadataAllowlist
-&gt; CustomTypes
-&gt; Actions
-&gt; CronTriggers
-&gt; Endpoints
-&gt; ApiLimit
-&gt; MetricsConfig
-&gt; InheritedRoles
-&gt; SetGraphqlIntrospectionOptions
-&gt; Network
-&gt; BackendMap BackendConfigWrapper
-&gt; OpenTelemetryConfig
-&gt; Metadata
</span><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-var">Metadata</span></a></span><span>
</span><span id="line-342"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
forall k v. Hashable k =&gt; k -&gt; v -&gt; InsOrdHashMap k v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/insert-ordered-containers-0.2.5.3-dcb71999c8104475fd299533bb40a6c15ee8a9411f3a03b68aa99a14a4143c19/share/doc/html/src/Data.HashMap.Strict.InsOrd.html/Data.HashMap.Strict.InsOrd.html#singleton"><span class="hs-identifier hs-var">InsOrdHashMap.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceMetadata
</span><a href="#local-6989586621688022732"><span class="hs-identifier hs-var">defaultSourceMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>                      </span><span class="annot"><span class="annottext">RemoteSchemas
</span><a href="#local-6989586621688022718"><span class="hs-identifier hs-var">_mnsRemoteSchemas</span></a></span><span>
</span><span id="line-344"></span><span>                      </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688022719"><span class="hs-identifier hs-var">_mnsQueryCollections</span></a></span><span>
</span><span id="line-345"></span><span>                      </span><span class="annot"><span class="annottext">MetadataAllowlist
</span><a href="#local-6989586621688022720"><span class="hs-identifier hs-var">_mnsAllowlist</span></a></span><span>
</span><span id="line-346"></span><span>                      </span><span class="annot"><span class="annottext">CustomTypes
</span><a href="#local-6989586621688022721"><span class="hs-identifier hs-var">_mnsCustomTypes</span></a></span><span>
</span><span id="line-347"></span><span>                      </span><span class="annot"><span class="annottext">Actions
</span><a href="#local-6989586621688022722"><span class="hs-identifier hs-var">_mnsActions</span></a></span><span>
</span><span id="line-348"></span><span>                      </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621688022723"><span class="hs-identifier hs-var">_mnsCronTriggers</span></a></span><span>
</span><span id="line-349"></span><span>                      </span><span class="annot"><span class="annottext">Endpoints
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-350"></span><span>                      </span><span class="annot"><span class="annottext">ApiLimit
</span><a href="Hasura.RQL.Types.ApiLimit.html#emptyApiLimit"><span class="hs-identifier hs-var">emptyApiLimit</span></a></span><span>
</span><span id="line-351"></span><span>                      </span><span class="annot"><span class="annottext">MetricsConfig
</span><a href="Hasura.RQL.Types.Common.html#emptyMetricsConfig"><span class="hs-identifier hs-var">emptyMetricsConfig</span></a></span><span>
</span><span id="line-352"></span><span>                      </span><span class="annot"><span class="annottext">InheritedRoles
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-353"></span><span>                      </span><span class="annot"><span class="annottext">SetGraphqlIntrospectionOptions
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-354"></span><span>                      </span><span class="annot"><span class="annottext">Network
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.Types.Extended.html/Network.Types.Extended.html#emptyNetwork"><span class="hs-identifier hs-var">emptyNetwork</span></a></span><span>
</span><span id="line-355"></span><span>                      </span><span class="annot"><span class="annottext">BackendMap BackendConfigWrapper
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-356"></span><span>                      </span><span class="annot"><span class="annottext">OpenTelemetryConfig
</span><a href="Hasura.RQL.Types.OpenTelemetry.html#emptyOpenTelemetryConfig"><span class="hs-identifier hs-var">emptyOpenTelemetryConfig</span></a></span><span>
</span><span id="line-357"></span><span>          </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-type">liftTx</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Catalog.html#insertMetadataInCatalog"><span class="hs-identifier hs-type">insertMetadataInCatalog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022714"><span class="hs-identifier hs-type">metadataV3</span></a></span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span>    </span><span id="local-6989586621688022687"><span class="annot"><span class="annottext">from43To42 :: m ()
</span><a href="#local-6989586621688022687"><span class="hs-identifier hs-var hs-var">from43To42</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022737"><span class="annot"><span class="annottext">query :: Query
</span><a href="#local-6989586621688022737"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html#makeRelativeToProject"><span class="hs-identifier hs-type">makeRelativeToProject</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;src-rsr/migrations/43_to_42.sql&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#sqlFromFile"><span class="hs-identifier hs-type">PG.sqlFromFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688022683"><span class="hs-identifier hs-var">dryRun</span></a></span><span>
</span><span id="line-362"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; (Query -&gt; IO ()) -&gt; Query -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO ()
</span><span class="hs-identifier hs-var">TIO.putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO ()) -&gt; (Query -&gt; Text) -&gt; Query -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#getQueryText"><span class="hs-identifier hs-var">PG.getQueryText</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Query
</span><a href="#local-6989586621688022737"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-363"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-364"></span><span>          </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#Metadata"><span class="hs-identifier hs-type">Metadata</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688022738"><span id="local-6989586621688022739"><span id="local-6989586621688022740"><span id="local-6989586621688022741"><span id="local-6989586621688022742"><span id="local-6989586621688022743"><span id="local-6989586621688022744"><span id="local-6989586621688022745"><span id="local-6989586621688022746"><span id="local-6989586621688022747"><span id="local-6989586621688022748"><span id="local-6989586621688022749"><span id="local-6989586621688022750"><span id="local-6989586621688022751"><span id="local-6989586621688022752"><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#_metaSources"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TxE QErr Metadata -&gt; m Metadata
forall a. TxE QErr a -&gt; m a
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-var">liftTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr Metadata
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataFromCatalog"><span class="hs-identifier hs-var">fetchMetadataFromCatalog</span></a></span><span>
</span><span id="line-365"></span><span>          </span><span class="annot"><a href="Hasura.Server.Migrate.html#multiQ"><span class="hs-identifier hs-type">multiQ</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022737"><span class="hs-identifier hs-type">query</span></a></span><span>
</span><span id="line-366"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688022799"><span class="annot"><a href="#local-6989586621688022799"><span class="hs-identifier hs-var hs-var">emptyMetadataNoSources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-367"></span><span>                </span><span class="annot"><span class="annottext">InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
-&gt; InsOrdHashMap
     (FunctionName ('Postgres 'Vanilla))
     (FunctionMetadata ('Postgres 'Vanilla))
-&gt; RemoteSchemas
-&gt; QueryCollections
-&gt; MetadataAllowlist
-&gt; CustomTypes
-&gt; Actions
-&gt; CronTriggers
-&gt; MetadataNoSources
</span><a href="Hasura.RQL.Types.Metadata.html#MetadataNoSources"><span class="hs-identifier hs-var">MetadataNoSources</span></a></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
InsOrdHashMap QualifiedTable (TableMetadata ('Postgres 'Vanilla))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (FunctionMetadata ('Postgres 'Vanilla))
InsOrdHashMap
  QualifiedFunction (FunctionMetadata ('Postgres 'Vanilla))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemas
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">QueryCollections
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">MetadataAllowlist
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">CustomTypes
</span><a href="Hasura.RQL.Types.CustomTypes.html#emptyCustomTypes"><span class="hs-identifier hs-var">emptyCustomTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Actions
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">CronTriggers
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-368"></span><span>          </span><span id="local-6989586621688022801"><span class="annot"><a href="#local-6989586621688022801"><span class="hs-identifier hs-var">metadataV2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/insert-ordered-containers-0.2.5.3-dcb71999c8104475fd299533bb40a6c15ee8a9411f3a03b68aa99a14a4143c19/share/doc/html/src/Data.HashMap.Strict.InsOrd.html/Data.HashMap.Strict.InsOrd.html#toList"><span class="hs-identifier hs-type">InsOrdHashMap.toList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022738"><span class="hs-identifier hs-type">_metaSources</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-369"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetadataNoSources -&gt; m MetadataNoSources
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MetadataNoSources
</span><a href="#local-6989586621688022799"><span class="hs-identifier hs-var">emptyMetadataNoSources</span></a></span><span>
</span><span id="line-370"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#BackendSourceMetadata"><span class="hs-identifier hs-type">BackendSourceMetadata</span></a></span><span> </span><span id="local-6989586621688022803"><span class="annot"><span class="annottext">AnyBackend SourceMetadata
</span><a href="#local-6989586621688022803"><span class="hs-identifier hs-var">exists</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-371"></span><span>              </span><span class="annot"><span class="annottext">MetadataNoSources -&gt; m MetadataNoSources
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(MetadataNoSources -&gt; m MetadataNoSources)
-&gt; MetadataNoSources -&gt; m MetadataNoSources
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
-&gt; Maybe (SourceMetadata ('Postgres 'Vanilla))
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
AnyBackend i -&gt; Maybe (i b)
</span><a href="Hasura.SQL.AnyBackend.html#unpackAnyBackend"><span class="hs-identifier hs-var">AB.unpackAnyBackend</span></a></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceMetadata
</span><a href="#local-6989586621688022803"><span class="hs-identifier hs-var">exists</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-372"></span><span>                </span><span class="annot"><span class="annottext">Maybe (SourceMetadata ('Postgres 'Vanilla))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetadataNoSources
</span><a href="#local-6989586621688022799"><span class="hs-identifier hs-var">emptyMetadataNoSources</span></a></span><span>
</span><span id="line-373"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#SourceMetadata"><span class="hs-identifier hs-type">SourceMetadata</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688022805"><span id="local-6989586621688022806"><span id="local-6989586621688022807"><span id="local-6989586621688022808"><span id="local-6989586621688022809"><span id="local-6989586621688022810"><span id="local-6989586621688022811"><span id="local-6989586621688022812"><span id="local-6989586621688022813"><span id="local-6989586621688022814"><span id="local-6989586621688022815"><span class="annot"><span class="annottext">Maybe QueryTagsConfig
Maybe (HealthCheckConfig ('Postgres 'Vanilla))
InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (FunctionMetadata ('Postgres 'Vanilla))
InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (StoredProcedureMetadata ('Postgres 'Vanilla))
NativeQueries ('Postgres 'Vanilla)
LogicalModels ('Postgres 'Vanilla)
BackendSourceKind ('Postgres 'Vanilla)
SourceName
SourceConnConfiguration ('Postgres 'Vanilla)
SourceCustomization
_smName :: SourceName
_smKind :: BackendSourceKind ('Postgres 'Vanilla)
_smTables :: InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
_smFunctions :: InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (FunctionMetadata ('Postgres 'Vanilla))
_smNativeQueries :: NativeQueries ('Postgres 'Vanilla)
_smStoredProcedures :: InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (StoredProcedureMetadata ('Postgres 'Vanilla))
_smLogicalModels :: LogicalModels ('Postgres 'Vanilla)
_smConfiguration :: SourceConnConfiguration ('Postgres 'Vanilla)
_smQueryTags :: Maybe QueryTagsConfig
_smCustomization :: SourceCustomization
_smHealthCheckConfig :: Maybe (HealthCheckConfig ('Postgres 'Vanilla))
_smHealthCheckConfig :: forall (b :: BackendType).
SourceMetadata b -&gt; Maybe (HealthCheckConfig b)
_smCustomization :: forall (b :: BackendType). SourceMetadata b -&gt; SourceCustomization
_smQueryTags :: forall (b :: BackendType).
SourceMetadata b -&gt; Maybe QueryTagsConfig
_smConfiguration :: forall (b :: BackendType).
SourceMetadata b -&gt; SourceConnConfiguration b
_smLogicalModels :: forall (b :: BackendType). SourceMetadata b -&gt; LogicalModels b
_smStoredProcedures :: forall (b :: BackendType). SourceMetadata b -&gt; StoredProcedures b
_smNativeQueries :: forall (b :: BackendType). SourceMetadata b -&gt; NativeQueries b
_smFunctions :: forall (b :: BackendType). SourceMetadata b -&gt; Functions b
_smTables :: forall (b :: BackendType). SourceMetadata b -&gt; Tables b
_smKind :: forall (b :: BackendType). SourceMetadata b -&gt; BackendSourceKind b
_smName :: forall (b :: BackendType). SourceMetadata b -&gt; SourceName
</span><a href="#local-6989586621688022805"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-374"></span><span>                  </span><span class="annot"><span class="annottext">InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
-&gt; InsOrdHashMap
     (FunctionName ('Postgres 'Vanilla))
     (FunctionMetadata ('Postgres 'Vanilla))
-&gt; RemoteSchemas
-&gt; QueryCollections
-&gt; MetadataAllowlist
-&gt; CustomTypes
-&gt; Actions
-&gt; CronTriggers
-&gt; MetadataNoSources
</span><a href="Hasura.RQL.Types.Metadata.html#MetadataNoSources"><span class="hs-identifier hs-var">MetadataNoSources</span></a></span><span>
</span><span id="line-375"></span><span>                    </span><span class="annot"><span class="annottext">InsOrdHashMap
  (TableName ('Postgres 'Vanilla))
  (TableMetadata ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022807"><span class="hs-identifier hs-var">_smTables</span></a></span><span>
</span><span id="line-376"></span><span>                    </span><span class="annot"><span class="annottext">InsOrdHashMap
  (FunctionName ('Postgres 'Vanilla))
  (FunctionMetadata ('Postgres 'Vanilla))
</span><a href="#local-6989586621688022808"><span class="hs-identifier hs-var">_smFunctions</span></a></span><span>
</span><span id="line-377"></span><span>                    </span><span class="annot"><span class="annottext">RemoteSchemas
</span><a href="#local-6989586621688022739"><span class="hs-identifier hs-var">_metaRemoteSchemas</span></a></span><span>
</span><span id="line-378"></span><span>                    </span><span class="annot"><span class="annottext">QueryCollections
</span><a href="#local-6989586621688022740"><span class="hs-identifier hs-var">_metaQueryCollections</span></a></span><span>
</span><span id="line-379"></span><span>                    </span><span class="annot"><span class="annottext">MetadataAllowlist
</span><a href="#local-6989586621688022741"><span class="hs-identifier hs-var">_metaAllowlist</span></a></span><span>
</span><span id="line-380"></span><span>                    </span><span class="annot"><span class="annottext">CustomTypes
</span><a href="#local-6989586621688022742"><span class="hs-identifier hs-var">_metaCustomTypes</span></a></span><span>
</span><span id="line-381"></span><span>                    </span><span class="annot"><span class="annottext">Actions
</span><a href="#local-6989586621688022743"><span class="hs-identifier hs-var">_metaActions</span></a></span><span>
</span><span id="line-382"></span><span>                    </span><span class="annot"><span class="annottext">CronTriggers
</span><a href="#local-6989586621688022744"><span class="hs-identifier hs-var">_metaCronTriggers</span></a></span><span>
</span><span id="line-383"></span><span>            </span><span class="annot"><span class="annottext">[(SourceName, BackendSourceMetadata)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m MetadataNoSources
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Cannot downgrade since there are more than one source&quot;</span></span><span>
</span><span id="line-384"></span><span>          </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-type">liftTx</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-385"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">flip</span></span><span> </span><span class="annot"><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SystemDefined"><span class="hs-identifier hs-type">SystemDefined</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.LegacyCatalog.html#saveMetadataToHdbTables"><span class="hs-identifier hs-type">saveMetadataToHdbTables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022801"><span class="hs-identifier hs-type">metadataV2</span></a></span><span>
</span><span id="line-386"></span><span>            </span><span class="hs-comment">-- when the graphql-engine is migrated from v1 to v2, we drop the foreign key</span><span>
</span><span id="line-387"></span><span>            </span><span class="hs-comment">-- constraint of the `hdb_catalog.hdb_cron_event` table because the cron triggers</span><span>
</span><span id="line-388"></span><span>            </span><span class="hs-comment">-- in v2 are saved in the `hdb_catalog.hdb_metadata` table. So, when a downgrade</span><span>
</span><span id="line-389"></span><span>            </span><span class="hs-comment">-- happens, we need to delay adding the foreign key constraint until the</span><span>
</span><span id="line-390"></span><span>            </span><span class="hs-comment">-- cron triggers are added in the `hdb_catalog.hdb_cron_triggers`</span><span>
</span><span id="line-391"></span><span>            </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.LegacyCatalog.html#addCronTriggerForeignKeyConstraint"><span class="hs-identifier hs-type">addCronTriggerForeignKeyConstraint</span></a></span><span>
</span><span id="line-392"></span><span>          </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.LegacyCatalog.html#recreateSystemMetadata"><span class="hs-identifier hs-type">recreateSystemMetadata</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span id="local-6989586621688022093"><span class="annot"><a href="Hasura.Server.Migrate.html#multiQ"><span class="hs-identifier hs-type">multiQ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#MonadTx"><span class="hs-identifier hs-type">MonadTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688022093"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#Query"><span class="hs-identifier hs-type">PG.Query</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688022093"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-395"></span><span id="multiQ"><span class="annot"><span class="annottext">multiQ :: forall (m :: * -&gt; *). MonadTx m =&gt; Query -&gt; m ()
</span><a href="Hasura.Server.Migrate.html#multiQ"><span class="hs-identifier hs-var hs-var">multiQ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; m ()
forall a. TxE QErr a -&gt; m a
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-var">liftTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; m ()) -&gt; (Query -&gt; TxE QErr ()) -&gt; Query -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr) -&gt; Query -&gt; TxE QErr ()
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRes a) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#multiQE"><span class="hs-identifier hs-var">PG.multiQE</span></a></span><span> </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-396"></span></pre></body></html>