<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | Postgres DDL RunSQL</span><span>
</span><span id="line-5"></span><span class="hs-comment">--</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Escape hatch for running raw SQL against a postgres database.</span><span>
</span><span id="line-7"></span><span class="hs-comment">--</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- 'runRunSQL' executes the provided raw SQL.</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- 'isSchemaCacheBuildRequiredRunSQL' checks for known schema-mutating keywords</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- in the raw SQL text.</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- See 'Hasura.Server.API.V2Query' and 'Hasura.Server.API.Query'.</span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html"><span class="hs-identifier">Hasura.Backends.Postgres.DDL.RunSQL</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#runRunSQL"><span class="hs-identifier">runRunSQL</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier">RunSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isReadOnly"><span class="hs-identifier">isReadOnly</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isSchemaCacheBuildRequiredRunSQL"><span class="hs-identifier">isSchemaCacheBuildRequiredRunSQL</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">where</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html"><span class="hs-identifier">Control.Monad.Trans.Control</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier">MonadBaseControl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.html/Data.Aeson.html"><span class="hs-identifier">Data.Aeson</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Strict.html/Data.HashMap.Strict.html"><span class="hs-identifier">Data.HashMap.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.html/Data.HashSet.html"><span class="hs-identifier">Data.HashSet</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HS</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html/Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.html/Database.PG.Query.html"><span class="hs-identifier">Database.PG.Query</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PG</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Authentication.User.html"><span class="hs-identifier">Hasura.Authentication.User</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Authentication.User.html#UserInfoM"><span class="hs-identifier">UserInfoM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html"><span class="hs-identifier">Hasura.Backends.Postgres.Connection.MonadTx</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.EventTrigger.html"><span class="hs-identifier">Hasura.Backends.Postgres.DDL.EventTrigger</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html"><span class="hs-identifier">Hasura.Backends.Postgres.DDL.Source</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchFunctionMetadata"><span class="hs-identifier">FetchFunctionMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchTableMetadata"><span class="hs-identifier">FetchTableMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#ToMetadataFetchQuery"><span class="hs-identifier">ToMetadataFetchQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#fetchFunctionMetadata"><span class="hs-identifier">fetchFunctionMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#fetchTableMetadata"><span class="hs-identifier">fetchTableMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Execute.Types.html"><span class="hs-identifier">Hasura.Backends.Postgres.Execute.Types</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html"><span class="hs-identifier">Hasura.Backends.Postgres.SQL.Types</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#FunctionName"><span class="hs-identifier">FunctionName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#TableName"><span class="hs-identifier">TableName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-json-encoding-1.0.0/opt/doc/html/hasura-json-encoding/src/Hasura.EncJSON.html/Hasura.EncJSON.html"><span class="hs-identifier">Hasura.EncJSON</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Function.Cache.html"><span class="hs-identifier">Hasura.Function.Cache</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Diff</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Diff</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html"><span class="hs-identifier">Hasura.RQL.Types.BackendType</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Column.html"><span class="hs-identifier">Hasura.RQL.Types.Column</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#StructuredColumnInfo"><span class="hs-identifier">StructuredColumnInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.ComputedField.html"><span class="hs-identifier">Hasura.RQL.Types.ComputedField</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.EventTrigger</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata.Backend</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache.Build</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCacheTypes</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Utils.html"><span class="hs-identifier">Hasura.Server.Utils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Utils.html#quoteRegex"><span class="hs-identifier">quoteRegex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Table.Cache.html"><span class="hs-identifier">Hasura.Table.Cache</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/regex-tdfa-1.3.2.2-bba2e0707f49b8913e3525fd5acd95f61def8d2816d6a9c12a8ee453c6dd890d/share/doc/html/src/Text.Regex.TDFA.html/Text.Regex.TDFA.html"><span class="hs-identifier">Text.Regex.TDFA</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TDFA</span></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">data</span><span> </span><span id="RunSQL"><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-var">RunSQL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RunSQL"><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-var">RunSQL</span></a></span></span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="rSql"><span class="annot"><span class="annottext">RunSQL -&gt; Text
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rSql"><span class="hs-identifier hs-var hs-var">rSql</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>    </span><span id="rSource"><span class="annot"><span class="annottext">RunSQL -&gt; SourceName
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rSource"><span class="hs-identifier hs-var hs-var">rSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>    </span><span id="rCascade"><span class="annot"><span class="annottext">RunSQL -&gt; Bool
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rCascade"><span class="hs-identifier hs-var hs-var">rCascade</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>    </span><span id="rCheckMetadataConsistency"><span class="annot"><span class="annottext">RunSQL -&gt; Maybe Bool
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rCheckMetadataConsistency"><span class="hs-identifier hs-var hs-var">rCheckMetadataConsistency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>    </span><span id="rTxAccessMode"><span class="annot"><span class="annottext">RunSQL -&gt; TxAccess
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rTxAccessMode"><span class="hs-identifier hs-var hs-var">rTxAccessMode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxAccess"><span class="hs-identifier hs-type">PG.TxAccess</span></a></span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688023569"><span id="local-6989586621688023583"><span id="local-6989586621688023587"><span class="annot"><span class="annottext">Int -&gt; RunSQL -&gt; ShowS
[RunSQL] -&gt; ShowS
RunSQL -&gt; String
(Int -&gt; RunSQL -&gt; ShowS)
-&gt; (RunSQL -&gt; String) -&gt; ([RunSQL] -&gt; ShowS) -&gt; Show RunSQL
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; RunSQL -&gt; ShowS
showsPrec :: Int -&gt; RunSQL -&gt; ShowS
$cshow :: RunSQL -&gt; String
show :: RunSQL -&gt; String
$cshowList :: [RunSQL] -&gt; ShowS
showList :: [RunSQL] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688023592"><span id="local-6989586621688023604"><span class="annot"><span class="annottext">RunSQL -&gt; RunSQL -&gt; Bool
(RunSQL -&gt; RunSQL -&gt; Bool)
-&gt; (RunSQL -&gt; RunSQL -&gt; Bool) -&gt; Eq RunSQL
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: RunSQL -&gt; RunSQL -&gt; Bool
== :: RunSQL -&gt; RunSQL -&gt; Bool
$c/= :: RunSQL -&gt; RunSQL -&gt; Bool
/= :: RunSQL -&gt; RunSQL -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688023610"><span id="local-6989586621688023614"><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#FromJSON"><span class="hs-identifier hs-type">FromJSON</span></a></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-75"></span><span>  </span><span id="local-6989586621688023639"><span class="annot"><span class="annottext">parseJSON :: Value -&gt; Parser RunSQL
</span><a href="#local-6989586621688023639"><span class="hs-identifier hs-var hs-var hs-var">parseJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; (Object -&gt; Parser RunSQL) -&gt; Value -&gt; Parser RunSQL
forall a. String -&gt; (Object -&gt; Parser a) -&gt; Value -&gt; Parser a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#withObject"><span class="hs-identifier hs-var">withObject</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RunSQL&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Object -&gt; Parser RunSQL) -&gt; Value -&gt; Parser RunSQL)
-&gt; (Object -&gt; Parser RunSQL) -&gt; Value -&gt; Parser RunSQL
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688023642"><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621688023642"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>    </span><span id="local-6989586621688023643"><span class="annot"><a href="#local-6989586621688023643"><span class="hs-identifier hs-var">rSql</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621688023642"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser Text
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#.%3A"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;sql&quot;</span></span><span>
</span><span id="line-77"></span><span>    </span><span id="local-6989586621688023645"><span class="annot"><a href="#local-6989586621688023645"><span class="hs-identifier hs-var">rSource</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621688023642"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#.%3A%3F"><span class="hs-operator hs-type">.:?</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#.%21%3D"><span class="hs-operator hs-type">.!=</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-type">defaultSource</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span id="local-6989586621688023649"><span class="annot"><a href="#local-6989586621688023649"><span class="hs-identifier hs-var">rCascade</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621688023642"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#.%3A%3F"><span class="hs-operator hs-type">.:?</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;cascade&quot;</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#.%21%3D"><span class="hs-operator hs-type">.!=</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-79"></span><span>    </span><span id="local-6989586621688023650"><span class="annot"><a href="#local-6989586621688023650"><span class="hs-identifier hs-var">rCheckMetadataConsistency</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621688023642"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#.%3A%3F"><span class="hs-operator hs-type">.:?</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;check_metadata_consistency&quot;</span></span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621688023651"><span class="annot"><a href="#local-6989586621688023651"><span class="hs-identifier hs-var">readOnly</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621688023642"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#.%3A%3F"><span class="hs-operator hs-type">.:?</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;read_only&quot;</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.FromJSON.html/Data.Aeson.Types.FromJSON.html#.%21%3D"><span class="hs-operator hs-type">.!=</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688023652"><span class="annot"><a href="#local-6989586621688023652"><span class="hs-identifier hs-var hs-var">rTxAccessMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688023651"><span class="hs-identifier hs-var">readOnly</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadOnly"><span class="hs-identifier hs-var">PG.ReadOnly</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadWrite"><span class="hs-identifier hs-var">PG.ReadWrite</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rSql"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-type hs-type hs-type hs-type hs-type">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688023657"><span id="local-6989586621688023661"><span id="local-6989586621688023664"><span id="local-6989586621688023667"><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-85"></span><span>  </span><span id="local-6989586621688023692"><span class="annot"><span class="annottext">toJSON :: RunSQL -&gt; Value
</span><a href="#local-6989586621688023692"><span class="hs-identifier hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688023694"><span id="local-6989586621688023695"><span id="local-6989586621688023696"><span id="local-6989586621688023697"><span id="local-6989586621688023698"><span class="annot"><span class="annottext">Bool
Maybe Bool
Text
TxAccess
SourceName
rSql :: RunSQL -&gt; Text
rSource :: RunSQL -&gt; SourceName
rCascade :: RunSQL -&gt; Bool
rCheckMetadataConsistency :: RunSQL -&gt; Maybe Bool
rTxAccessMode :: RunSQL -&gt; TxAccess
rSql :: Text
rSource :: SourceName
rCascade :: Bool
rCheckMetadataConsistency :: Maybe Bool
rTxAccessMode :: TxAccess
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rSql"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.Internal.html/Data.Aeson.Types.Internal.html#object"><span class="hs-identifier hs-var">object</span></a></span><span>
</span><span id="line-87"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;sql&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688023694"><span class="hs-identifier hs-var">rSql</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; SourceName -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688023695"><span class="hs-identifier hs-var">rSource</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-89"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;cascade&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Bool -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688023696"><span class="hs-identifier hs-var">rCascade</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-90"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;check_metadata_consistency&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Maybe Bool -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621688023697"><span class="hs-identifier hs-var">rCheckMetadataConsistency</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;read_only&quot;</span></span><span>
</span><span id="line-92"></span><span>          </span><span class="annot"><span class="annottext">Key -&gt; Bool -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688023698"><span class="hs-identifier hs-var">rTxAccessMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-93"></span><span>            </span><span class="annot"><span class="annottext">TxAccess
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadOnly"><span class="hs-identifier hs-var">PG.ReadOnly</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-94"></span><span>            </span><span class="annot"><span class="annottext">TxAccess
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadWrite"><span class="hs-identifier hs-var">PG.ReadWrite</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">-- | Check for known schema-mutating keywords in the raw SQL text.</span><span>
</span><span id="line-98"></span><span class="hs-comment">--</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- See Note [Checking metadata consistency in run_sql].</span><span>
</span><span id="line-100"></span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isSchemaCacheBuildRequiredRunSQL"><span class="hs-identifier hs-type">isSchemaCacheBuildRequiredRunSQL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-101"></span><span id="isSchemaCacheBuildRequiredRunSQL"><span class="annot"><span class="annottext">isSchemaCacheBuildRequiredRunSQL :: RunSQL -&gt; Bool
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isSchemaCacheBuildRequiredRunSQL"><span class="hs-identifier hs-var hs-var">isSchemaCacheBuildRequiredRunSQL</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688023701"><span id="local-6989586621688023702"><span id="local-6989586621688023703"><span id="local-6989586621688023704"><span id="local-6989586621688023705"><span class="annot"><span class="annottext">Bool
Maybe Bool
Text
TxAccess
SourceName
rSql :: RunSQL -&gt; Text
rSource :: RunSQL -&gt; SourceName
rCascade :: RunSQL -&gt; Bool
rCheckMetadataConsistency :: RunSQL -&gt; Maybe Bool
rTxAccessMode :: RunSQL -&gt; TxAccess
rSql :: Text
rSource :: SourceName
rCascade :: Bool
rCheckMetadataConsistency :: Maybe Bool
rTxAccessMode :: TxAccess
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rSql"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688023705"><span class="hs-identifier hs-var">rTxAccessMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">TxAccess
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadOnly"><span class="hs-identifier hs-var">PG.ReadOnly</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">TxAccess
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadWrite"><span class="hs-identifier hs-var">PG.ReadWrite</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool -&gt; Bool
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><a href="#local-6989586621688023707"><span class="hs-identifier hs-var">containsDDLKeyword</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688023701"><span class="hs-identifier hs-var">rSql</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621688023704"><span class="hs-identifier hs-var">rCheckMetadataConsistency</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621688023707"><span class="annot"><span class="annottext">containsDDLKeyword :: Text -&gt; Bool
</span><a href="#local-6989586621688023707"><span class="hs-identifier hs-var hs-var">containsDDLKeyword</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-107"></span><span>      </span><span class="annot"><span class="annottext">Regex -&gt; Text -&gt; Bool
forall regex source target.
RegexContext regex source target =&gt;
regex -&gt; source -&gt; target
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/regex-base-0.94.0.2-ea90ea971e6557d4cceea1a20a86310f31f4a85cf5a5c2eb5fdf73639aeb0031/share/doc/html/src/Text.Regex.Base.RegexLike.html/Text.Regex.Base.RegexLike.html#match"><span class="hs-identifier hs-var">TDFA.match</span></a></span><span>
</span><span id="line-108"></span><span>        </span><span class="hs-special">$$</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.Utils.html#quoteRegex"><span class="hs-identifier hs-type">quoteRegex</span></a></span><span>
</span><span id="line-109"></span><span>              </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/regex-base-0.94.0.2-ea90ea971e6557d4cceea1a20a86310f31f4a85cf5a5c2eb5fdf73639aeb0031/share/doc/html/src/Text.Regex.Base.RegexLike.html/Text.Regex.Base.RegexLike.html#defaultCompOpt"><span class="hs-identifier hs-type">TDFA.defaultCompOpt</span></a></span><span>
</span><span id="line-110"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/regex-tdfa-1.3.2.2-bba2e0707f49b8913e3525fd5acd95f61def8d2816d6a9c12a8ee453c6dd890d/share/doc/html/src/Text.Regex.TDFA.Common.html/Text.Regex.TDFA.Common.html#caseSensitive"><span class="hs-identifier hs-var">TDFA.caseSensitive</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-special">,</span><span>
</span><span id="line-111"></span><span>                  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/regex-tdfa-1.3.2.2-bba2e0707f49b8913e3525fd5acd95f61def8d2816d6a9c12a8ee453c6dd890d/share/doc/html/src/Text.Regex.TDFA.Common.html/Text.Regex.TDFA.Common.html#multiline"><span class="hs-identifier hs-var">TDFA.multiline</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>                  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/regex-tdfa-1.3.2.2-bba2e0707f49b8913e3525fd5acd95f61def8d2816d6a9c12a8ee453c6dd890d/share/doc/html/src/Text.Regex.TDFA.Common.html/Text.Regex.TDFA.Common.html#lastStarGreedy"><span class="hs-identifier hs-var">TDFA.lastStarGreedy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span>
</span><span id="line-113"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-114"></span><span>              </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/regex-base-0.94.0.2-ea90ea971e6557d4cceea1a20a86310f31f4a85cf5a5c2eb5fdf73639aeb0031/share/doc/html/src/Text.Regex.Base.RegexLike.html/Text.Regex.Base.RegexLike.html#defaultExecOpt"><span class="hs-identifier hs-type">TDFA.defaultExecOpt</span></a></span><span>
</span><span id="line-115"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/regex-tdfa-1.3.2.2-bba2e0707f49b8913e3525fd5acd95f61def8d2816d6a9c12a8ee453c6dd890d/share/doc/html/src/Text.Regex.TDFA.Common.html/Text.Regex.TDFA.Common.html#captureGroups"><span class="hs-identifier hs-var">TDFA.captureGroups</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-116"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-117"></span><span>              </span><span class="annot"><span class="hs-string">&quot;\\balter\\b|\\bdrop\\b|\\breplace\\b|\\bcreate function\\b|\\bcomment on\\b&quot;</span></span><span>
</span><span id="line-118"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isReadOnly"><span class="hs-identifier hs-type">isReadOnly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-121"></span><span id="isReadOnly"><span class="annot"><span class="annottext">isReadOnly :: RunSQL -&gt; Bool
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isReadOnly"><span class="hs-identifier hs-var hs-var">isReadOnly</span></a></span></span><span> </span><span id="local-6989586621688023723"><span class="annot"><span class="annottext">RunSQL
</span><a href="#local-6989586621688023723"><span class="hs-identifier hs-var">runsql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RunSQL -&gt; TxAccess
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rTxAccessMode"><span class="hs-identifier hs-var">rTxAccessMode</span></a></span><span> </span><span class="annot"><span class="annottext">RunSQL
</span><a href="#local-6989586621688023723"><span class="hs-identifier hs-var">runsql</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">TxAccess
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadOnly"><span class="hs-identifier hs-var">PG.ReadOnly</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="annottext">TxAccess
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadWrite"><span class="hs-identifier hs-var">PG.ReadWrite</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">{- Note [Checking metadata consistency in run_sql]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SQL queries executed by run_sql may change the Postgres schema in arbitrary
ways. We attempt to automatically update the metadata to reflect those changes
as much as possible---for example, if a table is renamed, we want to update the
metadata to track the table under its new name instead of its old one. This
schema diffing (plus some integrity checking) is handled by withMetadataCheck.

But this process has overhead---it involves reloading the metadata, diffing it,
and rebuilding the schema cache---so we don&#8217;t want to do it if it isn&#8217;t
necessary. The user can explicitly disable the check via the
check_metadata_consistency option, and we also skip it if the current
transaction is in READ ONLY mode, since the schema can&#8217;t be modified in that
case, anyway.

However, even if neither read_only or check_metadata_consistency is passed, lots
of queries may not modify the schema at all. As a (fairly stupid) heuristic, we
check if the query contains any keywords for DDL operations, and if not, we skip
the metadata check as well. -}</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">-- | Fetch metadata of tracked tables/functions and build @'Diff.TableMeta'/@'Diff.FunctionMeta'</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- to calculate diff later in @'withMetadataCheck'.</span><span>
</span><span id="line-148"></span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchTablesFunctionsMetadata"><span class="hs-identifier hs-type">fetchTablesFunctionsMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688023181"><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span></span><span> </span><span id="local-6989586621688023187"><span class="annot"><a href="#local-6989586621688023187"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#ToMetadataFetchQuery"><span class="hs-identifier hs-type">ToMetadataFetchQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchTableMetadata"><span class="hs-identifier hs-type">FetchTableMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchFunctionMetadata"><span class="hs-identifier hs-type">FetchFunctionMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-153"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-154"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#MonadTx"><span class="hs-identifier hs-type">MonadTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023187"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><a href="Hasura.Table.Cache.html#TableCache"><span class="hs-identifier hs-type">TableCache</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HS.HashSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HS.HashSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#FunctionName"><span class="hs-identifier hs-type">FunctionName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><a href="#local-6989586621688023187"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#TableMeta"><span class="hs-identifier hs-type">Diff.TableMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#FunctionMeta"><span class="hs-identifier hs-type">Diff.FunctionMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span id="fetchTablesFunctionsMetadata"><span class="annot"><span class="annottext">fetchTablesFunctionsMetadata :: forall (pgKind :: PostgresKind) (m :: * -&gt; *).
(ToMetadataFetchQuery pgKind, FetchTableMetadata pgKind,
 FetchFunctionMetadata pgKind, BackendMetadata ('Postgres pgKind),
 MonadTx m) =&gt;
TableCache ('Postgres pgKind)
-&gt; HashSet (TableName ('Postgres pgKind))
-&gt; HashSet (FunctionName ('Postgres pgKind))
-&gt; m ([TableMeta ('Postgres pgKind)],
      [FunctionMeta ('Postgres pgKind)])
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchTablesFunctionsMetadata"><span class="hs-identifier hs-var hs-var">fetchTablesFunctionsMetadata</span></a></span></span><span> </span><span id="local-6989586621688023769"><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
</span><a href="#local-6989586621688023769"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span> </span><span id="local-6989586621688023770"><span class="annot"><span class="annottext">HashSet (TableName ('Postgres pgKind))
</span><a href="#local-6989586621688023770"><span class="hs-identifier hs-var">tables</span></a></span></span><span> </span><span id="local-6989586621688023771"><span class="annot"><span class="annottext">HashSet (FunctionName ('Postgres pgKind))
</span><a href="#local-6989586621688023771"><span class="hs-identifier hs-var">functions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-161"></span><span>  </span><span id="local-6989586621688023772"><span class="annot"><a href="#local-6989586621688023772"><span class="hs-identifier hs-var">tableMetaInfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashSet QualifiedTable -&gt; m (DBTablesMetadata ('Postgres pgKind))
forall (pgKind :: PostgresKind) (m :: * -&gt; *).
(FetchTableMetadata pgKind, Backend ('Postgres pgKind),
 ToMetadataFetchQuery pgKind, MonadTx m) =&gt;
HashSet QualifiedTable -&gt; m (DBTablesMetadata ('Postgres pgKind))
forall (m :: * -&gt; *).
(Backend ('Postgres pgKind), ToMetadataFetchQuery pgKind,
 MonadTx m) =&gt;
HashSet QualifiedTable -&gt; m (DBTablesMetadata ('Postgres pgKind))
</span><a href="Hasura.Backends.Postgres.DDL.Source.html#fetchTableMetadata"><span class="hs-identifier hs-var">fetchTableMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (TableName ('Postgres pgKind))
HashSet QualifiedTable
</span><a href="#local-6989586621688023770"><span class="hs-identifier hs-var">tables</span></a></span><span>
</span><span id="line-162"></span><span>  </span><span id="local-6989586621688023773"><span class="annot"><a href="#local-6989586621688023773"><span class="hs-identifier hs-var">functionMetaInfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#fetchFunctionMetadata"><span class="hs-identifier hs-type">fetchFunctionMetadata</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023771"><span class="hs-identifier hs-type">functions</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688023774"><span class="annot"><a href="#local-6989586621688023774"><span class="hs-identifier hs-var hs-var">functionMetas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">FunctionMeta ('Postgres pgKind)
</span><a href="#local-6989586621688023775"><span class="hs-identifier hs-var">functionMeta</span></a></span><span>
</span><span id="line-166"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621688023776"><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688023776"><span class="hs-identifier hs-var">function</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashSet QualifiedFunction -&gt; [QualifiedFunction]
forall a. HashSet a -&gt; [a]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#toList"><span class="hs-identifier hs-var">HS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (FunctionName ('Postgres pgKind))
HashSet QualifiedFunction
</span><a href="#local-6989586621688023771"><span class="hs-identifier hs-var">functions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-167"></span><span>            </span><span id="local-6989586621688023775"><span class="annot"><span class="annottext">FunctionMeta ('Postgres pgKind)
</span><a href="#local-6989586621688023775"><span class="hs-identifier hs-var">functionMeta</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedFunction (FunctionOverloads ('Postgres pgKind))
-&gt; QualifiedFunction -&gt; [FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688023778"><span class="hs-identifier hs-var">mkFunctionMetas</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedFunction (FunctionOverloads ('Postgres pgKind))
</span><a href="#local-6989586621688023773"><span class="hs-identifier hs-var">functionMetaInfos</span></a></span><span> </span><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688023776"><span class="hs-identifier hs-var">function</span></a></span><span>
</span><span id="line-168"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688023779"><span class="annot"><a href="#local-6989586621688023779"><span class="hs-identifier hs-var hs-var">tableMetas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-170"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TableName ('Postgres pgKind)
-&gt; DBTableMetadata ('Postgres pgKind)
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
-&gt; TableMeta ('Postgres pgKind)
forall (b :: BackendType).
TableName b
-&gt; DBTableMetadata b -&gt; [ComputedFieldMeta b] -&gt; TableMeta b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#TableMeta"><span class="hs-identifier hs-var">Diff.TableMeta</span></a></span><span> </span><span class="annot"><span class="annottext">TableName ('Postgres pgKind)
QualifiedTable
</span><a href="#local-6989586621688023780"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">DBTableMetadata ('Postgres pgKind)
</span><a href="#local-6989586621688023781"><span class="hs-identifier hs-var">tableMetaInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[ComputedFieldMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688023782"><span class="hs-identifier hs-var">computedFieldInfos</span></a></span><span>
</span><span id="line-171"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688023780"><span class="annot"><span class="annottext">QualifiedTable
</span><a href="#local-6989586621688023780"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688023781"><span class="annot"><span class="annottext">DBTableMetadata ('Postgres pgKind)
</span><a href="#local-6989586621688023781"><span class="hs-identifier hs-var">tableMetaInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (DBTableMetadata ('Postgres pgKind))
-&gt; [(QualifiedTable, DBTableMetadata ('Postgres pgKind))]
forall k v. HashMap k v -&gt; [(k, v)]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#toList"><span class="hs-identifier hs-var">HashMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (DBTableMetadata ('Postgres pgKind))
</span><a href="#local-6989586621688023772"><span class="hs-identifier hs-var">tableMetaInfos</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-172"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688023782"><span class="annot"><span class="annottext">computedFieldInfos :: [ComputedFieldMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688023782"><span class="hs-identifier hs-var hs-var">computedFieldInfos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-173"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ComputedFieldMeta ('Postgres pgKind)
</span><a href="#local-6989586621688023784"><span class="hs-identifier hs-var">computedFieldMeta</span></a></span><span>
</span><span id="line-174"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688023785"><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
</span><a href="#local-6989586621688023785"><span class="hs-identifier hs-var">tableInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TableInfo ('Postgres pgKind))
-&gt; [Maybe (TableInfo ('Postgres pgKind))]
forall a. a -&gt; [a]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualifiedTable
-&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; Maybe (TableInfo ('Postgres pgKind))
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">QualifiedTable
</span><a href="#local-6989586621688023780"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688023769"><span class="hs-identifier hs-var">tableCache</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-175"></span><span>                      </span><span id="local-6989586621688023787"><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
</span><a href="#local-6989586621688023787"><span class="hs-identifier hs-var">computedField</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
forall (pgKind :: PostgresKind).
TableInfo ('Postgres pgKind)
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#getComputedFields"><span class="hs-identifier hs-var">getComputedFields</span></a></span><span> </span><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
</span><a href="#local-6989586621688023785"><span class="hs-identifier hs-var">tableInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-176"></span><span>                      </span><span id="local-6989586621688023784"><span class="annot"><span class="annottext">ComputedFieldMeta ('Postgres pgKind)
</span><a href="#local-6989586621688023784"><span class="hs-identifier hs-var">computedFieldMeta</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-177"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ComputedFieldName
-&gt; FunctionMeta ('Postgres pgKind)
-&gt; ComputedFieldMeta ('Postgres pgKind)
forall (b :: BackendType).
ComputedFieldName -&gt; FunctionMeta b -&gt; ComputedFieldMeta b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#ComputedFieldMeta"><span class="hs-identifier hs-var">Diff.ComputedFieldMeta</span></a></span><span> </span><span class="annot"><span class="annottext">ComputedFieldName
</span><a href="#local-6989586621688023790"><span class="hs-identifier hs-var">fieldName</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionMeta ('Postgres pgKind)
</span><a href="#local-6989586621688023791"><span class="hs-identifier hs-var">functionMeta</span></a></span><span>
</span><span id="line-178"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688023790"><span class="annot"><span class="annottext">fieldName :: ComputedFieldName
</span><a href="#local-6989586621688023790"><span class="hs-identifier hs-var hs-var">fieldName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind) -&gt; ComputedFieldName
forall (b :: BackendType). ComputedFieldInfo b -&gt; ComputedFieldName
</span><a href="Hasura.RQL.Types.ComputedField.html#_cfiName"><span class="hs-identifier hs-var">_cfiName</span></a></span><span> </span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
</span><a href="#local-6989586621688023787"><span class="hs-identifier hs-var">computedField</span></a></span><span>
</span><span id="line-179"></span><span>                                </span><span id="local-6989586621688023793"><span class="annot"><span class="annottext">function :: FunctionName ('Postgres pgKind)
</span><a href="#local-6989586621688023793"><span class="hs-identifier hs-var hs-var">function</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ComputedFieldFunction ('Postgres pgKind)
-&gt; FunctionName ('Postgres pgKind)
forall (b :: BackendType).
ComputedFieldFunction b -&gt; FunctionName b
</span><a href="Hasura.RQL.Types.ComputedField.html#_cffName"><span class="hs-identifier hs-var">_cffName</span></a></span><span> </span><span class="annot"><span class="annottext">(ComputedFieldFunction ('Postgres pgKind)
 -&gt; FunctionName ('Postgres pgKind))
-&gt; ComputedFieldFunction ('Postgres pgKind)
-&gt; FunctionName ('Postgres pgKind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
-&gt; ComputedFieldFunction ('Postgres pgKind)
forall (b :: BackendType).
ComputedFieldInfo b -&gt; ComputedFieldFunction b
</span><a href="Hasura.RQL.Types.ComputedField.html#_cfiFunction"><span class="hs-identifier hs-var">_cfiFunction</span></a></span><span> </span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
</span><a href="#local-6989586621688023787"><span class="hs-identifier hs-var">computedField</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-180"></span><span>                            </span><span id="local-6989586621688023791"><span class="annot"><span class="annottext">FunctionMeta ('Postgres pgKind)
</span><a href="#local-6989586621688023791"><span class="hs-identifier hs-var">functionMeta</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedFunction (FunctionOverloads ('Postgres pgKind))
-&gt; QualifiedFunction -&gt; [FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688023778"><span class="hs-identifier hs-var">mkFunctionMetas</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedFunction (FunctionOverloads ('Postgres pgKind))
</span><a href="#local-6989586621688023773"><span class="hs-identifier hs-var">functionMetaInfos</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName ('Postgres pgKind)
QualifiedFunction
</span><a href="#local-6989586621688023793"><span class="hs-identifier hs-var">function</span></a></span><span>
</span><span id="line-181"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-182"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688023779"><span class="hs-identifier hs-type">tableMetas</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688023774"><span class="hs-identifier hs-type">functionMetas</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><a href="#local-6989586621688023778"><span class="hs-identifier hs-type">mkFunctionMetas</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#HashMap"><span class="hs-identifier hs-type">HashMap</span></a></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#QualifiedFunction"><span class="hs-identifier hs-type">QualifiedFunction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Function.Cache.html#FunctionOverloads"><span class="hs-identifier hs-type">FunctionOverloads</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>      </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#QualifiedFunction"><span class="hs-identifier hs-type">QualifiedFunction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#FunctionMeta"><span class="hs-identifier hs-type">Diff.FunctionMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023181"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621688023778"><span class="annot"><span class="annottext">mkFunctionMetas :: HashMap QualifiedFunction (FunctionOverloads ('Postgres pgKind))
-&gt; QualifiedFunction -&gt; [FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688023778"><span class="hs-identifier hs-var hs-var">mkFunctionMetas</span></a></span></span><span> </span><span id="local-6989586621688023796"><span class="annot"><span class="annottext">HashMap QualifiedFunction (FunctionOverloads ('Postgres pgKind))
</span><a href="#local-6989586621688023796"><span class="hs-identifier hs-var">functionMetaInfos</span></a></span></span><span> </span><span id="local-6989586621688023797"><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688023797"><span class="hs-identifier hs-var">function</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">OID
-&gt; FunctionName ('Postgres pgKind)
-&gt; FunctionVolatility
-&gt; FunctionMeta ('Postgres pgKind)
forall (b :: BackendType).
OID -&gt; FunctionName b -&gt; FunctionVolatility -&gt; FunctionMeta b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#FunctionMeta"><span class="hs-identifier hs-var">Diff.FunctionMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGRawFunctionInfo -&gt; OID
</span><a href="Hasura.Backends.Postgres.SQL.Types.html#rfiOid"><span class="hs-identifier hs-var">rfiOid</span></a></span><span> </span><span class="annot"><span class="annottext">PGRawFunctionInfo
</span><a href="#local-6989586621688023799"><span class="hs-identifier hs-var">rawInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FunctionName ('Postgres pgKind)
QualifiedFunction
</span><a href="#local-6989586621688023797"><span class="hs-identifier hs-var">function</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGRawFunctionInfo -&gt; FunctionVolatility
</span><a href="Hasura.Backends.Postgres.SQL.Types.html#rfiFunctionType"><span class="hs-identifier hs-var">rfiFunctionType</span></a></span><span> </span><span class="annot"><span class="annottext">PGRawFunctionInfo
</span><a href="#local-6989586621688023799"><span class="hs-identifier hs-var">rawInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- It would seem like we could feasibly detect function overloads here already,</span><span>
</span><span id="line-194"></span><span>          </span><span class="hs-comment">-- But that is handled elsewhere.</span><span>
</span><span id="line-195"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688023801"><span class="annot"><span class="annottext">FunctionOverloads ('Postgres pgKind)
</span><a href="#local-6989586621688023801"><span class="hs-identifier hs-var">overloads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (FunctionOverloads ('Postgres pgKind))
-&gt; [Maybe (FunctionOverloads ('Postgres pgKind))]
forall a. a -&gt; [a]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualifiedFunction
-&gt; HashMap QualifiedFunction (FunctionOverloads ('Postgres pgKind))
-&gt; Maybe (FunctionOverloads ('Postgres pgKind))
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688023797"><span class="hs-identifier hs-var">function</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedFunction (FunctionOverloads ('Postgres pgKind))
</span><a href="#local-6989586621688023796"><span class="hs-identifier hs-var">functionMetaInfos</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-196"></span><span>          </span><span id="local-6989586621688023799"><span class="annot"><span class="annottext">PGRawFunctionInfo
</span><a href="#local-6989586621688023799"><span class="hs-identifier hs-var">rawInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NonEmpty PGRawFunctionInfo -&gt; [PGRawFunctionInfo]
forall a. NonEmpty a -&gt; [a]
</span><span class="hs-identifier hs-var">NE.toList</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty PGRawFunctionInfo -&gt; [PGRawFunctionInfo])
-&gt; NonEmpty PGRawFunctionInfo -&gt; [PGRawFunctionInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunctionOverloads ('Postgres pgKind)
-&gt; NonEmpty (RawFunctionInfo ('Postgres pgKind))
forall (b :: BackendType).
FunctionOverloads b -&gt; NonEmpty (RawFunctionInfo b)
</span><a href="Hasura.Function.Cache.html#getFunctionOverloads"><span class="hs-identifier hs-var">getFunctionOverloads</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionOverloads ('Postgres pgKind)
</span><a href="#local-6989586621688023801"><span class="hs-identifier hs-var">overloads</span></a></span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="annot"><span class="hs-comment">-- | Used as an escape hatch to run raw SQL against a database.</span></span><span>
</span><span id="line-200"></span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#runRunSQL"><span class="hs-identifier hs-type">runRunSQL</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688023245"><span class="annot"><a href="#local-6989586621688023245"><span class="hs-identifier hs-type">pgKind</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#PostgresKind"><span class="hs-identifier hs-type">PostgresKind</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688023246"><span class="annot"><a href="#local-6989586621688023246"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023245"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#ToMetadataFetchQuery"><span class="hs-identifier hs-type">ToMetadataFetchQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023245"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchTableMetadata"><span class="hs-identifier hs-type">FetchTableMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023245"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchFunctionMetadata"><span class="hs-identifier hs-type">FetchFunctionMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023245"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023246"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023246"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688023246"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023246"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688023246"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.Class.html#MonadTrace"><span class="hs-identifier hs-type">Tracing.MonadTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023246"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><a href="Hasura.Authentication.User.html#UserInfoM"><span class="hs-identifier hs-type">UserInfoM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023246"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SQLGenCtx"><span class="hs-identifier hs-type">SQLGenCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="#local-6989586621688023246"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-json-encoding-1.0.0/opt/doc/html/hasura-json-encoding/src/Hasura.EncJSON.html/Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span><span>
</span><span id="line-217"></span><span id="runRunSQL"><span class="annot"><span class="annottext">runRunSQL :: forall (pgKind :: PostgresKind) (m :: * -&gt; *).
(BackendMetadata ('Postgres pgKind), ToMetadataFetchQuery pgKind,
 FetchTableMetadata pgKind, FetchFunctionMetadata pgKind,
 CacheRWM m, MetadataM m, MonadBaseControl IO m, MonadError QErr m,
 MonadIO m, MonadTrace m, UserInfoM m) =&gt;
SQLGenCtx -&gt; RunSQL -&gt; m EncJSON
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#runRunSQL"><span class="hs-identifier hs-var hs-var">runRunSQL</span></a></span></span><span> </span><span id="local-6989586621688023850"><span class="annot"><span class="annottext">SQLGenCtx
</span><a href="#local-6989586621688023850"><span class="hs-identifier hs-var">sqlGen</span></a></span></span><span> </span><span id="local-6989586621688023851"><span class="annot"><span class="annottext">q :: RunSQL
</span><a href="#local-6989586621688023851"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688023852"><span id="local-6989586621688023853"><span id="local-6989586621688023854"><span id="local-6989586621688023855"><span id="local-6989586621688023856"><span class="annot"><span class="annottext">Bool
Maybe Bool
Text
TxAccess
SourceName
rSql :: RunSQL -&gt; Text
rSource :: RunSQL -&gt; SourceName
rCascade :: RunSQL -&gt; Bool
rCheckMetadataConsistency :: RunSQL -&gt; Maybe Bool
rTxAccessMode :: RunSQL -&gt; TxAccess
rSql :: Text
rSource :: SourceName
rCascade :: Bool
rCheckMetadataConsistency :: Maybe Bool
rTxAccessMode :: TxAccess
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rSql"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-218"></span><span>  </span><span id="local-6989586621688023857"><span class="annot"><a href="#local-6989586621688023857"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(CacheRM m, MonadError QErr m, Backend b, MetadataM m) =&gt;
SourceName -&gt; m (SourceConfig b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSourceConfig"><span class="hs-identifier hs-var">askSourceConfig</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023245"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688023853"><span class="hs-identifier hs-var">rSource</span></a></span><span>
</span><span id="line-219"></span><span>  </span><span id="local-6989586621688023859"><span class="annot"><a href="#local-6989586621688023859"><span class="hs-identifier hs-var">traceCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.Tracing.Class.html#currentContext"><span class="hs-identifier hs-type">Tracing.currentContext</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span id="local-6989586621688023861"><span class="annot"><a href="#local-6989586621688023861"><span class="hs-identifier hs-var">userInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.Authentication.User.html#askUserInfo"><span class="hs-identifier hs-type">askUserInfo</span></a></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688023863"><span class="annot"><a href="#local-6989586621688023863"><span class="hs-identifier hs-var hs-var">pgExecCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PGSourceConfig -&gt; PGExecCtx
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#_pscExecCtx"><span class="hs-identifier hs-var">_pscExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">PGSourceConfig
</span><a href="#local-6989586621688023857"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isSchemaCacheBuildRequiredRunSQL"><span class="hs-identifier hs-type">isSchemaCacheBuildRequiredRunSQL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023851"><span class="hs-identifier hs-type">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>      </span><span class="hs-comment">-- see Note [Checking metadata consistency in run_sql]</span><span>
</span><span id="line-225"></span><span>      </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#withMetadataCheck"><span class="hs-identifier hs-type">withMetadataCheck</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688023245"><span class="hs-identifier hs-type">pgKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023850"><span class="hs-identifier hs-type">sqlGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023853"><span class="hs-identifier hs-type">rSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023854"><span class="hs-identifier hs-type">rCascade</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023856"><span class="hs-identifier hs-type">rTxAccessMode</span></a></span><span>
</span><span id="line-226"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#withTraceContext"><span class="hs-identifier hs-type">withTraceContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023859"><span class="hs-identifier hs-type">traceCtx</span></a></span><span>
</span><span id="line-227"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#withUserInfo"><span class="hs-identifier hs-type">withUserInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023861"><span class="hs-identifier hs-type">userInfo</span></a></span><span>
</span><span id="line-228"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621688023867"><span class="hs-identifier hs-type">execRawSQL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023852"><span class="hs-identifier hs-type">rSql</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>      </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#runTxWithCtx"><span class="hs-identifier hs-type">runTxWithCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023863"><span class="hs-identifier hs-type">pgExecCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.Execute.Types.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023856"><span class="hs-identifier hs-type">rTxAccessMode</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Execute.Types.html#RunSQLQuery"><span class="hs-identifier hs-type">RunSQLQuery</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621688023867"><span class="hs-identifier hs-type">execRawSQL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023852"><span class="hs-identifier hs-type">rSql</span></a></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-232"></span><span>    </span><span id="local-6989586621688023280"><span class="annot"><a href="#local-6989586621688023867"><span class="hs-identifier hs-type">execRawSQL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#MonadTx"><span class="hs-identifier hs-type">MonadTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023280"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688023280"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-json-encoding-1.0.0/opt/doc/html/hasura-json-encoding/src/Hasura.EncJSON.html/Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621688023867"><span class="annot"><span class="annottext">execRawSQL :: forall (n :: * -&gt; *). MonadTx n =&gt; Text -&gt; n EncJSON
</span><a href="#local-6989586621688023867"><span class="hs-identifier hs-var hs-var">execRawSQL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-234"></span><span>      </span><span class="annot"><span class="annottext">(RunSQLRes -&gt; EncJSON) -&gt; n RunSQLRes -&gt; n EncJSON
forall a b. (a -&gt; b) -&gt; n a -&gt; n b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-json-encoding-1.0.0/opt/doc/html/hasura-json-encoding/src/Hasura.EncJSON.html/Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.html#RunSQLRes"><span class="hs-identifier hs-type">RunSQLRes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(n RunSQLRes -&gt; n EncJSON)
-&gt; (Text -&gt; n RunSQLRes) -&gt; Text -&gt; n EncJSON
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TxE QErr RunSQLRes -&gt; n RunSQLRes
forall a. TxE QErr a -&gt; n a
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#liftTx"><span class="hs-identifier hs-var">liftTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr RunSQLRes -&gt; n RunSQLRes)
-&gt; (Text -&gt; TxE QErr RunSQLRes) -&gt; Text -&gt; n RunSQLRes
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr) -&gt; Query -&gt; TxE QErr RunSQLRes
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRes a) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#multiQE"><span class="hs-identifier hs-var">PG.multiQE</span></a></span><span> </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
forall {a}. ToJSON a =&gt; a -&gt; QErr
</span><a href="#local-6989586621688023891"><span class="hs-identifier hs-var">rawSqlErrHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxE QErr RunSQLRes)
-&gt; (Text -&gt; Query) -&gt; Text -&gt; TxE QErr RunSQLRes
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#fromText"><span class="hs-identifier hs-var">PG.fromText</span></a></span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-236"></span><span>        </span><span id="local-6989586621688023891"><span class="annot"><span class="annottext">rawSqlErrHandler :: a -&gt; QErr
</span><a href="#local-6989586621688023891"><span class="hs-identifier hs-var hs-var">rawSqlErrHandler</span></a></span></span><span> </span><span id="local-6989586621688023897"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688023897"><span class="hs-identifier hs-var">txe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-237"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#err400"><span class="hs-identifier hs-var">err400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#PostgresError"><span class="hs-identifier hs-var">PostgresError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;query execution failed&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#qeInternal"><span class="hs-identifier hs-var">qeInternal</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#ExtraInternal"><span class="hs-identifier hs-type">ExtraInternal</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-type">toJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023897"><span class="hs-identifier hs-type">txe</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | @'withMetadataCheck' source cascade txAccess runSQLQuery@ executes @runSQLQuery@ and checks if the schema changed as a</span><span>
</span><span id="line-240"></span><span class="hs-comment">-- result. If it did, it checks to ensure the changes do not violate any integrity constraints, and</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- if not, incorporates them into the schema cache.</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- TODO(antoine): shouldn't this be generalized?</span><span>
</span><span id="line-243"></span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#withMetadataCheck"><span class="hs-identifier hs-type">withMetadataCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688023273"><span class="annot"><a href="#local-6989586621688023273"><span class="hs-identifier hs-type">pgKind</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#PostgresKind"><span class="hs-identifier hs-type">PostgresKind</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688023275"><span class="annot"><a href="#local-6989586621688023275"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621688023274"><span class="annot"><a href="#local-6989586621688023274"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023273"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#ToMetadataFetchQuery"><span class="hs-identifier hs-type">ToMetadataFetchQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023273"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchTableMetadata"><span class="hs-identifier hs-type">FetchTableMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023273"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchFunctionMetadata"><span class="hs-identifier hs-type">FetchFunctionMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023273"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023274"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023274"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-251"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688023274"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-252"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023274"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688023274"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SQLGenCtx"><span class="hs-identifier hs-type">SQLGenCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxAccess"><span class="hs-identifier hs-type">PG.TxAccess</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxET"><span class="hs-identifier hs-type">PG.TxET</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023274"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023275"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><a href="#local-6989586621688023274"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023275"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-261"></span><span id="withMetadataCheck"><span class="annot"><span class="annottext">withMetadataCheck :: forall (pgKind :: PostgresKind) a (m :: * -&gt; *).
(BackendMetadata ('Postgres pgKind), ToMetadataFetchQuery pgKind,
 FetchTableMetadata pgKind, FetchFunctionMetadata pgKind,
 CacheRWM m, MetadataM m, MonadBaseControl IO m, MonadError QErr m,
 MonadIO m) =&gt;
SQLGenCtx -&gt; SourceName -&gt; Bool -&gt; TxAccess -&gt; TxET QErr m a -&gt; m a
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#withMetadataCheck"><span class="hs-identifier hs-var hs-var">withMetadataCheck</span></a></span></span><span> </span><span id="local-6989586621688023967"><span class="annot"><span class="annottext">SQLGenCtx
</span><a href="#local-6989586621688023967"><span class="hs-identifier hs-var">sqlGen</span></a></span></span><span> </span><span id="local-6989586621688023968"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688023968"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621688023969"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688023969"><span class="hs-identifier hs-var">cascade</span></a></span></span><span> </span><span id="local-6989586621688023970"><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688023970"><span class="hs-identifier hs-var">txAccess</span></a></span></span><span> </span><span id="local-6989586621688023971"><span class="annot"><span class="annottext">TxET QErr m a
</span><a href="#local-6989586621688023971"><span class="hs-identifier hs-var">runSQLQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688023973"><span id="local-6989586621688023974"><span id="local-6989586621688023975"><span id="local-6989586621688023976"><span id="local-6989586621688023977"><span id="local-6989586621688023978"><span id="local-6989586621688023979"><span id="local-6989586621688023980"><span id="local-6989586621688023981"><span id="local-6989586621688023982"><span id="local-6989586621688023983"><span class="annot"><a href="#local-6989586621688023973"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(CacheRM m, MetadataM m, MonadError QErr m, Backend b) =&gt;
SourceName -&gt; m (SourceInfo b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSourceInfo"><span class="hs-identifier hs-var">askSourceInfo</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023273"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688023968"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-comment">-- Run SQL query and metadata checker in a transaction</span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688023996"><span class="annot"><a href="#local-6989586621688023996"><span class="hs-identifier hs-var">queryResult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688023997"><span class="annot"><a href="#local-6989586621688023997"><span class="hs-identifier hs-var">metadataUpdater</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#runTxWithMetadataCheck"><span class="hs-identifier hs-type">runTxWithMetadataCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023968"><span class="hs-identifier hs-type">source</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023980"><span class="hs-identifier hs-type">_siConfiguration</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023970"><span class="hs-identifier hs-type">txAccess</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023975"><span class="hs-identifier hs-type">_siTables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023976"><span class="hs-identifier hs-type">_siFunctions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023969"><span class="hs-identifier hs-type">cascade</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023971"><span class="hs-identifier hs-type">runSQLQuery</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-comment">-- Build schema cache with updated metadata</span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#withNewInconsistentObjsCheck"><span class="hs-identifier hs-type">withNewInconsistentObjsCheck</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCacheWithInvalidations"><span class="hs-identifier hs-type">buildSchemaCacheWithInvalidations</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciSources"><span class="hs-identifier hs-var">ciSources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#singleton"><span class="hs-identifier hs-type">HS.singleton</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023968"><span class="hs-identifier hs-type">source</span></a></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="#local-6989586621688023997"><span class="hs-identifier hs-type">metadataUpdater</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>  </span><span id="local-6989586621688024003"><span class="annot"><a href="#local-6989586621688024003"><span class="hs-identifier hs-var">postRunSQLSchemaCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-type">askSchemaCache</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-comment">-- Recreate event triggers in hdb_catalog. Event triggers are dropped before executing @'runSQLQuery'.</span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><a href="#local-6989586621688024005"><span class="hs-identifier hs-type">recreateEventTriggers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023980"><span class="hs-identifier hs-type">_siConfiguration</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024003"><span class="hs-identifier hs-type">postRunSQLSchemaCache</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621688023996"><span class="hs-identifier hs-type">queryResult</span></a></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><a href="#local-6989586621688024005"><span class="hs-identifier hs-type">recreateEventTriggers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Execute.Types.html#PGSourceConfig"><span class="hs-identifier hs-type">PGSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688023274"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>    </span><span id="local-6989586621688024005"><span class="annot"><span class="annottext">recreateEventTriggers :: PGSourceConfig -&gt; SchemaCache -&gt; m ()
</span><a href="#local-6989586621688024005"><span class="hs-identifier hs-var hs-var">recreateEventTriggers</span></a></span></span><span> </span><span id="local-6989586621688024006"><span class="annot"><span class="annottext">PGSourceConfig
</span><a href="#local-6989586621688024006"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688024007"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688024007"><span class="hs-identifier hs-var">schemaCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-280"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688024008"><span class="annot"><span class="annottext">tables :: HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688024008"><span class="hs-identifier hs-var hs-var">tables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; Maybe (HashMap QualifiedTable (TableInfo ('Postgres pgKind)))
-&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind))
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (HashMap QualifiedTable (TableInfo ('Postgres pgKind)))
 -&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind)))
-&gt; Maybe (HashMap QualifiedTable (TableInfo ('Postgres pgKind)))
-&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; SourceCache -&gt; Maybe (TableCache b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#unsafeTableCache"><span class="hs-identifier hs-var">unsafeTableCache</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023273"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688023968"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceCache -&gt; Maybe (TableCache ('Postgres pgKind)))
-&gt; SourceCache -&gt; Maybe (TableCache ('Postgres pgKind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688024007"><span class="hs-identifier hs-var">schemaCache</span></a></span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PGSourceConfig
-&gt; PGExecFrom -&gt; TxET QErr m () -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
PGSourceConfig -&gt; PGExecFrom -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#runPgSourceWriteTx"><span class="hs-identifier hs-var">runPgSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">PGSourceConfig
</span><a href="#local-6989586621688024006"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">PGExecFrom
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#RunSQLQuery"><span class="hs-identifier hs-var">RunSQLQuery</span></a></span><span>
</span><span id="line-283"></span><span>        </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; m (Either QErr ()))
-&gt; TxET QErr m () -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TableInfo ('Postgres pgKind)]
-&gt; (TableInfo ('Postgres pgKind) -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; [TableInfo ('Postgres pgKind)]
forall k v. HashMap k v -&gt; [v]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#elems"><span class="hs-identifier hs-var">HashMap.elems</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688024008"><span class="hs-identifier hs-var">tables</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>        </span><span class="annot"><span class="annottext">((TableInfo ('Postgres pgKind) -&gt; TxET QErr m ())
 -&gt; TxET QErr m ())
-&gt; (TableInfo ('Postgres pgKind) -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Table.Cache.html#TableInfo"><span class="hs-identifier hs-type">TableInfo</span></a></span><span> </span><span id="local-6989586621688024016"><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
</span><a href="#local-6989586621688024016"><span class="hs-identifier hs-var">coreInfo</span></a></span></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap ('Postgres pgKind)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688024017"><span class="annot"><span class="annottext">EventTriggerInfoMap ('Postgres pgKind)
</span><a href="#local-6989586621688024017"><span class="hs-identifier hs-var">eventTriggers</span></a></span></span><span> </span><span class="annot"><span class="annottext">RolePermInfo ('Postgres pgKind)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-285"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688024018"><span class="annot"><span class="annottext">table :: TableName ('Postgres pgKind)
</span><a href="#local-6989586621688024018"><span class="hs-identifier hs-var hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind) -&gt; TableName ('Postgres pgKind)
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; TableName b
</span><a href="Hasura.Table.Cache.html#_tciName"><span class="hs-identifier hs-var">_tciName</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
</span><a href="#local-6989586621688024016"><span class="hs-identifier hs-var">coreInfo</span></a></span><span>
</span><span id="line-286"></span><span>              </span><span id="local-6989586621688024020"><span class="annot"><span class="annottext">columns :: [ColumnInfo ('Postgres pgKind)]
</span><a href="#local-6989586621688024020"><span class="hs-identifier hs-var hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StructuredColumnInfo ('Postgres pgKind)
 -&gt; ColumnInfo ('Postgres pgKind))
-&gt; [StructuredColumnInfo ('Postgres pgKind)]
-&gt; [ColumnInfo ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#SCIScalarColumn"><span class="hs-identifier hs-type">SCIScalarColumn</span></a></span><span> </span><span id="local-6989586621688024022"><span class="annot"><span class="annottext">ColumnInfo ('Postgres pgKind)
</span><a href="#local-6989586621688024022"><span class="hs-identifier hs-var">col</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ColumnInfo ('Postgres pgKind)
</span><a href="#local-6989586621688024022"><span class="hs-identifier hs-var">col</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([StructuredColumnInfo ('Postgres pgKind)]
 -&gt; [ColumnInfo ('Postgres pgKind)])
-&gt; [StructuredColumnInfo ('Postgres pgKind)]
-&gt; [ColumnInfo ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo ('Postgres pgKind))
-&gt; [StructuredColumnInfo ('Postgres pgKind)]
forall (backend :: BackendType).
FieldInfoMap (FieldInfo backend) -&gt; [StructuredColumnInfo backend]
</span><a href="Hasura.Table.Cache.html#getCols"><span class="hs-identifier hs-var">getCols</span></a></span><span> </span><span class="annot"><span class="annottext">(FieldInfoMap (FieldInfo ('Postgres pgKind))
 -&gt; [StructuredColumnInfo ('Postgres pgKind)])
-&gt; FieldInfoMap (FieldInfo ('Postgres pgKind))
-&gt; [StructuredColumnInfo ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
-&gt; FieldInfoMap (FieldInfo ('Postgres pgKind))
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; FieldInfoMap field
</span><a href="Hasura.Table.Cache.html#_tciFieldInfoMap"><span class="hs-identifier hs-var">_tciFieldInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
</span><a href="#local-6989586621688024016"><span class="hs-identifier hs-var">coreInfo</span></a></span><span>
</span><span id="line-287"></span><span>          </span><span class="annot"><span class="annottext">[(TriggerName, EventTriggerInfo ('Postgres pgKind))]
-&gt; ((TriggerName, EventTriggerInfo ('Postgres pgKind))
    -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfoMap ('Postgres pgKind)
-&gt; [(TriggerName, EventTriggerInfo ('Postgres pgKind))]
forall k v. HashMap k v -&gt; [(k, v)]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#toList"><span class="hs-identifier hs-var">HashMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfoMap ('Postgres pgKind)
</span><a href="#local-6989586621688024017"><span class="hs-identifier hs-var">eventTriggers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TriggerName, EventTriggerInfo ('Postgres pgKind))
  -&gt; TxET QErr m ())
 -&gt; TxET QErr m ())
-&gt; ((TriggerName, EventTriggerInfo ('Postgres pgKind))
    -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688024025"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688024025"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventTriggerInfo"><span class="hs-identifier hs-type">EventTriggerInfo</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688024027"><span class="annot"><span class="annottext">TriggerOpsDef ('Postgres pgKind)
etiOpsDef :: TriggerOpsDef ('Postgres pgKind)
etiOpsDef :: forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerOpsDef b
</span><a href="#local-6989586621688024027"><span class="hs-identifier hs-var hs-var">etiOpsDef</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688024029"><span class="annot"><span class="annottext">TriggerOnReplication
etiTriggerOnReplication :: TriggerOnReplication
etiTriggerOnReplication :: forall (b :: BackendType).
EventTriggerInfo b -&gt; TriggerOnReplication
</span><a href="#local-6989586621688024029"><span class="hs-identifier hs-var hs-var">etiTriggerOnReplication</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>            </span><span class="annot"><span class="annottext">(ReaderT SQLGenCtx (TxET QErr m) () -&gt; SQLGenCtx -&gt; TxET QErr m ())
-&gt; SQLGenCtx
-&gt; ReaderT SQLGenCtx (TxET QErr m) ()
-&gt; TxET QErr m ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT SQLGenCtx (TxET QErr m) () -&gt; SQLGenCtx -&gt; TxET QErr m ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">SQLGenCtx
</span><a href="#local-6989586621688023967"><span class="hs-identifier hs-var">sqlGen</span></a></span><span>
</span><span id="line-289"></span><span>              </span><span class="annot"><span class="annottext">(ReaderT SQLGenCtx (TxET QErr m) () -&gt; TxET QErr m ())
-&gt; ReaderT SQLGenCtx (TxET QErr m) () -&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; QualifiedTable
-&gt; TriggerOnReplication
-&gt; [ColumnInfo ('Postgres pgKind)]
-&gt; TriggerOpsDef ('Postgres pgKind)
-&gt; ReaderT SQLGenCtx (TxET QErr m) ()
forall (pgKind :: PostgresKind) (m :: * -&gt; *).
(Backend ('Postgres pgKind), MonadTx m, MonadReader SQLGenCtx m) =&gt;
TriggerName
-&gt; QualifiedTable
-&gt; TriggerOnReplication
-&gt; [ColumnInfo ('Postgres pgKind)]
-&gt; TriggerOpsDef ('Postgres pgKind)
-&gt; m ()
</span><a href="Hasura.Backends.Postgres.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-var">mkAllTriggersQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688024025"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName ('Postgres pgKind)
QualifiedTable
</span><a href="#local-6989586621688024018"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOnReplication
</span><a href="#local-6989586621688024029"><span class="hs-identifier hs-var">etiTriggerOnReplication</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo ('Postgres pgKind)]
</span><a href="#local-6989586621688024020"><span class="hs-identifier hs-var">columns</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef ('Postgres pgKind)
</span><a href="#local-6989586621688024027"><span class="hs-identifier hs-var">etiOpsDef</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- | @'runTxWithMetadataCheck source sourceConfig txAccess tableCache functionCache cascadeDependencies tx' checks for</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- changes in GraphQL Engine metadata when a @'tx' is executed on the database alters Postgres</span><span>
</span><span id="line-293"></span><span class="hs-comment">-- schema of tables and functions. If any indirect dependencies (Eg. remote table dependence of a relationship) are</span><span>
</span><span id="line-294"></span><span class="hs-comment">-- found and @'cascadeDependencies' is False, then an exception is raised.</span><span>
</span><span id="line-295"></span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#runTxWithMetadataCheck"><span class="hs-identifier hs-type">runTxWithMetadataCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688023344"><span class="annot"><a href="#local-6989586621688023344"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688023345"><span class="annot"><a href="#local-6989586621688023345"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688023343"><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#PostgresKind"><span class="hs-identifier hs-type">PostgresKind</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-298"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#ToMetadataFetchQuery"><span class="hs-identifier hs-type">ToMetadataFetchQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchTableMetadata"><span class="hs-identifier hs-type">FetchTableMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#FetchFunctionMetadata"><span class="hs-identifier hs-type">FetchFunctionMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023344"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688023344"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688023344"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-304"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023344"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-305"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxAccess"><span class="hs-identifier hs-type">PG.TxAccess</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><a href="Hasura.Table.Cache.html#TableCache"><span class="hs-identifier hs-type">TableCache</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><a href="Hasura.Function.Cache.html#FunctionCache"><span class="hs-identifier hs-type">FunctionCache</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxET"><span class="hs-identifier hs-type">PG.TxET</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023344"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023345"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-313"></span><span>  </span><span class="annot"><a href="#local-6989586621688023344"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688023345"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-type">MetadataModifier</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span id="runTxWithMetadataCheck"><span class="annot"><span class="annottext">runTxWithMetadataCheck :: forall (m :: * -&gt; *) a (pgKind :: PostgresKind).
(BackendMetadata ('Postgres pgKind), ToMetadataFetchQuery pgKind,
 FetchTableMetadata pgKind, FetchFunctionMetadata pgKind,
 CacheRWM m, MonadIO m, MonadBaseControl IO m, MonadError QErr m) =&gt;
SourceName
-&gt; SourceConfig ('Postgres pgKind)
-&gt; TxAccess
-&gt; TableCache ('Postgres pgKind)
-&gt; FunctionCache ('Postgres pgKind)
-&gt; Bool
-&gt; TxET QErr m a
-&gt; m (a, MetadataModifier)
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#runTxWithMetadataCheck"><span class="hs-identifier hs-var hs-var">runTxWithMetadataCheck</span></a></span></span><span> </span><span id="local-6989586621688024131"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688024131"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621688024132"><span class="annot"><span class="annottext">SourceConfig ('Postgres pgKind)
</span><a href="#local-6989586621688024132"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688024133"><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688024133"><span class="hs-identifier hs-var">txAccess</span></a></span></span><span> </span><span id="local-6989586621688024134"><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
</span><a href="#local-6989586621688024134"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span> </span><span id="local-6989586621688024135"><span class="annot"><span class="annottext">FunctionCache ('Postgres pgKind)
</span><a href="#local-6989586621688024135"><span class="hs-identifier hs-var">functionCache</span></a></span></span><span> </span><span id="local-6989586621688024136"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688024136"><span class="hs-identifier hs-var">cascadeDependencies</span></a></span></span><span> </span><span id="local-6989586621688024137"><span class="annot"><span class="annottext">TxET QErr m a
</span><a href="#local-6989586621688024137"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-315"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr (a, MetadataModifier)) -&gt; m (a, MetadataModifier)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><span class="annottext">(m (Either QErr (a, MetadataModifier)) -&gt; m (a, MetadataModifier))
-&gt; m (Either QErr (a, MetadataModifier)) -&gt; m (a, MetadataModifier)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExceptT QErr m (a, MetadataModifier)
-&gt; m (Either QErr (a, MetadataModifier))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span>
</span><span id="line-317"></span><span>    </span><span class="annot"><span class="annottext">(ExceptT QErr m (a, MetadataModifier)
 -&gt; m (Either QErr (a, MetadataModifier)))
-&gt; ExceptT QErr m (a, MetadataModifier)
-&gt; m (Either QErr (a, MetadataModifier))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PGExecCtx -&gt; PGExecCtxInfo -&gt; RunTx
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#_pecRunTx"><span class="hs-identifier hs-var">_pecRunTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGSourceConfig -&gt; PGExecCtx
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#_pscExecCtx"><span class="hs-identifier hs-var">_pscExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig ('Postgres pgKind)
PGSourceConfig
</span><a href="#local-6989586621688024132"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGExecTxType -&gt; PGExecFrom -&gt; PGExecCtxInfo
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#PGExecCtxInfo"><span class="hs-identifier hs-var">PGExecCtxInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxAccess -&gt; Maybe TxIsolation -&gt; PGExecTxType
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#Tx"><span class="hs-identifier hs-var">Tx</span></a></span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688024133"><span class="hs-identifier hs-var">txAccess</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TxIsolation
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PGExecFrom
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#RunSQLQuery"><span class="hs-identifier hs-var">RunSQLQuery</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><span class="annottext">(TxET QErr m (a, MetadataModifier)
 -&gt; ExceptT QErr m (a, MetadataModifier))
-&gt; TxET QErr m (a, MetadataModifier)
-&gt; ExceptT QErr m (a, MetadataModifier)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>      </span><span class="hs-comment">-- Running in a transaction helps to rollback the @'tx' execution in case of any exceptions</span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span>      </span><span class="hs-comment">-- Before running the @'tx', fetch metadata of existing tables and functions from Postgres.</span><span>
</span><span id="line-322"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688024141"><span class="annot"><span class="annottext">tableNames :: HashSet QualifiedTable
</span><a href="#local-6989586621688024141"><span class="hs-identifier hs-var hs-var hs-var">tableNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; HashSet QualifiedTable
forall k a. HashMap k a -&gt; HashSet k
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#keysSet"><span class="hs-identifier hs-var">HashMap.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688024134"><span class="hs-identifier hs-var">tableCache</span></a></span><span>
</span><span id="line-323"></span><span>          </span><span id="local-6989586621688024143"><span class="annot"><span class="annottext">computedFieldFunctions :: HashSet QualifiedFunction
</span><a href="#local-6989586621688024143"><span class="hs-identifier hs-var hs-var hs-var">computedFieldFunctions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HashSet QualifiedFunction] -&gt; HashSet QualifiedFunction
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([HashSet QualifiedFunction] -&gt; HashSet QualifiedFunction)
-&gt; [HashSet QualifiedFunction] -&gt; HashSet QualifiedFunction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TableInfo ('Postgres pgKind) -&gt; HashSet QualifiedFunction)
-&gt; [TableInfo ('Postgres pgKind)] -&gt; [HashSet QualifiedFunction]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
-&gt; HashSet (FunctionName ('Postgres pgKind))
TableInfo ('Postgres pgKind) -&gt; HashSet QualifiedFunction
forall (pgKind :: PostgresKind).
TableInfo ('Postgres pgKind)
-&gt; HashSet (FunctionName ('Postgres pgKind))
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#getComputedFieldFunctions"><span class="hs-identifier hs-var">getComputedFieldFunctions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; [TableInfo ('Postgres pgKind)]
forall k v. HashMap k v -&gt; [v]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#elems"><span class="hs-identifier hs-var">HashMap.elems</span></a></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688024134"><span class="hs-identifier hs-var">tableCache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>          </span><span id="local-6989586621688024145"><span class="annot"><span class="annottext">functionNames :: HashSet QualifiedFunction
</span><a href="#local-6989586621688024145"><span class="hs-identifier hs-var hs-var hs-var">functionNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedFunction (FunctionInfo ('Postgres pgKind))
-&gt; HashSet QualifiedFunction
forall k a. HashMap k a -&gt; HashSet k
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#keysSet"><span class="hs-identifier hs-var">HashMap.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionCache ('Postgres pgKind)
HashMap QualifiedFunction (FunctionInfo ('Postgres pgKind))
</span><a href="#local-6989586621688024135"><span class="hs-identifier hs-var">functionCache</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet QualifiedFunction
-&gt; HashSet QualifiedFunction -&gt; HashSet QualifiedFunction
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet QualifiedFunction
</span><a href="#local-6989586621688024143"><span class="hs-identifier hs-var">computedFieldFunctions</span></a></span><span>
</span><span id="line-325"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621688024146"><span class="annot"><a href="#local-6989586621688024146"><span class="hs-identifier hs-var">preTxTablesMeta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688024147"><span class="annot"><a href="#local-6989586621688024147"><span class="hs-identifier hs-var">preTxFunctionsMeta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
-&gt; HashSet (TableName ('Postgres pgKind))
-&gt; HashSet (FunctionName ('Postgres pgKind))
-&gt; TxET
     QErr
     m
     ([TableMeta ('Postgres pgKind)], [FunctionMeta ('Postgres pgKind)])
forall (pgKind :: PostgresKind) (m :: * -&gt; *).
(ToMetadataFetchQuery pgKind, FetchTableMetadata pgKind,
 FetchFunctionMetadata pgKind, BackendMetadata ('Postgres pgKind),
 MonadTx m) =&gt;
TableCache ('Postgres pgKind)
-&gt; HashSet (TableName ('Postgres pgKind))
-&gt; HashSet (FunctionName ('Postgres pgKind))
-&gt; m ([TableMeta ('Postgres pgKind)],
      [FunctionMeta ('Postgres pgKind)])
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchTablesFunctionsMetadata"><span class="hs-identifier hs-var">fetchTablesFunctionsMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
</span><a href="#local-6989586621688024134"><span class="hs-identifier hs-var">tableCache</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (TableName ('Postgres pgKind))
HashSet QualifiedTable
</span><a href="#local-6989586621688024141"><span class="hs-identifier hs-var">tableNames</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (FunctionName ('Postgres pgKind))
HashSet QualifiedFunction
</span><a href="#local-6989586621688024145"><span class="hs-identifier hs-var">functionNames</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>      </span><span class="hs-comment">-- Since the @'tx' may alter table/function names we use the OIDs of underlying tables</span><span>
</span><span id="line-328"></span><span>      </span><span class="hs-comment">-- (sourced from 'pg_class' for tables and 'pg_proc' for functions), which remain unchanged in the</span><span>
</span><span id="line-329"></span><span>      </span><span class="hs-comment">-- case if a table/function is renamed.</span><span>
</span><span id="line-330"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688024148"><span class="annot"><a href="#local-6989586621688024148"><span class="hs-identifier hs-var hs-var">tableOids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OID] -&gt; HashSet OID
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#fromList"><span class="hs-identifier hs-var">HS.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([OID] -&gt; HashSet OID) -&gt; [OID] -&gt; HashSet OID
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TableMeta ('Postgres pgKind) -&gt; OID)
-&gt; [TableMeta ('Postgres pgKind)] -&gt; [OID]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DBTableMetadata ('Postgres pgKind) -&gt; OID
forall (b :: BackendType). DBTableMetadata b -&gt; OID
</span><a href="Hasura.Table.Cache.html#_ptmiOid"><span class="hs-identifier hs-var">_ptmiOid</span></a></span><span> </span><span class="annot"><span class="annottext">(DBTableMetadata ('Postgres pgKind) -&gt; OID)
-&gt; (TableMeta ('Postgres pgKind)
    -&gt; DBTableMetadata ('Postgres pgKind))
-&gt; TableMeta ('Postgres pgKind)
-&gt; OID
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableMeta ('Postgres pgKind) -&gt; DBTableMetadata ('Postgres pgKind)
forall (b :: BackendType). TableMeta b -&gt; DBTableMetadata b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#tmInfo"><span class="hs-identifier hs-var">Diff.tmInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688024146"><span class="hs-identifier hs-var">preTxTablesMeta</span></a></span><span>
</span><span id="line-331"></span><span>          </span><span id="local-6989586621688024152"><span class="annot"><a href="#local-6989586621688024152"><span class="hs-identifier hs-var hs-var">functionOids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OID] -&gt; HashSet OID
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#fromList"><span class="hs-identifier hs-var">HS.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([OID] -&gt; HashSet OID) -&gt; [OID] -&gt; HashSet OID
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(FunctionMeta ('Postgres pgKind) -&gt; OID)
-&gt; [FunctionMeta ('Postgres pgKind)] -&gt; [OID]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FunctionMeta ('Postgres pgKind) -&gt; OID
forall (b :: BackendType). FunctionMeta b -&gt; OID
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#fmOid"><span class="hs-identifier hs-var">Diff.fmOid</span></a></span><span> </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688024147"><span class="hs-identifier hs-var">preTxFunctionsMeta</span></a></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>      </span><span class="hs-comment">-- Run the transaction</span><span>
</span><span id="line-334"></span><span>      </span><span id="local-6989586621688024154"><span class="annot"><a href="#local-6989586621688024154"><span class="hs-identifier hs-var">txResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621688024137"><span class="hs-identifier hs-type">tx</span></a></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621688024155"><span class="annot"><a href="#local-6989586621688024155"><span class="hs-identifier hs-var">postTxTablesMeta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688024156"><span class="annot"><a href="#local-6989586621688024156"><span class="hs-identifier hs-var">postTxFunctionMeta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchTablesFunctionsMetadata"><span class="hs-identifier hs-type">fetchTablesFunctionsMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024134"><span class="hs-identifier hs-type">tableCache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>          </span><span class="hs-comment">-- Fetch names of tables and functions using OIDs which also contains renamed items</span><span>
</span><span id="line-339"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">=&lt;&lt;</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchTablesFunctionsFromOids"><span class="hs-identifier hs-type">fetchTablesFunctionsFromOids</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024148"><span class="hs-identifier hs-type">tableOids</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024152"><span class="hs-identifier hs-type">functionOids</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>      </span><span class="hs-comment">-- Calculate the tables diff (dropped &amp; altered tables)</span><span>
</span><span id="line-342"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688024160"><span class="annot"><a href="#local-6989586621688024160"><span class="hs-identifier hs-var hs-var">tablesDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
-&gt; [TableMeta ('Postgres pgKind)] -&gt; TablesDiff ('Postgres pgKind)
forall (b :: BackendType).
Backend b =&gt;
[TableMeta b] -&gt; [TableMeta b] -&gt; TablesDiff b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#getTablesDiff"><span class="hs-identifier hs-var">Diff.getTablesDiff</span></a></span><span> </span><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688024146"><span class="hs-identifier hs-var">preTxTablesMeta</span></a></span><span> </span><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688024155"><span class="hs-identifier hs-var">postTxTablesMeta</span></a></span><span>
</span><span id="line-343"></span><span>          </span><span class="hs-comment">-- Calculate the functions diff. For calculating diff for functions, only consider</span><span>
</span><span id="line-344"></span><span>          </span><span class="hs-comment">-- query/mutation functions and exclude functions underpinning computed fields.</span><span>
</span><span id="line-345"></span><span>          </span><span class="hs-comment">-- Computed field functions are being processed under each table diff.</span><span>
</span><span id="line-346"></span><span>          </span><span class="hs-comment">-- See @'getTablesDiff' and @'Diff.processTablesDiff'</span><span>
</span><span id="line-347"></span><span>          </span><span id="local-6989586621688024162"><span class="annot"><a href="#local-6989586621688024162"><span class="hs-identifier hs-var hs-var">excludeComputedFieldFunctions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FunctionMeta ('Postgres pgKind) -&gt; Bool)
-&gt; [FunctionMeta ('Postgres pgKind)]
-&gt; [FunctionMeta ('Postgres pgKind)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunctionName ('Postgres pgKind)
-&gt; FunctionCache ('Postgres pgKind) -&gt; Bool
forall k a. (Eq k, Hashable k) =&gt; k -&gt; HashMap k a -&gt; Bool
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#member"><span class="hs-operator hs-var">`HashMap.member`</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionCache ('Postgres pgKind)
</span><a href="#local-6989586621688024135"><span class="hs-identifier hs-var">functionCache</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(QualifiedFunction -&gt; Bool)
-&gt; (FunctionMeta ('Postgres pgKind) -&gt; QualifiedFunction)
-&gt; FunctionMeta ('Postgres pgKind)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FunctionMeta ('Postgres pgKind) -&gt; FunctionName ('Postgres pgKind)
FunctionMeta ('Postgres pgKind) -&gt; QualifiedFunction
forall (b :: BackendType). FunctionMeta b -&gt; FunctionName b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#fmFunction"><span class="hs-identifier hs-var">Diff.fmFunction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>          </span><span id="local-6989586621688024165"><span class="annot"><a href="#local-6989586621688024165"><span class="hs-identifier hs-var hs-var">functionsDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-349"></span><span>            </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
-&gt; [FunctionMeta ('Postgres pgKind)]
-&gt; FunctionsDiff ('Postgres pgKind)
forall (b :: BackendType).
[FunctionMeta b] -&gt; [FunctionMeta b] -&gt; FunctionsDiff b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#getFunctionsDiff"><span class="hs-identifier hs-var">Diff.getFunctionsDiff</span></a></span><span>
</span><span id="line-350"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
-&gt; [FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688024162"><span class="hs-identifier hs-var">excludeComputedFieldFunctions</span></a></span><span> </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688024147"><span class="hs-identifier hs-var">preTxFunctionsMeta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
-&gt; [FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688024162"><span class="hs-identifier hs-var">excludeComputedFieldFunctions</span></a></span><span> </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688024156"><span class="hs-identifier hs-var">postTxFunctionMeta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><a href="#local-6989586621688024167"><span class="hs-identifier hs-type">dontAllowFunctionOverloading</span></a></span><span>
</span><span id="line-354"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#getOverloadedFunctions"><span class="hs-identifier hs-type">Diff.getOverloadedFunctions</span></a></span><span>
</span><span id="line-355"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#keys"><span class="hs-identifier hs-type">HashMap.keys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024135"><span class="hs-identifier hs-type">functionCache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688024162"><span class="hs-identifier hs-type">excludeComputedFieldFunctions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024156"><span class="hs-identifier hs-type">postTxFunctionMeta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span>      </span><span class="hs-comment">-- Update metadata with schema change caused by @'tx'</span><span>
</span><span id="line-359"></span><span>      </span><span id="local-6989586621688024170"><span class="annot"><a href="#local-6989586621688024170"><span class="hs-identifier hs-var">metadataUpdater</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">execWriterT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-comment">-- Collect indirect dependencies of altered tables</span><span>
</span><span id="line-361"></span><span>        </span><span id="local-6989586621688024172"><span class="annot"><a href="#local-6989586621688024172"><span class="hs-identifier hs-var">tableIndirectDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#getIndirectDependenciesFromTableDiff"><span class="hs-identifier hs-type">Diff.getIndirectDependenciesFromTableDiff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024131"><span class="hs-identifier hs-type">source</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024160"><span class="hs-identifier hs-type">tablesDiff</span></a></span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span>        </span><span class="hs-comment">-- If table indirect dependencies exist and cascading is not enabled then report an exception</span><span>
</span><span id="line-364"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621688024172"><span class="hs-identifier hs-type">tableIndirectDeps</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="#local-6989586621688024136"><span class="hs-identifier hs-type">cascadeDependencies</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#reportDependentObjectsExist"><span class="hs-identifier hs-type">reportDependentObjectsExist</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024172"><span class="hs-identifier hs-type">tableIndirectDeps</span></a></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-comment">-- Purge all the table dependents</span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">traverse_</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#purgeSourceAndSchemaDependencies"><span class="hs-identifier hs-type">purgeSourceAndSchemaDependencies</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024172"><span class="hs-identifier hs-type">tableIndirectDeps</span></a></span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span>        </span><span class="hs-comment">-- Collect function names from purged table dependencies</span><span>
</span><span id="line-370"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688024180"><span class="annot"><a href="#local-6989586621688024180"><span class="hs-identifier hs-var hs-var">purgedFunctions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SchemaObjId] -&gt; [FunctionName ('Postgres pgKind)]
</span><a href="#local-6989586621688024181"><span class="hs-identifier hs-var">collectFunctionsInDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[SchemaObjId]
</span><a href="#local-6989586621688024172"><span class="hs-identifier hs-var">tableIndirectDeps</span></a></span><span>
</span><span id="line-371"></span><span>            </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#FunctionsDiff"><span class="hs-identifier hs-type">Diff.FunctionsDiff</span></a></span><span> </span><span id="local-6989586621688024183"><span class="annot"><a href="#local-6989586621688024183"><span class="hs-identifier hs-var">droppedFunctions</span></a></span></span><span> </span><span id="local-6989586621688024184"><span class="annot"><a href="#local-6989586621688024184"><span class="hs-identifier hs-var">alteredFunctions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688024165"><span class="hs-identifier hs-type">functionsDiff</span></a></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-comment">-- Drop functions in metadata. Exclude functions that were already dropped as part of table indirect dependencies</span><span>
</span><span id="line-374"></span><span>        </span><span class="annot"><a href="#local-6989586621688024185"><span class="hs-identifier hs-type">purgeFunctionsFromMetadata</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621688024183"><span class="hs-identifier hs-type">droppedFunctions</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">\\</span></span><span> </span><span class="annot"><a href="#local-6989586621688024180"><span class="hs-identifier hs-type">purgedFunctions</span></a></span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span>        </span><span class="hs-comment">-- If any function type is altered to VOLATILE then raise an exception</span><span>
</span><span id="line-377"></span><span>        </span><span class="annot"><a href="#local-6989586621688024187"><span class="hs-identifier hs-type">dontAllowFunctionAlteredVolatile</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024184"><span class="hs-identifier hs-type">alteredFunctions</span></a></span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-comment">-- Propagate table changes to metadata</span><span>
</span><span id="line-380"></span><span>        </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#processTablesDiff"><span class="hs-identifier hs-type">Diff.processTablesDiff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024131"><span class="hs-identifier hs-type">source</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024134"><span class="hs-identifier hs-type">tableCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688024160"><span class="hs-identifier hs-type">tablesDiff</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688024154"><span class="hs-identifier hs-type">txResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688024170"><span class="hs-identifier hs-type">metadataUpdater</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-384"></span><span>    </span><span id="local-6989586621688023458"><span class="annot"><a href="#local-6989586621688024167"><span class="hs-identifier hs-type">dontAllowFunctionOverloading</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-385"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023458"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-386"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#FunctionName"><span class="hs-identifier hs-type">FunctionName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-387"></span><span>      </span><span class="annot"><a href="#local-6989586621688023458"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-388"></span><span>    </span><span id="local-6989586621688024167"><span class="annot"><span class="annottext">dontAllowFunctionOverloading :: forall (n :: * -&gt; *).
MonadError QErr n =&gt;
[FunctionName ('Postgres pgKind)] -&gt; n ()
</span><a href="#local-6989586621688024167"><span class="hs-identifier hs-var hs-var">dontAllowFunctionOverloading</span></a></span></span><span> </span><span id="local-6989586621688024200"><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
</span><a href="#local-6989586621688024200"><span class="hs-identifier hs-var">overloadedFunctions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-389"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; n () -&gt; n ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[QualifiedFunction] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
[QualifiedFunction]
</span><a href="#local-6989586621688024200"><span class="hs-identifier hs-var">overloadedFunctions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span>        </span><span class="annot"><span class="annottext">(n () -&gt; n ()) -&gt; n () -&gt; n ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; n ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><span class="annottext">(Text -&gt; n ()) -&gt; Text -&gt; n ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;the following tracked function(s) cannot be overloaded: &quot;</span></span><span>
</span><span id="line-392"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[QualifiedFunction] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html/Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
[QualifiedFunction]
</span><a href="#local-6989586621688024200"><span class="hs-identifier hs-var">overloadedFunctions</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621688023479"><span class="annot"><a href="#local-6989586621688024187"><span class="hs-identifier hs-type">dontAllowFunctionAlteredVolatile</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-395"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023479"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-396"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#FunctionName"><span class="hs-identifier hs-type">FunctionName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Function.Cache.html#FunctionVolatility"><span class="hs-identifier hs-type">FunctionVolatility</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-397"></span><span>      </span><span class="annot"><a href="#local-6989586621688023479"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-398"></span><span>    </span><span id="local-6989586621688024187"><span class="annot"><span class="annottext">dontAllowFunctionAlteredVolatile :: forall (n :: * -&gt; *).
MonadError QErr n =&gt;
[(FunctionName ('Postgres pgKind), FunctionVolatility)] -&gt; n ()
</span><a href="#local-6989586621688024187"><span class="hs-identifier hs-var hs-var">dontAllowFunctionAlteredVolatile</span></a></span></span><span> </span><span id="local-6989586621688024217"><span class="annot"><span class="annottext">[(FunctionName ('Postgres pgKind), FunctionVolatility)]
</span><a href="#local-6989586621688024217"><span class="hs-identifier hs-var">alteredFunctions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-399"></span><span>      </span><span class="annot"><span class="annottext">[(QualifiedFunction, FunctionVolatility)]
-&gt; ((QualifiedFunction, FunctionVolatility) -&gt; n ()) -&gt; n ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(FunctionName ('Postgres pgKind), FunctionVolatility)]
[(QualifiedFunction, FunctionVolatility)]
</span><a href="#local-6989586621688024217"><span class="hs-identifier hs-var">alteredFunctions</span></a></span><span> </span><span class="annot"><span class="annottext">(((QualifiedFunction, FunctionVolatility) -&gt; n ()) -&gt; n ())
-&gt; ((QualifiedFunction, FunctionVolatility) -&gt; n ()) -&gt; n ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688024218"><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688024218"><span class="hs-identifier hs-var">qf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688024219"><span class="annot"><span class="annottext">FunctionVolatility
</span><a href="#local-6989586621688024219"><span class="hs-identifier hs-var">newTy</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; n () -&gt; n ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunctionVolatility
</span><a href="#local-6989586621688024219"><span class="hs-identifier hs-var">newTy</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionVolatility -&gt; FunctionVolatility -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FunctionVolatility
</span><a href="Hasura.Function.Cache.html#FTVOLATILE"><span class="hs-identifier hs-var">FTVOLATILE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span>          </span><span class="annot"><span class="annottext">(n () -&gt; n ()) -&gt; n () -&gt; n ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; n ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span>
</span><span id="line-402"></span><span>          </span><span class="annot"><span class="annottext">(Text -&gt; n ()) -&gt; Text -&gt; n ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;type of function &quot;</span></span><span>
</span><span id="line-403"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688024218"><span class="hs-identifier hs-var">qf</span></a></span><span>
</span><span id="line-404"></span><span>          </span><span class="annot"><span class="annottext">QualifiedFunction -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html/Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; is altered to \&quot;VOLATILE\&quot; which is not supported now&quot;</span></span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621688023477"><span class="annot"><a href="#local-6989586621688024185"><span class="hs-identifier hs-type">purgeFunctionsFromMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688023477"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-408"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#FunctionName"><span class="hs-identifier hs-type">FunctionName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-409"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">WriterT</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#MetadataModifier"><span class="hs-identifier hs-type">MetadataModifier</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023477"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-410"></span><span>    </span><span id="local-6989586621688024185"><span class="annot"><span class="annottext">purgeFunctionsFromMetadata :: forall (n :: * -&gt; *).
Monad n =&gt;
[FunctionName ('Postgres pgKind)] -&gt; WriterT MetadataModifier n ()
</span><a href="#local-6989586621688024185"><span class="hs-identifier hs-var hs-var">purgeFunctionsFromMetadata</span></a></span></span><span> </span><span id="local-6989586621688024229"><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
</span><a href="#local-6989586621688024229"><span class="hs-identifier hs-var">functions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-411"></span><span>      </span><span class="annot"><span class="annottext">[QualifiedFunction]
-&gt; (QualifiedFunction -&gt; WriterT MetadataModifier n ())
-&gt; WriterT MetadataModifier n ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
[QualifiedFunction]
</span><a href="#local-6989586621688024229"><span class="hs-identifier hs-var">functions</span></a></span><span> </span><span class="annot"><span class="annottext">((QualifiedFunction -&gt; WriterT MetadataModifier n ())
 -&gt; WriterT MetadataModifier n ())
-&gt; (QualifiedFunction -&gt; WriterT MetadataModifier n ())
-&gt; WriterT MetadataModifier n ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MetadataModifier -&gt; WriterT MetadataModifier n ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(MetadataModifier -&gt; WriterT MetadataModifier n ())
-&gt; (QualifiedFunction -&gt; MetadataModifier)
-&gt; QualifiedFunction
-&gt; WriterT MetadataModifier n ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; FunctionName b -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#dropFunctionInMetadata"><span class="hs-identifier hs-var">dropFunctionInMetadata</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688024131"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span>    </span><span class="annot"><a href="#local-6989586621688024181"><span class="hs-identifier hs-type">collectFunctionsInDeps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SchemaObjId"><span class="hs-identifier hs-type">SchemaObjId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#FunctionName"><span class="hs-identifier hs-type">FunctionName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-414"></span><span>    </span><span id="local-6989586621688024181"><span class="annot"><span class="annottext">collectFunctionsInDeps :: [SchemaObjId] -&gt; [FunctionName ('Postgres pgKind)]
</span><a href="#local-6989586621688024181"><span class="hs-identifier hs-var hs-var">collectFunctionsInDeps</span></a></span></span><span> </span><span id="local-6989586621688024233"><span class="annot"><span class="annottext">[SchemaObjId]
</span><a href="#local-6989586621688024233"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-415"></span><span>      </span><span class="annot"><span class="annottext">((SchemaObjId -&gt; Maybe QualifiedFunction)
 -&gt; [SchemaObjId] -&gt; [QualifiedFunction])
-&gt; [SchemaObjId]
-&gt; (SchemaObjId -&gt; Maybe QualifiedFunction)
-&gt; [QualifiedFunction]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">(SchemaObjId -&gt; Maybe QualifiedFunction)
-&gt; [SchemaObjId] -&gt; [QualifiedFunction]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/witherable-0.5-ed5d92584b79c1fa03d7efeb1159ae93eef86189605b088dd8806eb40d0b16f5/share/doc/html/src/Witherable.html/Witherable.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[SchemaObjId]
</span><a href="#local-6989586621688024233"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-416"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOSourceObj"><span class="hs-identifier hs-type">SOSourceObj</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688024236"><span class="annot"><span class="annottext">AnyBackend SourceObjId
</span><a href="#local-6989586621688024236"><span class="hs-identifier hs-var">objectID</span></a></span></span><span>
</span><span id="line-417"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOIFunction"><span class="hs-identifier hs-type">SOIFunction</span></a></span><span> </span><span id="local-6989586621688024238"><span class="annot"><span class="annottext">FunctionName ('Postgres pgKind)
</span><a href="#local-6989586621688024238"><span class="hs-identifier hs-var">qf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
AnyBackend i -&gt; Maybe (i b)
</span><a href="Hasura.SQL.AnyBackend.html#unpackAnyBackend"><span class="hs-identifier hs-var">AB.unpackAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023343"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceObjId
</span><a href="#local-6989586621688024236"><span class="hs-identifier hs-var">objectID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-418"></span><span>              </span><span class="annot"><span class="annottext">QualifiedFunction -&gt; Maybe QualifiedFunction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">FunctionName ('Postgres pgKind)
QualifiedFunction
</span><a href="#local-6989586621688024238"><span class="hs-identifier hs-var">qf</span></a></span><span>
</span><span id="line-419"></span><span>        </span><span class="annot"><span class="annottext">SchemaObjId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe QualifiedFunction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span class="annot"><span class="hs-comment">-- | Fetch list of tables and functions with provided oids</span></span><span>
</span><span id="line-422"></span><span id="local-6989586621688023448"><span id="local-6989586621688023449"><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchTablesFunctionsFromOids"><span class="hs-identifier hs-type">fetchTablesFunctionsFromOids</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688023448"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-424"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HashSet</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#OID"><span class="hs-identifier hs-type">OID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-425"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HashSet</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#OID"><span class="hs-identifier hs-type">OID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-426"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxET"><span class="hs-identifier hs-type">PG.TxET</span></a></span><span>
</span><span id="line-427"></span><span>    </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span>
</span><span id="line-428"></span><span>    </span><span class="annot"><a href="#local-6989586621688023448"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HS.HashSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023449"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-430"></span><span>      </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HS.HashSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#FunctionName"><span class="hs-identifier hs-type">FunctionName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023449"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-special">)</span></span></span><span>
</span><span id="line-432"></span><span id="fetchTablesFunctionsFromOids"><span class="annot"><span class="annottext">fetchTablesFunctionsFromOids :: forall (m :: * -&gt; *) (pgKind :: PostgresKind).
MonadIO m =&gt;
HashSet OID
-&gt; HashSet OID
-&gt; TxET
     QErr
     m
     (HashSet (TableName ('Postgres pgKind)),
      HashSet (FunctionName ('Postgres pgKind)))
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchTablesFunctionsFromOids"><span class="hs-identifier hs-var hs-var">fetchTablesFunctionsFromOids</span></a></span></span><span> </span><span id="local-6989586621688024294"><span class="annot"><span class="annottext">HashSet OID
</span><a href="#local-6989586621688024294"><span class="hs-identifier hs-var">tableOids</span></a></span></span><span> </span><span id="local-6989586621688024295"><span class="annot"><span class="annottext">HashSet OID
</span><a href="#local-6989586621688024295"><span class="hs-identifier hs-var">functionOids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-433"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ViaJSON (HashSet QualifiedTable) -&gt; HashSet QualifiedTable
forall a. ViaJSON a -&gt; a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#getViaJSON"><span class="hs-identifier hs-var">PG.getViaJSON</span></a></span><span> </span><span class="annot"><span class="annottext">(ViaJSON (HashSet QualifiedTable) -&gt; HashSet QualifiedTable)
-&gt; (ViaJSON (HashSet QualifiedFunction)
    -&gt; HashSet QualifiedFunction)
-&gt; (ViaJSON (HashSet QualifiedTable),
    ViaJSON (HashSet QualifiedFunction))
-&gt; (HashSet QualifiedTable, HashSet QualifiedFunction)
forall b c b' c'. (b -&gt; c) -&gt; (b' -&gt; c') -&gt; (b, b') -&gt; (c, c')
forall (a :: * -&gt; * -&gt; *) b c b' c'.
Arrow a =&gt;
a b c -&gt; a b' c' -&gt; a (b, b') (c, c')
</span><span class="hs-operator hs-var">***</span></span><span> </span><span class="annot"><span class="annottext">ViaJSON (HashSet QualifiedFunction) -&gt; HashSet QualifiedFunction
forall a. ViaJSON a -&gt; a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#getViaJSON"><span class="hs-identifier hs-var">PG.getViaJSON</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((ViaJSON (HashSet QualifiedTable),
  ViaJSON (HashSet QualifiedFunction))
 -&gt; (HashSet QualifiedTable, HashSet QualifiedFunction))
-&gt; (SingleRow
      (ViaJSON (HashSet QualifiedTable),
       ViaJSON (HashSet QualifiedFunction))
    -&gt; (ViaJSON (HashSet QualifiedTable),
        ViaJSON (HashSet QualifiedFunction)))
-&gt; SingleRow
     (ViaJSON (HashSet QualifiedTable),
      ViaJSON (HashSet QualifiedFunction))
-&gt; (HashSet QualifiedTable, HashSet QualifiedFunction)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SingleRow
  (ViaJSON (HashSet QualifiedTable),
   ViaJSON (HashSet QualifiedFunction))
-&gt; (ViaJSON (HashSet QualifiedTable),
    ViaJSON (HashSet QualifiedFunction))
forall a. SingleRow a -&gt; a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#getRow"><span class="hs-identifier hs-var">PG.getRow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>    </span><span class="annot"><span class="annottext">(SingleRow
   (ViaJSON (HashSet QualifiedTable),
    ViaJSON (HashSet QualifiedFunction))
 -&gt; (HashSet QualifiedTable, HashSet QualifiedFunction))
-&gt; TxET
     QErr
     m
     (SingleRow
        (ViaJSON (HashSet QualifiedTable),
         ViaJSON (HashSet QualifiedFunction)))
-&gt; TxET QErr m (HashSet QualifiedTable, HashSet QualifiedFunction)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr)
-&gt; Query
-&gt; (ViaJSON [Value], ViaJSON [Value])
-&gt; Bool
-&gt; TxET
     QErr
     m
     (SingleRow
        (ViaJSON (HashSet QualifiedTable),
         ViaJSON (HashSet QualifiedFunction)))
forall (m :: * -&gt; *) a r e.
(MonadIO m, FromRes a, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#withQE"><span class="hs-identifier hs-var">PG.withQE</span></a></span><span>
</span><span id="line-435"></span><span>      </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-436"></span><span>      </span><span class="annot"><span class="">[PG.sql|
    SELECT
      COALESCE(
        ( SELECT
            json_agg(
              row_to_json(
                (
                  SELECT e
                    FROM ( SELECT &quot;table&quot;.relname AS &quot;name&quot;,
                                  &quot;schema&quot;.nspname AS &quot;schema&quot;
                    ) AS e
                )
              )
            ) AS &quot;item&quot;
            FROM jsonb_to_recordset($1::jsonb) AS oid_table(&quot;oid&quot; int)
                 JOIN pg_catalog.pg_class &quot;table&quot; ON (&quot;table&quot;.oid = &quot;oid_table&quot;.oid)
                 JOIN pg_catalog.pg_namespace &quot;schema&quot; ON (&quot;schema&quot;.oid = &quot;table&quot;.relnamespace)
        ),
        '[]'
      ) AS &quot;tables&quot;,

      COALESCE(
        ( SELECT
            json_agg(
              row_to_json(
                (
                  SELECT e
                    FROM ( SELECT &quot;function&quot;.proname AS &quot;name&quot;,
                                  &quot;schema&quot;.nspname AS &quot;schema&quot;
                    ) AS e
                )
              )
            ) AS &quot;item&quot;
            FROM jsonb_to_recordset($2::jsonb) AS oid_table(&quot;oid&quot; int)
                 JOIN pg_catalog.pg_proc &quot;function&quot; ON (&quot;function&quot;.oid = &quot;oid_table&quot;.oid)
                 JOIN pg_catalog.pg_namespace &quot;schema&quot; ON (&quot;schema&quot;.oid = &quot;function&quot;.pronamespace)
        ),
        '[]'
      ) AS &quot;functions&quot;
  |]</span></span><span>
</span><span id="line-476"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Value] -&gt; ViaJSON [Value]
forall a. a -&gt; ViaJSON a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#ViaJSON"><span class="hs-identifier hs-var">PG.ViaJSON</span></a></span><span> </span><span class="annot"><span class="annottext">([Value] -&gt; ViaJSON [Value]) -&gt; [Value] -&gt; ViaJSON [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(OID -&gt; Value) -&gt; [OID] -&gt; [Value]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">OID -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="#local-6989586621688024303"><span class="hs-identifier hs-var">mkOidObject</span></a></span><span> </span><span class="annot"><span class="annottext">([OID] -&gt; [Value]) -&gt; [OID] -&gt; [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet OID -&gt; [OID]
forall a. HashSet a -&gt; [a]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#toList"><span class="hs-identifier hs-var">HS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet OID
</span><a href="#local-6989586621688024294"><span class="hs-identifier hs-var">tableOids</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; ViaJSON [Value]
forall a. a -&gt; ViaJSON a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#ViaJSON"><span class="hs-identifier hs-var">PG.ViaJSON</span></a></span><span> </span><span class="annot"><span class="annottext">([Value] -&gt; ViaJSON [Value]) -&gt; [Value] -&gt; ViaJSON [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(OID -&gt; Value) -&gt; [OID] -&gt; [Value]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">OID -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="#local-6989586621688024303"><span class="hs-identifier hs-var">mkOidObject</span></a></span><span> </span><span class="annot"><span class="annottext">([OID] -&gt; [Value]) -&gt; [OID] -&gt; [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet OID -&gt; [OID]
forall a. HashSet a -&gt; [a]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#toList"><span class="hs-identifier hs-var">HS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(HashSet OID -&gt; [OID]) -&gt; HashSet OID -&gt; [OID]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashSet OID
</span><a href="#local-6989586621688024295"><span class="hs-identifier hs-var">functionOids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-478"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-479"></span><span>    </span><span id="local-6989586621688024303"><span class="annot"><span class="annottext">mkOidObject :: v -&gt; Value
</span><a href="#local-6989586621688024303"><span class="hs-identifier hs-var hs-var">mkOidObject</span></a></span></span><span> </span><span id="local-6989586621688024310"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621688024310"><span class="hs-identifier hs-var">oid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.Internal.html/Data.Aeson.Types.Internal.html#object"><span class="hs-identifier hs-var">object</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;oid&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; v -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621688024310"><span class="hs-identifier hs-var">oid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-480"></span><span>
</span><span id="line-481"></span><span class="hs-comment">------ helpers ------------</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span id="local-6989586621688023231"><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#getComputedFields"><span class="hs-identifier hs-type">getComputedFields</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Table.Cache.html#TableInfo"><span class="hs-identifier hs-type">TableInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023231"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.ComputedField.html#ComputedFieldInfo"><span class="hs-identifier hs-type">ComputedFieldInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023231"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-484"></span><span id="getComputedFields"><span class="annot"><span class="annottext">getComputedFields :: forall (pgKind :: PostgresKind).
TableInfo ('Postgres pgKind)
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#getComputedFields"><span class="hs-identifier hs-var hs-var">getComputedFields</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo ('Postgres pgKind))
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
forall (backend :: BackendType).
FieldInfoMap (FieldInfo backend) -&gt; [ComputedFieldInfo backend]
</span><a href="Hasura.Table.Cache.html#getComputedFieldInfos"><span class="hs-identifier hs-var">getComputedFieldInfos</span></a></span><span> </span><span class="annot"><span class="annottext">(FieldInfoMap (FieldInfo ('Postgres pgKind))
 -&gt; [ComputedFieldInfo ('Postgres pgKind)])
-&gt; (TableInfo ('Postgres pgKind)
    -&gt; FieldInfoMap (FieldInfo ('Postgres pgKind)))
-&gt; TableInfo ('Postgres pgKind)
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableCoreInfoG
  ('Postgres pgKind)
  (FieldInfo ('Postgres pgKind))
  (ColumnInfo ('Postgres pgKind))
-&gt; FieldInfoMap (FieldInfo ('Postgres pgKind))
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; FieldInfoMap field
</span><a href="Hasura.Table.Cache.html#_tciFieldInfoMap"><span class="hs-identifier hs-var">_tciFieldInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">(TableCoreInfoG
   ('Postgres pgKind)
   (FieldInfo ('Postgres pgKind))
   (ColumnInfo ('Postgres pgKind))
 -&gt; FieldInfoMap (FieldInfo ('Postgres pgKind)))
-&gt; (TableInfo ('Postgres pgKind)
    -&gt; TableCoreInfoG
         ('Postgres pgKind)
         (FieldInfo ('Postgres pgKind))
         (ColumnInfo ('Postgres pgKind)))
-&gt; TableInfo ('Postgres pgKind)
-&gt; FieldInfoMap (FieldInfo ('Postgres pgKind))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
-&gt; TableCoreInfoG
     ('Postgres pgKind)
     (FieldInfo ('Postgres pgKind))
     (ColumnInfo ('Postgres pgKind))
forall (b :: BackendType). TableInfo b -&gt; TableCoreInfo b
</span><a href="Hasura.Table.Cache.html#_tiCoreInfo"><span class="hs-identifier hs-var">_tiCoreInfo</span></a></span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span id="local-6989586621688023435"><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#getComputedFieldFunctions"><span class="hs-identifier hs-type">getComputedFieldFunctions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Table.Cache.html#TableInfo"><span class="hs-identifier hs-type">TableInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023435"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HashSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#FunctionName"><span class="hs-identifier hs-type">FunctionName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688023435"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-487"></span><span id="getComputedFieldFunctions"><span class="annot"><span class="annottext">getComputedFieldFunctions :: forall (pgKind :: PostgresKind).
TableInfo ('Postgres pgKind)
-&gt; HashSet (FunctionName ('Postgres pgKind))
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#getComputedFieldFunctions"><span class="hs-identifier hs-var hs-var">getComputedFieldFunctions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[QualifiedFunction] -&gt; HashSet QualifiedFunction
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#fromList"><span class="hs-identifier hs-var">HS.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([QualifiedFunction] -&gt; HashSet QualifiedFunction)
-&gt; (TableInfo ('Postgres pgKind) -&gt; [QualifiedFunction])
-&gt; TableInfo ('Postgres pgKind)
-&gt; HashSet QualifiedFunction
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ComputedFieldInfo ('Postgres pgKind) -&gt; QualifiedFunction)
-&gt; [ComputedFieldInfo ('Postgres pgKind)] -&gt; [QualifiedFunction]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ComputedFieldFunction ('Postgres pgKind)
-&gt; FunctionName ('Postgres pgKind)
ComputedFieldFunction ('Postgres pgKind) -&gt; QualifiedFunction
forall (b :: BackendType).
ComputedFieldFunction b -&gt; FunctionName b
</span><a href="Hasura.RQL.Types.ComputedField.html#_cffName"><span class="hs-identifier hs-var">_cffName</span></a></span><span> </span><span class="annot"><span class="annottext">(ComputedFieldFunction ('Postgres pgKind) -&gt; QualifiedFunction)
-&gt; (ComputedFieldInfo ('Postgres pgKind)
    -&gt; ComputedFieldFunction ('Postgres pgKind))
-&gt; ComputedFieldInfo ('Postgres pgKind)
-&gt; QualifiedFunction
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
-&gt; ComputedFieldFunction ('Postgres pgKind)
forall (b :: BackendType).
ComputedFieldInfo b -&gt; ComputedFieldFunction b
</span><a href="Hasura.RQL.Types.ComputedField.html#_cfiFunction"><span class="hs-identifier hs-var">_cfiFunction</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([ComputedFieldInfo ('Postgres pgKind)] -&gt; [QualifiedFunction])
-&gt; (TableInfo ('Postgres pgKind)
    -&gt; [ComputedFieldInfo ('Postgres pgKind)])
-&gt; TableInfo ('Postgres pgKind)
-&gt; [QualifiedFunction]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
forall (pgKind :: PostgresKind).
TableInfo ('Postgres pgKind)
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#getComputedFields"><span class="hs-identifier hs-var">getComputedFields</span></a></span><span>
</span><span id="line-488"></span></pre></body></html>