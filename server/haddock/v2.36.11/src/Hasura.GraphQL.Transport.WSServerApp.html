<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WSServerApp</span></a></span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html#createWSServerApp"><span class="hs-identifier">createWSServerApp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html#stopWSServerApp"><span class="hs-identifier">stopWSServerApp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html#createWSServerEnv"><span class="hs-identifier">createWSServerEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-6"></span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-async-0.10.2.5-7453f3a39fe1c149b1fdd3dbcd3716b82112049f5f698aafbd6eb5b568cc41a4/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html/Control.Concurrent.Async.Lifted.Safe.html"><span class="hs-identifier">Control.Concurrent.Async.Lifted.Safe</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LA</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-base-0.2.3.12-1236ccd06afb130acb896e54a1f2632aea78e5a896631c0879370de140144631/share/doc/html/src/Control.Exception.Lifted.html/Control.Exception.Lifted.html"><span class="hs-identifier">Control.Exception.Lifted</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html"><span class="hs-identifier">Control.Monad.Trans.Control</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.html/Data.Aeson.html"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Encoding.html/Data.Aeson.Encoding.html"><span class="hs-identifier">Data.Aeson.Encoding</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pack</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pack</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.App.State.html"><span class="hs-identifier">Hasura.App.State</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.DataConnector.Agent.Client.html"><span class="hs-identifier">Hasura.Backends.DataConnector.Agent.Client</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.DataConnector.Agent.Client.html#AgentLicenseKey"><span class="hs-identifier">AgentLicenseKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.CredentialCache.html"><span class="hs-identifier">Hasura.CredentialCache</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.html"><span class="hs-identifier">Hasura.GraphQL.Execute</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Logging.html"><span class="hs-identifier">Hasura.GraphQL.Logging</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier">MonadExecuteQuery</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#encodeGQExecError"><span class="hs-identifier">encodeGQExecError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.Instances.html"><span class="hs-identifier">Hasura.GraphQL.Transport.Instances</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Protocol</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Server</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WS</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Types</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html"><span class="hs-identifier">Hasura.Metadata.Class</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.QueryTags.html"><span class="hs-identifier">Hasura.QueryTags</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html"><span class="hs-identifier">Hasura.Server.AppStateRef</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Auth.html"><span class="hs-identifier">Hasura.Server.Auth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Auth.html#UserAuthentication"><span class="hs-identifier">UserAuthentication</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Init.Config.html"><span class="hs-identifier">Hasura.Server.Init.Config</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.Init.Config.html#WSConnectionInitTimeout"><span class="hs-identifier">WSConnectionInitTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html"><span class="hs-identifier">Hasura.Server.Limits</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Metrics.html"><span class="hs-identifier">Hasura.Server.Metrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier">ServerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html"><span class="hs-identifier">Hasura.Server.Prometheus</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier">PrometheusMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#decWebsocketConnections"><span class="hs-identifier">decWebsocketConnections</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#incWebsocketConnections"><span class="hs-identifier">incWebsocketConnections</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MonadGetPolicies"><span class="hs-identifier">MonadGetPolicies</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Services.Network.html"><span class="hs-identifier">Hasura.Services.Network</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/websockets-0.13.0.0-2cd899d4b3466ebf052047c238a83c60318de1a150acea53b7173aee9736fdbb/share/doc/html/src/Network.WebSockets.html/Network.WebSockets.html"><span class="hs-identifier">Network.WebSockets</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WS</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.Gauge.html/System.Metrics.Gauge.html"><span class="hs-identifier">System.Metrics.Gauge</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Gauge</span></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span id="local-6989586621688062364"><span id="local-6989586621688062383"><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html#createWSServerApp"><span class="hs-identifier hs-type">createWSServerApp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- only due to https://gitlab.haskell.org/ghc/ghc/-/issues/15681</span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MC.MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/constraints-0.14.2-ff824dad83d629e0fa70449d98d0e80ecc50be2f324c7bd62638caa7179948ea/share/doc/html/src/Data.Constraint.Forall.html/Data.Constraint.Forall.html#Forall"><span class="hs-identifier hs-type">LA.Forall</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-async-0.10.2.5-7453f3a39fe1c149b1fdd3dbcd3716b82112049f5f698aafbd6eb5b568cc41a4/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html/Control.Concurrent.Async.Lifted.Safe.html#Pure"><span class="hs-identifier hs-type">LA.Pure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="Hasura.Server.Auth.html#UserAuthentication"><span class="hs-identifier hs-type">UserAuthentication</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Common.html#MonadGQLExecutionCheck"><span class="hs-identifier hs-type">E.MonadGQLExecutionCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#MonadWSLog"><span class="hs-identifier hs-type">WS.MonadWSLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Logging.QueryLog.html#MonadQueryLog"><span class="hs-identifier hs-type">MonadQueryLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Logging.ExecutionLog.html#MonadExecutionLog"><span class="hs-identifier hs-type">MonadExecutionLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier hs-type">MonadExecuteQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="Hasura.QueryTags.html#MonadQueryTags"><span class="hs-identifier hs-type">MonadQueryTags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><a href="Hasura.Services.Network.html#ProvidesNetwork"><span class="hs-identifier hs-type">ProvidesNetwork</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.Class.html#MonadTrace"><span class="hs-identifier hs-type">Tracing.MonadTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><a href="Hasura.Server.Types.html#MonadGetPolicies"><span class="hs-identifier hs-type">MonadGetPolicies</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-69"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HashSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#EngineLogType"><span class="hs-identifier hs-type">L.EngineLogType</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#WSServerEnv"><span class="hs-identifier hs-type">WSServerEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062383"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#WSConnectionInitTimeout"><span class="hs-identifier hs-type">WSConnectionInitTimeout</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-72"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.CredentialCache.html#CredentialCache"><span class="hs-identifier hs-type">CredentialCache</span></a></span><span> </span><span class="annot"><a href="Hasura.Backends.DataConnector.Agent.Client.html#AgentLicenseKey"><span class="hs-identifier hs-type">AgentLicenseKey</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><span class="hs-comment">-- | aka generalized 'WS.ServerApp'</span></span><span>
</span><span id="line-74"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#HasuraServerApp"><span class="hs-identifier hs-type">WS.HasuraServerApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062364"><span class="hs-identifier hs-type">m</span></a></span></span></span><span>
</span><span id="line-75"></span><span id="createWSServerApp"><span class="annot"><span class="annottext">createWSServerApp :: forall (m :: * -&gt; *) impl.
(MonadIO m, MonadFail m, MonadBaseControl IO m, Forall (Pure m),
 UserAuthentication m, MonadGQLExecutionCheck m, MonadWSLog m,
 MonadQueryLog m, MonadExecutionLog m, MonadExecuteQuery m,
 MonadMetadataStorage m, MonadQueryTags m, HasResourceLimits m,
 ProvidesNetwork m, MonadTrace m, MonadGetPolicies m) =&gt;
HashSet (EngineLogType Hasura)
-&gt; WSServerEnv impl
-&gt; WSConnectionInitTimeout
-&gt; Maybe (CredentialCache AgentLicenseKey)
-&gt; HasuraServerApp m
</span><a href="Hasura.GraphQL.Transport.WSServerApp.html#createWSServerApp"><span class="hs-identifier hs-var hs-var">createWSServerApp</span></a></span></span><span> </span><span id="local-6989586621688062644"><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688062644"><span class="hs-identifier hs-var">enabledLogTypes</span></a></span></span><span> </span><span id="local-6989586621688062645"><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062645"><span class="hs-identifier hs-var">serverEnv</span></a></span></span><span> </span><span id="local-6989586621688062646"><span class="annot"><span class="annottext">WSConnectionInitTimeout
</span><a href="#local-6989586621688062646"><span class="hs-identifier hs-var">connInitTimeout</span></a></span></span><span> </span><span id="local-6989586621688062647"><span class="annot"><span class="annottext">Maybe (CredentialCache AgentLicenseKey)
</span><a href="#local-6989586621688062647"><span class="hs-identifier hs-var">licenseKeyCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688062648"><span class="annot"><span class="annottext">IpAddress
</span><a href="#local-6989586621688062648"><span class="hs-identifier hs-var">ipAddress</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688062649"><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621688062649"><span class="hs-identifier hs-var">pendingConn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688062650"><span class="annot"><span class="annottext">getMetricsConfig :: IO MetricsConfig
</span><a href="#local-6989586621688062650"><span class="hs-identifier hs-var hs-var">getMetricsConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; MetricsConfig
</span><a href="Hasura.RQL.Types.SchemaCache.html#scMetricsConfig"><span class="hs-identifier hs-var">scMetricsConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; MetricsConfig)
-&gt; IO SchemaCache -&gt; IO MetricsConfig
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl -&gt; IO SchemaCache
forall impl. AppStateRef impl -&gt; IO SchemaCache
</span><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-var">getSchemaCache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WSServerEnv impl -&gt; AppStateRef impl
forall impl. WSServerEnv impl -&gt; AppStateRef impl
</span><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wseAppStateRef"><span class="hs-identifier hs-var">_wseAppStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062645"><span class="hs-identifier hs-var">serverEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>  </span><span class="annot"><span class="annottext">IO MetricsConfig
-&gt; WSConnectionInitTimeout
-&gt; WSServer WSConnData
-&gt; PrometheusMetrics
-&gt; WSHandlers m WSConnData
-&gt; IpAddress
-&gt; PendingConnection
-&gt; m ()
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m, Forall (Pure m), MonadWSLog m,
 MonadGetPolicies m) =&gt;
IO MetricsConfig
-&gt; WSConnectionInitTimeout
-&gt; WSServer a
-&gt; PrometheusMetrics
-&gt; WSHandlers m a
-&gt; HasuraServerApp m
</span><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#createServerApp"><span class="hs-identifier hs-var">WS.createServerApp</span></a></span><span> </span><span class="annot"><span class="annottext">IO MetricsConfig
</span><a href="#local-6989586621688062650"><span class="hs-identifier hs-var">getMetricsConfig</span></a></span><span> </span><span class="annot"><span class="annottext">WSConnectionInitTimeout
</span><a href="#local-6989586621688062646"><span class="hs-identifier hs-var">connInitTimeout</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WSServerEnv impl -&gt; WSServer WSConnData
forall impl. WSServerEnv impl -&gt; WSServer WSConnData
</span><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wseServer"><span class="hs-identifier hs-var">_wseServer</span></a></span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062645"><span class="hs-identifier hs-var">serverEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688062657"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">WSHandlers m WSConnData
</span><a href="#local-6989586621688062658"><span class="hs-identifier hs-var">handlers</span></a></span><span> </span><span class="annot"><span class="annottext">IpAddress
</span><a href="#local-6989586621688062648"><span class="hs-identifier hs-var">ipAddress</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621688062649"><span class="hs-identifier hs-var">pendingConn</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-79"></span><span>    </span><span id="local-6989586621688062658"><span class="annot"><span class="annottext">handlers :: WSHandlers m WSConnData
</span><a href="#local-6989586621688062658"><span class="hs-identifier hs-var hs-var">handlers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-80"></span><span>      </span><span class="annot"><span class="annottext">(WSId
 -&gt; RequestHead
 -&gt; IpAddress
 -&gt; WSSubProtocol
 -&gt; m (Either RejectRequest (AcceptWith WSConnData)))
-&gt; (WSConn WSConnData -&gt; ByteString -&gt; WSSubProtocol -&gt; m ())
-&gt; OnCloseH m WSConnData
-&gt; WSHandlers m WSConnData
forall (m :: * -&gt; *) a.
(WSId
 -&gt; RequestHead
 -&gt; IpAddress
 -&gt; WSSubProtocol
 -&gt; m (Either RejectRequest (AcceptWith a)))
-&gt; (WSConn a -&gt; ByteString -&gt; WSSubProtocol -&gt; m ())
-&gt; OnCloseH m a
-&gt; WSHandlers m a
</span><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#WSHandlers"><span class="hs-identifier hs-var">WS.WSHandlers</span></a></span><span>
</span><span id="line-81"></span><span>        </span><span class="annot"><span class="annottext">WSId
-&gt; RequestHead
-&gt; IpAddress
-&gt; WSSubProtocol
-&gt; m (Either RejectRequest (AcceptWith WSConnData))
</span><a href="#local-6989586621688062660"><span class="hs-identifier hs-var">onConnHandler</span></a></span><span>
</span><span id="line-82"></span><span>        </span><span class="annot"><span class="annottext">WSConn WSConnData -&gt; ByteString -&gt; WSSubProtocol -&gt; m ()
</span><a href="#local-6989586621688062661"><span class="hs-identifier hs-var">onMessageHandler</span></a></span><span>
</span><span id="line-83"></span><span>        </span><span class="annot"><span class="annottext">OnCloseH m WSConnData
</span><a href="#local-6989586621688062662"><span class="hs-identifier hs-var">onCloseHandler</span></a></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span>    </span><span id="local-6989586621688062663"><span class="annot"><span class="annottext">logger :: Logger Hasura
</span><a href="#local-6989586621688062663"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl -&gt; Logger Hasura
forall impl. WSServerEnv impl -&gt; Logger Hasura
</span><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wseLogger"><span class="hs-identifier hs-var">_wseLogger</span></a></span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062645"><span class="hs-identifier hs-var">serverEnv</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span id="local-6989586621688062665"><span class="annot"><span class="annottext">serverMetrics :: ServerMetrics
</span><a href="#local-6989586621688062665"><span class="hs-identifier hs-var hs-var">serverMetrics</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl -&gt; ServerMetrics
forall impl. WSServerEnv impl -&gt; ServerMetrics
</span><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wseServerMetrics"><span class="hs-identifier hs-var">_wseServerMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062645"><span class="hs-identifier hs-var">serverEnv</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span id="local-6989586621688062657"><span class="annot"><span class="annottext">prometheusMetrics :: PrometheusMetrics
</span><a href="#local-6989586621688062657"><span class="hs-identifier hs-var hs-var">prometheusMetrics</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl -&gt; PrometheusMetrics
forall impl. WSServerEnv impl -&gt; PrometheusMetrics
</span><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wsePrometheusMetrics"><span class="hs-identifier hs-var">_wsePrometheusMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062645"><span class="hs-identifier hs-var">serverEnv</span></a></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span>    </span><span id="local-6989586621688062668"><span class="annot"><span class="annottext">getAuthMode :: IO AuthMode
</span><a href="#local-6989586621688062668"><span class="hs-identifier hs-var hs-var">getAuthMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; AuthMode
</span><a href="Hasura.App.State.html#acAuthMode"><span class="hs-identifier hs-var">acAuthMode</span></a></span><span> </span><span class="annot"><span class="annottext">(AppContext -&gt; AuthMode) -&gt; IO AppContext -&gt; IO AuthMode
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl -&gt; IO AppContext
forall impl. AppStateRef impl -&gt; IO AppContext
</span><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-var">getAppContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WSServerEnv impl -&gt; AppStateRef impl
forall impl. WSServerEnv impl -&gt; AppStateRef impl
</span><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wseAppStateRef"><span class="hs-identifier hs-var">_wseAppStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062645"><span class="hs-identifier hs-var">serverEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>    </span><span id="local-6989586621688062671"><span class="annot"><span class="annottext">wsActions :: WSSubProtocol -&gt; WSActions WSConnData
</span><a href="#local-6989586621688062671"><span class="hs-identifier hs-var hs-var">wsActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; WSSubProtocol -&gt; WSActions WSConnData
</span><a href="Hasura.GraphQL.Transport.WSServerApp.html#mkWSActions"><span class="hs-identifier hs-var">mkWSActions</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688062663"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-comment">-- Mask async exceptions during event processing to help maintain integrity of mutable vars:</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-comment">-- here `sp` stands for sub-protocol</span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621688062660"><span class="annot"><span class="annottext">onConnHandler :: WSId
-&gt; RequestHead
-&gt; IpAddress
-&gt; WSSubProtocol
-&gt; m (Either RejectRequest (AcceptWith WSConnData))
</span><a href="#local-6989586621688062660"><span class="hs-identifier hs-var hs-var">onConnHandler</span></a></span></span><span> </span><span id="local-6989586621688062673"><span class="annot"><span class="annottext">WSId
</span><a href="#local-6989586621688062673"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621688062674"><span class="annot"><span class="annottext">RequestHead
</span><a href="#local-6989586621688062674"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span id="local-6989586621688062675"><span class="annot"><span class="annottext">IpAddress
</span><a href="#local-6989586621688062675"><span class="hs-identifier hs-var">ip</span></a></span></span><span> </span><span id="local-6989586621688062676"><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062676"><span class="hs-identifier hs-var">sp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Either RejectRequest (AcceptWith WSConnData))
-&gt; m (Either RejectRequest (AcceptWith WSConnData))
forall (m :: * -&gt; *) a. MonadBaseControl IO m =&gt; m a -&gt; m a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-base-0.2.3.12-1236ccd06afb130acb896e54a1f2632aea78e5a896631c0879370de140144631/share/doc/html/src/Control.Exception.Lifted.html/Control.Exception.Lifted.html#mask_"><span class="hs-identifier hs-var">mask_</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.Gauge.html/System.Metrics.Gauge.html#inc"><span class="hs-identifier hs-var">EKG.Gauge.inc</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smWebsocketConnections"><span class="hs-identifier hs-var">smWebsocketConnections</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688062665"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-96"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnectionsGauge -&gt; IO ()
</span><a href="Hasura.Server.Prometheus.html#incWebsocketConnections"><span class="hs-identifier hs-var">incWebsocketConnections</span></a></span><span> </span><span class="annot"><span class="annottext">(ConnectionsGauge -&gt; IO ()) -&gt; ConnectionsGauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; ConnectionsGauge
</span><a href="Hasura.Server.Prometheus.html#pmConnections"><span class="hs-identifier hs-var">pmConnections</span></a></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688062657"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-97"></span><span>      </span><span class="annot"><span class="annottext">(ReaderT
   (WSServerEnv impl) m (Either RejectRequest (AcceptWith WSConnData))
 -&gt; WSServerEnv impl
 -&gt; m (Either RejectRequest (AcceptWith WSConnData)))
-&gt; WSServerEnv impl
-&gt; ReaderT
     (WSServerEnv impl) m (Either RejectRequest (AcceptWith WSConnData))
-&gt; m (Either RejectRequest (AcceptWith WSConnData))
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT
  (WSServerEnv impl) m (Either RejectRequest (AcceptWith WSConnData))
-&gt; WSServerEnv impl
-&gt; m (Either RejectRequest (AcceptWith WSConnData))
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062645"><span class="hs-identifier hs-var">serverEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (WSServerEnv impl) m (Either RejectRequest (AcceptWith WSConnData))
 -&gt; m (Either RejectRequest (AcceptWith WSConnData)))
-&gt; ReaderT
     (WSServerEnv impl) m (Either RejectRequest (AcceptWith WSConnData))
-&gt; m (Either RejectRequest (AcceptWith WSConnData))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OnConnH (ReaderT (WSServerEnv impl) m) WSConnData
forall (m :: * -&gt; *) impl.
(MonadFail m, MonadIO m, MonadReader (WSServerEnv impl) m) =&gt;
OnConnH m WSConnData
</span><a href="Hasura.GraphQL.Transport.WebSocket.html#onConn"><span class="hs-identifier hs-var">onConn</span></a></span><span> </span><span class="annot"><span class="annottext">WSId
</span><a href="#local-6989586621688062673"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">RequestHead
</span><a href="#local-6989586621688062674"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">IpAddress
</span><a href="#local-6989586621688062675"><span class="hs-identifier hs-var">ip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WSSubProtocol -&gt; WSActions WSConnData
</span><a href="#local-6989586621688062671"><span class="hs-identifier hs-var">wsActions</span></a></span><span> </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062676"><span class="hs-identifier hs-var">sp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>    </span><span id="local-6989586621688062661"><span class="annot"><span class="annottext">onMessageHandler :: WSConn WSConnData -&gt; ByteString -&gt; WSSubProtocol -&gt; m ()
</span><a href="#local-6989586621688062661"><span class="hs-identifier hs-var hs-var">onMessageHandler</span></a></span></span><span> </span><span id="local-6989586621688062685"><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062685"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621688062686"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688062686"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621688062687"><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062687"><span class="hs-identifier hs-var">sp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-100"></span><span>      </span><span id="local-6989586621688062688"><span class="annot"><a href="#local-6989586621688062688"><span class="hs-identifier hs-var">traceQueryStatus</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TraceQueryStatus -&gt; m TraceQueryStatus
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO TraceQueryStatus -&gt; m TraceQueryStatus)
-&gt; IO TraceQueryStatus -&gt; m TraceQueryStatus
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; TraceQueryStatus
</span><a href="Hasura.App.State.html#acTraceQueryStatus"><span class="hs-identifier hs-var">acTraceQueryStatus</span></a></span><span> </span><span class="annot"><span class="annottext">(AppContext -&gt; TraceQueryStatus)
-&gt; IO AppContext -&gt; IO TraceQueryStatus
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl -&gt; IO AppContext
forall impl. AppStateRef impl -&gt; IO AppContext
</span><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-var">getAppContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WSServerEnv impl -&gt; AppStateRef impl
forall impl. WSServerEnv impl -&gt; AppStateRef impl
</span><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wseAppStateRef"><span class="hs-identifier hs-var">_wseAppStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062645"><span class="hs-identifier hs-var">serverEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-base-0.2.3.12-1236ccd06afb130acb896e54a1f2632aea78e5a896631c0879370de140144631/share/doc/html/src/Control.Exception.Lifted.html/Control.Exception.Lifted.html#mask_"><span class="hs-identifier hs-type">mask_</span></a></span><span>
</span><span id="line-102"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.html#onMessage"><span class="hs-identifier hs-type">onMessage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062644"><span class="hs-identifier hs-type">enabledLogTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062668"><span class="hs-identifier hs-type">getAuthMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062645"><span class="hs-identifier hs-type">serverEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062685"><span class="hs-identifier hs-type">conn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062686"><span class="hs-identifier hs-type">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688062671"><span class="hs-identifier hs-type">wsActions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062687"><span class="hs-identifier hs-type">sp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688062647"><span class="hs-identifier hs-type">licenseKeyCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062688"><span class="hs-identifier hs-type">traceQueryStatus</span></a></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span>    </span><span id="local-6989586621688062662"><span class="annot"><span class="annottext">onCloseHandler :: OnCloseH m WSConnData
</span><a href="#local-6989586621688062662"><span class="hs-identifier hs-var hs-var">onCloseHandler</span></a></span></span><span> </span><span id="local-6989586621688062691"><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062691"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. MonadBaseControl IO m =&gt; m a -&gt; m a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-base-0.2.3.12-1236ccd06afb130acb896e54a1f2632aea78e5a896631c0879370de140144631/share/doc/html/src/Control.Exception.Lifted.html/Control.Exception.Lifted.html#mask_"><span class="hs-identifier hs-var">mask_</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-105"></span><span>      </span><span id="local-6989586621688062692"><span class="annot"><a href="#local-6989586621688062692"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (IO GranularPrometheusMetricsState)
forall (m :: * -&gt; *).
MonadGetPolicies m =&gt;
m (IO GranularPrometheusMetricsState)
</span><a href="Hasura.Server.Types.html#runGetPrometheusMetricsGranularity"><span class="hs-identifier hs-var">runGetPrometheusMetricsGranularity</span></a></span><span>
</span><span id="line-106"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.Gauge.html/System.Metrics.Gauge.html#dec"><span class="hs-identifier hs-type">EKG.Gauge.dec</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Metrics.html#smWebsocketConnections"><span class="hs-identifier hs-var">smWebsocketConnections</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062665"><span class="hs-identifier hs-type">serverMetrics</span></a></span><span>
</span><span id="line-107"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html#decWebsocketConnections"><span class="hs-identifier hs-type">decWebsocketConnections</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html#pmConnections"><span class="hs-identifier hs-var">pmConnections</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062657"><span class="hs-identifier hs-type">prometheusMetrics</span></a></span><span>
</span><span id="line-108"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.html#onClose"><span class="hs-identifier hs-type">onClose</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062663"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062665"><span class="hs-identifier hs-type">serverMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062657"><span class="hs-identifier hs-type">prometheusMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wseSubscriptionState"><span class="hs-identifier hs-var">_wseSubscriptionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062645"><span class="hs-identifier hs-type">serverEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688062691"><span class="hs-identifier hs-type">conn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062692"><span class="hs-identifier hs-type">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span id="local-6989586621688062467"><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html#stopWSServerApp"><span class="hs-identifier hs-type">stopWSServerApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#WSServerEnv"><span class="hs-identifier hs-type">WSServerEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062467"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-111"></span><span id="stopWSServerApp"><span class="annot"><span class="annottext">stopWSServerApp :: forall impl. WSServerEnv impl -&gt; IO ()
</span><a href="Hasura.GraphQL.Transport.WSServerApp.html#stopWSServerApp"><span class="hs-identifier hs-var hs-var">stopWSServerApp</span></a></span></span><span> </span><span id="local-6989586621688062697"><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062697"><span class="hs-identifier hs-var">wsEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WSServer WSConnData -&gt; IO ()
forall a. WSServer a -&gt; IO ()
</span><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#shutdown"><span class="hs-identifier hs-var">WS.shutdown</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WSServerEnv impl -&gt; WSServer WSConnData
forall impl. WSServerEnv impl -&gt; WSServer WSConnData
</span><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wseServer"><span class="hs-identifier hs-var">_wseServer</span></a></span><span> </span><span class="annot"><span class="annottext">WSServerEnv impl
</span><a href="#local-6989586621688062697"><span class="hs-identifier hs-var">wsEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span id="local-6989586621688062470"><span id="local-6989586621688062472"><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html#createWSServerEnv"><span class="hs-identifier hs-type">createWSServerEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.App.State.html#HasAppEnv"><span class="hs-identifier hs-type">HasAppEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062470"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688062470"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier hs-type">AppStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062472"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-118"></span><span>  </span><span class="annot"><a href="#local-6989586621688062470"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#WSServerEnv"><span class="hs-identifier hs-type">WSServerEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062472"><span class="hs-identifier hs-type">impl</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-119"></span><span id="createWSServerEnv"><span class="annot"><span class="annottext">createWSServerEnv :: forall (m :: * -&gt; *) impl.
(HasAppEnv m, MonadIO m) =&gt;
AppStateRef impl -&gt; m (WSServerEnv impl)
</span><a href="Hasura.GraphQL.Transport.WSServerApp.html#createWSServerEnv"><span class="hs-identifier hs-var hs-var">createWSServerEnv</span></a></span></span><span> </span><span id="local-6989586621688062719"><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621688062719"><span class="hs-identifier hs-var">appStateRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688062721"><span id="local-6989586621688062722"><span id="local-6989586621688062723"><span id="local-6989586621688062724"><span id="local-6989586621688062725"><span id="local-6989586621688062726"><span id="local-6989586621688062727"><span id="local-6989586621688062728"><span id="local-6989586621688062729"><span id="local-6989586621688062730"><span id="local-6989586621688062731"><span id="local-6989586621688062732"><span id="local-6989586621688062733"><span id="local-6989586621688062734"><span id="local-6989586621688062735"><span id="local-6989586621688062736"><span id="local-6989586621688062737"><span id="local-6989586621688062738"><span id="local-6989586621688062739"><span id="local-6989586621688062740"><span id="local-6989586621688062741"><span id="local-6989586621688062742"><span id="local-6989586621688062743"><span id="local-6989586621688062744"><span id="local-6989586621688062745"><span id="local-6989586621688062746"><span id="local-6989586621688062747"><span id="local-6989586621688062748"><span id="local-6989586621688062749"><span id="local-6989586621688062750"><span id="local-6989586621688062751"><span id="local-6989586621688062752"><span id="local-6989586621688062753"><span id="local-6989586621688062754"><span id="local-6989586621688062755"><span class="annot"><a href="#local-6989586621688062721"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m AppEnv
forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688062792"><span class="annot"><a href="#local-6989586621688062792"><span class="hs-identifier hs-var hs-var">getCorsPolicy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; CorsPolicy
</span><a href="Hasura.App.State.html#acCorsPolicy"><span class="hs-identifier hs-var">acCorsPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">(AppContext -&gt; CorsPolicy) -&gt; IO AppContext -&gt; IO CorsPolicy
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl -&gt; IO AppContext
forall impl. AppStateRef impl -&gt; IO AppContext
</span><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-var">getAppContext</span></a></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621688062719"><span class="hs-identifier hs-var">appStateRef</span></a></span><span>
</span><span id="line-122"></span><span>      </span><span id="local-6989586621688062794"><span class="annot"><a href="#local-6989586621688062794"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Loggers -&gt; Logger Hasura
</span><a href="Hasura.App.State.html#_lsLogger"><span class="hs-identifier hs-var">_lsLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Loggers
</span><a href="#local-6989586621688062726"><span class="hs-identifier hs-var">appEnvLoggers</span></a></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><a href="Hasura.App.State.html#AppContext"><span class="hs-identifier hs-type">AppContext</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688062797"><span class="annot"><a href="#local-6989586621688062797"><span class="hs-identifier hs-var hs-var">acEnableAllowlist</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688062799"><span class="annot"><a href="Hasura.App.State.html#acAuthMode"><span class="hs-identifier hs-var hs-var">acAuthMode</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688062800"><span class="annot"><a href="#local-6989586621688062800"><span class="hs-identifier hs-var hs-var">acSQLGenCtx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688062802"><span class="annot"><a href="#local-6989586621688062802"><span class="hs-identifier hs-var hs-var">acExperimentalFeatures</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688062804"><span class="annot"><a href="#local-6989586621688062804"><span class="hs-identifier hs-var hs-var">acDefaultNamingConvention</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-type">getAppContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062719"><span class="hs-identifier hs-type">appStateRef</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span id="local-6989586621688062806"><span class="annot"><a href="#local-6989586621688062806"><span class="hs-identifier hs-var">allowlist</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#scAllowlist"><span class="hs-identifier hs-var">scAllowlist</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-type">getSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062719"><span class="hs-identifier hs-type">appStateRef</span></a></span><span>
</span><span id="line-126"></span><span>  </span><span id="local-6989586621688062808"><span class="annot"><a href="#local-6989586621688062808"><span class="hs-identifier hs-var">corsPolicy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688062792"><span class="hs-identifier hs-type">getCorsPolicy</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>  </span><span id="local-6989586621688062809"><span class="annot"><a href="#local-6989586621688062809"><span class="hs-identifier hs-var">wsServer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM.atomically</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#createWSServer"><span class="hs-identifier hs-type">WS.createWSServer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062799"><span class="hs-identifier hs-type">acAuthMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062797"><span class="hs-identifier hs-type">acEnableAllowlist</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062806"><span class="hs-identifier hs-type">allowlist</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062808"><span class="hs-identifier hs-type">corsPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062800"><span class="hs-identifier hs-type">acSQLGenCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062802"><span class="hs-identifier hs-type">acExperimentalFeatures</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062804"><span class="hs-identifier hs-type">acDefaultNamingConvention</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062794"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span>
</span><span id="line-131"></span><span>    </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#WSServerEnv"><span class="hs-identifier hs-type">WSServerEnv</span></a></span><span>
</span><span id="line-132"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.State.html#_lsLogger"><span class="hs-identifier hs-var">_lsLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688062726"><span class="hs-identifier hs-type">appEnvLoggers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>      </span><span class="annot"><a href="#local-6989586621688062738"><span class="hs-identifier hs-type">appEnvSubscriptionState</span></a></span><span>
</span><span id="line-134"></span><span>      </span><span class="annot"><a href="#local-6989586621688062719"><span class="hs-identifier hs-type">appStateRef</span></a></span><span>
</span><span id="line-135"></span><span>      </span><span class="annot"><a href="#local-6989586621688062725"><span class="hs-identifier hs-type">appEnvManager</span></a></span><span>
</span><span id="line-136"></span><span>      </span><span class="annot"><a href="#local-6989586621688062792"><span class="hs-identifier hs-type">getCorsPolicy</span></a></span><span>
</span><span id="line-137"></span><span>      </span><span class="annot"><a href="#local-6989586621688062732"><span class="hs-identifier hs-type">appEnvEnableReadOnlyMode</span></a></span><span>
</span><span id="line-138"></span><span>      </span><span class="annot"><a href="#local-6989586621688062809"><span class="hs-identifier hs-type">wsServer</span></a></span><span>
</span><span id="line-139"></span><span>      </span><span class="annot"><a href="#local-6989586621688062745"><span class="hs-identifier hs-type">appEnvWebSocketKeepAlive</span></a></span><span>
</span><span id="line-140"></span><span>      </span><span class="annot"><a href="#local-6989586621688062733"><span class="hs-identifier hs-type">appEnvServerMetrics</span></a></span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><a href="#local-6989586621688062736"><span class="hs-identifier hs-type">appEnvPrometheusMetrics</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><a href="#local-6989586621688062737"><span class="hs-identifier hs-type">appEnvTraceSamplingPolicy</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html#mkWSActions"><span class="hs-identifier hs-type">mkWSActions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#WSSubProtocol"><span class="hs-identifier hs-type">WSSubProtocol</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#WSActions"><span class="hs-identifier hs-type">WS.WSActions</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#WSConnData"><span class="hs-identifier hs-type">WSConnData</span></a></span><span>
</span><span id="line-145"></span><span id="mkWSActions"><span class="annot"><span class="annottext">mkWSActions :: Logger Hasura -&gt; WSSubProtocol -&gt; WSActions WSConnData
</span><a href="Hasura.GraphQL.Transport.WSServerApp.html#mkWSActions"><span class="hs-identifier hs-var hs-var">mkWSActions</span></a></span></span><span> </span><span id="local-6989586621688062813"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688062813"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688062814"><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062814"><span class="hs-identifier hs-var">subProtocol</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><span class="annottext">WSPostExecErrMessageAction WSConnData
-&gt; WSOnErrorMessageAction WSConnData
-&gt; WSCloseConnAction WSConnData
-&gt; WSKeepAliveMessageAction WSConnData
-&gt; (DataMsg -&gt; ServerMsg)
-&gt; AcceptRequest
-&gt; ([Encoding] -&gt; Encoding)
-&gt; WSActions WSConnData
forall a.
WSPostExecErrMessageAction a
-&gt; WSOnErrorMessageAction a
-&gt; WSCloseConnAction a
-&gt; WSKeepAliveMessageAction a
-&gt; (DataMsg -&gt; ServerMsg)
-&gt; AcceptRequest
-&gt; ([Encoding] -&gt; Encoding)
-&gt; WSActions a
</span><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#WSActions"><span class="hs-identifier hs-var">WS.WSActions</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><span class="annottext">WSPostExecErrMessageAction WSConnData
</span><a href="#local-6989586621688062816"><span class="hs-identifier hs-var">mkPostExecErrMessageAction</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">WSOnErrorMessageAction WSConnData
</span><a href="#local-6989586621688062817"><span class="hs-identifier hs-var">mkOnErrorMessageAction</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><span class="annottext">WSCloseConnAction WSConnData
</span><a href="#local-6989586621688062818"><span class="hs-identifier hs-var">mkConnectionCloseAction</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><span class="annottext">WSKeepAliveMessageAction WSConnData
</span><a href="#local-6989586621688062819"><span class="hs-identifier hs-var">keepAliveAction</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><span class="annottext">DataMsg -&gt; ServerMsg
</span><a href="#local-6989586621688062820"><span class="hs-identifier hs-var">getServerMsgType</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><span class="annottext">AcceptRequest
</span><a href="#local-6989586621688062821"><span class="hs-identifier hs-var">mkAcceptRequest</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="annot"><span class="annottext">[Encoding] -&gt; Encoding
</span><a href="#local-6989586621688062822"><span class="hs-identifier hs-var">fmtErrorMessage</span></a></span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-155"></span><span>    </span><span id="local-6989586621688062816"><span class="annot"><span class="annottext">mkPostExecErrMessageAction :: WSPostExecErrMessageAction WSConnData
</span><a href="#local-6989586621688062816"><span class="hs-identifier hs-var hs-var">mkPostExecErrMessageAction</span></a></span></span><span> </span><span id="local-6989586621688062823"><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062823"><span class="hs-identifier hs-var">wsConn</span></a></span></span><span> </span><span id="local-6989586621688062824"><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688062824"><span class="hs-identifier hs-var">opId</span></a></span></span><span> </span><span id="local-6989586621688062825"><span class="annot"><span class="annottext">GQExecError
</span><a href="#local-6989586621688062825"><span class="hs-identifier hs-var">execErr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>      </span><span class="annot"><span class="annottext">WSConn WSConnData -&gt; ServerMsg -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
WSConn WSConnData -&gt; ServerMsg -&gt; m ()
</span><a href="Hasura.GraphQL.Transport.WebSocket.html#sendMsg"><span class="hs-identifier hs-var">sendMsg</span></a></span><span> </span><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062823"><span class="hs-identifier hs-var">wsConn</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerMsg -&gt; IO ()) -&gt; ServerMsg -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062814"><span class="hs-identifier hs-var">subProtocol</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-157"></span><span>        </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#Apollo"><span class="hs-identifier hs-var">Apollo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DataMsg -&gt; ServerMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#SMData"><span class="hs-identifier hs-var">SMData</span></a></span><span> </span><span class="annot"><span class="annottext">(DataMsg -&gt; ServerMsg) -&gt; DataMsg -&gt; ServerMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OperationId -&gt; GQResponse -&gt; DataMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#DataMsg"><span class="hs-identifier hs-var">DataMsg</span></a></span><span> </span><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688062824"><span class="hs-identifier hs-var">opId</span></a></span><span> </span><span class="annot"><span class="annottext">(GQResponse -&gt; DataMsg) -&gt; GQResponse -&gt; DataMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GQExecError -&gt; GQResponse
forall a. GQExecError -&gt; Either GQExecError a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">GQExecError
</span><a href="#local-6989586621688062825"><span class="hs-identifier hs-var">execErr</span></a></span><span>
</span><span id="line-158"></span><span>        </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#GraphQLWS"><span class="hs-identifier hs-var">GraphQLWS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ErrorMsg -&gt; ServerMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#SMErr"><span class="hs-identifier hs-var">SMErr</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; ServerMsg) -&gt; ErrorMsg -&gt; ServerMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OperationId -&gt; Encoding -&gt; ErrorMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#ErrorMsg"><span class="hs-identifier hs-var">ErrorMsg</span></a></span><span> </span><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688062824"><span class="hs-identifier hs-var">opId</span></a></span><span> </span><span class="annot"><span class="annottext">(Encoding -&gt; ErrorMsg) -&gt; Encoding -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GQExecError -&gt; Encoding
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#encodeGQExecError"><span class="hs-identifier hs-var">encodeGQExecError</span></a></span><span> </span><span class="annot"><span class="annottext">GQExecError
</span><a href="#local-6989586621688062825"><span class="hs-identifier hs-var">execErr</span></a></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>    </span><span id="local-6989586621688062817"><span class="annot"><span class="annottext">mkOnErrorMessageAction :: WSOnErrorMessageAction WSConnData
</span><a href="#local-6989586621688062817"><span class="hs-identifier hs-var hs-var">mkOnErrorMessageAction</span></a></span></span><span> </span><span id="local-6989586621688062834"><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062834"><span class="hs-identifier hs-var">wsConn</span></a></span></span><span> </span><span id="local-6989586621688062835"><span class="annot"><span class="annottext">ConnErrMsg
</span><a href="#local-6989586621688062835"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621688062836"><span class="annot"><span class="annottext">WSErrorMessage
</span><a href="#local-6989586621688062836"><span class="hs-identifier hs-var">mErrMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062814"><span class="hs-identifier hs-var">subProtocol</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-162"></span><span>        </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#Apollo"><span class="hs-identifier hs-var">Apollo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-163"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WSErrorMessage
</span><a href="#local-6989586621688062836"><span class="hs-identifier hs-var">mErrMsg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-164"></span><span>            </span><span class="annot"><span class="annottext">WSErrorMessage
</span><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#ConnInitFailed"><span class="hs-identifier hs-var">WS.ConnInitFailed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; WSConn WSConnData
-&gt; ServerErrorCode
-&gt; Maybe ServerMsg
-&gt; Maybe Word16
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura
-&gt; WSConn WSConnData
-&gt; ServerErrorCode
-&gt; Maybe ServerMsg
-&gt; Maybe Word16
-&gt; m ()
</span><a href="Hasura.GraphQL.Transport.WebSocket.html#sendCloseWithMsg"><span class="hs-identifier hs-var">sendCloseWithMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688062813"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062834"><span class="hs-identifier hs-var">wsConn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WSSubProtocol -&gt; WSErrorMessage -&gt; ConnErrMsg -&gt; ServerErrorCode
</span><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#mkWSServerErrorCode"><span class="hs-identifier hs-var">WS.mkWSServerErrorCode</span></a></span><span> </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062814"><span class="hs-identifier hs-var">subProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">WSErrorMessage
</span><a href="#local-6989586621688062836"><span class="hs-identifier hs-var">mErrMsg</span></a></span><span> </span><span class="annot"><span class="annottext">ConnErrMsg
</span><a href="#local-6989586621688062835"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMsg -&gt; Maybe ServerMsg
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ServerMsg -&gt; Maybe ServerMsg) -&gt; ServerMsg -&gt; Maybe ServerMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnErrMsg -&gt; ServerMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#SMConnErr"><span class="hs-identifier hs-var">SMConnErr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnErrMsg
</span><a href="#local-6989586621688062835"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Word16
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-165"></span><span>            </span><span class="annot"><span class="annottext">WSErrorMessage
</span><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#ClientMessageParseFailed"><span class="hs-identifier hs-var">WS.ClientMessageParseFailed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WSConn WSConnData -&gt; ServerMsg -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
WSConn WSConnData -&gt; ServerMsg -&gt; m ()
</span><a href="Hasura.GraphQL.Transport.WebSocket.html#sendMsg"><span class="hs-identifier hs-var">sendMsg</span></a></span><span> </span><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062834"><span class="hs-identifier hs-var">wsConn</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerMsg -&gt; IO ()) -&gt; ServerMsg -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnErrMsg -&gt; ServerMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#SMConnErr"><span class="hs-identifier hs-var">SMConnErr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnErrMsg
</span><a href="#local-6989586621688062835"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-166"></span><span>        </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#GraphQLWS"><span class="hs-identifier hs-var">GraphQLWS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; WSConn WSConnData
-&gt; ServerErrorCode
-&gt; Maybe ServerMsg
-&gt; Maybe Word16
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura
-&gt; WSConn WSConnData
-&gt; ServerErrorCode
-&gt; Maybe ServerMsg
-&gt; Maybe Word16
-&gt; m ()
</span><a href="Hasura.GraphQL.Transport.WebSocket.html#sendCloseWithMsg"><span class="hs-identifier hs-var">sendCloseWithMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688062813"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062834"><span class="hs-identifier hs-var">wsConn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WSSubProtocol -&gt; WSErrorMessage -&gt; ConnErrMsg -&gt; ServerErrorCode
</span><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#mkWSServerErrorCode"><span class="hs-identifier hs-var">WS.mkWSServerErrorCode</span></a></span><span> </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062814"><span class="hs-identifier hs-var">subProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">WSErrorMessage
</span><a href="#local-6989586621688062836"><span class="hs-identifier hs-var">mErrMsg</span></a></span><span> </span><span class="annot"><span class="annottext">ConnErrMsg
</span><a href="#local-6989586621688062835"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ServerMsg
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Word16
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>    </span><span id="local-6989586621688062818"><span class="annot"><span class="annottext">mkConnectionCloseAction :: WSCloseConnAction WSConnData
</span><a href="#local-6989586621688062818"><span class="hs-identifier hs-var hs-var">mkConnectionCloseAction</span></a></span></span><span> </span><span id="local-6989586621688062842"><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062842"><span class="hs-identifier hs-var">wsConn</span></a></span></span><span> </span><span id="local-6989586621688062843"><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688062843"><span class="hs-identifier hs-var">opId</span></a></span></span><span> </span><span id="local-6989586621688062844"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688062844"><span class="hs-identifier hs-var">errMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-169"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062814"><span class="hs-identifier hs-var">subProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">WSSubProtocol -&gt; WSSubProtocol -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#GraphQLWS"><span class="hs-identifier hs-var">GraphQLWS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; WSConn WSConnData
-&gt; ServerErrorCode
-&gt; Maybe ServerMsg
-&gt; Maybe Word16
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura
-&gt; WSConn WSConnData
-&gt; ServerErrorCode
-&gt; Maybe ServerMsg
-&gt; Maybe Word16
-&gt; m ()
</span><a href="Hasura.GraphQL.Transport.WebSocket.html#sendCloseWithMsg"><span class="hs-identifier hs-var">sendCloseWithMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688062813"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062842"><span class="hs-identifier hs-var">wsConn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ServerErrorCode
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#GenericError4400"><span class="hs-identifier hs-var">GenericError4400</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688062844"><span class="hs-identifier hs-var">errMsg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMsg -&gt; Maybe ServerMsg
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ServerMsg -&gt; Maybe ServerMsg)
-&gt; (ErrorMsg -&gt; ServerMsg) -&gt; ErrorMsg -&gt; Maybe ServerMsg
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ErrorMsg -&gt; ServerMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#SMErr"><span class="hs-identifier hs-var">SMErr</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Maybe ServerMsg) -&gt; ErrorMsg -&gt; Maybe ServerMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OperationId -&gt; Encoding -&gt; ErrorMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#ErrorMsg"><span class="hs-identifier hs-var">ErrorMsg</span></a></span><span> </span><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688062843"><span class="hs-identifier hs-var">opId</span></a></span><span> </span><span class="annot"><span class="annottext">(Encoding -&gt; ErrorMsg) -&gt; Encoding -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Encoding
forall a. ToJSON a =&gt; a -&gt; Encoding
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#toEncoding"><span class="hs-identifier hs-var">J.toEncoding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688062844"><span class="hs-identifier hs-var">errMsg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word16 -&gt; Maybe Word16
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">1000</span></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621688062820"><span class="annot"><span class="annottext">getServerMsgType :: DataMsg -&gt; ServerMsg
</span><a href="#local-6989586621688062820"><span class="hs-identifier hs-var hs-var">getServerMsgType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062814"><span class="hs-identifier hs-var">subProtocol</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-173"></span><span>      </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#Apollo"><span class="hs-identifier hs-var">Apollo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DataMsg -&gt; ServerMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#SMData"><span class="hs-identifier hs-var">SMData</span></a></span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#GraphQLWS"><span class="hs-identifier hs-var">GraphQLWS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DataMsg -&gt; ServerMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#SMNext"><span class="hs-identifier hs-var">SMNext</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span>    </span><span id="local-6989586621688062819"><span class="annot"><span class="annottext">keepAliveAction :: WSKeepAliveMessageAction WSConnData
</span><a href="#local-6989586621688062819"><span class="hs-identifier hs-var hs-var">keepAliveAction</span></a></span></span><span> </span><span id="local-6989586621688062850"><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062850"><span class="hs-identifier hs-var">wsConn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WSConn WSConnData -&gt; ServerMsg -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
WSConn WSConnData -&gt; ServerMsg -&gt; m ()
</span><a href="Hasura.GraphQL.Transport.WebSocket.html#sendMsg"><span class="hs-identifier hs-var">sendMsg</span></a></span><span> </span><span class="annot"><span class="annottext">WSConn WSConnData
</span><a href="#local-6989586621688062850"><span class="hs-identifier hs-var">wsConn</span></a></span><span>
</span><span id="line-177"></span><span>      </span><span class="annot"><span class="annottext">(ServerMsg -&gt; IO ()) -&gt; ServerMsg -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062814"><span class="hs-identifier hs-var">subProtocol</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-178"></span><span>        </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#Apollo"><span class="hs-identifier hs-var">Apollo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#SMConnKeepAlive"><span class="hs-identifier hs-var">SMConnKeepAlive</span></a></span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#GraphQLWS"><span class="hs-identifier hs-var">GraphQLWS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe PingPongPayload -&gt; ServerMsg
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#SMPing"><span class="hs-identifier hs-var">SMPing</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe PingPongPayload -&gt; ServerMsg)
-&gt; (PingPongPayload -&gt; Maybe PingPongPayload)
-&gt; PingPongPayload
-&gt; ServerMsg
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PingPongPayload -&gt; Maybe PingPongPayload
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(PingPongPayload -&gt; ServerMsg) -&gt; PingPongPayload -&gt; ServerMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PingPongPayload
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#keepAliveMessage"><span class="hs-identifier hs-var">keepAliveMessage</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>    </span><span id="local-6989586621688062821"><span class="annot"><span class="annottext">mkAcceptRequest :: AcceptRequest
</span><a href="#local-6989586621688062821"><span class="hs-identifier hs-var hs-var">mkAcceptRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-182"></span><span>      </span><span class="annot"><span class="annottext">AcceptRequest
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/websockets-0.13.0.0-2cd899d4b3466ebf052047c238a83c60318de1a150acea53b7173aee9736fdbb/share/doc/html/src/Network.WebSockets.Connection.html/Network.WebSockets.Connection.html#defaultAcceptRequest"><span class="hs-identifier hs-var">WS.defaultAcceptRequest</span></a></span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/websockets-0.13.0.0-2cd899d4b3466ebf052047c238a83c60318de1a150acea53b7173aee9736fdbb/share/doc/html/src/Network.WebSockets.Connection.html/Network.WebSockets.Connection.html#acceptSubprotocol"><span class="hs-identifier hs-var">WS.acceptSubprotocol</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.pack</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#showSubProtocol"><span class="hs-identifier hs-type">showSubProtocol</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621688062814"><span class="hs-identifier hs-type">subProtocol</span></a></span><span>
</span><span id="line-184"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>    </span><span id="local-6989586621688062822"><span class="annot"><span class="annottext">fmtErrorMessage :: [Encoding] -&gt; Encoding
</span><a href="#local-6989586621688062822"><span class="hs-identifier hs-var hs-var">fmtErrorMessage</span></a></span></span><span> </span><span id="local-6989586621688062857"><span class="annot"><span class="annottext">[Encoding]
</span><a href="#local-6989586621688062857"><span class="hs-identifier hs-var">errMsgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="#local-6989586621688062814"><span class="hs-identifier hs-var">subProtocol</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-187"></span><span>      </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#Apollo"><span class="hs-identifier hs-var">Apollo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Series -&gt; Encoding
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Encoding.Internal.html/Data.Aeson.Encoding.Internal.html#pairs"><span class="hs-identifier hs-var">J.pairs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key -&gt; Encoding -&gt; Series
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Encoding.Internal.html/Data.Aeson.Encoding.Internal.html#pair"><span class="hs-identifier hs-var">J.pair</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;errors&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Encoding -&gt; Series) -&gt; Encoding -&gt; Series
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Encoding -&gt; Encoding) -&gt; [Encoding] -&gt; Encoding
forall a. (a -&gt; Encoding) -&gt; [a] -&gt; Encoding
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Encoding.Internal.html/Data.Aeson.Encoding.Internal.html#list"><span class="hs-identifier hs-var">J.list</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">[Encoding]
</span><a href="#local-6989586621688062857"><span class="hs-identifier hs-var">errMsgs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><span class="annottext">WSSubProtocol
</span><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#GraphQLWS"><span class="hs-identifier hs-var">GraphQLWS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Encoding -&gt; Encoding) -&gt; [Encoding] -&gt; Encoding
forall a. (a -&gt; Encoding) -&gt; [a] -&gt; Encoding
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Encoding.Internal.html/Data.Aeson.Encoding.Internal.html#list"><span class="hs-identifier hs-var">J.list</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">[Encoding]
</span><a href="#local-6989586621688062857"><span class="hs-identifier hs-var">errMsgs</span></a></span><span>
</span><span id="line-189"></span></pre></body></html>