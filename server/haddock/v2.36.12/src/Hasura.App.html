<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | Defines the CE version of the engine.</span><span>
</span><span id="line-7"></span><span class="hs-comment">--</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- This module contains everything that is required to run the community edition</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- of the engine: the base application monad and the implementation of all its</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- behaviour classes.</span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Hasura.App.html"><span class="hs-identifier">Hasura.App</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * top-level error handling</span></span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier">ExitCode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.App.html#ExitException"><span class="hs-identifier">ExitException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.App.html#throwErrExit"><span class="hs-identifier">throwErrExit</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hasura.App.html#throwErrJExit"><span class="hs-identifier">throwErrJExit</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier">accessDeniedErrMsg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><span class="hs-comment">-- * printing helpers</span></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Hasura.App.html#printJSON"><span class="hs-identifier">printJSON</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><span class="hs-comment">-- * logging</span></span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkLoggers"><span class="hs-identifier">mkLoggers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkPGLogger"><span class="hs-identifier">mkPGLogger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><span class="hs-comment">-- * basic connection info</span></span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Hasura.App.html#BasicConnectionInfo"><span class="hs-identifier">BasicConnectionInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Hasura.App.html#initMetadataConnectionInfo"><span class="hs-identifier">initMetadataConnectionInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Hasura.App.html#initBasicConnectionInfo"><span class="hs-identifier">initBasicConnectionInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Hasura.App.html#resolvePostgresConnInfo"><span class="hs-identifier">resolvePostgresConnInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="hs-comment">-- * app init</span></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Hasura.App.html#initialiseAppEnv"><span class="hs-identifier">initialiseAppEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Hasura.App.html#initialiseAppContext"><span class="hs-identifier">initialiseAppContext</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Hasura.App.html#migrateCatalogAndFetchMetadata"><span class="hs-identifier">migrateCatalogAndFetchMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Hasura.App.html#buildFirstSchemaCache"><span class="hs-identifier">buildFirstSchemaCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Hasura.App.html#initSubscriptionsState"><span class="hs-identifier">initSubscriptionsState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Hasura.App.html#initLockedEventsCtx"><span class="hs-identifier">initLockedEventsCtx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-comment">-- * app monad</span></span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier">AppM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Hasura.App.html#runAppM"><span class="hs-identifier">runAppM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-comment">-- * misc</span></span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Hasura.App.html#getCatalogStateTx"><span class="hs-identifier">getCatalogStateTx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Hasura.App.html#updateJwkCtxThread"><span class="hs-identifier">updateJwkCtxThread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Hasura.App.html#notifySchemaCacheSyncTx"><span class="hs-identifier">notifySchemaCacheSyncTx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Hasura.App.html#parseArgs"><span class="hs-identifier">parseArgs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><a href="Hasura.App.html#runHGEServer"><span class="hs-identifier">runHGEServer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><a href="Hasura.App.html#setCatalogStateTx"><span class="hs-identifier">setCatalogStateTx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkHGEServer"><span class="hs-identifier">mkHGEServer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier">mkPgSourceResolver</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier">mkMSSQLSourceResolver</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">where</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-async-0.10.2.5-7453f3a39fe1c149b1fdd3dbcd3716b82112049f5f698aafbd6eb5b568cc41a4/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html/Control.Concurrent.Async.Lifted.Safe.html"><span class="hs-identifier">Control.Concurrent.Async.Lifted.Safe</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LA</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier">sleep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bracket_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Exception</span></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><span class="hs-identifier">MonadCatch</span></span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><span class="hs-identifier">MonadMask</span></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><span class="hs-identifier">MonadThrow</span></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/mmorph-1.2.0-4c0f8c8ac6cf3be26d81218d98eb81405af8960badca054b02f2e270f75a44c0/share/doc/html/src/Control.Monad.Morph.html/Control.Monad.Morph.html"><span class="hs-identifier">Control.Monad.Morph</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/mmorph-1.2.0-4c0f8c8ac6cf3be26d81218d98eb81405af8960badca054b02f2e270f75a44c0/share/doc/html/src/Control.Monad.Morph.html/Control.Monad.Morph.html#hoist"><span class="hs-identifier">hoist</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Monad.Stateless.html"><span class="hs-identifier">Control.Monad.Stateless</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html"><span class="hs-identifier">Control.Monad.Trans.Control</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier">MonadBaseControl</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Monad.Trans.Managed.html"><span class="hs-identifier">Control.Monad.Trans.Managed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier">ManagedT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#allocate"><span class="hs-identifier">allocate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#allocate_"><span class="hs-identifier">allocate_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/retry-0.9.3.1-2b36dff8cf59a85fca7a5dd6eae26e5f9b0efcf71e66a890cbec749b1a21fcbb/share/doc/html/src/Control.Retry.html/Control.Retry.html"><span class="hs-identifier">Control.Retry</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Retry</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.html/Data.Aeson.html"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BC</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy.Char8</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BLC</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html/Data.Environment.html"><span class="hs-identifier">Data.Environment</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html"><span class="hs-identifier">Data.FileEmbed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html#makeRelativeToProject"><span class="hs-identifier">makeRelativeToProject</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Strict.html/Data.HashMap.Strict.html"><span class="hs-identifier">Data.HashMap.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/nonempty-containers-0.3.4.5-6253a3619bd9831a5ebd2c53914ef0d1fa73c0ede58b91c10cd19aef7728ba79/share/doc/html/src/Data.Set.NonEmpty.html/Data.Set.NonEmpty.html"><span class="hs-identifier">Data.Set.NonEmpty</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Clock</span></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Database.MSSQL.Pool.html"><span class="hs-identifier">Database.MSSQL.Pool</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MSPool</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.html/Database.PG.Query.html"><span class="hs-identifier">Database.PG.Query</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PG</span></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.html/Database.PG.Query.html"><span class="hs-identifier">Database.PG.Query</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/GHC.AssertNF.CPP.html/GHC.AssertNF.CPP.html"><span class="hs-identifier">GHC.AssertNF.CPP</span></a></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.App.State.html"><span class="hs-identifier">Hasura.App.State</span></a></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Authentication.Role.html"><span class="hs-identifier">Hasura.Authentication.Role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Authentication.Role.html#adminRoleName"><span class="hs-identifier">adminRoleName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Authentication.User.html"><span class="hs-identifier">Hasura.Authentication.User</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Authentication.User.html#ExtraUserInfo"><span class="hs-identifier">ExtraUserInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Authentication.User.html#UserInfo"><span class="hs-identifier">UserInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Connection</span></a></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.html"><span class="hs-identifier">Hasura.Backends.Postgres.Connection</span></a></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.ClientCredentials.html"><span class="hs-identifier">Hasura.ClientCredentials</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.ClientCredentials.html#getEEClientCredentialsTx"><span class="hs-identifier">getEEClientCredentialsTx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.ClientCredentials.html#setEEClientCredentialsTx"><span class="hs-identifier">setEEClientCredentialsTx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.Backend.html"><span class="hs-identifier">Hasura.Eventing.Backend</span></a></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html"><span class="hs-identifier">Hasura.Eventing.Common</span></a></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html"><span class="hs-identifier">Hasura.Eventing.EventTrigger</span></a></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.ScheduledTrigger.html"><span class="hs-identifier">Hasura.Eventing.ScheduledTrigger</span></a></span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.html"><span class="hs-identifier">Hasura.GraphQL.Execute</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#ExecutionStep"><span class="hs-identifier">ExecutionStep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Common.html#MonadGQLExecutionCheck"><span class="hs-identifier">MonadGQLExecutionCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.html#checkQueryInAllowlist"><span class="hs-identifier">checkQueryInAllowlist</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Action.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Action</span></a></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Action.Subscription.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Action.Subscription</span></a></span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ES</span></span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.State</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ES</span></span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Logging.html"><span class="hs-identifier">Hasura.GraphQL.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Logging.ExecutionLog.html#MonadExecutionLog"><span class="hs-identifier">MonadExecutionLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Logging.QueryLog.html#MonadQueryLog"><span class="hs-identifier">MonadQueryLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP</span></a></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#CacheResult"><span class="hs-identifier">CacheResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier">MonadExecuteQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#toParsed"><span class="hs-identifier">toParsed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WSServerApp</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WS</span></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Server</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WS</span></span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#WSServerEnv"><span class="hs-identifier">WSServerEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html"><span class="hs-identifier">Hasura.Metadata.Class</span></a></span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.PingSources.html"><span class="hs-identifier">Hasura.PingSources</span></a></span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.QueryTags.html"><span class="hs-identifier">Hasura.QueryTags</span></a></span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.DDL.EventTrigger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html#MonadEventLogCleanup"><span class="hs-identifier">MonadEventLogCleanup</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache</span></a></span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Common</span></a></span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Config</span></a></span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Catalog.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Catalog</span></a></span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.SchemaRegistry.html"><span class="hs-identifier">Hasura.RQL.DDL.SchemaRegistry</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SchemaRegistry</span></span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Allowlist.html"><span class="hs-identifier">Hasura.RQL.Types.Allowlist</span></a></span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html"><span class="hs-identifier">Hasura.RQL.Types.BackendType</span></a></span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata</span></a></span><span>
</span><span id="line-134"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.ResizePool.html"><span class="hs-identifier">Hasura.RQL.Types.ResizePool</span></a></span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-136"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache.Build</span></a></span><span>
</span><span id="line-137"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-138"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-139"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.API.Query.html"><span class="hs-identifier">Hasura.Server.API.Query</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.API.Query.html#requiresAdmin"><span class="hs-identifier">requiresAdmin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.App.html"><span class="hs-identifier">Hasura.Server.App</span></a></span><span>
</span><span id="line-141"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html"><span class="hs-identifier">Hasura.Server.AppStateRef</span></a></span><span>
</span><span id="line-142"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Auth.html"><span class="hs-identifier">Hasura.Server.Auth</span></a></span><span>
</span><span id="line-143"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.CheckUpdates.html"><span class="hs-identifier">Hasura.Server.CheckUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.CheckUpdates.html#checkForUpdates"><span class="hs-identifier">checkForUpdates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Init.html"><span class="hs-identifier">Hasura.Server.Init</span></a></span><span>
</span><span id="line-145"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html"><span class="hs-identifier">Hasura.Server.Limits</span></a></span><span>
</span><span id="line-146"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html"><span class="hs-identifier">Hasura.Server.Logging</span></a></span><span>
</span><span id="line-147"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Metrics.html"><span class="hs-identifier">Hasura.Server.Metrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier">ServerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html"><span class="hs-identifier">Hasura.Server.Migrate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Migrate.html#migrateCatalog"><span class="hs-identifier">migrateCatalog</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html"><span class="hs-identifier">Hasura.Server.Prometheus</span></a></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier">PrometheusMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#decWarpThreads"><span class="hs-identifier">decWarpThreads</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#incWarpThreads"><span class="hs-identifier">incWarpThreads</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.ResourceChecker.html"><span class="hs-identifier">Hasura.Server.ResourceChecker</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.ResourceChecker.html#getServerResources"><span class="hs-identifier">getServerResources</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html"><span class="hs-identifier">Hasura.Server.SchemaUpdate</span></a></span><span>
</span><span id="line-156"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Telemetry.html"><span class="hs-identifier">Hasura.Server.Telemetry</span></a></span><span>
</span><span id="line-157"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-158"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Version.html"><span class="hs-identifier">Hasura.Server.Version</span></a></span><span>
</span><span id="line-159"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Services.html"><span class="hs-identifier">Hasura.Services</span></a></span><span>
</span><span id="line-160"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.ShutdownLatch.html"><span class="hs-identifier">Hasura.ShutdownLatch</span></a></span><span>
</span><span id="line-161"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span>
</span><span id="line-162"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/http-client-0.7.17-1b2133de2c2ce095aea721bc3d56fba68148ba6d3c4af69a01586f3a88b4e771/share/doc/html/src/Network.HTTP.Client.html/Network.HTTP.Client.html"><span class="hs-identifier">Network.HTTP.Client</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HTTP</span></span><span>
</span><span id="line-163"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.HTTP.Client.CreateManager.html/Network.HTTP.Client.CreateManager.html"><span class="hs-identifier">Network.HTTP.Client.CreateManager</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.HTTP.Client.CreateManager.html/Network.HTTP.Client.CreateManager.html#mkHttpManager"><span class="hs-identifier">mkHttpManager</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.Types.Extended.html/Network.Types.Extended.html"><span class="hs-identifier">Network.Types.Extended</span></a></span><span>
</span><span id="line-165"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/wai-3.2.4-f1faaa95aed979d4a132d2900aa502afdcfa02c1b7b8106923106c2a2a52f9c3/share/doc/html/src/Network.Wai.html/Network.Wai.html"><span class="hs-identifier">Network.Wai</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/wai-3.2.4-f1faaa95aed979d4a132d2900aa502afdcfa02c1b7b8106923106c2a2a52f9c3/share/doc/html/src/Network.Wai.html/Network.Wai.html#Application"><span class="hs-identifier">Application</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.html/Network.Wai.Handler.Warp.html"><span class="hs-identifier">Network.Wai.Handler.Warp</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Warp</span></span><span>
</span><span id="line-167"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/optparse-applicative-0.18.1.0-08df638190761201024420c2e72e640380c9f6597c5ba4a4cf09ccc63be4d34f/share/doc/html/src/Options.Applicative.html/Options.Applicative.html"><span class="hs-identifier">Options.Applicative</span></a></span><span>
</span><span id="line-168"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/refined-0.8.2-0dcf4cad4ded3c586f9b24c73216dddc25503a45bf2f48d52c9d10964a9a8deb/share/doc/html/src/Refined.html/Refined.html"><span class="hs-identifier">Refined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/refined-0.8.2-0dcf4cad4ded3c586f9b24c73216dddc25503a45bf2f48d52c9d10964a9a8deb/share/doc/html/src/Refined.html/Refined.html#unrefine"><span class="hs-identifier">unrefine</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.html/System.Metrics.html"><span class="hs-identifier">System.Metrics</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG</span></span><span>
</span><span id="line-170"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.Gauge.html/System.Metrics.Gauge.html"><span class="hs-identifier">System.Metrics.Gauge</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Gauge</span></span><span>
</span><span id="line-171"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/mustache-2.4.2-3271fd39a3b991c41148584525840a94e2833955ca4e6a2a51c074e7efb812a4/share/doc/html/src/Text.Mustache.Compile.html/Text.Mustache.Compile.html"><span class="hs-identifier">Text.Mustache.Compile</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-172"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/Spock-core-0.14.0.1-4c65b572f2f596b4a392ab1f1cae578fb470ab4a2fb29ebadb96683fd9592f48/share/doc/html/src/Web.Spock.Core.html/Web.Spock.Core.html"><span class="hs-identifier">Web.Spock.Core</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Spock</span></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- Error handling (move to another module!)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="hs-keyword">data</span><span> </span><span id="ExitCode"><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier hs-var">ExitCode</span></a></span></span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- these are used during server initialization:</span><span>
</span><span id="line-179"></span><span>    </span><span id="InvalidEnvironmentVariableOptionsError"><span class="annot"><a href="Hasura.App.html#InvalidEnvironmentVariableOptionsError"><span class="hs-identifier hs-var">InvalidEnvironmentVariableOptionsError</span></a></span></span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="InvalidDatabaseConnectionParamsError"><span class="annot"><a href="Hasura.App.html#InvalidDatabaseConnectionParamsError"><span class="hs-identifier hs-var">InvalidDatabaseConnectionParamsError</span></a></span></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AuthConfigurationError"><span class="annot"><a href="Hasura.App.html#AuthConfigurationError"><span class="hs-identifier hs-var">AuthConfigurationError</span></a></span></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DatabaseMigrationError"><span class="annot"><a href="Hasura.App.html#DatabaseMigrationError"><span class="hs-identifier hs-var">DatabaseMigrationError</span></a></span></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | used by MT because it initialises the schema cache only</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-comment">-- these are used in app/Main.hs:</span><span>
</span><span id="line-185"></span><span>    </span><span id="SchemaCacheInitError"><span class="annot"><a href="Hasura.App.html#SchemaCacheInitError"><span class="hs-identifier hs-var">SchemaCacheInitError</span></a></span></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MetadataExportError"><span class="annot"><a href="Hasura.App.html#MetadataExportError"><span class="hs-identifier hs-var">MetadataExportError</span></a></span></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MetadataCleanError"><span class="annot"><a href="Hasura.App.html#MetadataCleanError"><span class="hs-identifier hs-var">MetadataCleanError</span></a></span></span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DowngradeProcessError"><span class="annot"><a href="Hasura.App.html#DowngradeProcessError"><span class="hs-identifier hs-var">DowngradeProcessError</span></a></span></span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688070973"><span id="local-6989586621688070975"><span id="local-6989586621688070979"><span class="annot"><span class="annottext">Int -&gt; ExitCode -&gt; ShowS
[ExitCode] -&gt; ShowS
ExitCode -&gt; String
(Int -&gt; ExitCode -&gt; ShowS)
-&gt; (ExitCode -&gt; String) -&gt; ([ExitCode] -&gt; ShowS) -&gt; Show ExitCode
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ExitCode -&gt; ShowS
showsPrec :: Int -&gt; ExitCode -&gt; ShowS
$cshow :: ExitCode -&gt; String
show :: ExitCode -&gt; String
$cshowList :: [ExitCode] -&gt; ShowS
showList :: [ExitCode] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-keyword">data</span><span> </span><span id="ExitException"><span class="annot"><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-var">ExitException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ExitException"><span class="annot"><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-var">ExitException</span></a></span></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="eeCode"><span class="annot"><span class="annottext">ExitException -&gt; ExitCode
</span><a href="Hasura.App.html#eeCode"><span class="hs-identifier hs-var hs-var">eeCode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier hs-type">ExitCode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-193"></span><span>    </span><span id="eeMessage"><span class="annot"><span class="annottext">ExitException -&gt; ByteString
</span><a href="Hasura.App.html#eeMessage"><span class="hs-identifier hs-var hs-var">eeMessage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">BC.ByteString</span></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688070987"><span id="local-6989586621688070994"><span id="local-6989586621688070998"><span class="annot"><span class="annottext">Int -&gt; ExitException -&gt; ShowS
[ExitException] -&gt; ShowS
ExitException -&gt; String
(Int -&gt; ExitException -&gt; ShowS)
-&gt; (ExitException -&gt; String)
-&gt; ([ExitException] -&gt; ShowS)
-&gt; Show ExitException
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ExitException -&gt; ShowS
showsPrec :: Int -&gt; ExitException -&gt; ShowS
$cshow :: ExitException -&gt; String
show :: ExitException -&gt; String
$cshowList :: [ExitException] -&gt; ShowS
showList :: [ExitException] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688071005"><span id="local-6989586621688071009"><span id="local-6989586621688071012"><span id="local-6989586621688071015"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-type">ExitException</span></a></span></span></span></span></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span id="local-6989586621688069855"><span class="annot"><a href="Hasura.App.html#throwErrExit"><span class="hs-identifier hs-type">throwErrExit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688069855"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688069856"><span class="annot"><a href="#local-6989586621688069856"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier hs-type">ExitCode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688069855"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688069856"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-200"></span><span id="throwErrExit"><span class="annot"><span class="annottext">throwErrExit :: forall (m :: * -&gt; *) a. MonadIO m =&gt; ExitCode -&gt; String -&gt; m a
</span><a href="Hasura.App.html#throwErrExit"><span class="hs-identifier hs-var hs-var">throwErrExit</span></a></span></span><span> </span><span id="local-6989586621688071023"><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621688071023"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; m a
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; m a) -&gt; (String -&gt; IO a) -&gt; String -&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExitException -&gt; IO a
forall e a. (HasCallStack, Exception e) =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(ExitException -&gt; IO a)
-&gt; (String -&gt; ExitException) -&gt; String -&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExitCode -&gt; ByteString -&gt; ExitException
</span><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-var">ExitException</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621688071023"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ExitException)
-&gt; (String -&gt; ByteString) -&gt; String -&gt; ExitException
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">BC.pack</span></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span id="local-6989586621688069867"><span id="local-6989586621688069868"><span class="annot"><a href="Hasura.App.html#throwErrJExit"><span class="hs-identifier hs-type">throwErrJExit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-type">J.ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688069867"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688069868"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688069869"><span class="annot"><a href="#local-6989586621688069869"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier hs-type">ExitCode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688069867"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688069868"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688069869"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-203"></span><span id="throwErrJExit"><span class="annot"><span class="annottext">throwErrJExit :: forall a (m :: * -&gt; *) b.
(ToJSON a, MonadIO m) =&gt;
ExitCode -&gt; a -&gt; m b
</span><a href="Hasura.App.html#throwErrJExit"><span class="hs-identifier hs-var hs-var">throwErrJExit</span></a></span></span><span> </span><span id="local-6989586621688071034"><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621688071034"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO b -&gt; m b
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO b -&gt; m b) -&gt; (a -&gt; IO b) -&gt; a -&gt; m b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExitException -&gt; IO b
forall e a. (HasCallStack, Exception e) =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(ExitException -&gt; IO b) -&gt; (a -&gt; ExitException) -&gt; a -&gt; IO b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExitCode -&gt; ByteString -&gt; ExitException
</span><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-var">ExitException</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621688071034"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ExitException)
-&gt; (a -&gt; ByteString) -&gt; a -&gt; ExitException
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LazyByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BLC.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(LazyByteString -&gt; ByteString)
-&gt; (a -&gt; LazyByteString) -&gt; a -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; LazyByteString
forall a. ToJSON a =&gt; a -&gt; LazyByteString
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.html/Data.Aeson.html#encode"><span class="hs-identifier hs-var">J.encode</span></a></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="annot"><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-type">accessDeniedErrMsg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-206"></span><span id="accessDeniedErrMsg"><span class="annot"><span class="annottext">accessDeniedErrMsg :: Text
</span><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-var hs-var">accessDeniedErrMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;restricted access : admin only&quot;</span></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- Printing helpers (move to another module!)</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span id="local-6989586621688069876"><span id="local-6989586621688069877"><span class="annot"><a href="Hasura.App.html#printJSON"><span class="hs-identifier hs-type">printJSON</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#ToJSON"><span class="hs-identifier hs-type">J.ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688069876"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688069877"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688069876"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688069877"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-212"></span><span id="printJSON"><span class="annot"><span class="annottext">printJSON :: forall a (m :: * -&gt; *). (ToJSON a, MonadIO m) =&gt; a -&gt; m ()
</span><a href="Hasura.App.html#printJSON"><span class="hs-identifier hs-var hs-var">printJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; (a -&gt; IO ()) -&gt; a -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LazyByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BLC.putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(LazyByteString -&gt; IO ()) -&gt; (a -&gt; LazyByteString) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; LazyByteString
forall a. ToJSON a =&gt; a -&gt; LazyByteString
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.html/Data.Aeson.html#encode"><span class="hs-identifier hs-var">J.encode</span></a></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- Logging</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="annot"><a href="Hasura.App.html#mkPGLogger"><span class="hs-identifier hs-type">mkPGLogger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#PGLogger"><span class="hs-identifier hs-type">PG.PGLogger</span></a></span><span>
</span><span id="line-218"></span><span id="mkPGLogger"><span class="annot"><span class="annottext">mkPGLogger :: Logger Hasura -&gt; PGLogger
</span><a href="Hasura.App.html#mkPGLogger"><span class="hs-identifier hs-var hs-var">mkPGLogger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span id="local-6989586621688071043"><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688071043"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#PLERetryMsg"><span class="hs-identifier hs-type">PG.PLERetryMsg</span></a></span><span> </span><span id="local-6989586621688071045"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688071045"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PGLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688071043"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(PGLog -&gt; IO ()) -&gt; PGLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Value -&gt; PGLog
</span><a href="Hasura.Server.Logging.html#PGLog"><span class="hs-identifier hs-var">PGLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">LevelWarn</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688071045"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="annot"><span class="hs-comment">-- | Create all loggers based on the set of enabled logs and chosen log level.</span></span><span>
</span><span id="line-221"></span><span id="local-6989586621688069890"><span class="annot"><a href="Hasura.App.html#mkLoggers"><span class="hs-identifier hs-type">mkLoggers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688069890"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688069890"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashSet.Internal.html/Data.HashSet.Internal.html#HashSet"><span class="hs-identifier hs-type">HashSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#EngineLogType"><span class="hs-identifier hs-type">EngineLogType</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#LogLevel"><span class="hs-identifier hs-type">LogLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688069890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.App.State.html#Loggers"><span class="hs-identifier hs-type">Loggers</span></a></span></span><span>
</span><span id="line-226"></span><span id="mkLoggers"><span class="annot"><span class="annottext">mkLoggers :: forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m) =&gt;
HashSet (EngineLogType Hasura) -&gt; LogLevel -&gt; ManagedT m Loggers
</span><a href="Hasura.App.html#mkLoggers"><span class="hs-identifier hs-var hs-var">mkLoggers</span></a></span></span><span> </span><span id="local-6989586621688071058"><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688071058"><span class="hs-identifier hs-var">enabledLogs</span></a></span></span><span> </span><span id="local-6989586621688071059"><span class="annot"><span class="annottext">LogLevel
</span><a href="#local-6989586621688071059"><span class="hs-identifier hs-var">logLevel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-227"></span><span>  </span><span id="local-6989586621688071060"><span class="annot"><a href="#local-6989586621688071060"><span class="hs-identifier hs-var">loggerCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LoggerSettings
-&gt; HashSet (EngineLogType Hasura) -&gt; ManagedT m (LoggerCtx Hasura)
forall (io :: * -&gt; *) impl.
(MonadIO io, MonadBaseControl IO io) =&gt;
LoggerSettings
-&gt; HashSet (EngineLogType impl) -&gt; ManagedT io (LoggerCtx impl)
</span><a href="Hasura.Logging.html#mkLoggerCtx"><span class="hs-identifier hs-var">mkLoggerCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; LogLevel -&gt; LoggerSettings
</span><a href="Hasura.Logging.html#defaultLoggerSettings"><span class="hs-identifier hs-var">defaultLoggerSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="#local-6989586621688071059"><span class="hs-identifier hs-var">logLevel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688071058"><span class="hs-identifier hs-var">enabledLogs</span></a></span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688071063"><span class="annot"><a href="#local-6989586621688071063"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura -&gt; Logger Hasura
forall impl.
ToJSON (EngineLogType impl) =&gt;
LoggerCtx impl -&gt; Logger impl
</span><a href="Hasura.Logging.html#mkLogger"><span class="hs-identifier hs-var">mkLogger</span></a></span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura
</span><a href="#local-6989586621688071060"><span class="hs-identifier hs-var">loggerCtx</span></a></span><span>
</span><span id="line-229"></span><span>      </span><span id="local-6989586621688071065"><span class="annot"><a href="#local-6989586621688071065"><span class="hs-identifier hs-var hs-var">pgLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; PGLogger
</span><a href="Hasura.App.html#mkPGLogger"><span class="hs-identifier hs-var">mkPGLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071063"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.App.State.html#Loggers"><span class="hs-identifier hs-type">Loggers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071060"><span class="hs-identifier hs-type">loggerCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071063"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071065"><span class="hs-identifier hs-type">pgLogger</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- Basic connection info</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="hs-comment">-- | Basic information required to connect to the metadata DB, and to the</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- default Postgres DB if any.</span><span>
</span><span id="line-237"></span><span class="hs-keyword">data</span><span> </span><span id="BasicConnectionInfo"><span class="annot"><a href="Hasura.App.html#BasicConnectionInfo"><span class="hs-identifier hs-var">BasicConnectionInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BasicConnectionInfo"><span class="annot"><a href="Hasura.App.html#BasicConnectionInfo"><span class="hs-identifier hs-var">BasicConnectionInfo</span></a></span></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-comment">-- | metadata db connection info</span></span><span>
</span><span id="line-239"></span><span>    </span><span id="bciMetadataConnInfo"><span class="annot"><span class="annottext">BasicConnectionInfo -&gt; ConnInfo
</span><a href="Hasura.App.html#bciMetadataConnInfo"><span class="hs-identifier hs-var hs-var">bciMetadataConnInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#ConnInfo"><span class="hs-identifier hs-type">PG.ConnInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><span class="hs-comment">-- | default postgres connection info, if any</span></span><span>
</span><span id="line-241"></span><span>    </span><span id="bciDefaultPostgres"><span class="annot"><span class="annottext">BasicConnectionInfo -&gt; Maybe PostgresConnConfiguration
</span><a href="Hasura.App.html#bciDefaultPostgres"><span class="hs-identifier hs-var hs-var">bciDefaultPostgres</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#PostgresConnConfiguration"><span class="hs-identifier hs-type">PostgresConnConfiguration</span></a></span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">-- | Only create the metadata connection info.</span><span>
</span><span id="line-245"></span><span class="hs-comment">--</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- Like 'initBasicConnectionInfo', it prioritizes @--metadata-database-url@, and</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- falls back to @--database-url@ otherwise.</span><span>
</span><span id="line-248"></span><span class="hs-comment">--</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- !!! This function throws a fatal error if the @--database-url@ cannot be</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- !!! resolved.</span><span>
</span><span id="line-251"></span><span id="local-6989586621688069908"><span class="annot"><a href="Hasura.App.html#initMetadataConnectionInfo"><span class="hs-identifier hs-type">initMetadataConnectionInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688069908"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><span class="hs-comment">-- | metadata DB URL (--metadata-database-url)</span></span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><span class="hs-comment">-- | user's DB URL (--database-url)</span></span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#PostgresConnInfo"><span class="hs-identifier hs-type">PostgresConnInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#UrlConf"><span class="hs-identifier hs-type">UrlConf</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><a href="#local-6989586621688069908"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#ConnInfo"><span class="hs-identifier hs-type">PG.ConnInfo</span></a></span></span><span>
</span><span id="line-259"></span><span id="initMetadataConnectionInfo"><span class="annot"><span class="annottext">initMetadataConnectionInfo :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Environment
-&gt; Maybe String -&gt; PostgresConnInfo (Maybe UrlConf) -&gt; m ConnInfo
</span><a href="Hasura.App.html#initMetadataConnectionInfo"><span class="hs-identifier hs-var hs-var">initMetadataConnectionInfo</span></a></span></span><span> </span><span id="local-6989586621688071079"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071079"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621688071080"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621688071080"><span class="hs-identifier hs-var">metadataDbURL</span></a></span></span><span> </span><span id="local-6989586621688071081"><span class="annot"><span class="annottext">PostgresConnInfo (Maybe UrlConf)
</span><a href="#local-6989586621688071081"><span class="hs-identifier hs-var">dbURL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><span class="annottext">(BasicConnectionInfo -&gt; ConnInfo)
-&gt; m BasicConnectionInfo -&gt; m ConnInfo
forall a b. (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">BasicConnectionInfo -&gt; ConnInfo
</span><a href="Hasura.App.html#bciMetadataConnInfo"><span class="hs-identifier hs-var">bciMetadataConnInfo</span></a></span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><span class="annottext">(m BasicConnectionInfo -&gt; m ConnInfo)
-&gt; m BasicConnectionInfo -&gt; m ConnInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; Maybe String
-&gt; PostgresConnInfo (Maybe UrlConf)
-&gt; Maybe PostgresPoolSettings
-&gt; Bool
-&gt; TxIsolation
-&gt; m BasicConnectionInfo
forall (m :: * -&gt; *).
MonadIO m =&gt;
Environment
-&gt; Maybe String
-&gt; PostgresConnInfo (Maybe UrlConf)
-&gt; Maybe PostgresPoolSettings
-&gt; Bool
-&gt; TxIsolation
-&gt; m BasicConnectionInfo
</span><a href="Hasura.App.html#initBasicConnectionInfo"><span class="hs-identifier hs-var">initBasicConnectionInfo</span></a></span><span>
</span><span id="line-262"></span><span>      </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071079"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621688071080"><span class="hs-identifier hs-var">metadataDbURL</span></a></span><span>
</span><span id="line-264"></span><span>      </span><span class="annot"><span class="annottext">PostgresConnInfo (Maybe UrlConf)
</span><a href="#local-6989586621688071081"><span class="hs-identifier hs-var">dbURL</span></a></span><span>
</span><span id="line-265"></span><span>      </span><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- ignored</span><span>
</span><span id="line-266"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- ignored</span><span>
</span><span id="line-267"></span><span>      </span><span class="annot"><span class="annottext">TxIsolation
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadCommitted"><span class="hs-identifier hs-var">PG.ReadCommitted</span></a></span><span> </span><span class="hs-comment">-- ignored</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-comment">-- | Create a 'BasicConnectionInfo' based on the given options.</span><span>
</span><span id="line-270"></span><span class="hs-comment">--</span><span>
</span><span id="line-271"></span><span class="hs-comment">-- The default postgres connection is only created when the @--database-url@</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- option is given. If the @--metadata-database-url@ isn't given, the</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- @--database-url@ will be used for the metadata connection.</span><span>
</span><span id="line-274"></span><span class="hs-comment">--</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- All arguments related to the default postgres connection are ignored if the</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- @--database-url@ is missing.</span><span>
</span><span id="line-277"></span><span class="hs-comment">--</span><span>
</span><span id="line-278"></span><span class="hs-comment">-- !!! This function throws a fatal error if the @--database-url@ cannot be</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- !!! resolved.</span><span>
</span><span id="line-280"></span><span id="local-6989586621688069919"><span class="annot"><a href="Hasura.App.html#initBasicConnectionInfo"><span class="hs-identifier hs-type">initBasicConnectionInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688069919"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-comment">-- | metadata DB URL (--metadata-database-url). This is expected to be either</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-comment">-- a postgres connection string URI, or our own @dynamic-from-file@ URI,</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-comment">-- corresponding to the dynamic_from_file feature when connecting a postgres</span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-comment">-- data source.</span><span>
</span><span id="line-287"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-288"></span><span>  </span><span class="annot"><span class="hs-comment">-- | user's DB URL (--database-url)</span></span><span>
</span><span id="line-289"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#PostgresConnInfo"><span class="hs-identifier hs-type">PostgresConnInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#UrlConf"><span class="hs-identifier hs-type">UrlConf</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><span class="hs-comment">-- | pool settings of the default PG connection</span></span><span>
</span><span id="line-291"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#PostgresPoolSettings"><span class="hs-identifier hs-type">PostgresPoolSettings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>  </span><span class="annot"><span class="hs-comment">-- | whether the default PG config should use prepared statements</span></span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>  </span><span class="annot"><span class="hs-comment">-- | default transaction isolation level</span></span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxIsolation"><span class="hs-identifier hs-type">PG.TxIsolation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><a href="#local-6989586621688069919"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#BasicConnectionInfo"><span class="hs-identifier hs-type">BasicConnectionInfo</span></a></span></span><span>
</span><span id="line-297"></span><span id="initBasicConnectionInfo"><span class="annot"><span class="annottext">initBasicConnectionInfo :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Environment
-&gt; Maybe String
-&gt; PostgresConnInfo (Maybe UrlConf)
-&gt; Maybe PostgresPoolSettings
-&gt; Bool
-&gt; TxIsolation
-&gt; m BasicConnectionInfo
</span><a href="Hasura.App.html#initBasicConnectionInfo"><span class="hs-identifier hs-var hs-var">initBasicConnectionInfo</span></a></span></span><span>
</span><span id="line-298"></span><span>  </span><span id="local-6989586621688071106"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071106"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-299"></span><span>  </span><span id="local-6989586621688071107"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621688071107"><span class="hs-identifier hs-var">metadataDbUrl</span></a></span></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Init.Config.html#PostgresConnInfo"><span class="hs-identifier hs-type">PostgresConnInfo</span></a></span><span> </span><span id="local-6989586621688071109"><span class="annot"><span class="annottext">Maybe UrlConf
</span><a href="#local-6989586621688071109"><span class="hs-identifier hs-var">dbUrlConf</span></a></span></span><span> </span><span id="local-6989586621688071110"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688071110"><span class="hs-identifier hs-var">maybeRetries</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>  </span><span id="local-6989586621688071111"><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
</span><a href="#local-6989586621688071111"><span class="hs-identifier hs-var">poolSettings</span></a></span></span><span>
</span><span id="line-302"></span><span>  </span><span id="local-6989586621688071112"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688071112"><span class="hs-identifier hs-var">usePreparedStatements</span></a></span></span><span>
</span><span id="line-303"></span><span>  </span><span id="local-6989586621688071113"><span class="annot"><span class="annottext">TxIsolation
</span><a href="#local-6989586621688071113"><span class="hs-identifier hs-var">isolationLevel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621688071107"><span class="hs-identifier hs-var">metadataDbUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe UrlConf
</span><a href="#local-6989586621688071109"><span class="hs-identifier hs-var">dbUrlConf</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-305"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe UrlConf
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-306"></span><span>        </span><span class="annot"><span class="annottext">ExitCode -&gt; String -&gt; m BasicConnectionInfo
forall a. ExitCode -&gt; String -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; ExitCode -&gt; String -&gt; m a
</span><a href="Hasura.App.html#throwErrExit"><span class="hs-identifier hs-var">throwErrExit</span></a></span><span>
</span><span id="line-307"></span><span>          </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#InvalidDatabaseConnectionParamsError"><span class="hs-identifier hs-var">InvalidDatabaseConnectionParamsError</span></a></span><span>
</span><span id="line-308"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Fatal Error: Either of --metadata-database-url or --database-url option expected&quot;</span></span><span>
</span><span id="line-309"></span><span>      </span><span class="hs-comment">-- If no metadata storage specified consider use default database as</span><span>
</span><span id="line-310"></span><span>      </span><span class="hs-comment">-- metadata storage</span><span>
</span><span id="line-311"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688071114"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688071114"><span class="hs-identifier hs-var">srcURL</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>        </span><span id="local-6989586621688071115"><span class="annot"><a href="#local-6989586621688071115"><span class="hs-identifier hs-var">srcConnInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Environment -&gt; UrlConf -&gt; Maybe Int -&gt; m ConnInfo
forall (m :: * -&gt; *).
MonadIO m =&gt;
Environment -&gt; UrlConf -&gt; Maybe Int -&gt; m ConnInfo
</span><a href="Hasura.App.html#resolvePostgresConnInfo"><span class="hs-identifier hs-var">resolvePostgresConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071106"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688071114"><span class="hs-identifier hs-var">srcURL</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688071110"><span class="hs-identifier hs-var">maybeRetries</span></a></span><span>
</span><span id="line-313"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.App.html#BasicConnectionInfo"><span class="hs-identifier hs-type">BasicConnectionInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071115"><span class="hs-identifier hs-type">srcConnInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621688071116"><span class="hs-identifier hs-type">mkSourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071114"><span class="hs-identifier hs-type">srcURL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688071117"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071117"><span class="hs-identifier hs-var">mdURL</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe UrlConf
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-315"></span><span>        </span><span class="annot"><span class="annottext">BasicConnectionInfo -&gt; m BasicConnectionInfo
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(BasicConnectionInfo -&gt; m BasicConnectionInfo)
-&gt; BasicConnectionInfo -&gt; m BasicConnectionInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnInfo -&gt; Maybe PostgresConnConfiguration -&gt; BasicConnectionInfo
</span><a href="Hasura.App.html#BasicConnectionInfo"><span class="hs-identifier hs-var">BasicConnectionInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ConnInfo
</span><a href="#local-6989586621688071118"><span class="hs-identifier hs-var">mkConnInfoFromMDB</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071117"><span class="hs-identifier hs-var">mdURL</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe PostgresConnConfiguration
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-316"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688071119"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071119"><span class="hs-identifier hs-var">mdURL</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688071120"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688071120"><span class="hs-identifier hs-var">srcURL</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>        </span><span id="local-6989586621688071121"><span class="annot"><a href="#local-6989586621688071121"><span class="hs-identifier hs-var">_srcConnInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Environment -&gt; UrlConf -&gt; Maybe Int -&gt; m ConnInfo
forall (m :: * -&gt; *).
MonadIO m =&gt;
Environment -&gt; UrlConf -&gt; Maybe Int -&gt; m ConnInfo
</span><a href="Hasura.App.html#resolvePostgresConnInfo"><span class="hs-identifier hs-var">resolvePostgresConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071106"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688071120"><span class="hs-identifier hs-var">srcURL</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688071110"><span class="hs-identifier hs-var">maybeRetries</span></a></span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.App.html#BasicConnectionInfo"><span class="hs-identifier hs-type">BasicConnectionInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688071118"><span class="hs-identifier hs-type">mkConnInfoFromMDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071119"><span class="hs-identifier hs-type">mdURL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621688071116"><span class="hs-identifier hs-type">mkSourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071120"><span class="hs-identifier hs-type">srcURL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-320"></span><span>      </span><span class="hs-comment">-- Our own made up URI scheme corresponding to the dynamic_from_file feature</span><span>
</span><span id="line-321"></span><span>      </span><span class="hs-comment">-- NOTE: Since this can only be set by the administrator, there's no need</span><span>
</span><span id="line-322"></span><span>      </span><span class="hs-comment">-- to validate against something like HASURA_GRAPHQL_DYNAMIC_SECRETS_ALLOWED_PATH_PREFIX</span><span>
</span><span id="line-323"></span><span>      </span><span id="local-6989586621688071125"><span class="annot"><span class="annottext">dynamicScheme :: String
</span><a href="#local-6989586621688071125"><span class="hs-identifier hs-var hs-var">dynamicScheme</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dynamic-from-file://&quot;</span></span><span>
</span><span id="line-324"></span><span>      </span><span id="local-6989586621688071118"><span class="annot"><span class="annottext">mkConnInfoFromMDB :: String -&gt; ConnInfo
</span><a href="#local-6989586621688071118"><span class="hs-identifier hs-var hs-var">mkConnInfoFromMDB</span></a></span></span><span> </span><span id="local-6989586621688071126"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071126"><span class="hs-identifier hs-var">mdbURL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-325"></span><span>        </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#ConnInfo"><span class="hs-identifier hs-type">PG.ConnInfo</span></a></span><span>
</span><span id="line-326"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ciRetries :: Int
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#ciRetries"><span class="hs-identifier hs-var">PG.ciRetries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688071110"><span class="hs-identifier hs-var">maybeRetries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-327"></span><span>            </span><span class="annot"><span class="annottext">ciDetails :: ConnDetails
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#ciDetails"><span class="hs-identifier hs-var">PG.ciDetails</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; String -&gt; (String, String)
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071125"><span class="hs-identifier hs-var">dynamicScheme</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071126"><span class="hs-identifier hs-var">mdbURL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-328"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621688071133"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071133"><span class="hs-identifier hs-var">mbDynamicScheme</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688071134"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071134"><span class="hs-identifier hs-var">mbPath</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071133"><span class="hs-identifier hs-var">mbDynamicScheme</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071125"><span class="hs-identifier hs-var">dynamicScheme</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-330"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; ConnDetails
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#CDDynamicDatabaseURI"><span class="hs-identifier hs-var">PG.CDDynamicDatabaseURI</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071134"><span class="hs-identifier hs-var">mbPath</span></a></span><span>
</span><span id="line-331"></span><span>              </span><span class="annot"><span class="annottext">(String, String)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ConnDetails
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#CDDatabaseURI"><span class="hs-identifier hs-var">PG.CDDatabaseURI</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ConnDetails) -&gt; ByteString -&gt; ConnDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#txtToBs"><span class="hs-identifier hs-var">txtToBs</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ByteString) -&gt; Text -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688071126"><span class="hs-identifier hs-var">mdbURL</span></a></span><span>
</span><span id="line-332"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-333"></span><span>      </span><span id="local-6989586621688071116"><span class="annot"><span class="annottext">mkSourceConfig :: UrlConf -&gt; PostgresConnConfiguration
</span><a href="#local-6989586621688071116"><span class="hs-identifier hs-var hs-var">mkSourceConfig</span></a></span></span><span> </span><span id="local-6989586621688071139"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688071139"><span class="hs-identifier hs-var">srcURL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-334"></span><span>        </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#PostgresConnConfiguration"><span class="hs-identifier hs-type">PostgresConnConfiguration</span></a></span><span>
</span><span id="line-335"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">pccConnectionInfo :: PostgresSourceConnInfo
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#pccConnectionInfo"><span class="hs-identifier hs-var">pccConnectionInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-336"></span><span>              </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#PostgresSourceConnInfo"><span class="hs-identifier hs-type">PostgresSourceConnInfo</span></a></span><span>
</span><span id="line-337"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">psciDatabaseUrl :: UrlConf
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#psciDatabaseUrl"><span class="hs-identifier hs-var">psciDatabaseUrl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688071139"><span class="hs-identifier hs-var">srcURL</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-338"></span><span>                  </span><span class="annot"><span class="annottext">psciPoolSettings :: Maybe PostgresPoolSettings
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#psciPoolSettings"><span class="hs-identifier hs-var">psciPoolSettings</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
</span><a href="#local-6989586621688071111"><span class="hs-identifier hs-var">poolSettings</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-339"></span><span>                  </span><span class="annot"><span class="annottext">psciUsePreparedStatements :: Bool
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#psciUsePreparedStatements"><span class="hs-identifier hs-var">psciUsePreparedStatements</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688071112"><span class="hs-identifier hs-var">usePreparedStatements</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-340"></span><span>                  </span><span class="annot"><span class="annottext">psciIsolationLevel :: TxIsolation
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#psciIsolationLevel"><span class="hs-identifier hs-var">psciIsolationLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxIsolation
</span><a href="#local-6989586621688071113"><span class="hs-identifier hs-var">isolationLevel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-341"></span><span>                  </span><span class="annot"><span class="annottext">psciSslConfiguration :: Maybe (PGClientCerts CertVar CertVar)
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#psciSslConfiguration"><span class="hs-identifier hs-var">psciSslConfiguration</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (PGClientCerts CertVar CertVar)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-342"></span><span>                </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-343"></span><span>            </span><span class="annot"><span class="annottext">pccReadReplicas :: Maybe (NonEmpty PostgresSourceConnInfo)
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#pccReadReplicas"><span class="hs-identifier hs-var">pccReadReplicas</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty PostgresSourceConnInfo)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-344"></span><span>            </span><span class="annot"><span class="annottext">pccExtensionsSchema :: ExtensionsSchema
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#pccExtensionsSchema"><span class="hs-identifier hs-var">pccExtensionsSchema</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtensionsSchema
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#defaultPostgresExtensionsSchema"><span class="hs-identifier hs-var">defaultPostgresExtensionsSchema</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-345"></span><span>            </span><span class="annot"><span class="annottext">pccConnectionTemplate :: Maybe ConnectionTemplate
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#pccConnectionTemplate"><span class="hs-identifier hs-var">pccConnectionTemplate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ConnectionTemplate
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-346"></span><span>            </span><span class="annot"><span class="annottext">pccConnectionSet :: Maybe PostgresConnectionSet
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#pccConnectionSet"><span class="hs-identifier hs-var">pccConnectionSet</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe PostgresConnectionSet
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-347"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span class="hs-comment">-- | Creates a 'PG.ConnInfo' from a 'UrlConf' parameter.</span><span>
</span><span id="line-350"></span><span class="hs-comment">--</span><span>
</span><span id="line-351"></span><span class="hs-comment">-- !!! throws a fatal error if the configuration is invalid</span><span>
</span><span id="line-352"></span><span id="local-6989586621688069924"><span class="annot"><a href="Hasura.App.html#resolvePostgresConnInfo"><span class="hs-identifier hs-type">resolvePostgresConnInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688069924"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-354"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-355"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#UrlConf"><span class="hs-identifier hs-type">UrlConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-356"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-357"></span><span>  </span><span class="annot"><a href="#local-6989586621688069924"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#ConnInfo"><span class="hs-identifier hs-type">PG.ConnInfo</span></a></span></span><span>
</span><span id="line-358"></span><span id="resolvePostgresConnInfo"><span class="annot"><span class="annottext">resolvePostgresConnInfo :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Environment -&gt; UrlConf -&gt; Maybe Int -&gt; m ConnInfo
</span><a href="Hasura.App.html#resolvePostgresConnInfo"><span class="hs-identifier hs-var hs-var">resolvePostgresConnInfo</span></a></span></span><span> </span><span id="local-6989586621688071167"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071167"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621688071168"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688071168"><span class="hs-identifier hs-var">dbUrlConf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621688071169"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688071169"><span class="hs-identifier hs-var">retries</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-359"></span><span>  </span><span id="local-6989586621688071170"><span class="annot"><a href="#local-6989586621688071170"><span class="hs-identifier hs-var">connDetails</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-360"></span><span>    </span><span class="annot"><span class="annottext">ExceptT QErr m ConnDetails -&gt; m (Either QErr ConnDetails)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Environment -&gt; UrlConf -&gt; ExceptT QErr m ConnDetails
forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
Environment -&gt; UrlConf -&gt; m ConnDetails
</span><a href="Hasura.RQL.Types.Common.html#resolveUrlConf"><span class="hs-identifier hs-var">resolveUrlConf</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071167"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688071168"><span class="hs-identifier hs-var">dbUrlConf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>      </span><span class="annot"><span class="annottext">m (Either QErr ConnDetails)
-&gt; (Either QErr ConnDetails -&gt; m ConnDetails) -&gt; m ConnDetails
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(QErr -&gt; m ConnDetails)
-&gt; (ConnDetails -&gt; m ConnDetails)
-&gt; Either QErr ConnDetails
-&gt; m ConnDetails
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO ConnDetails -&gt; m ConnDetails
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ConnDetails -&gt; m ConnDetails)
-&gt; (QErr -&gt; IO ConnDetails) -&gt; QErr -&gt; m ConnDetails
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExitCode -&gt; QErr -&gt; IO ConnDetails
forall b. ExitCode -&gt; QErr -&gt; IO b
forall a (m :: * -&gt; *) b.
(ToJSON a, MonadIO m) =&gt;
ExitCode -&gt; a -&gt; m b
</span><a href="Hasura.App.html#throwErrJExit"><span class="hs-identifier hs-var">throwErrJExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#InvalidDatabaseConnectionParamsError"><span class="hs-identifier hs-var">InvalidDatabaseConnectionParamsError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConnDetails -&gt; m ConnDetails
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-362"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#ConnInfo"><span class="hs-identifier hs-type">PG.ConnInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071169"><span class="hs-identifier hs-type">retries</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071170"><span class="hs-identifier hs-type">connDetails</span></a></span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-365"></span><span class="hs-comment">-- App init</span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span class="hs-comment">-- | The initialisation of the app is split into several functions, for clarity;</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- but there are several pieces of information that need to be threaded across</span><span>
</span><span id="line-369"></span><span class="hs-comment">-- those initialisation functions. This small data structure groups together all</span><span>
</span><span id="line-370"></span><span class="hs-comment">-- such pieces of information that are required throughout the initialisation,</span><span>
</span><span id="line-371"></span><span class="hs-comment">-- but that aren't needed in the rest of the application.</span><span>
</span><span id="line-372"></span><span class="hs-keyword">data</span><span> </span><span id="AppInit"><span class="annot"><a href="Hasura.App.html#AppInit"><span class="hs-identifier hs-var">AppInit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AppInit"><span class="annot"><a href="Hasura.App.html#AppInit"><span class="hs-identifier hs-var">AppInit</span></a></span></span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="aiTLSAllowListRef"><span class="annot"><span class="annottext">AppInit -&gt; TLSAllowListRef
</span><a href="Hasura.App.html#aiTLSAllowListRef"><span class="hs-identifier hs-var hs-var">aiTLSAllowListRef</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#TLSAllowListRef"><span class="hs-identifier hs-type">TLSAllowListRef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-374"></span><span>    </span><span id="aiMetadataWithResourceVersion"><span class="annot"><span class="annottext">AppInit -&gt; MetadataWithResourceVersion
</span><a href="Hasura.App.html#aiMetadataWithResourceVersion"><span class="hs-identifier hs-var hs-var">aiMetadataWithResourceVersion</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataWithResourceVersion"><span class="hs-identifier hs-type">MetadataWithResourceVersion</span></a></span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span class="hs-comment">-- | Initializes or migrates the catalog and creates the 'AppEnv' required to</span><span>
</span><span id="line-378"></span><span class="hs-comment">-- start the server, and also create the 'AppInit' that needs to be threaded</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- along the init code.</span><span>
</span><span id="line-380"></span><span class="hs-comment">--</span><span>
</span><span id="line-381"></span><span class="hs-comment">-- For historical reasons, this function performs a few additional startup tasks</span><span>
</span><span id="line-382"></span><span class="hs-comment">-- that are not required to create the 'AppEnv', such as starting background</span><span>
</span><span id="line-383"></span><span class="hs-comment">-- processes and logging startup information. All of those are flagged with a</span><span>
</span><span id="line-384"></span><span class="hs-comment">-- comment marking them as a side-effect.</span><span>
</span><span id="line-385"></span><span class="hs-comment">--</span><span>
</span><span id="line-386"></span><span class="hs-comment">-- NOTE: this is invoked in pro, but only for OSS mode (no license key)</span><span>
</span><span id="line-387"></span><span id="local-6989586621688069952"><span class="annot"><a href="Hasura.App.html#initialiseAppEnv"><span class="hs-identifier hs-type">initialiseAppEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688069952"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-389"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-390"></span><span>  </span><span class="annot"><a href="Hasura.App.html#BasicConnectionInfo"><span class="hs-identifier hs-type">BasicConnectionInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-391"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#ServeOptions"><span class="hs-identifier hs-type">ServeOptions</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-392"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier hs-type">ES.SubscriptionPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-393"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-394"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier hs-type">PrometheusMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-395"></span><span>  </span><span class="annot"><a href="Hasura.Tracing.Sampling.html#SamplingPolicy"><span class="hs-identifier hs-type">SamplingPolicy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-396"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688069952"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#AppInit"><span class="hs-identifier hs-type">AppInit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-397"></span><span id="initialiseAppEnv"><span class="annot"><span class="annottext">initialiseAppEnv :: forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
Environment
-&gt; BasicConnectionInfo
-&gt; ServeOptions Hasura
-&gt; Maybe SubscriptionPostPollHook
-&gt; ServerMetrics
-&gt; PrometheusMetrics
-&gt; SamplingPolicy
-&gt; ManagedT m (AppInit, AppEnv)
</span><a href="Hasura.App.html#initialiseAppEnv"><span class="hs-identifier hs-var hs-var">initialiseAppEnv</span></a></span></span><span> </span><span id="local-6989586621688071256"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071256"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><a href="Hasura.App.html#BasicConnectionInfo"><span class="hs-identifier hs-type">BasicConnectionInfo</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688071257"><span id="local-6989586621688071258"><span class="annot"><span class="annottext">Maybe PostgresConnConfiguration
ConnInfo
bciMetadataConnInfo :: BasicConnectionInfo -&gt; ConnInfo
bciDefaultPostgres :: BasicConnectionInfo -&gt; Maybe PostgresConnConfiguration
bciMetadataConnInfo :: ConnInfo
bciDefaultPostgres :: Maybe PostgresConnConfiguration
</span><a href="Hasura.App.html#bciMetadataConnInfo"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621688071259"><span class="annot"><span class="annottext">serveOptions :: ServeOptions Hasura
</span><a href="#local-6989586621688071259"><span class="hs-identifier hs-var">serveOptions</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.Server.Init.Config.html#ServeOptions"><span class="hs-identifier hs-type">ServeOptions</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688071261"><span id="local-6989586621688071262"><span id="local-6989586621688071263"><span id="local-6989586621688071264"><span id="local-6989586621688071265"><span id="local-6989586621688071266"><span id="local-6989586621688071267"><span id="local-6989586621688071268"><span id="local-6989586621688071269"><span id="local-6989586621688071270"><span id="local-6989586621688071271"><span id="local-6989586621688071272"><span id="local-6989586621688071273"><span id="local-6989586621688071274"><span id="local-6989586621688071275"><span id="local-6989586621688071276"><span id="local-6989586621688071277"><span id="local-6989586621688071278"><span id="local-6989586621688071279"><span id="local-6989586621688071280"><span id="local-6989586621688071281"><span id="local-6989586621688071282"><span id="local-6989586621688071283"><span id="local-6989586621688071284"><span id="local-6989586621688071285"><span id="local-6989586621688071286"><span id="local-6989586621688071287"><span id="local-6989586621688071288"><span id="local-6989586621688071289"><span id="local-6989586621688071290"><span id="local-6989586621688071291"><span id="local-6989586621688071292"><span id="local-6989586621688071293"><span id="local-6989586621688071294"><span id="local-6989586621688071295"><span id="local-6989586621688071296"><span id="local-6989586621688071297"><span id="local-6989586621688071298"><span id="local-6989586621688071299"><span id="local-6989586621688071300"><span id="local-6989586621688071301"><span id="local-6989586621688071302"><span id="local-6989586621688071303"><span id="local-6989586621688071304"><span id="local-6989586621688071305"><span id="local-6989586621688071306"><span id="local-6989586621688071307"><span id="local-6989586621688071308"><span id="local-6989586621688071309"><span id="local-6989586621688071310"><span id="local-6989586621688071311"><span id="local-6989586621688071312"><span id="local-6989586621688071313"><span class="annot"><span class="annottext">Int
[JWTConfig]
Maybe Text
Maybe RoleName
Maybe AuthHook
HostPreference
HashSet ExperimentalFeature
HashSet (EngineLogType Hasura)
HashSet AdminSecretHash
HashSet API
TxIsolation
ConnParams
Refined NonNegative Int
Refined NonNegative Milliseconds
Refined NonNegative Seconds
Refined Positive Int
ConnectionOptions
StreamQueriesOptions
NamingCase
RemoteSchemaPermissions
InferFunctionPermissions
RemoteNullForwardingPolicy
BackwardsCompatibleNullInNonNullableVariables
DangerouslyCollapseBooleans
StringifyNumbers
ExtensionsSchema
CorsConfig
PersistedQueriesState
CloseWebsocketsOnMetadataChangeStatus
TriggersErrorLogLevelStatus
ApolloFederationStatus
EventingMode
ReadOnlyMode
MaintenanceMode ()
TraceQueryStatus
LogLevel
HttpLogQueryOnlyOnError
MetadataQueryLoggingMode
MetadataDefaults
WSConnectionInitTimeout
KeepAliveDelay
OptionalInterval
Port
TelemetryStatus
DevModeStatus
AllowListStatus
AdminInternalErrorsStatus
ConsoleStatus
soPort :: Port
soHost :: HostPreference
soConnParams :: ConnParams
soTxIso :: TxIsolation
soAdminSecret :: HashSet AdminSecretHash
soAuthHook :: Maybe AuthHook
soJwtSecret :: [JWTConfig]
soUnAuthRole :: Maybe RoleName
soCorsConfig :: CorsConfig
soConsoleStatus :: ConsoleStatus
soConsoleAssetsDir :: Maybe Text
soConsoleSentryDsn :: Maybe Text
soEnableTelemetry :: TelemetryStatus
soStringifyNum :: StringifyNumbers
soDangerousBooleanCollapse :: DangerouslyCollapseBooleans
soBackwardsCompatibleNullInNonNullableVariables :: BackwardsCompatibleNullInNonNullableVariables
soRemoteNullForwardingPolicy :: RemoteNullForwardingPolicy
soEnabledAPIs :: HashSet API
soLiveQueryOpts :: StreamQueriesOptions
soStreamingQueryOpts :: StreamQueriesOptions
soEnableAllowList :: AllowListStatus
soEnabledLogTypes :: HashSet (EngineLogType Hasura)
soLogLevel :: LogLevel
soEventsHttpPoolSize :: Refined Positive Int
soEventsFetchInterval :: Refined NonNegative Milliseconds
soAsyncActionsFetchInterval :: OptionalInterval
soEnableRemoteSchemaPermissions :: RemoteSchemaPermissions
soConnectionOptions :: ConnectionOptions
soWebSocketKeepAlive :: KeepAliveDelay
soInferFunctionPermissions :: InferFunctionPermissions
soEnableMaintenanceMode :: MaintenanceMode ()
soSchemaPollInterval :: OptionalInterval
soExperimentalFeatures :: HashSet ExperimentalFeature
soEventsFetchBatchSize :: Refined NonNegative Int
soDevMode :: DevModeStatus
soAdminInternalErrors :: AdminInternalErrorsStatus
soGracefulShutdownTimeout :: Refined NonNegative Seconds
soWebSocketConnectionInitTimeout :: WSConnectionInitTimeout
soEventingMode :: EventingMode
soReadOnlyMode :: ReadOnlyMode
soEnableMetadataQueryLogging :: MetadataQueryLoggingMode
soHttpLogQueryOnlyOnError :: HttpLogQueryOnlyOnError
soDefaultNamingConvention :: NamingCase
soExtensionsSchema :: ExtensionsSchema
soMetadataDefaults :: MetadataDefaults
soApolloFederationStatus :: ApolloFederationStatus
soCloseWebsocketsOnMetadataChangeStatus :: CloseWebsocketsOnMetadataChangeStatus
soMaxTotalHeaderLength :: Int
soTriggersErrorLogLevelStatus :: TriggersErrorLogLevelStatus
soAsyncActionsFetchBatchSize :: Int
soPersistedQueries :: PersistedQueriesState
soPersistedQueriesTtl :: Int
soTraceQueryStatus :: TraceQueryStatus
soTraceQueryStatus :: forall impl. ServeOptions impl -&gt; TraceQueryStatus
soPersistedQueriesTtl :: forall impl. ServeOptions impl -&gt; Int
soPersistedQueries :: forall impl. ServeOptions impl -&gt; PersistedQueriesState
soAsyncActionsFetchBatchSize :: forall impl. ServeOptions impl -&gt; Int
soTriggersErrorLogLevelStatus :: forall impl. ServeOptions impl -&gt; TriggersErrorLogLevelStatus
soMaxTotalHeaderLength :: forall impl. ServeOptions impl -&gt; Int
soCloseWebsocketsOnMetadataChangeStatus :: forall impl.
ServeOptions impl -&gt; CloseWebsocketsOnMetadataChangeStatus
soApolloFederationStatus :: forall impl. ServeOptions impl -&gt; ApolloFederationStatus
soMetadataDefaults :: forall impl. ServeOptions impl -&gt; MetadataDefaults
soExtensionsSchema :: forall impl. ServeOptions impl -&gt; ExtensionsSchema
soDefaultNamingConvention :: forall impl. ServeOptions impl -&gt; NamingCase
soHttpLogQueryOnlyOnError :: forall impl. ServeOptions impl -&gt; HttpLogQueryOnlyOnError
soEnableMetadataQueryLogging :: forall impl. ServeOptions impl -&gt; MetadataQueryLoggingMode
soReadOnlyMode :: forall impl. ServeOptions impl -&gt; ReadOnlyMode
soEventingMode :: forall impl. ServeOptions impl -&gt; EventingMode
soWebSocketConnectionInitTimeout :: forall impl. ServeOptions impl -&gt; WSConnectionInitTimeout
soGracefulShutdownTimeout :: forall impl. ServeOptions impl -&gt; Refined NonNegative Seconds
soAdminInternalErrors :: forall impl. ServeOptions impl -&gt; AdminInternalErrorsStatus
soDevMode :: forall impl. ServeOptions impl -&gt; DevModeStatus
soEventsFetchBatchSize :: forall impl. ServeOptions impl -&gt; Refined NonNegative Int
soExperimentalFeatures :: forall impl. ServeOptions impl -&gt; HashSet ExperimentalFeature
soSchemaPollInterval :: forall impl. ServeOptions impl -&gt; OptionalInterval
soEnableMaintenanceMode :: forall impl. ServeOptions impl -&gt; MaintenanceMode ()
soInferFunctionPermissions :: forall impl. ServeOptions impl -&gt; InferFunctionPermissions
soWebSocketKeepAlive :: forall impl. ServeOptions impl -&gt; KeepAliveDelay
soConnectionOptions :: forall impl. ServeOptions impl -&gt; ConnectionOptions
soEnableRemoteSchemaPermissions :: forall impl. ServeOptions impl -&gt; RemoteSchemaPermissions
soAsyncActionsFetchInterval :: forall impl. ServeOptions impl -&gt; OptionalInterval
soEventsFetchInterval :: forall impl. ServeOptions impl -&gt; Refined NonNegative Milliseconds
soEventsHttpPoolSize :: forall impl. ServeOptions impl -&gt; Refined Positive Int
soLogLevel :: forall impl. ServeOptions impl -&gt; LogLevel
soEnabledLogTypes :: forall impl. ServeOptions impl -&gt; HashSet (EngineLogType impl)
soEnableAllowList :: forall impl. ServeOptions impl -&gt; AllowListStatus
soStreamingQueryOpts :: forall impl. ServeOptions impl -&gt; StreamQueriesOptions
soLiveQueryOpts :: forall impl. ServeOptions impl -&gt; StreamQueriesOptions
soEnabledAPIs :: forall impl. ServeOptions impl -&gt; HashSet API
soRemoteNullForwardingPolicy :: forall impl. ServeOptions impl -&gt; RemoteNullForwardingPolicy
soBackwardsCompatibleNullInNonNullableVariables :: forall impl.
ServeOptions impl -&gt; BackwardsCompatibleNullInNonNullableVariables
soDangerousBooleanCollapse :: forall impl. ServeOptions impl -&gt; DangerouslyCollapseBooleans
soStringifyNum :: forall impl. ServeOptions impl -&gt; StringifyNumbers
soEnableTelemetry :: forall impl. ServeOptions impl -&gt; TelemetryStatus
soConsoleSentryDsn :: forall impl. ServeOptions impl -&gt; Maybe Text
soConsoleAssetsDir :: forall impl. ServeOptions impl -&gt; Maybe Text
soConsoleStatus :: forall impl. ServeOptions impl -&gt; ConsoleStatus
soCorsConfig :: forall impl. ServeOptions impl -&gt; CorsConfig
soUnAuthRole :: forall impl. ServeOptions impl -&gt; Maybe RoleName
soJwtSecret :: forall impl. ServeOptions impl -&gt; [JWTConfig]
soAuthHook :: forall impl. ServeOptions impl -&gt; Maybe AuthHook
soAdminSecret :: forall impl. ServeOptions impl -&gt; HashSet AdminSecretHash
soTxIso :: forall impl. ServeOptions impl -&gt; TxIsolation
soConnParams :: forall impl. ServeOptions impl -&gt; ConnParams
soHost :: forall impl. ServeOptions impl -&gt; HostPreference
soPort :: forall impl. ServeOptions impl -&gt; Port
</span><a href="#local-6989586621688071261"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621688071367"><span class="annot"><span class="annottext">Maybe SubscriptionPostPollHook
</span><a href="#local-6989586621688071367"><span class="hs-identifier hs-var">liveQueryHook</span></a></span></span><span> </span><span id="local-6989586621688071368"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688071368"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span> </span><span id="local-6989586621688071369"><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688071369"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span></span><span> </span><span id="local-6989586621688071370"><span class="annot"><span class="annottext">SamplingPolicy
</span><a href="#local-6989586621688071370"><span class="hs-identifier hs-var">traceSamplingPolicy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>  </span><span id="local-6989586621688071371"><span class="annot"><a href="#local-6989586621688071371"><span class="hs-identifier hs-var">loggers</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.State.html#Loggers"><span class="hs-identifier hs-type">Loggers</span></a></span><span> </span><span id="local-6989586621688071372"><span class="annot"><a href="#local-6989586621688071372"><span class="hs-identifier hs-var">_loggerCtx</span></a></span></span><span> </span><span id="local-6989586621688071373"><span class="annot"><a href="#local-6989586621688071373"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688071374"><span class="annot"><a href="#local-6989586621688071374"><span class="hs-identifier hs-var">pgLogger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura) -&gt; LogLevel -&gt; ManagedT m Loggers
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m) =&gt;
HashSet (EngineLogType Hasura) -&gt; LogLevel -&gt; ManagedT m Loggers
</span><a href="Hasura.App.html#mkLoggers"><span class="hs-identifier hs-var">mkLoggers</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688071282"><span class="hs-identifier hs-var">soEnabledLogTypes</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="#local-6989586621688071283"><span class="hs-identifier hs-var">soLogLevel</span></a></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>  </span><span class="hs-comment">-- SIDE EFFECT: print a warning if no admin secret is set.</span><span>
</span><span id="line-401"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621688071265"><span class="hs-identifier hs-type">soAdminSecret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>    </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span>
</span><span id="line-403"></span><span>      </span><span class="annot"><a href="#local-6989586621688071373"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><a href="Hasura.Server.Logging.html#StartupLog"><span class="hs-identifier hs-type">StartupLog</span></a></span><span>
</span><span id="line-405"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html#slLogLevel"><span class="hs-identifier hs-var">slLogLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-type">LevelWarn</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-406"></span><span>          </span><span class="annot"><a href="Hasura.Server.Logging.html#slKind"><span class="hs-identifier hs-var">slKind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;no_admin_secret&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-407"></span><span>          </span><span class="annot"><a href="Hasura.Server.Logging.html#slInfo"><span class="hs-identifier hs-var">slInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-type">J.toJSON</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;WARNING: No admin secret provided&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-comment">-- SIDE EFFECT: log all server options.</span><span>
</span><span id="line-411"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071373"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Logging.html#serveOptsToLog"><span class="hs-identifier hs-type">serveOptsToLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071259"><span class="hs-identifier hs-type">serveOptions</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-comment">-- SIDE EFFECT: log metadata postgres connection info.</span><span>
</span><span id="line-414"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071373"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Logging.html#connInfoToLog"><span class="hs-identifier hs-type">connInfoToLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071257"><span class="hs-identifier hs-type">bciMetadataConnInfo</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-comment">-- Generate the instance id.</span><span>
</span><span id="line-417"></span><span>  </span><span id="local-6989586621688071385"><span class="annot"><a href="#local-6989586621688071385"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#generateInstanceId"><span class="hs-identifier hs-type">generateInstanceId</span></a></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621688071387"><span class="hs-identifier hs-type">connectionContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.Internal.html/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span>
</span><span id="line-420"></span><span>      </span><span id="local-6989586621688071387"><span class="annot"><a href="#local-6989586621688071387"><span class="hs-identifier hs-var hs-var">connectionContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.Internal.html/Data.Aeson.Types.Internal.html#object"><span class="hs-identifier hs-var">J.object</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.Internal.html/Data.Aeson.Types.Internal.html#String"><span class="hs-identifier hs-var">J.String</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;metadata&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-comment">-- Init metadata db pool.</span><span>
</span><span id="line-423"></span><span>  </span><span id="local-6989586621688071391"><span class="annot"><a href="#local-6989586621688071391"><span class="hs-identifier hs-var">metadataDbPool</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-424"></span><span>    </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#allocate"><span class="hs-identifier hs-type">allocate</span></a></span><span>
</span><span id="line-425"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#initPGPool"><span class="hs-identifier hs-type">PG.initPGPool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071257"><span class="hs-identifier hs-type">bciMetadataConnInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071387"><span class="hs-identifier hs-type">connectionContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071263"><span class="hs-identifier hs-type">soConnParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071374"><span class="hs-identifier hs-type">pgLogger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#destroyPGPool"><span class="hs-identifier hs-type">PG.destroyPGPool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-comment">-- Migrate the catalog and fetch the metdata.</span><span>
</span><span id="line-429"></span><span>  </span><span id="local-6989586621688071394"><span class="annot"><a href="#local-6989586621688071394"><span class="hs-identifier hs-var">metadataWithVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-430"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span>
</span><span id="line-431"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.App.html#migrateCatalogAndFetchMetadata"><span class="hs-identifier hs-type">migrateCatalogAndFetchMetadata</span></a></span><span>
</span><span id="line-432"></span><span>        </span><span class="annot"><a href="#local-6989586621688071373"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-433"></span><span>        </span><span class="annot"><a href="#local-6989586621688071391"><span class="hs-identifier hs-type">metadataDbPool</span></a></span><span>
</span><span id="line-434"></span><span>        </span><span class="annot"><a href="#local-6989586621688071258"><span class="hs-identifier hs-type">bciDefaultPostgres</span></a></span><span>
</span><span id="line-435"></span><span>        </span><span class="annot"><a href="#local-6989586621688071291"><span class="hs-identifier hs-type">soEnableMaintenanceMode</span></a></span><span>
</span><span id="line-436"></span><span>        </span><span class="annot"><a href="#local-6989586621688071304"><span class="hs-identifier hs-type">soExtensionsSchema</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span>  </span><span class="hs-comment">-- Create the TLSAllowListRef and the HTTP Manager.</span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688071396"><span class="annot"><a href="#local-6989586621688071396"><span class="hs-identifier hs-var hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataWithResourceVersion -&gt; Metadata
</span><a href="Hasura.RQL.Types.SchemaCache.html#_mwrvMetadata"><span class="hs-identifier hs-var">_mwrvMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataWithResourceVersion
</span><a href="#local-6989586621688071394"><span class="hs-identifier hs-var">metadataWithVersion</span></a></span><span>
</span><span id="line-440"></span><span>  </span><span id="local-6989586621688071398"><span class="annot"><a href="#local-6989586621688071398"><span class="hs-identifier hs-var">tlsAllowListRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#createTLSAllowListRef"><span class="hs-identifier hs-type">createTLSAllowListRef</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.Types.Extended.html/Network.Types.Extended.html#networkTlsAllowlist"><span class="hs-identifier hs-var">networkTlsAllowlist</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#_metaNetwork"><span class="hs-identifier hs-var">_metaNetwork</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071396"><span class="hs-identifier hs-type">metadata</span></a></span><span>
</span><span id="line-441"></span><span>  </span><span id="local-6989586621688071402"><span class="annot"><a href="#local-6989586621688071402"><span class="hs-identifier hs-var">httpManager</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Network.HTTP.Client.CreateManager.html/Network.HTTP.Client.CreateManager.html#mkHttpManager"><span class="hs-identifier hs-type">mkHttpManager</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#readTLSAllowList"><span class="hs-identifier hs-type">readTLSAllowList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071398"><span class="hs-identifier hs-type">tlsAllowListRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span>  </span><span class="hs-comment">-- Start a background thread for listening schema sync events from other</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-comment">-- server instances (an interval of 0 indicates that no schema sync is</span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-comment">-- required). Logs whether the thread is started or not, and with what</span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-comment">-- interval.</span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-comment">-- TODO: extract into a separate init function.</span><span>
</span><span id="line-448"></span><span>  </span><span id="local-6989586621688071404"><span class="annot"><a href="#local-6989586621688071404"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM.newEmptyTMVarIO</span></span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621688071292"><span class="hs-identifier hs-type">soSchemaPollInterval</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-450"></span><span>    </span><span class="annot"><span class="annottext">OptionalInterval
</span><a href="Hasura.Server.Init.Config.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071373"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;schema-sync&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Schema sync disabled&quot;</span></span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><a href="Hasura.Server.Init.Config.html#Interval"><span class="hs-identifier hs-type">Interval</span></a></span><span> </span><span id="local-6989586621688071410"><span class="annot"><span class="annottext">Refined NonNegative Milliseconds
</span><a href="#local-6989586621688071410"><span class="hs-identifier hs-var">interval</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-452"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071373"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;schema-sync&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Schema sync enabled. Polling at &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Milliseconds -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Milliseconds
</span><a href="#local-6989586621688071410"><span class="hs-identifier hs-var">interval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span>      </span><span class="annot"><span class="annottext">ManagedT m Thread -&gt; ManagedT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ManagedT m Thread -&gt; ManagedT m ())
-&gt; ManagedT m Thread -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; PGPool
-&gt; InstanceId
-&gt; Refined NonNegative Milliseconds
-&gt; TMVar MetadataResourceVersion
-&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
Logger Hasura
-&gt; PGPool
-&gt; InstanceId
-&gt; Refined NonNegative Milliseconds
-&gt; TMVar MetadataResourceVersion
-&gt; ManagedT m Thread
</span><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncListenerThread"><span class="hs-identifier hs-var">startSchemaSyncListenerThread</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071373"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688071391"><span class="hs-identifier hs-var">metadataDbPool</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688071385"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Milliseconds
</span><a href="#local-6989586621688071410"><span class="hs-identifier hs-var">interval</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621688071404"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-comment">-- Generate the shutdown latch.</span><span>
</span><span id="line-456"></span><span>  </span><span id="local-6989586621688071414"><span class="annot"><a href="#local-6989586621688071414"><span class="hs-identifier hs-var">latch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><a href="Hasura.ShutdownLatch.html#newShutdownLatch"><span class="hs-identifier hs-type">newShutdownLatch</span></a></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>  </span><span class="hs-comment">-- Generate subscription state.</span><span>
</span><span id="line-459"></span><span>  </span><span id="local-6989586621688071416"><span class="annot"><a href="#local-6989586621688071416"><span class="hs-identifier hs-var">subscriptionsState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.App.html#initSubscriptionsState"><span class="hs-identifier hs-type">initSubscriptionsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071373"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071367"><span class="hs-identifier hs-type">liveQueryHook</span></a></span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-comment">-- Generate event's trigger shared state</span><span>
</span><span id="line-462"></span><span>  </span><span id="local-6989586621688071417"><span class="annot"><a href="#local-6989586621688071417"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.App.html#initLockedEventsCtx"><span class="hs-identifier hs-type">initLockedEventsCtx</span></a></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.App.html#AppInit"><span class="hs-identifier hs-type">AppInit</span></a></span><span>
</span><span id="line-466"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Hasura.App.html#aiTLSAllowListRef"><span class="hs-identifier hs-var">aiTLSAllowListRef</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071398"><span class="hs-identifier hs-type">tlsAllowListRef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-467"></span><span>          </span><span class="annot"><a href="Hasura.App.html#aiMetadataWithResourceVersion"><span class="hs-identifier hs-var">aiMetadataWithResourceVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071394"><span class="hs-identifier hs-type">metadataWithVersion</span></a></span><span>
</span><span id="line-468"></span><span>        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-469"></span><span>      </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span>
</span><span id="line-470"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Hasura.App.State.html#appEnvPort"><span class="hs-identifier hs-var">appEnvPort</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071261"><span class="hs-identifier hs-type">soPort</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-471"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvHost"><span class="hs-identifier hs-var">appEnvHost</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071262"><span class="hs-identifier hs-type">soHost</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-472"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvMetadataDbPool"><span class="hs-identifier hs-var">appEnvMetadataDbPool</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071391"><span class="hs-identifier hs-type">metadataDbPool</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-473"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvIntrospectionDbPool"><span class="hs-identifier hs-var">appEnvIntrospectionDbPool</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- No introspection storage for self-hosted CE</span><span>
</span><span id="line-474"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvManager"><span class="hs-identifier hs-var">appEnvManager</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071402"><span class="hs-identifier hs-type">httpManager</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-475"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvLoggers"><span class="hs-identifier hs-var">appEnvLoggers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071371"><span class="hs-identifier hs-type">loggers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-476"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvMetadataVersionRef"><span class="hs-identifier hs-var">appEnvMetadataVersionRef</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071404"><span class="hs-identifier hs-type">metaVersionRef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-477"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvInstanceId"><span class="hs-identifier hs-var">appEnvInstanceId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071385"><span class="hs-identifier hs-type">instanceId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-478"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvEnableMaintenanceMode"><span class="hs-identifier hs-var">appEnvEnableMaintenanceMode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071291"><span class="hs-identifier hs-type">soEnableMaintenanceMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-479"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvLoggingSettings"><span class="hs-identifier hs-var">appEnvLoggingSettings</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html#LoggingSettings"><span class="hs-identifier hs-type">LoggingSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071282"><span class="hs-identifier hs-type">soEnabledLogTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071301"><span class="hs-identifier hs-type">soEnableMetadataQueryLogging</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071302"><span class="hs-identifier hs-type">soHttpLogQueryOnlyOnError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-480"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvEventingMode"><span class="hs-identifier hs-var">appEnvEventingMode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071299"><span class="hs-identifier hs-type">soEventingMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-481"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvEnableReadOnlyMode"><span class="hs-identifier hs-var">appEnvEnableReadOnlyMode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071300"><span class="hs-identifier hs-type">soReadOnlyMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-482"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvServerMetrics"><span class="hs-identifier hs-var">appEnvServerMetrics</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071368"><span class="hs-identifier hs-type">serverMetrics</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-483"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvShutdownLatch"><span class="hs-identifier hs-var">appEnvShutdownLatch</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071414"><span class="hs-identifier hs-type">latch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-484"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvMetaVersionRef"><span class="hs-identifier hs-var">appEnvMetaVersionRef</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071404"><span class="hs-identifier hs-type">metaVersionRef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-485"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvPrometheusMetrics"><span class="hs-identifier hs-var">appEnvPrometheusMetrics</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071369"><span class="hs-identifier hs-type">prometheusMetrics</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-486"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvTraceSamplingPolicy"><span class="hs-identifier hs-var">appEnvTraceSamplingPolicy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071370"><span class="hs-identifier hs-type">traceSamplingPolicy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-487"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvSubscriptionState"><span class="hs-identifier hs-var">appEnvSubscriptionState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071416"><span class="hs-identifier hs-type">subscriptionsState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-488"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvLockedEventsCtx"><span class="hs-identifier hs-var">appEnvLockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071417"><span class="hs-identifier hs-type">lockedEventsCtx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-489"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvConnParams"><span class="hs-identifier hs-var">appEnvConnParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071263"><span class="hs-identifier hs-type">soConnParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-490"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvTxIso"><span class="hs-identifier hs-var">appEnvTxIso</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071264"><span class="hs-identifier hs-type">soTxIso</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-491"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvConsoleAssetsDir"><span class="hs-identifier hs-var">appEnvConsoleAssetsDir</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071271"><span class="hs-identifier hs-type">soConsoleAssetsDir</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-492"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvConsoleSentryDsn"><span class="hs-identifier hs-var">appEnvConsoleSentryDsn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071272"><span class="hs-identifier hs-type">soConsoleSentryDsn</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-493"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvConnectionOptions"><span class="hs-identifier hs-var">appEnvConnectionOptions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071288"><span class="hs-identifier hs-type">soConnectionOptions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-494"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvWebSocketKeepAlive"><span class="hs-identifier hs-var">appEnvWebSocketKeepAlive</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071289"><span class="hs-identifier hs-type">soWebSocketKeepAlive</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-495"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvWebSocketConnectionInitTimeout"><span class="hs-identifier hs-var">appEnvWebSocketConnectionInitTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071298"><span class="hs-identifier hs-type">soWebSocketConnectionInitTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-496"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvGracefulShutdownTimeout"><span class="hs-identifier hs-var">appEnvGracefulShutdownTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071297"><span class="hs-identifier hs-type">soGracefulShutdownTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-497"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvCheckFeatureFlag"><span class="hs-identifier hs-var">appEnvCheckFeatureFlag</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.Server.Init.FeatureFlag.html#ceCheckFeatureFlag"><span class="hs-identifier hs-type">ceCheckFeatureFlag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071256"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-498"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvSchemaPollInterval"><span class="hs-identifier hs-var">appEnvSchemaPollInterval</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071292"><span class="hs-identifier hs-type">soSchemaPollInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-499"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvLicenseKeyCache"><span class="hs-identifier hs-var">appEnvLicenseKeyCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-500"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvMaxTotalHeaderLength"><span class="hs-identifier hs-var">appEnvMaxTotalHeaderLength</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071308"><span class="hs-identifier hs-type">soMaxTotalHeaderLength</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-501"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvTriggersErrorLogLevelStatus"><span class="hs-identifier hs-var">appEnvTriggersErrorLogLevelStatus</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071309"><span class="hs-identifier hs-type">soTriggersErrorLogLevelStatus</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-502"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvAsyncActionsFetchBatchSize"><span class="hs-identifier hs-var">appEnvAsyncActionsFetchBatchSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071310"><span class="hs-identifier hs-type">soAsyncActionsFetchBatchSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-503"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvPersistedQueries"><span class="hs-identifier hs-var">appEnvPersistedQueries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071311"><span class="hs-identifier hs-type">soPersistedQueries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-504"></span><span>          </span><span class="annot"><a href="Hasura.App.State.html#appEnvPersistedQueriesTtl"><span class="hs-identifier hs-var">appEnvPersistedQueriesTtl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071312"><span class="hs-identifier hs-type">soPersistedQueriesTtl</span></a></span><span>
</span><span id="line-505"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span class="hs-comment">-- | Initializes the 'AppContext' and returns a corresponding 'AppStateRef'.</span><span>
</span><span id="line-509"></span><span class="hs-comment">--</span><span>
</span><span id="line-510"></span><span class="hs-comment">-- This function is meant to be run in the app monad, which provides the</span><span>
</span><span id="line-511"></span><span class="hs-comment">-- 'AppEnv'.</span><span>
</span><span id="line-512"></span><span id="local-6989586621688070103"><span class="annot"><a href="Hasura.App.html#initialiseAppContext"><span class="hs-identifier hs-type">initialiseAppContext</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070103"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.App.State.html#HasAppEnv"><span class="hs-identifier hs-type">HasAppEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070103"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-514"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-515"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#ServeOptions"><span class="hs-identifier hs-type">ServeOptions</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-516"></span><span>  </span><span class="annot"><a href="Hasura.App.html#AppInit"><span class="hs-identifier hs-type">AppInit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-517"></span><span>  </span><span class="annot"><a href="#local-6989586621688070103"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier hs-type">AppStateRef</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-518"></span><span id="initialiseAppContext"><span class="annot"><span class="annottext">initialiseAppContext :: forall (m :: * -&gt; *).
(ForkableMonadIO m, HasAppEnv m) =&gt;
Environment
-&gt; ServeOptions Hasura -&gt; AppInit -&gt; m (AppStateRef Hasura)
</span><a href="Hasura.App.html#initialiseAppContext"><span class="hs-identifier hs-var hs-var">initialiseAppContext</span></a></span></span><span> </span><span id="local-6989586621688071471"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071471"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621688071472"><span class="annot"><span class="annottext">ServeOptions Hasura
</span><a href="#local-6989586621688071472"><span class="hs-identifier hs-var">serveOptions</span></a></span></span><span> </span><span class="annot"><a href="Hasura.App.html#AppInit"><span class="hs-identifier hs-type">AppInit</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688071473"><span id="local-6989586621688071474"><span class="annot"><span class="annottext">MetadataWithResourceVersion
TLSAllowListRef
aiTLSAllowListRef :: AppInit -&gt; TLSAllowListRef
aiMetadataWithResourceVersion :: AppInit -&gt; MetadataWithResourceVersion
aiTLSAllowListRef :: TLSAllowListRef
aiMetadataWithResourceVersion :: MetadataWithResourceVersion
</span><a href="Hasura.App.html#aiTLSAllowListRef"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>  </span><span id="local-6989586621688071475"><span class="annot"><a href="#local-6989586621688071475"><span class="hs-identifier hs-var">appEnv</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688071476"><span id="local-6989586621688071477"><span id="local-6989586621688071478"><span id="local-6989586621688071479"><span id="local-6989586621688071480"><span id="local-6989586621688071481"><span id="local-6989586621688071482"><span id="local-6989586621688071483"><span id="local-6989586621688071484"><span id="local-6989586621688071485"><span id="local-6989586621688071486"><span id="local-6989586621688071487"><span id="local-6989586621688071488"><span id="local-6989586621688071489"><span id="local-6989586621688071490"><span id="local-6989586621688071491"><span id="local-6989586621688071492"><span id="local-6989586621688071493"><span id="local-6989586621688071494"><span id="local-6989586621688071495"><span id="local-6989586621688071496"><span id="local-6989586621688071497"><span id="local-6989586621688071498"><span id="local-6989586621688071499"><span id="local-6989586621688071500"><span id="local-6989586621688071501"><span id="local-6989586621688071502"><span id="local-6989586621688071503"><span id="local-6989586621688071504"><span id="local-6989586621688071505"><span id="local-6989586621688071506"><span id="local-6989586621688071507"><span id="local-6989586621688071508"><span id="local-6989586621688071509"><span id="local-6989586621688071510"><span class="annot"><a href="Hasura.App.State.html#appEnvPort"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m AppEnv
forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-520"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688071512"><span class="annot"><a href="#local-6989586621688071512"><span class="hs-identifier hs-var hs-var">cacheStaticConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppEnv -&gt; CacheStaticConfig
</span><a href="Hasura.App.State.html#buildCacheStaticConfig"><span class="hs-identifier hs-var">buildCacheStaticConfig</span></a></span><span> </span><span class="annot"><span class="annottext">AppEnv
</span><a href="#local-6989586621688071475"><span class="hs-identifier hs-var">appEnv</span></a></span><span>
</span><span id="line-521"></span><span>      </span><span class="annot"><a href="Hasura.App.State.html#Loggers"><span class="hs-identifier hs-type">Loggers</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688071514"><span class="annot"><a href="#local-6989586621688071514"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688071515"><span class="annot"><a href="#local-6989586621688071515"><span class="hs-identifier hs-var">pgLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688071481"><span class="hs-identifier hs-type">appEnvLoggers</span></a></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-comment">-- Build the RebuildableAppContext.</span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-comment">-- (See note [Hasura Application State].)</span><span>
</span><span id="line-525"></span><span>  </span><span id="local-6989586621688071516"><span class="annot"><a href="#local-6989586621688071516"><span class="hs-identifier hs-var">rebuildableAppCtxE</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-526"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span>
</span><span id="line-527"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">runExceptT</span></span><span>
</span><span id="line-528"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.App.State.html#buildRebuildableAppContext"><span class="hs-identifier hs-type">buildRebuildableAppContext</span></a></span><span>
</span><span id="line-529"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688071514"><span class="hs-identifier hs-type">logger</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688071480"><span class="hs-identifier hs-type">appEnvManager</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>            </span><span class="annot"><a href="#local-6989586621688071472"><span class="hs-identifier hs-type">serveOptions</span></a></span><span>
</span><span id="line-531"></span><span>            </span><span class="annot"><a href="#local-6989586621688071504"><span class="hs-identifier hs-type">appEnvCheckFeatureFlag</span></a></span><span>
</span><span id="line-532"></span><span>            </span><span class="annot"><a href="#local-6989586621688071471"><span class="hs-identifier hs-type">env</span></a></span><span>
</span><span id="line-533"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>  </span><span class="hs-glyph">!</span><span id="local-6989586621688071518"><span class="annot"><a href="#local-6989586621688071518"><span class="hs-identifier hs-var">rebuildableAppCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-type">onLeft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071516"><span class="hs-identifier hs-type">rebuildableAppCtxE</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688071520"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688071520"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExitCode -&gt; String -&gt; m (RebuildableAppContext Hasura)
forall a. ExitCode -&gt; String -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; ExitCode -&gt; String -&gt; m a
</span><a href="Hasura.App.html#throwErrExit"><span class="hs-identifier hs-var">throwErrExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#InvalidEnvironmentVariableOptionsError"><span class="hs-identifier hs-var">InvalidEnvironmentVariableOptionsError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m (RebuildableAppContext Hasura))
-&gt; String -&gt; m (RebuildableAppContext Hasura)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; Text -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#qeError"><span class="hs-identifier hs-var">qeError</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688071520"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688071523"><span class="annot"><a href="#local-6989586621688071523"><span class="hs-identifier hs-var hs-var">cacheDynamicConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; CacheDynamicConfig
</span><a href="Hasura.App.State.html#buildCacheDynamicConfig"><span class="hs-identifier hs-var">buildCacheDynamicConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RebuildableAppContext Hasura -&gt; AppContext
forall impl. RebuildableAppContext impl -&gt; AppContext
</span><a href="Hasura.App.State.html#lastBuiltAppContext"><span class="hs-identifier hs-var">lastBuiltAppContext</span></a></span><span> </span><span class="annot"><span class="annottext">RebuildableAppContext Hasura
</span><a href="#local-6989586621688071518"><span class="hs-identifier hs-var">rebuildableAppCtx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span>  </span><span class="hs-comment">-- Create the schema cache</span><span>
</span><span id="line-539"></span><span>  </span><span id="local-6989586621688071526"><span class="annot"><a href="#local-6989586621688071526"><span class="hs-identifier hs-var">rebuildableSchemaCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-540"></span><span>    </span><span class="annot"><a href="Hasura.App.html#buildFirstSchemaCache"><span class="hs-identifier hs-type">buildFirstSchemaCache</span></a></span><span>
</span><span id="line-541"></span><span>      </span><span class="annot"><a href="#local-6989586621688071471"><span class="hs-identifier hs-type">env</span></a></span><span>
</span><span id="line-542"></span><span>      </span><span class="annot"><a href="#local-6989586621688071514"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-543"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier hs-type">mkPgSourceResolver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071515"><span class="hs-identifier hs-type">pgLogger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>      </span><span class="annot"><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier hs-type">mkMSSQLSourceResolver</span></a></span><span>
</span><span id="line-545"></span><span>      </span><span class="annot"><a href="#local-6989586621688071474"><span class="hs-identifier hs-type">aiMetadataWithResourceVersion</span></a></span><span>
</span><span id="line-546"></span><span>      </span><span class="annot"><a href="#local-6989586621688071512"><span class="hs-identifier hs-type">cacheStaticConfig</span></a></span><span>
</span><span id="line-547"></span><span>      </span><span class="annot"><a href="#local-6989586621688071523"><span class="hs-identifier hs-type">cacheDynamicConfig</span></a></span><span>
</span><span id="line-548"></span><span>      </span><span class="annot"><a href="#local-6989586621688071480"><span class="hs-identifier hs-type">appEnvManager</span></a></span><span>
</span><span id="line-549"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-550"></span><span>  </span><span class="hs-comment">-- Initialise the 'AppStateRef' from 'RebuildableSchemaCacheRef' and 'RebuildableAppContext'.</span><span>
</span><span id="line-551"></span><span>  </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#initialiseAppStateRef"><span class="hs-identifier hs-type">initialiseAppStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071473"><span class="hs-identifier hs-type">aiTLSAllowListRef</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="annot"><a href="#local-6989586621688071488"><span class="hs-identifier hs-type">appEnvServerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071526"><span class="hs-identifier hs-type">rebuildableSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071518"><span class="hs-identifier hs-type">rebuildableAppCtx</span></a></span><span>
</span><span id="line-552"></span><span>
</span><span id="line-553"></span><span class="hs-comment">-- | Runs catalogue migration, and returns the metadata that was fetched.</span><span>
</span><span id="line-554"></span><span class="hs-comment">--</span><span>
</span><span id="line-555"></span><span class="hs-comment">-- On success, this function logs the result of the migration, on failure it</span><span>
</span><span id="line-556"></span><span class="hs-comment">-- logs a 'catalog_migrate' error and throws a fatal error.</span><span>
</span><span id="line-557"></span><span id="local-6989586621688070082"><span class="annot"><a href="Hasura.App.html#migrateCatalogAndFetchMetadata"><span class="hs-identifier hs-type">migrateCatalogAndFetchMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688070082"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688070082"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-559"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-560"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#PGPool"><span class="hs-identifier hs-type">PG.PGPool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-561"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SourceConfiguration.html#SourceConnConfiguration"><span class="hs-identifier hs-type">SourceConnConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-562"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-563"></span><span>  </span><span class="annot"><a href="Hasura.SQL.Types.html#ExtensionsSchema"><span class="hs-identifier hs-type">ExtensionsSchema</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-564"></span><span>  </span><span class="annot"><a href="#local-6989586621688070082"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataWithResourceVersion"><span class="hs-identifier hs-type">MetadataWithResourceVersion</span></a></span></span><span>
</span><span id="line-565"></span><span id="migrateCatalogAndFetchMetadata"><span class="annot"><span class="annottext">migrateCatalogAndFetchMetadata :: forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m) =&gt;
Logger Hasura
-&gt; PGPool
-&gt; Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; MaintenanceMode ()
-&gt; ExtensionsSchema
-&gt; m MetadataWithResourceVersion
</span><a href="Hasura.App.html#migrateCatalogAndFetchMetadata"><span class="hs-identifier hs-var hs-var">migrateCatalogAndFetchMetadata</span></a></span></span><span>
</span><span id="line-566"></span><span>  </span><span id="local-6989586621688071566"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071566"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-567"></span><span>  </span><span id="local-6989586621688071567"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688071567"><span class="hs-identifier hs-var">pool</span></a></span></span><span>
</span><span id="line-568"></span><span>  </span><span id="local-6989586621688071568"><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><a href="#local-6989586621688071568"><span class="hs-identifier hs-var">defaultSourceConfig</span></a></span></span><span>
</span><span id="line-569"></span><span>  </span><span id="local-6989586621688071569"><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621688071569"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span>
</span><span id="line-570"></span><span>  </span><span id="local-6989586621688071570"><span class="annot"><span class="annottext">ExtensionsSchema
</span><a href="#local-6989586621688071570"><span class="hs-identifier hs-var">extensionsSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>    </span><span class="hs-comment">-- TODO: should we allow the migration to happen during maintenance mode?</span><span>
</span><span id="line-572"></span><span>    </span><span class="hs-comment">-- Allowing this can be a sanity check, to see if the hdb_catalog in the</span><span>
</span><span id="line-573"></span><span>    </span><span class="hs-comment">-- DB has been set correctly</span><span>
</span><span id="line-574"></span><span>    </span><span id="local-6989586621688071571"><span class="annot"><a href="#local-6989586621688071571"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; m UTCTime
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">Clock.getCurrentTime</span></span><span>
</span><span id="line-575"></span><span>    </span><span id="local-6989586621688071573"><span class="annot"><a href="#local-6989586621688071573"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-576"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">runExceptT</span></span><span>
</span><span id="line-577"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#runTx"><span class="hs-identifier hs-type">PG.runTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071567"><span class="hs-identifier hs-type">pool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#Serializable"><span class="hs-identifier hs-type">PG.Serializable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadWrite"><span class="hs-identifier hs-type">PG.ReadWrite</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html#migrateCatalog"><span class="hs-identifier hs-type">migrateCatalog</span></a></span><span>
</span><span id="line-579"></span><span>          </span><span class="annot"><a href="#local-6989586621688071568"><span class="hs-identifier hs-type">defaultSourceConfig</span></a></span><span>
</span><span id="line-580"></span><span>          </span><span class="annot"><a href="#local-6989586621688071570"><span class="hs-identifier hs-type">extensionsSchema</span></a></span><span>
</span><span id="line-581"></span><span>          </span><span class="annot"><a href="#local-6989586621688071569"><span class="hs-identifier hs-type">maintenanceMode</span></a></span><span>
</span><span id="line-582"></span><span>          </span><span class="annot"><a href="#local-6989586621688071571"><span class="hs-identifier hs-type">currentTime</span></a></span><span>
</span><span id="line-583"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621688071573"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-584"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688071577"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688071577"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-585"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span>
</span><span id="line-586"></span><span>          </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071566"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-587"></span><span>          </span><span class="annot"><a href="Hasura.Server.Logging.html#StartupLog"><span class="hs-identifier hs-type">StartupLog</span></a></span><span>
</span><span id="line-588"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">slLogLevel :: LogLevel
</span><a href="Hasura.Server.Logging.html#slLogLevel"><span class="hs-identifier hs-var">slLogLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">LevelError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-589"></span><span>              </span><span class="annot"><span class="annottext">slKind :: Text
</span><a href="Hasura.Server.Logging.html#slKind"><span class="hs-identifier hs-var">slKind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;catalog_migrate&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-590"></span><span>              </span><span class="annot"><span class="annottext">slInfo :: Value
</span><a href="Hasura.Server.Logging.html#slInfo"><span class="hs-identifier hs-var">slInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">J.toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688071577"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-591"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-592"></span><span>        </span><span class="annot"><span class="annottext">IO MetadataWithResourceVersion -&gt; m MetadataWithResourceVersion
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExitCode -&gt; QErr -&gt; IO MetadataWithResourceVersion
forall b. ExitCode -&gt; QErr -&gt; IO b
forall a (m :: * -&gt; *) b.
(ToJSON a, MonadIO m) =&gt;
ExitCode -&gt; a -&gt; m b
</span><a href="Hasura.App.html#throwErrJExit"><span class="hs-identifier hs-var">throwErrJExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#DatabaseMigrationError"><span class="hs-identifier hs-var">DatabaseMigrationError</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688071577"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-593"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688071579"><span class="annot"><span class="annottext">MigrationResult
</span><a href="#local-6989586621688071579"><span class="hs-identifier hs-var">migrationResult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688071580"><span class="annot"><span class="annottext">MetadataWithResourceVersion
</span><a href="#local-6989586621688071580"><span class="hs-identifier hs-var">metadataWithVersion</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-594"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071566"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationResult
</span><a href="#local-6989586621688071579"><span class="hs-identifier hs-var">migrationResult</span></a></span><span>
</span><span id="line-595"></span><span>        </span><span class="annot"><span class="annottext">MetadataWithResourceVersion -&gt; m MetadataWithResourceVersion
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MetadataWithResourceVersion
</span><a href="#local-6989586621688071580"><span class="hs-identifier hs-var">metadataWithVersion</span></a></span><span>
</span><span id="line-596"></span><span>
</span><span id="line-597"></span><span class="hs-comment">-- | Build the original 'RebuildableSchemaCache'.</span><span>
</span><span id="line-598"></span><span class="hs-comment">--</span><span>
</span><span id="line-599"></span><span class="hs-comment">-- On error, it logs a 'catalog_migrate' error and throws a fatal error. This</span><span>
</span><span id="line-600"></span><span class="hs-comment">-- misnomer is intentional: it is to preserve a previous behaviour of the code</span><span>
</span><span id="line-601"></span><span class="hs-comment">-- and avoid a breaking change.</span><span>
</span><span id="line-602"></span><span id="local-6989586621688070121"><span class="annot"><a href="Hasura.App.html#buildFirstSchemaCache"><span class="hs-identifier hs-type">buildFirstSchemaCache</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-603"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688070121"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-604"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-605"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-606"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceResolver"><span class="hs-identifier hs-type">SourceResolver</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-607"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceResolver"><span class="hs-identifier hs-type">SourceResolver</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-608"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataWithResourceVersion"><span class="hs-identifier hs-type">MetadataWithResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-609"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html#CacheStaticConfig"><span class="hs-identifier hs-type">CacheStaticConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-610"></span><span>  </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html#CacheDynamicConfig"><span class="hs-identifier hs-type">CacheDynamicConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-611"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/http-client-0.7.17-1b2133de2c2ce095aea721bc3d56fba68148ba6d3c4af69a01586f3a88b4e771/share/doc/html/src/Network.HTTP.Client.Types.html/Network.HTTP.Client.Types.html#Manager"><span class="hs-identifier hs-type">HTTP.Manager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-612"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.SchemaRegistry.html#SchemaRegistryContext"><span class="hs-identifier hs-type">SchemaRegistry.SchemaRegistryContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-613"></span><span>  </span><span class="annot"><a href="#local-6989586621688070121"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-type">RebuildableSchemaCache</span></a></span></span><span>
</span><span id="line-614"></span><span id="buildFirstSchemaCache"><span class="annot"><span class="annottext">buildFirstSchemaCache :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Environment
-&gt; Logger Hasura
-&gt; SourceResolver ('Postgres 'Vanilla)
-&gt; SourceResolver 'MSSQL
-&gt; MetadataWithResourceVersion
-&gt; CacheStaticConfig
-&gt; CacheDynamicConfig
-&gt; Manager
-&gt; Maybe SchemaRegistryContext
-&gt; m RebuildableSchemaCache
</span><a href="Hasura.App.html#buildFirstSchemaCache"><span class="hs-identifier hs-var hs-var">buildFirstSchemaCache</span></a></span></span><span>
</span><span id="line-615"></span><span>  </span><span id="local-6989586621688071597"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071597"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-616"></span><span>  </span><span id="local-6989586621688071598"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071598"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-617"></span><span>  </span><span id="local-6989586621688071599"><span class="annot"><span class="annottext">SourceResolver ('Postgres 'Vanilla)
</span><a href="#local-6989586621688071599"><span class="hs-identifier hs-var">pgSourceResolver</span></a></span></span><span>
</span><span id="line-618"></span><span>  </span><span id="local-6989586621688071600"><span class="annot"><span class="annottext">SourceResolver 'MSSQL
</span><a href="#local-6989586621688071600"><span class="hs-identifier hs-var">mssqlSourceResolver</span></a></span></span><span>
</span><span id="line-619"></span><span>  </span><span id="local-6989586621688071601"><span class="annot"><span class="annottext">MetadataWithResourceVersion
</span><a href="#local-6989586621688071601"><span class="hs-identifier hs-var">metadataWithVersion</span></a></span></span><span>
</span><span id="line-620"></span><span>  </span><span id="local-6989586621688071602"><span class="annot"><span class="annottext">CacheStaticConfig
</span><a href="#local-6989586621688071602"><span class="hs-identifier hs-var">cacheStaticConfig</span></a></span></span><span>
</span><span id="line-621"></span><span>  </span><span id="local-6989586621688071603"><span class="annot"><span class="annottext">CacheDynamicConfig
</span><a href="#local-6989586621688071603"><span class="hs-identifier hs-var">cacheDynamicConfig</span></a></span></span><span>
</span><span id="line-622"></span><span>  </span><span id="local-6989586621688071604"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688071604"><span class="hs-identifier hs-var">httpManager</span></a></span></span><span>
</span><span id="line-623"></span><span>  </span><span id="local-6989586621688071605"><span class="annot"><span class="annottext">Maybe SchemaRegistryContext
</span><a href="#local-6989586621688071605"><span class="hs-identifier hs-var">mSchemaRegistryContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-624"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688071606"><span class="annot"><span class="annottext">cacheBuildParams :: CacheBuildParams
</span><a href="#local-6989586621688071606"><span class="hs-identifier hs-var hs-var hs-var">cacheBuildParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Manager
-&gt; SourceResolver ('Postgres 'Vanilla)
-&gt; SourceResolver 'MSSQL
-&gt; CacheStaticConfig
-&gt; CacheBuildParams
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#CacheBuildParams"><span class="hs-identifier hs-var">CacheBuildParams</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688071604"><span class="hs-identifier hs-var">httpManager</span></a></span><span> </span><span class="annot"><span class="annottext">SourceResolver ('Postgres 'Vanilla)
</span><a href="#local-6989586621688071599"><span class="hs-identifier hs-var">pgSourceResolver</span></a></span><span> </span><span class="annot"><span class="annottext">SourceResolver 'MSSQL
</span><a href="#local-6989586621688071600"><span class="hs-identifier hs-var">mssqlSourceResolver</span></a></span><span> </span><span class="annot"><span class="annottext">CacheStaticConfig
</span><a href="#local-6989586621688071602"><span class="hs-identifier hs-var">cacheStaticConfig</span></a></span><span>
</span><span id="line-625"></span><span>    </span><span id="local-6989586621688071608"><span class="annot"><a href="#local-6989586621688071608"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-626"></span><span>      </span><span class="annot"><span class="annottext">ExceptT QErr m RebuildableSchemaCache
-&gt; m (Either QErr RebuildableSchemaCache)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span>
</span><span id="line-627"></span><span>        </span><span class="annot"><span class="annottext">(ExceptT QErr m RebuildableSchemaCache
 -&gt; m (Either QErr RebuildableSchemaCache))
-&gt; ExceptT QErr m RebuildableSchemaCache
-&gt; m (Either QErr RebuildableSchemaCache)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CacheBuildParams
-&gt; CacheBuild RebuildableSchemaCache
-&gt; ExceptT QErr m RebuildableSchemaCache
forall (m :: * -&gt; *) a.
(MonadIO m, MonadError QErr m) =&gt;
CacheBuildParams -&gt; CacheBuild a -&gt; m a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#runCacheBuild"><span class="hs-identifier hs-var">runCacheBuild</span></a></span><span> </span><span class="annot"><span class="annottext">CacheBuildParams
</span><a href="#local-6989586621688071606"><span class="hs-identifier hs-var">cacheBuildParams</span></a></span><span>
</span><span id="line-628"></span><span>        </span><span class="annot"><span class="annottext">(CacheBuild RebuildableSchemaCache
 -&gt; ExceptT QErr m RebuildableSchemaCache)
-&gt; CacheBuild RebuildableSchemaCache
-&gt; ExceptT QErr m RebuildableSchemaCache
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; Environment
-&gt; MetadataWithResourceVersion
-&gt; CacheDynamicConfig
-&gt; Maybe SchemaRegistryContext
-&gt; CacheBuild RebuildableSchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRebuildableSchemaCache"><span class="hs-identifier hs-var">buildRebuildableSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071598"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688071597"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataWithResourceVersion
</span><a href="#local-6989586621688071601"><span class="hs-identifier hs-var">metadataWithVersion</span></a></span><span> </span><span class="annot"><span class="annottext">CacheDynamicConfig
</span><a href="#local-6989586621688071603"><span class="hs-identifier hs-var">cacheDynamicConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SchemaRegistryContext
</span><a href="#local-6989586621688071605"><span class="hs-identifier hs-var">mSchemaRegistryContext</span></a></span><span>
</span><span id="line-629"></span><span>    </span><span class="annot"><a href="#local-6989586621688071608"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#onLeft"><span class="hs-operator hs-type">`onLeft`</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688071611"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688071611"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-630"></span><span>      </span><span class="hs-comment">-- TODO: we used to bundle the first schema cache build with the catalog</span><span>
</span><span id="line-631"></span><span>      </span><span class="hs-comment">-- migration, using the same error handler for both, meaning that an</span><span>
</span><span id="line-632"></span><span>      </span><span class="hs-comment">-- error in the first schema cache build would be reported as</span><span>
</span><span id="line-633"></span><span>      </span><span class="hs-comment">-- follows. Changing this will be a breaking change.</span><span>
</span><span id="line-634"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span>
</span><span id="line-635"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071598"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-636"></span><span>        </span><span class="annot"><a href="Hasura.Server.Logging.html#StartupLog"><span class="hs-identifier hs-type">StartupLog</span></a></span><span>
</span><span id="line-637"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">slLogLevel :: LogLevel
</span><a href="Hasura.Server.Logging.html#slLogLevel"><span class="hs-identifier hs-var">slLogLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">LevelError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-638"></span><span>            </span><span class="annot"><span class="annottext">slKind :: Text
</span><a href="Hasura.Server.Logging.html#slKind"><span class="hs-identifier hs-var">slKind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;catalog_migrate&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-639"></span><span>            </span><span class="annot"><span class="annottext">slInfo :: Value
</span><a href="Hasura.Server.Logging.html#slInfo"><span class="hs-identifier hs-var">slInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#toJSON"><span class="hs-identifier hs-var">J.toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688071611"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-640"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-641"></span><span>      </span><span class="annot"><span class="annottext">IO RebuildableSchemaCache -&gt; m RebuildableSchemaCache
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExitCode -&gt; QErr -&gt; IO RebuildableSchemaCache
forall b. ExitCode -&gt; QErr -&gt; IO b
forall a (m :: * -&gt; *) b.
(ToJSON a, MonadIO m) =&gt;
ExitCode -&gt; a -&gt; m b
</span><a href="Hasura.App.html#throwErrJExit"><span class="hs-identifier hs-var">throwErrJExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#DatabaseMigrationError"><span class="hs-identifier hs-var">DatabaseMigrationError</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688071611"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span class="annot"><a href="Hasura.App.html#initSubscriptionsState"><span class="hs-identifier hs-type">initSubscriptionsState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-644"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-645"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier hs-type">ES.SubscriptionPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-646"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">ES.SubscriptionsState</span></a></span><span>
</span><span id="line-647"></span><span id="initSubscriptionsState"><span class="annot"><span class="annottext">initSubscriptionsState :: Logger Hasura
-&gt; Maybe SubscriptionPostPollHook -&gt; IO SubscriptionsState
</span><a href="Hasura.App.html#initSubscriptionsState"><span class="hs-identifier hs-var hs-var">initSubscriptionsState</span></a></span></span><span> </span><span id="local-6989586621688071612"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071612"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688071613"><span class="annot"><span class="annottext">Maybe SubscriptionPostPollHook
</span><a href="#local-6989586621688071613"><span class="hs-identifier hs-var">liveQueryHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionPostPollHook -&gt; IO SubscriptionsState
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#initSubscriptionsState"><span class="hs-identifier hs-var">ES.initSubscriptionsState</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621688071615"><span class="hs-identifier hs-var">postPollHook</span></a></span><span>
</span><span id="line-648"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-649"></span><span>    </span><span id="local-6989586621688071615"><span class="annot"><span class="annottext">postPollHook :: SubscriptionPostPollHook
</span><a href="#local-6989586621688071615"><span class="hs-identifier hs-var hs-var">postPollHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionPostPollHook
-&gt; Maybe SubscriptionPostPollHook -&gt; SubscriptionPostPollHook
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger Hasura -&gt; SubscriptionPostPollHook
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#defaultSubscriptionPostPollHook"><span class="hs-identifier hs-var">ES.defaultSubscriptionPostPollHook</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688071612"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe SubscriptionPostPollHook
</span><a href="#local-6989586621688071613"><span class="hs-identifier hs-var">liveQueryHook</span></a></span><span>
</span><span id="line-650"></span><span>
</span><span id="line-651"></span><span class="annot"><a href="Hasura.App.html#initLockedEventsCtx"><span class="hs-identifier hs-type">initLockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span>
</span><span id="line-652"></span><span id="initLockedEventsCtx"><span class="annot"><span class="annottext">initLockedEventsCtx :: IO LockedEventsCtx
</span><a href="Hasura.App.html#initLockedEventsCtx"><span class="hs-identifier hs-var hs-var">initLockedEventsCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-653"></span><span>  </span><span class="annot"><span class="annottext">(TVar (Set CronEventId)
 -&gt; TVar (Set CronEventId)
 -&gt; TVar (HashMap SourceName (Set CronEventId))
 -&gt; TVar (Set CronEventId)
 -&gt; LockedEventsCtx)
-&gt; IO (TVar (Set CronEventId))
-&gt; IO (TVar (Set CronEventId))
-&gt; IO (TVar (HashMap SourceName (Set CronEventId)))
-&gt; IO (TVar (Set CronEventId))
-&gt; IO LockedEventsCtx
forall (m :: * -&gt; *) a1 a2 a3 a4 r.
Monad m =&gt;
(a1 -&gt; a2 -&gt; a3 -&gt; a4 -&gt; r) -&gt; m a1 -&gt; m a2 -&gt; m a3 -&gt; m a4 -&gt; m r
</span><span class="hs-identifier hs-var">liftM4</span></span><span>
</span><span id="line-654"></span><span>    </span><span class="annot"><span class="annottext">TVar (Set CronEventId)
-&gt; TVar (Set CronEventId)
-&gt; TVar (HashMap SourceName (Set CronEventId))
-&gt; TVar (Set CronEventId)
-&gt; LockedEventsCtx
</span><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-var">LockedEventsCtx</span></a></span><span>
</span><span id="line-655"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CronEventId -&gt; IO (TVar (Set CronEventId))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CronEventId -&gt; IO (TVar (Set CronEventId))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-657"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap SourceName (Set CronEventId)
-&gt; IO (TVar (HashMap SourceName (Set CronEventId)))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set CronEventId)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-658"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CronEventId -&gt; IO (TVar (Set CronEventId))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span>
</span><span id="line-660"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-661"></span><span class="hs-comment">-- App monad</span><span>
</span><span id="line-662"></span><span>
</span><span id="line-663"></span><span class="annot"><span class="hs-comment">-- | The base app monad of the CE engine.</span></span><span>
</span><span id="line-664"></span><span class="hs-keyword">newtype</span><span> </span><span id="AppM"><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-var">AppM</span></a></span></span><span> </span><span id="local-6989586621688070297"><span class="annot"><a href="#local-6989586621688070297"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AppM"><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-var">AppM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Tracing.Monad.html#TraceT"><span class="hs-identifier hs-type">TraceT</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688070297"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-665"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span>
</span><span id="line-666"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621688071622"><span id="local-6989586621688071628"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; AppM a -&gt; AppM b)
-&gt; (forall a b. a -&gt; AppM b -&gt; AppM a) -&gt; Functor AppM
forall a b. a -&gt; AppM b -&gt; AppM a
forall a b. (a -&gt; b) -&gt; AppM a -&gt; AppM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
$cfmap :: forall a b. (a -&gt; b) -&gt; AppM a -&gt; AppM b
fmap :: forall a b. (a -&gt; b) -&gt; AppM a -&gt; AppM b
$c&lt;$ :: forall a b. a -&gt; AppM b -&gt; AppM a
&lt;$ :: forall a b. a -&gt; AppM b -&gt; AppM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-667"></span><span>      </span><span id="local-6989586621688071640"><span class="annot"><span class="annottext">Monad AppM
Monad AppM =&gt; (forall a. String -&gt; AppM a) -&gt; MonadFail AppM
forall a. String -&gt; AppM a
forall (m :: * -&gt; *).
Monad m =&gt;
(forall a. String -&gt; m a) -&gt; MonadFail m
$cfail :: forall a. String -&gt; AppM a
fail :: forall a. String -&gt; AppM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadFail</span></span></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- only due to https://gitlab.haskell.org/ghc/ghc/-/issues/15681</span><span>
</span><span id="line-668"></span><span>      </span><span id="local-6989586621688071653"><span id="local-6989586621688071659"><span id="local-6989586621688071664"><span id="local-6989586621688071669"><span id="local-6989586621688071674"><span class="annot"><span class="annottext">Functor AppM
Functor AppM =&gt;
(forall a. a -&gt; AppM a)
-&gt; (forall a b. AppM (a -&gt; b) -&gt; AppM a -&gt; AppM b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; AppM a -&gt; AppM b -&gt; AppM c)
-&gt; (forall a b. AppM a -&gt; AppM b -&gt; AppM b)
-&gt; (forall a b. AppM a -&gt; AppM b -&gt; AppM a)
-&gt; Applicative AppM
forall a. a -&gt; AppM a
forall a b. AppM a -&gt; AppM b -&gt; AppM a
forall a b. AppM a -&gt; AppM b -&gt; AppM b
forall a b. AppM (a -&gt; b) -&gt; AppM a -&gt; AppM b
forall a b c. (a -&gt; b -&gt; c) -&gt; AppM a -&gt; AppM b -&gt; AppM c
forall (f :: * -&gt; *).
Functor f =&gt;
(forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
$cpure :: forall a. a -&gt; AppM a
pure :: forall a. a -&gt; AppM a
$c&lt;*&gt; :: forall a b. AppM (a -&gt; b) -&gt; AppM a -&gt; AppM b
&lt;*&gt; :: forall a b. AppM (a -&gt; b) -&gt; AppM a -&gt; AppM b
$cliftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; AppM a -&gt; AppM b -&gt; AppM c
liftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; AppM a -&gt; AppM b -&gt; AppM c
$c*&gt; :: forall a b. AppM a -&gt; AppM b -&gt; AppM b
*&gt; :: forall a b. AppM a -&gt; AppM b -&gt; AppM b
$c&lt;* :: forall a b. AppM a -&gt; AppM b -&gt; AppM a
&lt;* :: forall a b. AppM a -&gt; AppM b -&gt; AppM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-669"></span><span>      </span><span id="local-6989586621688071692"><span id="local-6989586621688071698"><span id="local-6989586621688071703"><span class="annot"><span class="annottext">Applicative AppM
Applicative AppM =&gt;
(forall a b. AppM a -&gt; (a -&gt; AppM b) -&gt; AppM b)
-&gt; (forall a b. AppM a -&gt; AppM b -&gt; AppM b)
-&gt; (forall a. a -&gt; AppM a)
-&gt; Monad AppM
forall a. a -&gt; AppM a
forall a b. AppM a -&gt; AppM b -&gt; AppM b
forall a b. AppM a -&gt; (a -&gt; AppM b) -&gt; AppM b
forall (m :: * -&gt; *).
Applicative m =&gt;
(forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
$c&gt;&gt;= :: forall a b. AppM a -&gt; (a -&gt; AppM b) -&gt; AppM b
&gt;&gt;= :: forall a b. AppM a -&gt; (a -&gt; AppM b) -&gt; AppM b
$c&gt;&gt; :: forall a b. AppM a -&gt; AppM b -&gt; AppM b
&gt;&gt; :: forall a b. AppM a -&gt; AppM b -&gt; AppM b
$creturn :: forall a. a -&gt; AppM a
return :: forall a. a -&gt; AppM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-670"></span><span>      </span><span id="local-6989586621688071712"><span class="annot"><span class="annottext">Monad AppM
Monad AppM =&gt; (forall a. IO a -&gt; AppM a) -&gt; MonadIO AppM
forall a. IO a -&gt; AppM a
forall (m :: * -&gt; *).
Monad m =&gt;
(forall a. IO a -&gt; m a) -&gt; MonadIO m
$cliftIO :: forall a. IO a -&gt; AppM a
liftIO :: forall a. IO a -&gt; AppM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadIO</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-671"></span><span>      </span><span id="local-6989586621688071723"><span class="annot"><span class="annottext">Monad AppM
Monad AppM =&gt; (forall a. (a -&gt; AppM a) -&gt; AppM a) -&gt; MonadFix AppM
forall a. (a -&gt; AppM a) -&gt; AppM a
forall (m :: * -&gt; *).
Monad m =&gt;
(forall a. (a -&gt; m a) -&gt; m a) -&gt; MonadFix m
$cmfix :: forall a. (a -&gt; AppM a) -&gt; AppM a
mfix :: forall a. (a -&gt; AppM a) -&gt; AppM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadFix</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-672"></span><span>      </span><span id="local-6989586621688071742"><span class="annot"><span class="annottext">MonadThrow AppM
MonadThrow AppM =&gt;
(forall e a.
 (HasCallStack, Exception e) =&gt;
 AppM a -&gt; (e -&gt; AppM a) -&gt; AppM a)
-&gt; MonadCatch AppM
forall e a.
(HasCallStack, Exception e) =&gt;
AppM a -&gt; (e -&gt; AppM a) -&gt; AppM a
forall (m :: * -&gt; *).
MonadThrow m =&gt;
(forall e a.
 (HasCallStack, Exception e) =&gt;
 m a -&gt; (e -&gt; m a) -&gt; m a)
-&gt; MonadCatch m
$ccatch :: forall e a.
(HasCallStack, Exception e) =&gt;
AppM a -&gt; (e -&gt; AppM a) -&gt; AppM a
catch :: forall e a.
(HasCallStack, Exception e) =&gt;
AppM a -&gt; (e -&gt; AppM a) -&gt; AppM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadCatch</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-673"></span><span>      </span><span id="local-6989586621688071766"><span class="annot"><span class="annottext">Monad AppM
Monad AppM =&gt;
(forall e a. (HasCallStack, Exception e) =&gt; e -&gt; AppM a)
-&gt; MonadThrow AppM
forall e a. (HasCallStack, Exception e) =&gt; e -&gt; AppM a
forall (m :: * -&gt; *).
Monad m =&gt;
(forall e a. (HasCallStack, Exception e) =&gt; e -&gt; m a)
-&gt; MonadThrow m
$cthrowM :: forall e a. (HasCallStack, Exception e) =&gt; e -&gt; AppM a
throwM :: forall e a. (HasCallStack, Exception e) =&gt; e -&gt; AppM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadThrow</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-674"></span><span>      </span><span id="local-6989586621688071787"><span id="local-6989586621688071799"><span id="local-6989586621688071810"><span class="annot"><span class="annottext">MonadCatch AppM
MonadCatch AppM =&gt;
(forall b.
 HasCallStack =&gt;
 ((forall a. AppM a -&gt; AppM a) -&gt; AppM b) -&gt; AppM b)
-&gt; (forall b.
    HasCallStack =&gt;
    ((forall a. AppM a -&gt; AppM a) -&gt; AppM b) -&gt; AppM b)
-&gt; (forall a b c.
    HasCallStack =&gt;
    AppM a
    -&gt; (a -&gt; ExitCase b -&gt; AppM c) -&gt; (a -&gt; AppM b) -&gt; AppM (b, c))
-&gt; MonadMask AppM
forall b.
HasCallStack =&gt;
((forall a. AppM a -&gt; AppM a) -&gt; AppM b) -&gt; AppM b
forall a b c.
HasCallStack =&gt;
AppM a
-&gt; (a -&gt; ExitCase b -&gt; AppM c) -&gt; (a -&gt; AppM b) -&gt; AppM (b, c)
forall (m :: * -&gt; *).
MonadCatch m =&gt;
(forall b. HasCallStack =&gt; ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b)
-&gt; (forall b.
    HasCallStack =&gt;
    ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b)
-&gt; (forall a b c.
    HasCallStack =&gt;
    m a -&gt; (a -&gt; ExitCase b -&gt; m c) -&gt; (a -&gt; m b) -&gt; m (b, c))
-&gt; MonadMask m
$cmask :: forall b.
HasCallStack =&gt;
((forall a. AppM a -&gt; AppM a) -&gt; AppM b) -&gt; AppM b
mask :: forall b.
HasCallStack =&gt;
((forall a. AppM a -&gt; AppM a) -&gt; AppM b) -&gt; AppM b
$cuninterruptibleMask :: forall b.
HasCallStack =&gt;
((forall a. AppM a -&gt; AppM a) -&gt; AppM b) -&gt; AppM b
uninterruptibleMask :: forall b.
HasCallStack =&gt;
((forall a. AppM a -&gt; AppM a) -&gt; AppM b) -&gt; AppM b
$cgeneralBracket :: forall a b c.
HasCallStack =&gt;
AppM a
-&gt; (a -&gt; ExitCase b -&gt; AppM c) -&gt; (a -&gt; AppM b) -&gt; AppM (b, c)
generalBracket :: forall a b c.
HasCallStack =&gt;
AppM a
-&gt; (a -&gt; ExitCase b -&gt; AppM c) -&gt; (a -&gt; AppM b) -&gt; AppM (b, c)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadMask</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-675"></span><span>      </span><span id="local-6989586621688071830"><span id="local-6989586621688071836"><span id="local-6989586621688071841"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-676"></span><span>      </span><span id="local-6989586621688071859"><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/transformers-base-0.4.6-df1098420f8bba181d3d0607518ad0acc5b4d50ee14ae11ab0cfa0957f133c37/share/doc/html/src/Control.Monad.Base.html/Control.Monad.Base.html#MonadBase"><span class="hs-identifier hs-type">MonadBase</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-677"></span><span>      </span><span id="local-6989586621688071873"><span id="local-6989586621688071880"><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/monad-control-1.0.3.1-127c0b1895a90d6faa345827c6b6be6447278996974a93c84184eef9ccf5fbbc/share/doc/html/src/Control.Monad.Trans.Control.html/Control.Monad.Trans.Control.html#MonadBaseControl"><span class="hs-identifier hs-type">MonadBaseControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span></span></span><span>
</span><span id="line-678"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>
</span><span id="line-680"></span><span id="local-6989586621688070287"><span class="annot"><a href="Hasura.App.html#runAppM"><span class="hs-identifier hs-type">runAppM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070287"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688070287"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-681"></span><span id="runAppM"><span class="annot"><span class="annottext">runAppM :: forall a. AppEnv -&gt; AppM a -&gt; IO a
</span><a href="Hasura.App.html#runAppM"><span class="hs-identifier hs-var hs-var">runAppM</span></a></span></span><span> </span><span id="local-6989586621688071893"><span class="annot"><span class="annottext">AppEnv
</span><a href="#local-6989586621688071893"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span id="local-6989586621688071894"><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) a
</span><a href="#local-6989586621688071894"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TraceT IO a -&gt; IO a
forall (m :: * -&gt; *) a. TraceT m a -&gt; m a
</span><a href="Hasura.Tracing.Monad.html#ignoreTraceT"><span class="hs-identifier hs-var">ignoreTraceT</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceT IO a -&gt; IO a) -&gt; TraceT IO a -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) a -&gt; AppEnv -&gt; TraceT IO a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) a
</span><a href="#local-6989586621688071894"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">AppEnv
</span><a href="#local-6989586621688071893"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-682"></span><span>
</span><span id="line-683"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.App.State.html#HasAppEnv"><span class="hs-identifier hs-type">HasAppEnv</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-684"></span><span>  </span><span id="local-6989586621688071903"><span class="annot"><span class="annottext">askAppEnv :: AppM AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var hs-var hs-var">askAppEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppM AppEnv
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-685"></span><span>
</span><span id="line-686"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.Init.FeatureFlag.html#HasFeatureFlagChecker"><span class="hs-identifier hs-type">HasFeatureFlagChecker</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-687"></span><span>  </span><span id="local-6989586621688071914"><span class="annot"><span class="annottext">checkFlag :: FeatureFlag -&gt; AppM Bool
</span><a href="#local-6989586621688071914"><span class="hs-identifier hs-var hs-var hs-var">checkFlag</span></a></span></span><span> </span><span id="local-6989586621688071916"><span class="annot"><span class="annottext">FeatureFlag
</span><a href="#local-6989586621688071916"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) Bool -&gt; AppM Bool
forall a. ReaderT AppEnv (TraceT IO) a -&gt; AppM a
</span><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-var">AppM</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-688"></span><span>    </span><span class="annot"><a href="Hasura.Server.Init.FeatureFlag.html#CheckFeatureFlag"><span class="hs-identifier hs-type">CheckFeatureFlag</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688071918"><span class="annot"><a href="#local-6989586621688071918"><span class="hs-identifier hs-var hs-var">runCheckFeatureFlag</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AppEnv -&gt; CheckFeatureFlag)
-&gt; ReaderT AppEnv (TraceT IO) CheckFeatureFlag
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AppEnv -&gt; CheckFeatureFlag
</span><a href="Hasura.App.State.html#appEnvCheckFeatureFlag"><span class="hs-identifier hs-var">appEnvCheckFeatureFlag</span></a></span><span>
</span><span id="line-689"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621688071918"><span class="hs-identifier hs-type">runCheckFeatureFlag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688071916"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-690"></span><span>
</span><span id="line-691"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html#HasCacheStaticConfig"><span class="hs-identifier hs-type">HasCacheStaticConfig</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-692"></span><span>  </span><span id="local-6989586621688071928"><span class="annot"><span class="annottext">askCacheStaticConfig :: AppM CacheStaticConfig
</span><a href="#local-6989586621688071928"><span class="hs-identifier hs-var hs-var hs-var">askCacheStaticConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppEnv -&gt; CacheStaticConfig
</span><a href="Hasura.App.State.html#buildCacheStaticConfig"><span class="hs-identifier hs-var">buildCacheStaticConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(AppEnv -&gt; CacheStaticConfig)
-&gt; AppM AppEnv -&gt; AppM CacheStaticConfig
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AppM AppEnv
forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Tracing.Class.html#MonadTrace"><span class="hs-identifier hs-type">MonadTrace</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-695"></span><span>  </span><span id="local-6989586621688071944"><span class="annot"><span class="annottext">newTraceWith :: forall a.
TraceContext -&gt; SamplingPolicy -&gt; Text -&gt; AppM a -&gt; AppM a
</span><a href="#local-6989586621688071944"><span class="hs-identifier hs-var hs-var hs-var">newTraceWith</span></a></span></span><span> </span><span id="local-6989586621688071946"><span class="annot"><span class="annottext">TraceContext
</span><a href="#local-6989586621688071946"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621688071947"><span class="annot"><span class="annottext">SamplingPolicy
</span><a href="#local-6989586621688071947"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621688071948"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688071948"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span id="local-6989586621688071949"><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) a
</span><a href="#local-6989586621688071949"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) a -&gt; AppM a
forall a. ReaderT AppEnv (TraceT IO) a -&gt; AppM a
</span><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-var">AppM</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT AppEnv (TraceT IO) a -&gt; AppM a)
-&gt; ReaderT AppEnv (TraceT IO) a -&gt; AppM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TraceContext
-&gt; SamplingPolicy
-&gt; Text
-&gt; ReaderT AppEnv (TraceT IO) a
-&gt; ReaderT AppEnv (TraceT IO) a
forall a.
TraceContext
-&gt; SamplingPolicy
-&gt; Text
-&gt; ReaderT AppEnv (TraceT IO) a
-&gt; ReaderT AppEnv (TraceT IO) a
forall (m :: * -&gt; *) a.
MonadTrace m =&gt;
TraceContext -&gt; SamplingPolicy -&gt; Text -&gt; m a -&gt; m a
</span><a href="Hasura.Tracing.Class.html#newTraceWith"><span class="hs-identifier hs-var">newTraceWith</span></a></span><span> </span><span class="annot"><span class="annottext">TraceContext
</span><a href="#local-6989586621688071946"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">SamplingPolicy
</span><a href="#local-6989586621688071947"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688071948"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) a
</span><a href="#local-6989586621688071949"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span id="local-6989586621688071953"><span class="annot"><span class="annottext">newSpanWith :: forall a. SpanId -&gt; Text -&gt; AppM a -&gt; AppM a
</span><a href="#local-6989586621688071953"><span class="hs-identifier hs-var hs-var hs-var">newSpanWith</span></a></span></span><span> </span><span id="local-6989586621688071955"><span class="annot"><span class="annottext">SpanId
</span><a href="#local-6989586621688071955"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621688071956"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688071956"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span id="local-6989586621688071957"><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) a
</span><a href="#local-6989586621688071957"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) a -&gt; AppM a
forall a. ReaderT AppEnv (TraceT IO) a -&gt; AppM a
</span><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-var">AppM</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT AppEnv (TraceT IO) a -&gt; AppM a)
-&gt; ReaderT AppEnv (TraceT IO) a -&gt; AppM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SpanId
-&gt; Text
-&gt; ReaderT AppEnv (TraceT IO) a
-&gt; ReaderT AppEnv (TraceT IO) a
forall a.
SpanId
-&gt; Text
-&gt; ReaderT AppEnv (TraceT IO) a
-&gt; ReaderT AppEnv (TraceT IO) a
forall (m :: * -&gt; *) a.
MonadTrace m =&gt;
SpanId -&gt; Text -&gt; m a -&gt; m a
</span><a href="Hasura.Tracing.Class.html#newSpanWith"><span class="hs-identifier hs-var">newSpanWith</span></a></span><span> </span><span class="annot"><span class="annottext">SpanId
</span><a href="#local-6989586621688071955"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688071956"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) a
</span><a href="#local-6989586621688071957"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-697"></span><span>  </span><span id="local-6989586621688071961"><span class="annot"><span class="annottext">attachMetadata :: TraceMetadata -&gt; AppM ()
</span><a href="#local-6989586621688071961"><span class="hs-identifier hs-var hs-var hs-var">attachMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) () -&gt; AppM ()
forall a. ReaderT AppEnv (TraceT IO) a -&gt; AppM a
</span><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-var">AppM</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT AppEnv (TraceT IO) () -&gt; AppM ())
-&gt; (TraceMetadata -&gt; ReaderT AppEnv (TraceT IO) ())
-&gt; TraceMetadata
-&gt; AppM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TraceMetadata -&gt; ReaderT AppEnv (TraceT IO) ()
forall (m :: * -&gt; *). MonadTrace m =&gt; TraceMetadata -&gt; m ()
</span><a href="Hasura.Tracing.Class.html#attachMetadata"><span class="hs-identifier hs-var">attachMetadata</span></a></span><span>
</span><span id="line-698"></span><span>
</span><span id="line-699"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Tracing.Class.html#MonadTraceContext"><span class="hs-identifier hs-type">MonadTraceContext</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-700"></span><span>  </span><span id="local-6989586621688071972"><span class="annot"><span class="annottext">currentContext :: AppM (Maybe TraceContext)
</span><a href="#local-6989586621688071972"><span class="hs-identifier hs-var hs-var hs-var">currentContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) (Maybe TraceContext)
-&gt; AppM (Maybe TraceContext)
forall a. ReaderT AppEnv (TraceT IO) a -&gt; AppM a
</span><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-var">AppM</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT AppEnv (TraceT IO) (Maybe TraceContext)
forall (m :: * -&gt; *). MonadTraceContext m =&gt; m (Maybe TraceContext)
</span><a href="Hasura.Tracing.Class.html#currentContext"><span class="hs-identifier hs-var">currentContext</span></a></span><span>
</span><span id="line-701"></span><span>
</span><span id="line-702"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Services.Network.html#ProvidesNetwork"><span class="hs-identifier hs-type">ProvidesNetwork</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-703"></span><span>  </span><span id="local-6989586621688071980"><span class="annot"><span class="annottext">askHTTPManager :: AppM Manager
</span><a href="#local-6989586621688071980"><span class="hs-identifier hs-var hs-var hs-var">askHTTPManager</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AppEnv -&gt; Manager) -&gt; AppM Manager
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AppEnv -&gt; Manager
</span><a href="Hasura.App.State.html#appEnvManager"><span class="hs-identifier hs-var">appEnvManager</span></a></span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-706"></span><span>  </span><span id="local-6989586621688071989"><span class="annot"><span class="annottext">askHTTPHandlerLimit :: AppM ResourceLimits
</span><a href="#local-6989586621688071989"><span class="hs-identifier hs-var hs-var hs-var">askHTTPHandlerLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceLimits -&gt; AppM ResourceLimits
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ResourceLimits -&gt; AppM ResourceLimits)
-&gt; ResourceLimits -&gt; AppM ResourceLimits
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(forall (m :: * -&gt; *) a.
 (MonadBaseControl IO m, MonadError QErr m) =&gt;
 m a -&gt; m a)
-&gt; ResourceLimits
</span><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-var">ResourceLimits</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; m a
forall a. a -&gt; a
forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, MonadError QErr m) =&gt;
m a -&gt; m a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-707"></span><span>  </span><span id="local-6989586621688071996"><span class="annot"><span class="annottext">askGraphqlOperationLimit :: RequestId -&gt; UserInfo -&gt; ApiLimit -&gt; AppM ResourceLimits
</span><a href="#local-6989586621688071996"><span class="hs-identifier hs-var hs-var hs-var">askGraphqlOperationLimit</span></a></span></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UserInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ApiLimit
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceLimits -&gt; AppM ResourceLimits
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ResourceLimits -&gt; AppM ResourceLimits)
-&gt; ResourceLimits -&gt; AppM ResourceLimits
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(forall (m :: * -&gt; *) a.
 (MonadBaseControl IO m, MonadError QErr m) =&gt;
 m a -&gt; m a)
-&gt; ResourceLimits
</span><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-var">ResourceLimits</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; m a
forall a. a -&gt; a
forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, MonadError QErr m) =&gt;
m a -&gt; m a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-708"></span><span>
</span><span id="line-709"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html#HttpLog"><span class="hs-identifier hs-type">HttpLog</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-710"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="ExtraHttpLogMetadata"><span class="annot"><a href="Hasura.Server.Logging.html#ExtraHttpLogMetadata"><span class="hs-identifier hs-var">ExtraHttpLogMetadata</span></a></span></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span>  </span><span id="local-6989586621688072008"><span class="annot"><span class="annottext">emptyExtraHttpLogMetadata :: ExtraHttpLogMetadata AppM
</span><a href="#local-6989586621688072008"><span class="hs-identifier hs-var hs-var hs-var">emptyExtraHttpLogMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span>  </span><span id="local-6989586621688072010"><span class="annot"><span class="annottext">buildExtraHttpLogMetadata :: ParameterizedQueryHashList
-&gt; ExtraUserInfo -&gt; ExtraHttpLogMetadata AppM
</span><a href="#local-6989586621688072010"><span class="hs-identifier hs-var hs-var hs-var">buildExtraHttpLogMetadata</span></a></span></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHashList
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExtraUserInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span>  </span><span id="local-6989586621688072016"><span class="annot"><span class="annottext">logHttpError :: Logger Hasura
-&gt; LoggingSettings
-&gt; Maybe UserInfo
-&gt; RequestId
-&gt; Request
-&gt; (LazyByteString, Maybe Value)
-&gt; QErr
-&gt; [Header]
-&gt; HttpLogMetadata AppM
-&gt; Bool
-&gt; AppM ()
</span><a href="#local-6989586621688072016"><span class="hs-identifier hs-var hs-var hs-var">logHttpError</span></a></span></span><span> </span><span id="local-6989586621688072018"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072018"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688072019"><span class="annot"><span class="annottext">LoggingSettings
</span><a href="#local-6989586621688072019"><span class="hs-identifier hs-var">loggingSettings</span></a></span></span><span> </span><span id="local-6989586621688072020"><span class="annot"><span class="annottext">Maybe UserInfo
</span><a href="#local-6989586621688072020"><span class="hs-identifier hs-var">userInfoM</span></a></span></span><span> </span><span id="local-6989586621688072021"><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688072021"><span class="hs-identifier hs-var">reqId</span></a></span></span><span> </span><span id="local-6989586621688072022"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688072022"><span class="hs-identifier hs-var">waiReq</span></a></span></span><span> </span><span id="local-6989586621688072023"><span class="annot"><span class="annottext">(LazyByteString, Maybe Value)
</span><a href="#local-6989586621688072023"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621688072024"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688072024"><span class="hs-identifier hs-var">qErr</span></a></span></span><span> </span><span id="local-6989586621688072025"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688072025"><span class="hs-identifier hs-var">headers</span></a></span></span><span> </span><span class="annot"><span class="annottext">HttpLogMetadata AppM
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-717"></span><span>    </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLoggerTracing"><span class="hs-identifier hs-var">unLoggerTracing</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072018"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-718"></span><span>      </span><span class="annot"><span class="annottext">(HttpLogLine -&gt; AppM ()) -&gt; HttpLogLine -&gt; AppM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HttpLogContext -&gt; HttpLogLine
</span><a href="Hasura.Server.Logging.html#mkHttpLog"><span class="hs-identifier hs-var">mkHttpLog</span></a></span><span>
</span><span id="line-719"></span><span>      </span><span class="annot"><span class="annottext">(HttpLogContext -&gt; HttpLogLine) -&gt; HttpLogContext -&gt; HttpLogLine
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe UserInfo
-&gt; LoggingSettings
-&gt; RequestId
-&gt; Request
-&gt; (LazyByteString, Maybe Value)
-&gt; QErr
-&gt; Maybe (DiffTime, DiffTime)
-&gt; Maybe CompressionType
-&gt; [Header]
-&gt; HttpLogContext
</span><a href="Hasura.Server.Logging.html#mkHttpErrorLogContext"><span class="hs-identifier hs-var">mkHttpErrorLogContext</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UserInfo
</span><a href="#local-6989586621688072020"><span class="hs-identifier hs-var">userInfoM</span></a></span><span> </span><span class="annot"><span class="annottext">LoggingSettings
</span><a href="#local-6989586621688072019"><span class="hs-identifier hs-var">loggingSettings</span></a></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688072021"><span class="hs-identifier hs-var">reqId</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688072022"><span class="hs-identifier hs-var">waiReq</span></a></span><span> </span><span class="annot"><span class="annottext">(LazyByteString, Maybe Value)
</span><a href="#local-6989586621688072023"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688072024"><span class="hs-identifier hs-var">qErr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DiffTime, DiffTime)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe CompressionType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688072025"><span class="hs-identifier hs-var">headers</span></a></span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span>  </span><span id="local-6989586621688072032"><span class="annot"><span class="annottext">logHttpSuccess :: Logger Hasura
-&gt; LoggingSettings
-&gt; Maybe UserInfo
-&gt; RequestId
-&gt; Request
-&gt; (LazyByteString, Maybe Value)
-&gt; LazyByteString
-&gt; LazyByteString
-&gt; Maybe (DiffTime, DiffTime)
-&gt; Maybe CompressionType
-&gt; [Header]
-&gt; HttpLogMetadata AppM
-&gt; Bool
-&gt; AppM ()
</span><a href="#local-6989586621688072032"><span class="hs-identifier hs-var hs-var hs-var">logHttpSuccess</span></a></span></span><span> </span><span id="local-6989586621688072034"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072034"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688072035"><span class="annot"><span class="annottext">LoggingSettings
</span><a href="#local-6989586621688072035"><span class="hs-identifier hs-var">loggingSettings</span></a></span></span><span> </span><span id="local-6989586621688072036"><span class="annot"><span class="annottext">Maybe UserInfo
</span><a href="#local-6989586621688072036"><span class="hs-identifier hs-var">userInfoM</span></a></span></span><span> </span><span id="local-6989586621688072037"><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688072037"><span class="hs-identifier hs-var">reqId</span></a></span></span><span> </span><span id="local-6989586621688072038"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688072038"><span class="hs-identifier hs-var">waiReq</span></a></span></span><span> </span><span id="local-6989586621688072039"><span class="annot"><span class="annottext">(LazyByteString, Maybe Value)
</span><a href="#local-6989586621688072039"><span class="hs-identifier hs-var">reqBody</span></a></span></span><span> </span><span id="local-6989586621688072040"><span class="annot"><span class="annottext">LazyByteString
</span><a href="#local-6989586621688072040"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span id="local-6989586621688072041"><span class="annot"><span class="annottext">LazyByteString
</span><a href="#local-6989586621688072041"><span class="hs-identifier hs-var">compressedResponse</span></a></span></span><span> </span><span id="local-6989586621688072042"><span class="annot"><span class="annottext">Maybe (DiffTime, DiffTime)
</span><a href="#local-6989586621688072042"><span class="hs-identifier hs-var">qTime</span></a></span></span><span> </span><span id="local-6989586621688072043"><span class="annot"><span class="annottext">Maybe CompressionType
</span><a href="#local-6989586621688072043"><span class="hs-identifier hs-var">cType</span></a></span></span><span> </span><span id="local-6989586621688072044"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688072044"><span class="hs-identifier hs-var">headers</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Logging.html#CommonHttpLogMetadata"><span class="hs-identifier hs-type">CommonHttpLogMetadata</span></a></span><span> </span><span id="local-6989586621688072046"><span class="annot"><span class="annottext">RequestMode
</span><a href="#local-6989586621688072046"><span class="hs-identifier hs-var">rb</span></a></span></span><span> </span><span id="local-6989586621688072047"><span class="annot"><span class="annottext">Maybe (GQLBatchedReqs GQLBatchQueryOperationLog)
</span><a href="#local-6989586621688072047"><span class="hs-identifier hs-var">batchQueryOpLogs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-722"></span><span>    </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLoggerTracing"><span class="hs-identifier hs-var">unLoggerTracing</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072034"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-723"></span><span>      </span><span class="annot"><span class="annottext">(HttpLogLine -&gt; AppM ()) -&gt; HttpLogLine -&gt; AppM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HttpLogContext -&gt; HttpLogLine
</span><a href="Hasura.Server.Logging.html#mkHttpLog"><span class="hs-identifier hs-var">mkHttpLog</span></a></span><span>
</span><span id="line-724"></span><span>      </span><span class="annot"><span class="annottext">(HttpLogContext -&gt; HttpLogLine) -&gt; HttpLogContext -&gt; HttpLogLine
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe UserInfo
-&gt; LoggingSettings
-&gt; RequestId
-&gt; Request
-&gt; (LazyByteString, Maybe Value)
-&gt; Int64
-&gt; LazyByteString
-&gt; Maybe (DiffTime, DiffTime)
-&gt; Maybe CompressionType
-&gt; [Header]
-&gt; RequestMode
-&gt; Maybe (GQLBatchedReqs GQLBatchQueryOperationLog)
-&gt; HttpLogContext
</span><a href="Hasura.Server.Logging.html#mkHttpAccessLogContext"><span class="hs-identifier hs-var">mkHttpAccessLogContext</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UserInfo
</span><a href="#local-6989586621688072036"><span class="hs-identifier hs-var">userInfoM</span></a></span><span> </span><span class="annot"><span class="annottext">LoggingSettings
</span><a href="#local-6989586621688072035"><span class="hs-identifier hs-var">loggingSettings</span></a></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688072037"><span class="hs-identifier hs-var">reqId</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688072038"><span class="hs-identifier hs-var">waiReq</span></a></span><span> </span><span class="annot"><span class="annottext">(LazyByteString, Maybe Value)
</span><a href="#local-6989586621688072039"><span class="hs-identifier hs-var">reqBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LazyByteString -&gt; Int64
</span><span class="hs-identifier hs-var">BL.length</span></span><span> </span><span class="annot"><span class="annottext">LazyByteString
</span><a href="#local-6989586621688072040"><span class="hs-identifier hs-var">response</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LazyByteString
</span><a href="#local-6989586621688072041"><span class="hs-identifier hs-var">compressedResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DiffTime, DiffTime)
</span><a href="#local-6989586621688072042"><span class="hs-identifier hs-var">qTime</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CompressionType
</span><a href="#local-6989586621688072043"><span class="hs-identifier hs-var">cType</span></a></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688072044"><span class="hs-identifier hs-var">headers</span></a></span><span> </span><span class="annot"><span class="annottext">RequestMode
</span><a href="#local-6989586621688072046"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (GQLBatchedReqs GQLBatchQueryOperationLog)
</span><a href="#local-6989586621688072047"><span class="hs-identifier hs-var">batchQueryOpLogs</span></a></span><span>
</span><span id="line-725"></span><span>
</span><span id="line-726"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier hs-type">MonadExecuteQuery</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-727"></span><span>  </span><span id="local-6989586621688072056"><span class="annot"><span class="annottext">cacheLookup :: ExecutionPlan
-&gt; [QueryRootField UnpreparedValue]
-&gt; Maybe CachedDirective
-&gt; GQLReqParsed
-&gt; UserInfo
-&gt; [Header]
-&gt; AppM (Either QErr ([Header], CacheResult))
</span><a href="#local-6989586621688072056"><span class="hs-identifier hs-var hs-var hs-var">cacheLookup</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExecutionPlan
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[QueryRootField UnpreparedValue]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe CachedDirective
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">GQLReqParsed
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UserInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either QErr ([Header], CacheResult)
-&gt; AppM (Either QErr ([Header], CacheResult))
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr ([Header], CacheResult)
 -&gt; AppM (Either QErr ([Header], CacheResult)))
-&gt; Either QErr ([Header], CacheResult)
-&gt; AppM (Either QErr ([Header], CacheResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Header], CacheResult) -&gt; Either QErr ([Header], CacheResult)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ResponseCacher -&gt; CacheResult
</span><a href="Hasura.GraphQL.Transport.HTTP.html#ResponseUncached"><span class="hs-identifier hs-var">ResponseUncached</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseCacher
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.Auth.html#UserAuthentication"><span class="hs-identifier hs-type">UserAuthentication</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-730"></span><span>  </span><span id="local-6989586621688072074"><span class="annot"><span class="annottext">resolveUserInfo :: Logger Hasura
-&gt; Manager
-&gt; [Header]
-&gt; AuthMode
-&gt; Maybe ReqsText
-&gt; AppM
     (Either QErr (UserInfo, Maybe UTCTime, [Header], ExtraUserInfo))
</span><a href="#local-6989586621688072074"><span class="hs-identifier hs-var hs-var hs-var">resolveUserInfo</span></a></span></span><span> </span><span id="local-6989586621688072076"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072076"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688072077"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688072077"><span class="hs-identifier hs-var">manager</span></a></span></span><span> </span><span id="local-6989586621688072078"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688072078"><span class="hs-identifier hs-var">headers</span></a></span></span><span> </span><span id="local-6989586621688072079"><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688072079"><span class="hs-identifier hs-var">authMode</span></a></span></span><span> </span><span id="local-6989586621688072080"><span class="annot"><span class="annottext">Maybe ReqsText
</span><a href="#local-6989586621688072080"><span class="hs-identifier hs-var">reqs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-731"></span><span>    </span><span class="annot"><span class="annottext">ExceptT
  QErr AppM (UserInfo, Maybe UTCTime, [Header], ExtraUserInfo)
-&gt; AppM
     (Either QErr (UserInfo, Maybe UTCTime, [Header], ExtraUserInfo))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   QErr AppM (UserInfo, Maybe UTCTime, [Header], ExtraUserInfo)
 -&gt; AppM
      (Either QErr (UserInfo, Maybe UTCTime, [Header], ExtraUserInfo)))
-&gt; ExceptT
     QErr AppM (UserInfo, Maybe UTCTime, [Header], ExtraUserInfo)
-&gt; AppM
     (Either QErr (UserInfo, Maybe UTCTime, [Header], ExtraUserInfo))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-732"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621688072081"><span class="annot"><a href="#local-6989586621688072081"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688072082"><span class="annot"><a href="#local-6989586621688072082"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688072083"><span class="annot"><a href="#local-6989586621688072083"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; Manager
-&gt; [Header]
-&gt; AuthMode
-&gt; Maybe ReqsText
-&gt; ExceptT QErr AppM (UserInfo, Maybe UTCTime, [Header])
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m, MonadError QErr m) =&gt;
Logger Hasura
-&gt; Manager
-&gt; [Header]
-&gt; AuthMode
-&gt; Maybe ReqsText
-&gt; m (UserInfo, Maybe UTCTime, [Header])
</span><a href="Hasura.Server.Auth.html#getUserInfoWithExpTime"><span class="hs-identifier hs-var">getUserInfoWithExpTime</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072076"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688072077"><span class="hs-identifier hs-var">manager</span></a></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688072078"><span class="hs-identifier hs-var">headers</span></a></span><span> </span><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688072079"><span class="hs-identifier hs-var">authMode</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ReqsText
</span><a href="#local-6989586621688072080"><span class="hs-identifier hs-var">reqs</span></a></span><span>
</span><span id="line-733"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688072081"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688072082"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688072083"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Authentication.User.html#ExtraUserInfo"><span class="hs-identifier hs-type">ExtraUserInfo</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-734"></span><span>
</span><span id="line-735"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#MonadMetadataApiAuthorization"><span class="hs-identifier hs-type">MonadMetadataApiAuthorization</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-736"></span><span>  </span><span id="local-6989586621688072101"><span class="annot"><span class="annottext">authorizeV1QueryApi :: RQLQuery -&gt; HandlerCtx -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072101"><span class="hs-identifier hs-var hs-var hs-var">authorizeV1QueryApi</span></a></span></span><span> </span><span id="local-6989586621688072103"><span class="annot"><span class="annottext">RQLQuery
</span><a href="#local-6989586621688072103"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span id="local-6989586621688072104"><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688072104"><span class="hs-identifier hs-var">handlerCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr AppM () -&gt; AppM (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-737"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688072105"><span class="annot"><span class="annottext">currRole :: RoleName
</span><a href="#local-6989586621688072105"><span class="hs-identifier hs-var hs-var">currRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserInfo -&gt; RoleName
</span><a href="Hasura.Authentication.User.html#_uiRole"><span class="hs-identifier hs-var">_uiRole</span></a></span><span> </span><span class="annot"><span class="annottext">(UserInfo -&gt; RoleName) -&gt; UserInfo -&gt; RoleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandlerCtx -&gt; UserInfo
</span><a href="Hasura.Server.App.html#hcUser"><span class="hs-identifier hs-var">hcUser</span></a></span><span> </span><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688072104"><span class="hs-identifier hs-var">handlerCtx</span></a></span><span>
</span><span id="line-738"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RQLQuery -&gt; Bool
</span><a href="Hasura.Server.API.Query.html#requiresAdmin"><span class="hs-identifier hs-var">requiresAdmin</span></a></span><span> </span><span class="annot"><span class="annottext">RQLQuery
</span><a href="#local-6989586621688072103"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688072105"><span class="hs-identifier hs-var">currRole</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.Authentication.Role.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>      </span><span class="annot"><span class="annottext">(ExceptT QErr AppM () -&gt; ExceptT QErr AppM ())
-&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#withPathK"><span class="hs-identifier hs-var">withPathK</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;args&quot;</span></span><span>
</span><span id="line-740"></span><span>      </span><span class="annot"><span class="annottext">(ExceptT QErr AppM () -&gt; ExceptT QErr AppM ())
-&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; ExceptT QErr AppM ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#AccessDenied"><span class="hs-identifier hs-var">AccessDenied</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-var">accessDeniedErrMsg</span></a></span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span>  </span><span id="local-6989586621688072120"><span class="annot"><span class="annottext">authorizeV1MetadataApi :: RQLMetadata -&gt; HandlerCtx -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072120"><span class="hs-identifier hs-var hs-var hs-var">authorizeV1MetadataApi</span></a></span></span><span> </span><span class="annot"><span class="annottext">RQLMetadata
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688072122"><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688072122"><span class="hs-identifier hs-var">handlerCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr AppM () -&gt; AppM (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-743"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688072123"><span class="annot"><span class="annottext">currRole :: RoleName
</span><a href="#local-6989586621688072123"><span class="hs-identifier hs-var hs-var">currRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserInfo -&gt; RoleName
</span><a href="Hasura.Authentication.User.html#_uiRole"><span class="hs-identifier hs-var">_uiRole</span></a></span><span> </span><span class="annot"><span class="annottext">(UserInfo -&gt; RoleName) -&gt; UserInfo -&gt; RoleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandlerCtx -&gt; UserInfo
</span><a href="Hasura.Server.App.html#hcUser"><span class="hs-identifier hs-var">hcUser</span></a></span><span> </span><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688072122"><span class="hs-identifier hs-var">handlerCtx</span></a></span><span>
</span><span id="line-744"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688072123"><span class="hs-identifier hs-var">currRole</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.Authentication.Role.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span>      </span><span class="annot"><span class="annottext">(ExceptT QErr AppM () -&gt; ExceptT QErr AppM ())
-&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#withPathK"><span class="hs-identifier hs-var">withPathK</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;args&quot;</span></span><span>
</span><span id="line-746"></span><span>      </span><span class="annot"><span class="annottext">(ExceptT QErr AppM () -&gt; ExceptT QErr AppM ())
-&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; ExceptT QErr AppM ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#AccessDenied"><span class="hs-identifier hs-var">AccessDenied</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-var">accessDeniedErrMsg</span></a></span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span>  </span><span id="local-6989586621688072131"><span class="annot"><span class="annottext">authorizeV2QueryApi :: RQLQuery -&gt; HandlerCtx -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072131"><span class="hs-identifier hs-var hs-var hs-var">authorizeV2QueryApi</span></a></span></span><span> </span><span class="annot"><span class="annottext">RQLQuery
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688072133"><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688072133"><span class="hs-identifier hs-var">handlerCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr AppM () -&gt; AppM (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-749"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688072134"><span class="annot"><span class="annottext">currRole :: RoleName
</span><a href="#local-6989586621688072134"><span class="hs-identifier hs-var hs-var">currRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserInfo -&gt; RoleName
</span><a href="Hasura.Authentication.User.html#_uiRole"><span class="hs-identifier hs-var">_uiRole</span></a></span><span> </span><span class="annot"><span class="annottext">(UserInfo -&gt; RoleName) -&gt; UserInfo -&gt; RoleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandlerCtx -&gt; UserInfo
</span><a href="Hasura.Server.App.html#hcUser"><span class="hs-identifier hs-var">hcUser</span></a></span><span> </span><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688072133"><span class="hs-identifier hs-var">handlerCtx</span></a></span><span>
</span><span id="line-750"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688072134"><span class="hs-identifier hs-var">currRole</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.Authentication.Role.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-751"></span><span>      </span><span class="annot"><span class="annottext">(ExceptT QErr AppM () -&gt; ExceptT QErr AppM ())
-&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#withPathK"><span class="hs-identifier hs-var">withPathK</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;args&quot;</span></span><span>
</span><span id="line-752"></span><span>      </span><span class="annot"><span class="annottext">(ExceptT QErr AppM () -&gt; ExceptT QErr AppM ())
-&gt; ExceptT QErr AppM () -&gt; ExceptT QErr AppM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; ExceptT QErr AppM ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#AccessDenied"><span class="hs-identifier hs-var">AccessDenied</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-var">accessDeniedErrMsg</span></a></span><span>
</span><span id="line-753"></span><span>
</span><span id="line-754"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#ConsoleRenderer"><span class="hs-identifier hs-type">ConsoleRenderer</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="ConsoleType"><span class="annot"><a href="Hasura.Server.App.html#ConsoleType"><span class="hs-identifier hs-var">ConsoleType</span></a></span></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#CEConsoleType"><span class="hs-identifier hs-type">CEConsoleType</span></a></span><span>
</span><span id="line-756"></span><span>  </span><span id="local-6989586621688072141"><span class="annot"><span class="annottext">renderConsole :: Text
-&gt; AuthMode
-&gt; TelemetryStatus
-&gt; Maybe Text
-&gt; Maybe Text
-&gt; ConsoleType AppM
-&gt; AppM (Either String Text)
</span><a href="#local-6989586621688072141"><span class="hs-identifier hs-var hs-var hs-var">renderConsole</span></a></span></span><span> </span><span id="local-6989586621688072143"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688072143"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621688072144"><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688072144"><span class="hs-identifier hs-var">authMode</span></a></span></span><span> </span><span id="local-6989586621688072145"><span class="annot"><span class="annottext">TelemetryStatus
</span><a href="#local-6989586621688072145"><span class="hs-identifier hs-var">enableTelemetry</span></a></span></span><span> </span><span id="local-6989586621688072146"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688072146"><span class="hs-identifier hs-var">consoleAssetsDir</span></a></span></span><span> </span><span id="local-6989586621688072147"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688072147"><span class="hs-identifier hs-var">consoleSentryDsn</span></a></span></span><span> </span><span id="local-6989586621688072148"><span class="annot"><span class="annottext">ConsoleType AppM
</span><a href="#local-6989586621688072148"><span class="hs-identifier hs-var">consoleType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-757"></span><span>    </span><span class="annot"><span class="annottext">Either String Text -&gt; AppM (Either String Text)
forall a. a -&gt; AppM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either String Text -&gt; AppM (Either String Text))
-&gt; Either String Text -&gt; AppM (Either String Text)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
-&gt; AuthMode
-&gt; TelemetryStatus
-&gt; Maybe Text
-&gt; Maybe Text
-&gt; CEConsoleType
-&gt; Either String Text
</span><a href="Hasura.App.html#mkConsoleHTML"><span class="hs-identifier hs-var">mkConsoleHTML</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688072143"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688072144"><span class="hs-identifier hs-var">authMode</span></a></span><span> </span><span class="annot"><span class="annottext">TelemetryStatus
</span><a href="#local-6989586621688072145"><span class="hs-identifier hs-var">enableTelemetry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688072146"><span class="hs-identifier hs-var">consoleAssetsDir</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688072147"><span class="hs-identifier hs-var">consoleSentryDsn</span></a></span><span> </span><span class="annot"><span class="annottext">CEConsoleType
ConsoleType AppM
</span><a href="#local-6989586621688072148"><span class="hs-identifier hs-var">consoleType</span></a></span><span>
</span><span id="line-758"></span><span>
</span><span id="line-759"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#MonadVersionAPIWithExtraData"><span class="hs-identifier hs-type">MonadVersionAPIWithExtraData</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-760"></span><span>  </span><span class="hs-comment">-- we always default to CE as the `server_type` in this codebase</span><span>
</span><span id="line-761"></span><span>  </span><span id="local-6989586621688072160"><span class="annot"><span class="annottext">getExtraDataForVersionAPI :: AppM [Pair]
</span><a href="#local-6989586621688072160"><span class="hs-identifier hs-var hs-var hs-var">getExtraDataForVersionAPI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; AppM [Pair]
forall a. a -&gt; AppM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;server_type&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;ce&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-762"></span><span>
</span><span id="line-763"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Common.html#MonadGQLExecutionCheck"><span class="hs-identifier hs-type">MonadGQLExecutionCheck</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-764"></span><span>  </span><span id="local-6989586621688072175"><span class="annot"><span class="annottext">checkGQLExecution :: UserInfo
-&gt; ([Header], IpAddress)
-&gt; AllowListStatus
-&gt; SchemaCache
-&gt; GQLReqUnparsed
-&gt; RequestId
-&gt; AppM (Either QErr GQLReqParsed)
</span><a href="#local-6989586621688072175"><span class="hs-identifier hs-var hs-var hs-var">checkGQLExecution</span></a></span></span><span> </span><span id="local-6989586621688072177"><span class="annot"><span class="annottext">UserInfo
</span><a href="#local-6989586621688072177"><span class="hs-identifier hs-var">userInfo</span></a></span></span><span> </span><span class="annot"><span class="annottext">([Header], IpAddress)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688072178"><span class="annot"><span class="annottext">AllowListStatus
</span><a href="#local-6989586621688072178"><span class="hs-identifier hs-var">enableAL</span></a></span></span><span> </span><span id="local-6989586621688072179"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688072179"><span class="hs-identifier hs-var">sc</span></a></span></span><span> </span><span id="local-6989586621688072180"><span class="annot"><span class="annottext">GQLReqUnparsed
</span><a href="#local-6989586621688072180"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr AppM GQLReqParsed -&gt; AppM (Either QErr GQLReqParsed)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr AppM GQLReqParsed -&gt; AppM (Either QErr GQLReqParsed))
-&gt; ExceptT QErr AppM GQLReqParsed
-&gt; AppM (Either QErr GQLReqParsed)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-765"></span><span>    </span><span id="local-6989586621688072181"><span class="annot"><a href="#local-6989586621688072181"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GQLReqUnparsed -&gt; ExceptT QErr AppM GQLReqParsed
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
GQLReqUnparsed -&gt; m GQLReqParsed
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#toParsed"><span class="hs-identifier hs-var">toParsed</span></a></span><span> </span><span class="annot"><span class="annottext">GQLReqUnparsed
</span><a href="#local-6989586621688072180"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-766"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.html#checkQueryInAllowlist"><span class="hs-identifier hs-type">checkQueryInAllowlist</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072178"><span class="hs-identifier hs-type">enableAL</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Allowlist.html#AllowlistModeGlobalOnly"><span class="hs-identifier hs-type">AllowlistModeGlobalOnly</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072177"><span class="hs-identifier hs-type">userInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072181"><span class="hs-identifier hs-type">req</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072179"><span class="hs-identifier hs-type">sc</span></a></span><span>
</span><span id="line-767"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621688072181"><span class="hs-identifier hs-type">req</span></a></span><span>
</span><span id="line-768"></span><span>
</span><span id="line-769"></span><span>  </span><span id="local-6989586621688072184"><span class="annot"><span class="annottext">executeIntrospection :: UserInfo
-&gt; Value
-&gt; SetGraphqlIntrospectionOptions
-&gt; AppM (Either QErr ExecutionStep)
</span><a href="#local-6989586621688072184"><span class="hs-identifier hs-var hs-var hs-var">executeIntrospection</span></a></span></span><span> </span><span class="annot"><span class="annottext">UserInfo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688072186"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688072186"><span class="hs-identifier hs-var">introspectionQuery</span></a></span></span><span> </span><span class="annot"><span class="annottext">SetGraphqlIntrospectionOptions
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-770"></span><span>    </span><span class="annot"><span class="annottext">Either QErr ExecutionStep -&gt; AppM (Either QErr ExecutionStep)
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr ExecutionStep -&gt; AppM (Either QErr ExecutionStep))
-&gt; Either QErr ExecutionStep -&gt; AppM (Either QErr ExecutionStep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExecutionStep -&gt; Either QErr ExecutionStep
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(ExecutionStep -&gt; Either QErr ExecutionStep)
-&gt; ExecutionStep -&gt; Either QErr ExecutionStep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; ExecutionStep
</span><a href="Hasura.GraphQL.Execute.Backend.html#ExecStepRaw"><span class="hs-identifier hs-var">ExecStepRaw</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688072186"><span class="hs-identifier hs-var">introspectionQuery</span></a></span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span>  </span><span id="local-6989586621688072191"><span class="annot"><span class="annottext">checkGQLBatchedReqs :: UserInfo
-&gt; RequestId
-&gt; [GQLReqUnparsed]
-&gt; SchemaCache
-&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072191"><span class="hs-identifier hs-var hs-var hs-var">checkGQLBatchedReqs</span></a></span></span><span> </span><span class="annot"><span class="annottext">UserInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[GQLReqUnparsed]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr AppM () -&gt; AppM (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr AppM () -&gt; AppM (Either QErr ()))
-&gt; ExceptT QErr AppM () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT QErr AppM ()
forall a. a -&gt; ExceptT QErr AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#MonadConfigApiHandler"><span class="hs-identifier hs-type">MonadConfigApiHandler</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-775"></span><span>  </span><span id="local-6989586621688072205"><span class="annot"><span class="annottext">runConfigApiHandler :: forall impl. AppStateRef impl -&gt; SpockCtxT () AppM ()
</span><a href="#local-6989586621688072205"><span class="hs-identifier hs-var hs-var hs-var">runConfigApiHandler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppStateRef impl -&gt; SpockCtxT () AppM ()
forall (m :: * -&gt; *) impl.
(MonadIO m, MonadBaseControl IO m, HasAppEnv m,
 UserAuthentication m, HttpLog m, HasResourceLimits m,
 MonadTrace m) =&gt;
AppStateRef impl -&gt; SpockCtxT () m ()
</span><a href="Hasura.Server.App.html#configApiGetHandler"><span class="hs-identifier hs-var">configApiGetHandler</span></a></span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#MonadGQLApiHandler"><span class="hs-identifier hs-type">MonadGQLApiHandler</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-778"></span><span>  </span><span id="local-6989586621688072218"><span class="annot"><span class="annottext">runPersistedQueriesGetHandler :: PersistedQueriesState
-&gt; Int
-&gt; TraceMetadata
-&gt; Handler AppM (HttpLogGraphQLInfo, APIResp)
</span><a href="#local-6989586621688072218"><span class="hs-identifier hs-var hs-var hs-var">runPersistedQueriesGetHandler</span></a></span></span><span> </span><span class="annot"><span class="annottext">PersistedQueriesState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TraceMetadata
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; Handler AppM (HttpLogGraphQLInfo, APIResp)
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;PersistedQueryNotSupported&quot;</span></span><span>
</span><span id="line-779"></span><span>  </span><span id="local-6989586621688072271"><span class="annot"><span class="annottext">runPersistedQueriesPostHandler :: PersistedQueriesState
-&gt; Int
-&gt; ExtQueryReqs
-&gt; Handler AppM (HttpLogGraphQLInfo, HttpResponse EncJSON)
</span><a href="#local-6989586621688072271"><span class="hs-identifier hs-var hs-var hs-var">runPersistedQueriesPostHandler</span></a></span></span><span> </span><span class="annot"><span class="annottext">PersistedQueriesState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688072273"><span class="annot"><span class="annottext">ExtQueryReqs
</span><a href="#local-6989586621688072273"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-780"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtQueryReqs
</span><a href="#local-6989586621688072273"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-781"></span><span>      </span><span class="annot"><a href="Hasura.Server.Types.html#EqrGQLReq"><span class="hs-identifier hs-type">EqrGQLReq</span></a></span><span> </span><span id="local-6989586621688072275"><span class="annot"><span class="annottext">ReqsText
</span><a href="#local-6989586621688072275"><span class="hs-identifier hs-var">gqlReq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReqsText -&gt; Handler AppM (HttpLogGraphQLInfo, HttpResponse EncJSON)
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m, MonadGQLExecutionCheck m,
 MonadQueryLog m, MonadExecutionLog m, MonadTrace m, HasAppEnv m,
 MonadExecuteQuery m, MonadError QErr m, MonadReader HandlerCtx m,
 MonadMetadataStorage m, MonadQueryTags m, HasResourceLimits m,
 ProvidesNetwork m, MonadGetPolicies m) =&gt;
ReqsText -&gt; m (HttpLogGraphQLInfo, HttpResponse EncJSON)
</span><a href="Hasura.Server.App.html#v1GQHandler"><span class="hs-identifier hs-var">v1GQHandler</span></a></span><span> </span><span class="annot"><span class="annottext">ReqsText
</span><a href="#local-6989586621688072275"><span class="hs-identifier hs-var">gqlReq</span></a></span><span>
</span><span id="line-782"></span><span>      </span><span class="annot"><a href="Hasura.Server.Types.html#EqrAPQReq"><span class="hs-identifier hs-type">EqrAPQReq</span></a></span><span> </span><span class="annot"><span class="annottext">ExtPersistedQueryRequest GQLReqUnparsed
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Code
-&gt; Text -&gt; Handler AppM (HttpLogGraphQLInfo, HttpResponse EncJSON)
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;PersistedQueryNotSupported&quot;</span></span><span>
</span><span id="line-783"></span><span>
</span><span id="line-784"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Logging.QueryLog.html#MonadQueryLog"><span class="hs-identifier hs-type">MonadQueryLog</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-785"></span><span>  </span><span id="local-6989586621688072286"><span class="annot"><span class="annottext">logQueryLog :: Logger Hasura -&gt; QueryLog -&gt; AppM ()
</span><a href="#local-6989586621688072286"><span class="hs-identifier hs-var hs-var hs-var">logQueryLog</span></a></span></span><span> </span><span id="local-6989586621688072288"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072288"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLoggerTracing"><span class="hs-identifier hs-var">unLoggerTracing</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072288"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-786"></span><span>
</span><span id="line-787"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Logging.ExecutionLog.html#MonadExecutionLog"><span class="hs-identifier hs-type">MonadExecutionLog</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-788"></span><span>  </span><span id="local-6989586621688072297"><span class="annot"><span class="annottext">logExecutionLog :: Logger Hasura -&gt; ExecutionLog -&gt; AppM ()
</span><a href="#local-6989586621688072297"><span class="hs-identifier hs-var hs-var hs-var">logExecutionLog</span></a></span></span><span> </span><span id="local-6989586621688072299"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072299"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLoggerTracing"><span class="hs-identifier hs-var">unLoggerTracing</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072299"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#MonadWSLog"><span class="hs-identifier hs-type">WS.MonadWSLog</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-791"></span><span>  </span><span id="local-6989586621688072309"><span class="annot"><span class="annottext">logWSLog :: Logger Hasura -&gt; WSLog -&gt; AppM ()
</span><a href="#local-6989586621688072309"><span class="hs-identifier hs-var hs-var hs-var">logWSLog</span></a></span></span><span> </span><span id="local-6989586621688072311"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072311"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLoggerTracing"><span class="hs-identifier hs-var">unLoggerTracing</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072311"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-792"></span><span>
</span><span id="line-793"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-794"></span><span>  </span><span id="local-6989586621688072319"><span class="annot"><span class="annottext">getPGSourceResolver :: AppM (SourceResolver ('Postgres 'Vanilla))
</span><a href="#local-6989586621688072319"><span class="hs-identifier hs-var hs-var hs-var">getPGSourceResolver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AppEnv
 -&gt; Environment
 -&gt; SourceName
 -&gt; PostgresConnConfiguration
 -&gt; IO (Either QErr PGSourceConfig))
-&gt; AppM
     (Environment
      -&gt; SourceName
      -&gt; PostgresConnConfiguration
      -&gt; IO (Either QErr PGSourceConfig))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGLogger -&gt; SourceResolver ('Postgres 'Vanilla)
PGLogger
-&gt; Environment
-&gt; SourceName
-&gt; PostgresConnConfiguration
-&gt; IO (Either QErr PGSourceConfig)
</span><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier hs-var">mkPgSourceResolver</span></a></span><span> </span><span class="annot"><span class="annottext">(PGLogger
 -&gt; Environment
 -&gt; SourceName
 -&gt; PostgresConnConfiguration
 -&gt; IO (Either QErr PGSourceConfig))
-&gt; (AppEnv -&gt; PGLogger)
-&gt; AppEnv
-&gt; Environment
-&gt; SourceName
-&gt; PostgresConnConfiguration
-&gt; IO (Either QErr PGSourceConfig)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Loggers -&gt; PGLogger
</span><a href="Hasura.App.State.html#_lsPgLogger"><span class="hs-identifier hs-var">_lsPgLogger</span></a></span><span> </span><span class="annot"><span class="annottext">(Loggers -&gt; PGLogger) -&gt; (AppEnv -&gt; Loggers) -&gt; AppEnv -&gt; PGLogger
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">AppEnv -&gt; Loggers
</span><a href="Hasura.App.State.html#appEnvLoggers"><span class="hs-identifier hs-var">appEnvLoggers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-795"></span><span>  </span><span id="local-6989586621688072323"><span class="annot"><span class="annottext">getMSSQLSourceResolver :: AppM (SourceResolver 'MSSQL)
</span><a href="#local-6989586621688072323"><span class="hs-identifier hs-var hs-var hs-var">getMSSQLSourceResolver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Environment
 -&gt; SourceName
 -&gt; MSSQLConnConfiguration
 -&gt; IO (Either QErr MSSQLSourceConfig))
-&gt; AppM
     (Environment
      -&gt; SourceName
      -&gt; MSSQLConnConfiguration
      -&gt; IO (Either QErr MSSQLSourceConfig))
forall a. a -&gt; AppM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; SourceName
-&gt; MSSQLConnConfiguration
-&gt; IO (Either QErr MSSQLSourceConfig)
SourceResolver 'MSSQL
</span><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier hs-var">mkMSSQLSourceResolver</span></a></span><span>
</span><span id="line-796"></span><span>
</span><span id="line-797"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.QueryTags.html#MonadQueryTags"><span class="hs-identifier hs-type">MonadQueryTags</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-798"></span><span>  </span><span id="local-6989586621688072331"><span class="annot"><span class="annottext">createQueryTags :: QueryTagsAttributes
-&gt; Maybe QueryTagsConfig -&gt; Tagged AppM QueryTagsComment
</span><a href="#local-6989586621688072331"><span class="hs-identifier hs-var hs-var hs-var">createQueryTags</span></a></span></span><span> </span><span id="local-6989586621688072333"><span class="annot"><span class="annottext">QueryTagsAttributes
</span><a href="#local-6989586621688072333"><span class="hs-identifier hs-var">_attributes</span></a></span></span><span> </span><span id="local-6989586621688072334"><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><a href="#local-6989586621688072334"><span class="hs-identifier hs-var">_qtSourceConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryTagsComment -&gt; Tagged AppM QueryTagsComment
forall a. a -&gt; Tagged AppM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(QueryTagsComment -&gt; Tagged AppM QueryTagsComment)
-&gt; QueryTagsComment -&gt; Tagged AppM QueryTagsComment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QueryTagsComment
</span><a href="Hasura.QueryTags.html#emptyQueryTagsComment"><span class="hs-identifier hs-var">emptyQueryTagsComment</span></a></span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html#MonadEventLogCleanup"><span class="hs-identifier hs-type">MonadEventLogCleanup</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-801"></span><span>  </span><span id="local-6989586621688072347"><span class="annot"><span class="annottext">runLogCleaner :: SourceCache
-&gt; TriggerLogCleanupConfig -&gt; AppM (Either QErr EncJSON)
</span><a href="#local-6989586621688072347"><span class="hs-identifier hs-var hs-var hs-var">runLogCleaner</span></a></span></span><span> </span><span class="annot"><span class="annottext">SourceCache
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TriggerLogCleanupConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either QErr EncJSON -&gt; AppM (Either QErr EncJSON)
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr EncJSON -&gt; AppM (Either QErr EncJSON))
-&gt; Either QErr EncJSON -&gt; AppM (Either QErr EncJSON)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; Either QErr EncJSON
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event log cleanup feature is enterprise edition only&quot;</span></span><span>
</span><span id="line-802"></span><span>  </span><span id="local-6989586621688072350"><span class="annot"><span class="annottext">generateCleanupSchedules :: AnyBackend SourceInfo
-&gt; TriggerName
-&gt; AutoTriggerLogCleanupConfig
-&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072350"><span class="hs-identifier hs-var hs-var hs-var">generateCleanupSchedules</span></a></span></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AutoTriggerLogCleanupConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; AppM (Either QErr ())
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; AppM (Either QErr ()))
-&gt; Either QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either QErr ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span>  </span><span id="local-6989586621688072353"><span class="annot"><span class="annottext">updateTriggerCleanupSchedules :: Logger Hasura
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; InsOrdHashMap SourceName BackendSourceMetadata
-&gt; SchemaCache
-&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072353"><span class="hs-identifier hs-var hs-var hs-var">updateTriggerCleanupSchedules</span></a></span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap SourceName BackendSourceMetadata
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; AppM (Either QErr ())
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; AppM (Either QErr ()))
-&gt; Either QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either QErr ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-804"></span><span>
</span><span id="line-805"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MonadGetPolicies"><span class="hs-identifier hs-type">MonadGetPolicies</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-806"></span><span>  </span><span id="local-6989586621688072362"><span class="annot"><span class="annottext">runGetApiTimeLimit :: AppM (Maybe MaxTime)
</span><a href="#local-6989586621688072362"><span class="hs-identifier hs-var hs-var hs-var">runGetApiTimeLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe MaxTime -&gt; AppM (Maybe MaxTime)
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe MaxTime -&gt; AppM (Maybe MaxTime))
-&gt; Maybe MaxTime -&gt; AppM (Maybe MaxTime)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe MaxTime
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-807"></span><span>  </span><span id="local-6989586621688072366"><span class="annot"><span class="annottext">runGetPrometheusMetricsGranularity :: AppM (IO GranularPrometheusMetricsState)
</span><a href="#local-6989586621688072366"><span class="hs-identifier hs-var hs-var hs-var">runGetPrometheusMetricsGranularity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; AppM (IO GranularPrometheusMetricsState)
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GranularPrometheusMetricsState -&gt; IO GranularPrometheusMetricsState
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">GranularPrometheusMetricsState
</span><a href="Hasura.Server.Types.html#GranularMetricsOff"><span class="hs-identifier hs-var">GranularMetricsOff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-808"></span><span>  </span><span id="local-6989586621688072371"><span class="annot"><span class="annottext">runGetModelInfoLogStatus :: AppM (IO ModelInfoLogState)
</span><a href="#local-6989586621688072371"><span class="hs-identifier hs-var hs-var hs-var">runGetModelInfoLogStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ModelInfoLogState -&gt; AppM (IO ModelInfoLogState)
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModelInfoLogState -&gt; IO ModelInfoLogState
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ModelInfoLogState
</span><a href="Hasura.Server.Types.html#ModelInfoLogOff"><span class="hs-identifier hs-var">ModelInfoLogOff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-809"></span><span>
</span><span id="line-810"></span><span class="annot"><span class="hs-comment">-- | Each of the function in the type class is executed in a totally separate transaction.</span></span><span>
</span><span id="line-811"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-812"></span><span>  </span><span id="local-6989586621688072407"><span class="annot"><span class="annottext">fetchMetadataResourceVersion :: AppM (Either QErr MetadataResourceVersion)
</span><a href="#local-6989586621688072407"><span class="hs-identifier hs-var hs-var hs-var">fetchMetadataResourceVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataResourceVersion
-&gt; AppM (Either QErr MetadataResourceVersion)
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataResourceVersion
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataResourceVersionFromCatalog"><span class="hs-identifier hs-var">fetchMetadataResourceVersionFromCatalog</span></a></span><span>
</span><span id="line-813"></span><span>  </span><span id="local-6989586621688072411"><span class="annot"><span class="annottext">fetchMetadata :: AppM (Either QErr MetadataWithResourceVersion)
</span><a href="#local-6989586621688072411"><span class="hs-identifier hs-var hs-var hs-var">fetchMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataWithResourceVersion
-&gt; AppM (Either QErr MetadataWithResourceVersion)
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataWithResourceVersion
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataAndResourceVersionFromCatalog"><span class="hs-identifier hs-var">fetchMetadataAndResourceVersionFromCatalog</span></a></span><span>
</span><span id="line-814"></span><span>  </span><span id="local-6989586621688072414"><span class="annot"><span class="annottext">fetchMetadataNotifications :: MetadataResourceVersion
-&gt; InstanceId
-&gt; AppM
     (Either QErr [(MetadataResourceVersion, CacheInvalidations)])
</span><a href="#local-6989586621688072414"><span class="hs-identifier hs-var hs-var hs-var">fetchMetadataNotifications</span></a></span></span><span> </span><span id="local-6989586621688072416"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688072416"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072417"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688072417"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr [(MetadataResourceVersion, CacheInvalidations)]
-&gt; AppM
     (Either QErr [(MetadataResourceVersion, CacheInvalidations)])
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr [(MetadataResourceVersion, CacheInvalidations)]
 -&gt; AppM
      (Either QErr [(MetadataResourceVersion, CacheInvalidations)]))
-&gt; TxE QErr [(MetadataResourceVersion, CacheInvalidations)]
-&gt; AppM
     (Either QErr [(MetadataResourceVersion, CacheInvalidations)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; InstanceId
-&gt; TxE QErr [(MetadataResourceVersion, CacheInvalidations)]
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataNotificationsFromCatalog"><span class="hs-identifier hs-var">fetchMetadataNotificationsFromCatalog</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688072416"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688072417"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-815"></span><span>  </span><span id="local-6989586621688072419"><span class="annot"><span class="annottext">setMetadata :: MetadataResourceVersion
-&gt; Metadata -&gt; AppM (Either QErr MetadataResourceVersion)
</span><a href="#local-6989586621688072419"><span class="hs-identifier hs-var hs-var hs-var">setMetadata</span></a></span></span><span> </span><span id="local-6989586621688072421"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688072421"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataResourceVersion
-&gt; AppM (Either QErr MetadataResourceVersion)
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr MetadataResourceVersion
 -&gt; AppM (Either QErr MetadataResourceVersion))
-&gt; (Metadata -&gt; TxE QErr MetadataResourceVersion)
-&gt; Metadata
-&gt; AppM (Either QErr MetadataResourceVersion)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; Metadata -&gt; TxE QErr MetadataResourceVersion
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#setMetadataInCatalog"><span class="hs-identifier hs-var">setMetadataInCatalog</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688072421"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-816"></span><span>  </span><span id="local-6989586621688072423"><span class="annot"><span class="annottext">notifySchemaCacheSync :: MetadataResourceVersion
-&gt; InstanceId -&gt; CacheInvalidations -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072423"><span class="hs-identifier hs-var hs-var hs-var">notifySchemaCacheSync</span></a></span></span><span> </span><span id="local-6989586621688072425"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688072425"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072426"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688072426"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621688072427"><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688072427"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; TxE QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; InstanceId -&gt; CacheInvalidations -&gt; TxE QErr ()
</span><a href="Hasura.App.html#notifySchemaCacheSyncTx"><span class="hs-identifier hs-var">notifySchemaCacheSyncTx</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688072425"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688072426"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688072427"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-817"></span><span>  </span><span id="local-6989586621688072428"><span class="annot"><span class="annottext">getCatalogState :: AppM (Either QErr CatalogState)
</span><a href="#local-6989586621688072428"><span class="hs-identifier hs-var hs-var hs-var">getCatalogState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr CatalogState -&gt; AppM (Either QErr CatalogState)
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr CatalogState
</span><a href="Hasura.App.html#getCatalogStateTx"><span class="hs-identifier hs-var">getCatalogStateTx</span></a></span><span>
</span><span id="line-818"></span><span>  </span><span id="local-6989586621688072430"><span class="annot"><span class="annottext">setCatalogState :: CatalogStateType -&gt; Value -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072430"><span class="hs-identifier hs-var hs-var hs-var">setCatalogState</span></a></span></span><span> </span><span id="local-6989586621688072432"><span class="annot"><span class="annottext">CatalogStateType
</span><a href="#local-6989586621688072432"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072433"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688072433"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; TxE QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CatalogStateType -&gt; Value -&gt; TxE QErr ()
</span><a href="Hasura.App.html#setCatalogStateTx"><span class="hs-identifier hs-var">setCatalogStateTx</span></a></span><span> </span><span class="annot"><span class="annottext">CatalogStateType
</span><a href="#local-6989586621688072432"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688072433"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-819"></span><span>
</span><span id="line-820"></span><span>  </span><span class="hs-comment">-- stored source introspection is not available in this distribution</span><span>
</span><span id="line-821"></span><span>  </span><span id="local-6989586621688072435"><span class="annot"><span class="annottext">fetchSourceIntrospection :: MetadataResourceVersion
-&gt; AppM (Either QErr (Maybe StoredIntrospection))
</span><a href="#local-6989586621688072435"><span class="hs-identifier hs-var hs-var hs-var">fetchSourceIntrospection</span></a></span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either QErr (Maybe StoredIntrospection)
-&gt; AppM (Either QErr (Maybe StoredIntrospection))
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr (Maybe StoredIntrospection)
 -&gt; AppM (Either QErr (Maybe StoredIntrospection)))
-&gt; Either QErr (Maybe StoredIntrospection)
-&gt; AppM (Either QErr (Maybe StoredIntrospection))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe StoredIntrospection
-&gt; Either QErr (Maybe StoredIntrospection)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Maybe StoredIntrospection
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-822"></span><span>  </span><span id="local-6989586621688072438"><span class="annot"><span class="annottext">storeSourceIntrospection :: StoredIntrospection
-&gt; MetadataResourceVersion -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072438"><span class="hs-identifier hs-var hs-var hs-var">storeSourceIntrospection</span></a></span></span><span> </span><span class="annot"><span class="annottext">StoredIntrospection
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; AppM (Either QErr ())
forall a. a -&gt; AppM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; AppM (Either QErr ()))
-&gt; Either QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either QErr ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-823"></span><span>
</span><span id="line-824"></span><span>  </span><span id="local-6989586621688072440"><span class="annot"><span class="annottext">getMetadataDbUid :: AppM (Either QErr MetadataDbId)
</span><a href="#local-6989586621688072440"><span class="hs-identifier hs-var hs-var hs-var">getMetadataDbUid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataDbId -&gt; AppM (Either QErr MetadataDbId)
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataDbId
</span><a href="Hasura.Server.Init.html#getDbId"><span class="hs-identifier hs-var">getDbId</span></a></span><span>
</span><span id="line-825"></span><span>  </span><span id="local-6989586621688072444"><span class="annot"><span class="annottext">checkMetadataStorageHealth :: AppM (Either QErr ())
</span><a href="#local-6989586621688072444"><span class="hs-identifier hs-var hs-var hs-var">checkMetadataStorageHealth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; TxE QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TxE QErr ()
forall (m :: * -&gt; *). MonadTx m =&gt; m ()
</span><a href="Hasura.Backends.Postgres.Connection.MonadTx.html#checkDbConnection"><span class="hs-identifier hs-var">checkDbConnection</span></a></span><span>
</span><span id="line-826"></span><span>
</span><span id="line-827"></span><span>  </span><span id="local-6989586621688072447"><span class="annot"><span class="annottext">getDeprivedCronTriggerStats :: [TriggerName] -&gt; AppM (Either QErr [CronTriggerStats])
</span><a href="#local-6989586621688072447"><span class="hs-identifier hs-var hs-var hs-var">getDeprivedCronTriggerStats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr [CronTriggerStats]
-&gt; AppM (Either QErr [CronTriggerStats])
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr [CronTriggerStats]
 -&gt; AppM (Either QErr [CronTriggerStats]))
-&gt; ([TriggerName] -&gt; TxE QErr [CronTriggerStats])
-&gt; [TriggerName]
-&gt; AppM (Either QErr [CronTriggerStats])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TriggerName] -&gt; TxE QErr [CronTriggerStats]
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getDeprivedCronTriggerStatsTx"><span class="hs-identifier hs-var">getDeprivedCronTriggerStatsTx</span></a></span><span>
</span><span id="line-828"></span><span>  </span><span id="local-6989586621688072450"><span class="annot"><span class="annottext">getScheduledEventsForDelivery :: [TriggerName]
-&gt; AppM (Either QErr ([CronEvent], [OneOffScheduledEvent]))
</span><a href="#local-6989586621688072450"><span class="hs-identifier hs-var hs-var hs-var">getScheduledEventsForDelivery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr ([CronEvent], [OneOffScheduledEvent])
-&gt; AppM (Either QErr ([CronEvent], [OneOffScheduledEvent]))
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr ([CronEvent], [OneOffScheduledEvent])
 -&gt; AppM (Either QErr ([CronEvent], [OneOffScheduledEvent])))
-&gt; ([TriggerName]
    -&gt; TxE QErr ([CronEvent], [OneOffScheduledEvent]))
-&gt; [TriggerName]
-&gt; AppM (Either QErr ([CronEvent], [OneOffScheduledEvent]))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TriggerName] -&gt; TxE QErr ([CronEvent], [OneOffScheduledEvent])
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getScheduledEventsForDeliveryTx"><span class="hs-identifier hs-var">getScheduledEventsForDeliveryTx</span></a></span><span>
</span><span id="line-829"></span><span>  </span><span id="local-6989586621688072453"><span class="annot"><span class="annottext">insertCronEvents :: [CronEventSeed] -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072453"><span class="hs-identifier hs-var hs-var hs-var">insertCronEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; ([CronEventSeed] -&gt; TxE QErr ())
-&gt; [CronEventSeed]
-&gt; AppM (Either QErr ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[CronEventSeed] -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#insertCronEventsTx"><span class="hs-identifier hs-var">insertCronEventsTx</span></a></span><span>
</span><span id="line-830"></span><span>  </span><span id="local-6989586621688072456"><span class="annot"><span class="annottext">insertOneOffScheduledEvent :: OneOffEvent -&gt; AppM (Either QErr CronEventId)
</span><a href="#local-6989586621688072456"><span class="hs-identifier hs-var hs-var hs-var">insertOneOffScheduledEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr CronEventId -&gt; AppM (Either QErr CronEventId)
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr CronEventId -&gt; AppM (Either QErr CronEventId))
-&gt; (OneOffEvent -&gt; TxE QErr CronEventId)
-&gt; OneOffEvent
-&gt; AppM (Either QErr CronEventId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OneOffEvent -&gt; TxE QErr CronEventId
</span><a href="Hasura.Eventing.ScheduledTrigger.html#insertOneOffScheduledEventTx"><span class="hs-identifier hs-var">insertOneOffScheduledEventTx</span></a></span><span>
</span><span id="line-831"></span><span>  </span><span id="local-6989586621688072459"><span class="annot"><span class="annottext">insertScheduledEventInvocation :: Invocation 'ScheduledType
-&gt; ScheduledEventType -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072459"><span class="hs-identifier hs-var hs-var hs-var">insertScheduledEventInvocation</span></a></span></span><span> </span><span id="local-6989586621688072461"><span class="annot"><span class="annottext">Invocation 'ScheduledType
</span><a href="#local-6989586621688072461"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072462"><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688072462"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; TxE QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'ScheduledType -&gt; ScheduledEventType -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#insertInvocationTx"><span class="hs-identifier hs-var">insertInvocationTx</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'ScheduledType
</span><a href="#local-6989586621688072461"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688072462"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-832"></span><span>  </span><span id="local-6989586621688072464"><span class="annot"><span class="annottext">setScheduledEventOp :: CronEventId
-&gt; ScheduledEventOp -&gt; ScheduledEventType -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072464"><span class="hs-identifier hs-var hs-var hs-var">setScheduledEventOp</span></a></span></span><span> </span><span id="local-6989586621688072466"><span class="annot"><span class="annottext">CronEventId
</span><a href="#local-6989586621688072466"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072467"><span class="annot"><span class="annottext">ScheduledEventOp
</span><a href="#local-6989586621688072467"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621688072468"><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688072468"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; TxE QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CronEventId
-&gt; ScheduledEventOp -&gt; ScheduledEventType -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#setScheduledEventOpTx"><span class="hs-identifier hs-var">setScheduledEventOpTx</span></a></span><span> </span><span class="annot"><span class="annottext">CronEventId
</span><a href="#local-6989586621688072466"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventOp
</span><a href="#local-6989586621688072467"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688072468"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-833"></span><span>  </span><span id="local-6989586621688072470"><span class="annot"><span class="annottext">unlockScheduledEvents :: ScheduledEventType -&gt; [CronEventId] -&gt; AppM (Either QErr Int)
</span><a href="#local-6989586621688072470"><span class="hs-identifier hs-var hs-var hs-var">unlockScheduledEvents</span></a></span></span><span> </span><span id="local-6989586621688072472"><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688072472"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072473"><span class="annot"><span class="annottext">[CronEventId]
</span><a href="#local-6989586621688072473"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr Int -&gt; AppM (Either QErr Int)
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr Int -&gt; AppM (Either QErr Int))
-&gt; TxE QErr Int -&gt; AppM (Either QErr Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType -&gt; [CronEventId] -&gt; TxE QErr Int
</span><a href="Hasura.Eventing.ScheduledTrigger.html#unlockScheduledEventsTx"><span class="hs-identifier hs-var">unlockScheduledEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688072472"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">[CronEventId]
</span><a href="#local-6989586621688072473"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-834"></span><span>  </span><span id="local-6989586621688072475"><span class="annot"><span class="annottext">unlockAllLockedScheduledEvents :: AppM (Either QErr ())
</span><a href="#local-6989586621688072475"><span class="hs-identifier hs-var hs-var hs-var">unlockAllLockedScheduledEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#unlockAllLockedScheduledEventsTx"><span class="hs-identifier hs-var">unlockAllLockedScheduledEventsTx</span></a></span><span>
</span><span id="line-835"></span><span>  </span><span id="local-6989586621688072478"><span class="annot"><span class="annottext">clearFutureCronEvents :: ClearCronEvents -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072478"><span class="hs-identifier hs-var hs-var hs-var">clearFutureCronEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; (ClearCronEvents -&gt; TxE QErr ())
-&gt; ClearCronEvents
-&gt; AppM (Either QErr ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ClearCronEvents -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#dropFutureCronEventsTx"><span class="hs-identifier hs-var">dropFutureCronEventsTx</span></a></span><span>
</span><span id="line-836"></span><span>  </span><span id="local-6989586621688072481"><span class="annot"><span class="annottext">getOneOffScheduledEvents :: ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; RowsCountOption
-&gt; [OrderByItem]
-&gt; AppM
     (Either QErr (WithOptionalTotalCount [OneOffScheduledEvent]))
</span><a href="#local-6989586621688072481"><span class="hs-identifier hs-var hs-var hs-var">getOneOffScheduledEvents</span></a></span></span><span> </span><span id="local-6989586621688072483"><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688072483"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072484"><span class="annot"><span class="annottext">[ScheduledEventStatus]
</span><a href="#local-6989586621688072484"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621688072485"><span class="annot"><span class="annottext">RowsCountOption
</span><a href="#local-6989586621688072485"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621688072486"><span class="annot"><span class="annottext">[OrderByItem]
</span><a href="#local-6989586621688072486"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr (WithOptionalTotalCount [OneOffScheduledEvent])
-&gt; AppM
     (Either QErr (WithOptionalTotalCount [OneOffScheduledEvent]))
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr (WithOptionalTotalCount [OneOffScheduledEvent])
 -&gt; AppM
      (Either QErr (WithOptionalTotalCount [OneOffScheduledEvent])))
-&gt; TxE QErr (WithOptionalTotalCount [OneOffScheduledEvent])
-&gt; AppM
     (Either QErr (WithOptionalTotalCount [OneOffScheduledEvent]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; RowsCountOption
-&gt; [OrderByItem]
-&gt; TxE QErr (WithOptionalTotalCount [OneOffScheduledEvent])
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getOneOffScheduledEventsTx"><span class="hs-identifier hs-var">getOneOffScheduledEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688072483"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">[ScheduledEventStatus]
</span><a href="#local-6989586621688072484"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">RowsCountOption
</span><a href="#local-6989586621688072485"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[OrderByItem]
</span><a href="#local-6989586621688072486"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-837"></span><span>  </span><span id="local-6989586621688072488"><span class="annot"><span class="annottext">getCronEvents :: TriggerName
-&gt; ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; RowsCountOption
-&gt; [OrderByItem]
-&gt; AppM (Either QErr (WithOptionalTotalCount [CronEvent]))
</span><a href="#local-6989586621688072488"><span class="hs-identifier hs-var hs-var hs-var">getCronEvents</span></a></span></span><span> </span><span id="local-6989586621688072490"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688072490"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072491"><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688072491"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621688072492"><span class="annot"><span class="annottext">[ScheduledEventStatus]
</span><a href="#local-6989586621688072492"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621688072493"><span class="annot"><span class="annottext">RowsCountOption
</span><a href="#local-6989586621688072493"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621688072494"><span class="annot"><span class="annottext">[OrderByItem]
</span><a href="#local-6989586621688072494"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr (WithOptionalTotalCount [CronEvent])
-&gt; AppM (Either QErr (WithOptionalTotalCount [CronEvent]))
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr (WithOptionalTotalCount [CronEvent])
 -&gt; AppM (Either QErr (WithOptionalTotalCount [CronEvent])))
-&gt; TxE QErr (WithOptionalTotalCount [CronEvent])
-&gt; AppM (Either QErr (WithOptionalTotalCount [CronEvent]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; RowsCountOption
-&gt; [OrderByItem]
-&gt; TxE QErr (WithOptionalTotalCount [CronEvent])
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getCronEventsTx"><span class="hs-identifier hs-var">getCronEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688072490"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688072491"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">[ScheduledEventStatus]
</span><a href="#local-6989586621688072492"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">RowsCountOption
</span><a href="#local-6989586621688072493"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">[OrderByItem]
</span><a href="#local-6989586621688072494"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-838"></span><span>  </span><span id="local-6989586621688072496"><span class="annot"><span class="annottext">getScheduledEventInvocations :: GetScheduledEventInvocations
-&gt; AppM
     (Either QErr (WithOptionalTotalCount [ScheduledEventInvocation]))
</span><a href="#local-6989586621688072496"><span class="hs-identifier hs-var hs-var hs-var">getScheduledEventInvocations</span></a></span></span><span> </span><span id="local-6989586621688072498"><span class="annot"><span class="annottext">GetScheduledEventInvocations
</span><a href="#local-6989586621688072498"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr (WithOptionalTotalCount [ScheduledEventInvocation])
-&gt; AppM
     (Either QErr (WithOptionalTotalCount [ScheduledEventInvocation]))
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr (WithOptionalTotalCount [ScheduledEventInvocation])
 -&gt; AppM
      (Either QErr (WithOptionalTotalCount [ScheduledEventInvocation])))
-&gt; TxE QErr (WithOptionalTotalCount [ScheduledEventInvocation])
-&gt; AppM
     (Either QErr (WithOptionalTotalCount [ScheduledEventInvocation]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GetScheduledEventInvocations
-&gt; TxE QErr (WithOptionalTotalCount [ScheduledEventInvocation])
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getScheduledEventInvocationsTx"><span class="hs-identifier hs-var">getScheduledEventInvocationsTx</span></a></span><span> </span><span class="annot"><span class="annottext">GetScheduledEventInvocations
</span><a href="#local-6989586621688072498"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-839"></span><span>  </span><span id="local-6989586621688072500"><span class="annot"><span class="annottext">deleteScheduledEvent :: CronEventId -&gt; ScheduledEventType -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072500"><span class="hs-identifier hs-var hs-var hs-var">deleteScheduledEvent</span></a></span></span><span> </span><span id="local-6989586621688072502"><span class="annot"><span class="annottext">CronEventId
</span><a href="#local-6989586621688072502"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072503"><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688072503"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; TxE QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CronEventId -&gt; ScheduledEventType -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#deleteScheduledEventTx"><span class="hs-identifier hs-var">deleteScheduledEventTx</span></a></span><span> </span><span class="annot"><span class="annottext">CronEventId
</span><a href="#local-6989586621688072502"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688072503"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-840"></span><span>
</span><span id="line-841"></span><span>  </span><span id="local-6989586621688072505"><span class="annot"><span class="annottext">insertAction :: ActionName
-&gt; SessionVariables
-&gt; [Header]
-&gt; Value
-&gt; AppM (Either QErr ActionId)
</span><a href="#local-6989586621688072505"><span class="hs-identifier hs-var hs-var hs-var">insertAction</span></a></span></span><span> </span><span id="local-6989586621688072507"><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688072507"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072508"><span class="annot"><span class="annottext">SessionVariables
</span><a href="#local-6989586621688072508"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621688072509"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688072509"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621688072510"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688072510"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr ActionId -&gt; AppM (Either QErr ActionId)
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr ActionId -&gt; AppM (Either QErr ActionId))
-&gt; TxE QErr ActionId -&gt; AppM (Either QErr ActionId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ActionName
-&gt; SessionVariables -&gt; [Header] -&gt; Value -&gt; TxE QErr ActionId
</span><a href="Hasura.GraphQL.Execute.Action.html#insertActionTx"><span class="hs-identifier hs-var">insertActionTx</span></a></span><span> </span><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688072507"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">SessionVariables
</span><a href="#local-6989586621688072508"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688072509"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688072510"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-842"></span><span>  </span><span id="local-6989586621688072512"><span class="annot"><span class="annottext">fetchUndeliveredActionEvents :: Int -&gt; AppM (Either QErr [ActionLogItem])
</span><a href="#local-6989586621688072512"><span class="hs-identifier hs-var hs-var hs-var">fetchUndeliveredActionEvents</span></a></span></span><span> </span><span id="local-6989586621688072514"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688072514"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr [ActionLogItem] -&gt; AppM (Either QErr [ActionLogItem])
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr [ActionLogItem] -&gt; AppM (Either QErr [ActionLogItem]))
-&gt; TxE QErr [ActionLogItem] -&gt; AppM (Either QErr [ActionLogItem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TxE QErr [ActionLogItem]
</span><a href="Hasura.GraphQL.Execute.Action.html#fetchUndeliveredActionEventsTx"><span class="hs-identifier hs-var">fetchUndeliveredActionEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688072514"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-843"></span><span>  </span><span id="local-6989586621688072516"><span class="annot"><span class="annottext">setActionStatus :: ActionId -&gt; AsyncActionStatus -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072516"><span class="hs-identifier hs-var hs-var hs-var">setActionStatus</span></a></span></span><span> </span><span id="local-6989586621688072518"><span class="annot"><span class="annottext">ActionId
</span><a href="#local-6989586621688072518"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688072519"><span class="annot"><span class="annottext">AsyncActionStatus
</span><a href="#local-6989586621688072519"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; TxE QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ActionId -&gt; AsyncActionStatus -&gt; TxE QErr ()
</span><a href="Hasura.GraphQL.Execute.Action.html#setActionStatusTx"><span class="hs-identifier hs-var">setActionStatusTx</span></a></span><span> </span><span class="annot"><span class="annottext">ActionId
</span><a href="#local-6989586621688072518"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncActionStatus
</span><a href="#local-6989586621688072519"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-844"></span><span>  </span><span id="local-6989586621688072521"><span class="annot"><span class="annottext">fetchActionResponse :: ActionId -&gt; AppM (Either QErr ActionLogResponse)
</span><a href="#local-6989586621688072521"><span class="hs-identifier hs-var hs-var hs-var">fetchActionResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr ActionLogResponse -&gt; AppM (Either QErr ActionLogResponse)
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr ActionLogResponse
 -&gt; AppM (Either QErr ActionLogResponse))
-&gt; (ActionId -&gt; TxE QErr ActionLogResponse)
-&gt; ActionId
-&gt; AppM (Either QErr ActionLogResponse)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ActionId -&gt; TxE QErr ActionLogResponse
</span><a href="Hasura.GraphQL.Execute.Action.html#fetchActionResponseTx"><span class="hs-identifier hs-var">fetchActionResponseTx</span></a></span><span>
</span><span id="line-845"></span><span>  </span><span id="local-6989586621688072524"><span class="annot"><span class="annottext">clearActionData :: ActionName -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072524"><span class="hs-identifier hs-var hs-var hs-var">clearActionData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; (ActionName -&gt; TxE QErr ())
-&gt; ActionName
-&gt; AppM (Either QErr ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ActionName -&gt; TxE QErr ()
</span><a href="Hasura.GraphQL.Execute.Action.html#clearActionDataTx"><span class="hs-identifier hs-var">clearActionDataTx</span></a></span><span>
</span><span id="line-846"></span><span>  </span><span id="local-6989586621688072527"><span class="annot"><span class="annottext">setProcessingActionLogsToPending :: LockedActionIdArray -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072527"><span class="hs-identifier hs-var hs-var hs-var">setProcessingActionLogsToPending</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; (LockedActionIdArray -&gt; TxE QErr ())
-&gt; LockedActionIdArray
-&gt; AppM (Either QErr ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LockedActionIdArray -&gt; TxE QErr ()
</span><a href="Hasura.GraphQL.Execute.Action.html#setProcessingActionLogsToPendingTx"><span class="hs-identifier hs-var">setProcessingActionLogsToPendingTx</span></a></span><span>
</span><span id="line-847"></span><span>
</span><span id="line-848"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadEECredentialsStorage"><span class="hs-identifier hs-type">MonadEECredentialsStorage</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-849"></span><span>  </span><span id="local-6989586621688072536"><span class="annot"><span class="annottext">getEEClientCredentials :: AppM (Either QErr (Maybe EEClientCredentials))
</span><a href="#local-6989586621688072536"><span class="hs-identifier hs-var hs-var hs-var">getEEClientCredentials</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr (Maybe EEClientCredentials)
-&gt; AppM (Either QErr (Maybe EEClientCredentials))
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr (Maybe EEClientCredentials)
</span><a href="Hasura.ClientCredentials.html#getEEClientCredentialsTx"><span class="hs-identifier hs-var">getEEClientCredentialsTx</span></a></span><span>
</span><span id="line-850"></span><span>  </span><span id="local-6989586621688072538"><span class="annot"><span class="annottext">setEEClientCredentials :: EEClientCredentials -&gt; AppM (Either QErr ())
</span><a href="#local-6989586621688072538"><span class="hs-identifier hs-var hs-var hs-var">setEEClientCredentials</span></a></span></span><span> </span><span id="local-6989586621688072540"><span class="annot"><span class="annottext">EEClientCredentials
</span><a href="#local-6989586621688072540"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; AppM (Either QErr ())
forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; AppM (Either QErr ()))
-&gt; TxE QErr () -&gt; AppM (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EEClientCredentials -&gt; TxE QErr ()
</span><a href="Hasura.ClientCredentials.html#setEEClientCredentialsTx"><span class="hs-identifier hs-var">setEEClientCredentialsTx</span></a></span><span> </span><span class="annot"><span class="annottext">EEClientCredentials
</span><a href="#local-6989586621688072540"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-853"></span><span class="hs-comment">-- misc</span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span class="hs-comment">-- TODO(SOLOMON): Move Into `Hasura.Server.Init`. Unable to do so</span><span>
</span><span id="line-856"></span><span class="hs-comment">-- currently due `throwErrExit`.</span><span>
</span><span id="line-857"></span><span>
</span><span id="line-858"></span><span class="annot"><span class="hs-comment">-- | Parse cli arguments to graphql-engine executable.</span></span><span>
</span><span id="line-859"></span><span id="local-6989586621688070511"><span class="annot"><a href="Hasura.App.html#parseArgs"><span class="hs-identifier hs-type">parseArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#EnabledLogTypes"><span class="hs-identifier hs-type">EnabledLogTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070511"><span class="hs-identifier hs-type">impl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Init.Config.html#HGEOptions"><span class="hs-identifier hs-type">HGEOptions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Init.Config.html#ServeOptions"><span class="hs-identifier hs-type">ServeOptions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070511"><span class="hs-identifier hs-type">impl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-860"></span><span id="parseArgs"><span class="annot"><span class="annottext">parseArgs :: forall impl.
EnabledLogTypes impl =&gt;
Environment -&gt; IO (HGEOptions (ServeOptions impl))
</span><a href="Hasura.App.html#parseArgs"><span class="hs-identifier hs-var hs-var">parseArgs</span></a></span></span><span> </span><span id="local-6989586621688072550"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688072550"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-861"></span><span>  </span><span id="local-6989586621688072551"><span class="annot"><a href="#local-6989586621688072551"><span class="hs-identifier hs-var">rawHGEOpts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ParserInfo (HGEOptionsRaw (ServeOptionsRaw impl))
-&gt; IO (HGEOptionsRaw (ServeOptionsRaw impl))
forall a. ParserInfo a -&gt; IO a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/optparse-applicative-0.18.1.0-08df638190761201024420c2e72e640380c9f6597c5ba4a4cf09ccc63be4d34f/share/doc/html/src/Options.Applicative.Extra.html/Options.Applicative.Extra.html#execParser"><span class="hs-identifier hs-var">execParser</span></a></span><span> </span><span class="annot"><span class="annottext">ParserInfo (HGEOptionsRaw (ServeOptionsRaw impl))
</span><a href="#local-6989586621688072553"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-862"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688072554"><span class="annot"><a href="#local-6989586621688072554"><span class="hs-identifier hs-var hs-var">eitherOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(String, String)]
-&gt; WithEnv (HGEOptions (ServeOptions impl))
-&gt; Either String (HGEOptions (ServeOptions impl))
forall a. [(String, String)] -&gt; WithEnv a -&gt; Either String a
</span><a href="Hasura.Server.Init.Env.html#runWithEnv"><span class="hs-identifier hs-var">runWithEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Environment -&gt; [(String, String)]
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html/Data.Environment.html#toList"><span class="hs-identifier hs-var">Env.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688072550"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WithEnv (HGEOptions (ServeOptions impl))
 -&gt; Either String (HGEOptions (ServeOptions impl)))
-&gt; WithEnv (HGEOptions (ServeOptions impl))
-&gt; Either String (HGEOptions (ServeOptions impl))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HGEOptionsRaw (ServeOptionsRaw impl)
-&gt; WithEnv (HGEOptions (ServeOptions impl))
forall impl.
EnabledLogTypes impl =&gt;
HGEOptionsRaw (ServeOptionsRaw impl)
-&gt; WithEnv (HGEOptions (ServeOptions impl))
</span><a href="Hasura.Server.Init.html#mkHGEOptions"><span class="hs-identifier hs-var">mkHGEOptions</span></a></span><span> </span><span class="annot"><span class="annottext">HGEOptionsRaw (ServeOptionsRaw impl)
</span><a href="#local-6989586621688072551"><span class="hs-identifier hs-var">rawHGEOpts</span></a></span><span>
</span><span id="line-863"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-type">onLeft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072554"><span class="hs-identifier hs-type">eitherOpts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.App.html#throwErrExit"><span class="hs-identifier hs-type">throwErrExit</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#InvalidEnvironmentVariableOptionsError"><span class="hs-identifier hs-type">InvalidEnvironmentVariableOptionsError</span></a></span><span>
</span><span id="line-864"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-865"></span><span>    </span><span id="local-6989586621688072553"><span class="annot"><span class="annottext">opts :: ParserInfo (HGEOptionsRaw (ServeOptionsRaw impl))
</span><a href="#local-6989586621688072553"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-866"></span><span>      </span><span class="annot"><span class="annottext">Parser (HGEOptionsRaw (ServeOptionsRaw impl))
-&gt; InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
-&gt; ParserInfo (HGEOptionsRaw (ServeOptionsRaw impl))
forall a. Parser a -&gt; InfoMod a -&gt; ParserInfo a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/optparse-applicative-0.18.1.0-08df638190761201024420c2e72e640380c9f6597c5ba4a4cf09ccc63be4d34f/share/doc/html/src/Options.Applicative.Builder.html/Options.Applicative.Builder.html#info"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-867"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser
  (HGEOptionsRaw (ServeOptionsRaw impl)
   -&gt; HGEOptionsRaw (ServeOptionsRaw impl))
forall a. Parser (a -&gt; a)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/optparse-applicative-0.18.1.0-08df638190761201024420c2e72e640380c9f6597c5ba4a4cf09ccc63be4d34f/share/doc/html/src/Options.Applicative.Extra.html/Options.Applicative.Extra.html#helper"><span class="hs-identifier hs-var">helper</span></a></span><span> </span><span class="annot"><span class="annottext">Parser
  (HGEOptionsRaw (ServeOptionsRaw impl)
   -&gt; HGEOptionsRaw (ServeOptionsRaw impl))
-&gt; Parser (HGEOptionsRaw (ServeOptionsRaw impl))
-&gt; Parser (HGEOptionsRaw (ServeOptionsRaw impl))
forall a b. Parser (a -&gt; b) -&gt; Parser a -&gt; Parser b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser (HGEOptionsRaw (ServeOptionsRaw impl))
forall impl.
EnabledLogTypes impl =&gt;
Parser (HGEOptionsRaw (ServeOptionsRaw impl))
</span><a href="Hasura.Server.Init.Arg.html#parseHgeOpts"><span class="hs-identifier hs-var">parseHgeOpts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-868"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
forall a. InfoMod a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/optparse-applicative-0.18.1.0-08df638190761201024420c2e72e640380c9f6597c5ba4a4cf09ccc63be4d34f/share/doc/html/src/Options.Applicative.Builder.html/Options.Applicative.Builder.html#fullDesc"><span class="hs-identifier hs-var">fullDesc</span></a></span><span>
</span><span id="line-869"></span><span>            </span><span class="annot"><span class="annottext">InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
-&gt; InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
-&gt; InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
forall a. String -&gt; InfoMod a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/optparse-applicative-0.18.1.0-08df638190761201024420c2e72e640380c9f6597c5ba4a4cf09ccc63be4d34f/share/doc/html/src/Options.Applicative.Builder.html/Options.Applicative.Builder.html#header"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Hasura GraphQL Engine: Blazing fast, instant realtime GraphQL APIs on your DB with fine grained access control, also trigger webhooks on database events.&quot;</span></span><span>
</span><span id="line-870"></span><span>            </span><span class="annot"><span class="annottext">InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
-&gt; InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
-&gt; InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Doc -&gt; InfoMod (HGEOptionsRaw (ServeOptionsRaw impl))
forall a. Maybe Doc -&gt; InfoMod a
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/optparse-applicative-0.18.1.0-08df638190761201024420c2e72e640380c9f6597c5ba4a4cf09ccc63be4d34f/share/doc/html/src/Options.Applicative.Builder.html/Options.Applicative.Builder.html#footerDoc"><span class="hs-identifier hs-var">footerDoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc -&gt; Maybe Doc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="Hasura.Server.Init.Arg.html#mainCmdFooter"><span class="hs-identifier hs-var">mainCmdFooter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-871"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-872"></span><span>
</span><span id="line-873"></span><span class="hs-comment">-- | Core logic to fork a poller thread to update the JWK based on the</span><span>
</span><span id="line-874"></span><span class="hs-comment">-- expiry time specified in @Expires@ header or @Cache-Control@ header</span><span>
</span><span id="line-875"></span><span id="local-6989586621688070533"><span class="annot"><a href="Hasura.App.html#updateJwkCtxThread"><span class="hs-identifier hs-type">updateJwkCtxThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-876"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070533"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-877"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.App.State.html#AppContext"><span class="hs-identifier hs-type">AppContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-878"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/http-client-0.7.17-1b2133de2c2ce095aea721bc3d56fba68148ba6d3c4af69a01586f3a88b4e771/share/doc/html/src/Network.HTTP.Client.Types.html/Network.HTTP.Client.Types.html#Manager"><span class="hs-identifier hs-type">HTTP.Manager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-879"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-880"></span><span>  </span><span class="annot"><a href="#local-6989586621688070533"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span></span><span>
</span><span id="line-881"></span><span id="updateJwkCtxThread"><span class="annot"><span class="annottext">updateJwkCtxThread :: forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
IO AppContext -&gt; Manager -&gt; Logger Hasura -&gt; m Void
</span><a href="Hasura.App.html#updateJwkCtxThread"><span class="hs-identifier hs-var hs-var">updateJwkCtxThread</span></a></span></span><span> </span><span id="local-6989586621688072594"><span class="annot"><span class="annottext">IO AppContext
</span><a href="#local-6989586621688072594"><span class="hs-identifier hs-var">getAppCtx</span></a></span></span><span> </span><span id="local-6989586621688072595"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688072595"><span class="hs-identifier hs-var">httpManager</span></a></span></span><span> </span><span id="local-6989586621688072596"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072596"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m Void
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m Void) -&gt; m () -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-882"></span><span>  </span><span id="local-6989586621688072598"><span class="annot"><a href="#local-6989586621688072598"><span class="hs-identifier hs-var">authMode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AuthMode -&gt; m AuthMode
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO AuthMode -&gt; m AuthMode) -&gt; IO AuthMode -&gt; m AuthMode
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; AuthMode
</span><a href="Hasura.App.State.html#acAuthMode"><span class="hs-identifier hs-var">acAuthMode</span></a></span><span> </span><span class="annot"><span class="annottext">(AppContext -&gt; AuthMode) -&gt; IO AppContext -&gt; IO AuthMode
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO AppContext
</span><a href="#local-6989586621688072594"><span class="hs-identifier hs-var">getAppCtx</span></a></span><span>
</span><span id="line-883"></span><span>  </span><span class="annot"><a href="Hasura.Server.Auth.html#updateJwkCtx"><span class="hs-identifier hs-type">updateJwkCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072598"><span class="hs-identifier hs-type">authMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072595"><span class="hs-identifier hs-type">httpManager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072596"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-884"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-type">sleep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Data.Time.Clock.Units.html/Data.Time.Clock.Units.html#seconds"><span class="hs-identifier hs-var">seconds</span></a></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-885"></span><span>
</span><span id="line-886"></span><span class="hs-comment">-- | Event triggers live in the user's DB and other events</span><span>
</span><span id="line-887"></span><span class="hs-comment">--  (cron, one-off and async actions)</span><span>
</span><span id="line-888"></span><span class="hs-comment">--   live in the metadata DB, so we need a way to differentiate the</span><span>
</span><span id="line-889"></span><span class="hs-comment">--   type of shutdown action</span><span>
</span><span id="line-890"></span><span class="hs-keyword">data</span><span> </span><span id="ShutdownAction"><span class="annot"><a href="Hasura.App.html#ShutdownAction"><span class="hs-identifier hs-var">ShutdownAction</span></a></span></span><span>
</span><span id="line-891"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EventTriggerShutdownAction"><span class="annot"><a href="Hasura.App.html#EventTriggerShutdownAction"><span class="hs-identifier hs-var">EventTriggerShutdownAction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-892"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MetadataDBShutdownAction"><span class="annot"><a href="Hasura.App.html#MetadataDBShutdownAction"><span class="hs-identifier hs-var">MetadataDBShutdownAction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-893"></span><span>
</span><span id="line-894"></span><span class="hs-comment">-- | This function acts as the entrypoint for the graphql-engine webserver.</span><span>
</span><span id="line-895"></span><span class="hs-comment">--</span><span>
</span><span id="line-896"></span><span class="hs-comment">-- Note: at the exit of this function, or in case of a graceful server shutdown</span><span>
</span><span id="line-897"></span><span class="hs-comment">-- (SIGTERM, or more generally, whenever the shutdown latch is set),  we need to</span><span>
</span><span id="line-898"></span><span class="hs-comment">-- make absolutely sure that we clean up any resources which were allocated during</span><span>
</span><span id="line-899"></span><span class="hs-comment">-- server setup. In the case of a multitenant process, failure to do so can lead to</span><span>
</span><span id="line-900"></span><span class="hs-comment">-- resource leaks.</span><span>
</span><span id="line-901"></span><span class="hs-comment">--</span><span>
</span><span id="line-902"></span><span class="hs-comment">-- To track these resources, we use the ManagedT monad, and attach finalizers at</span><span>
</span><span id="line-903"></span><span class="hs-comment">-- the same point in the code where we allocate resources. If you fork a new</span><span>
</span><span id="line-904"></span><span class="hs-comment">-- long-lived thread, or create a connection pool, or allocate any other</span><span>
</span><span id="line-905"></span><span class="hs-comment">-- long-lived resource, make sure to pair the allocator  with its finalizer.</span><span>
</span><span id="line-906"></span><span class="hs-comment">-- There are plenty of examples throughout the code. For example, see</span><span>
</span><span id="line-907"></span><span class="hs-comment">-- 'C.forkManagedT'.</span><span>
</span><span id="line-908"></span><span class="hs-comment">--</span><span>
</span><span id="line-909"></span><span class="hs-comment">-- Note also: the order in which the finalizers run can be important. Specifically,</span><span>
</span><span id="line-910"></span><span class="hs-comment">-- we want the finalizers for the logger threads to run last, so that we retain as</span><span>
</span><span id="line-911"></span><span class="hs-comment">-- many &quot;thread stopping&quot; log messages as possible. The order in which the</span><span>
</span><span id="line-912"></span><span class="hs-comment">-- finalizers is run is determined by the order in which they are introduced in the</span><span>
</span><span id="line-913"></span><span class="hs-comment">-- code.</span><span>
</span><span id="line-914"></span><span>
</span><span id="line-915"></span><span class="hs-comment">{- HLINT ignore runHGEServer &quot;Avoid lambda&quot; -}</span><span>
</span><span id="line-916"></span><span class="hs-comment">{- HLINT ignore runHGEServer &quot;Use withAsync&quot; -}</span><span>
</span><span id="line-917"></span><span class="annot"><a href="Hasura.App.html#runHGEServer"><span class="hs-identifier hs-type">runHGEServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-918"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688070539"><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688070544"><span class="annot"><a href="#local-6989586621688070544"><span class="hs-identifier hs-type">impl</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-919"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-920"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- only due to https://gitlab.haskell.org/ghc/ghc/-/issues/15681</span><span>
</span><span id="line-921"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadFix</span></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-922"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-923"></span><span>    </span><span class="annot"><a href="Control.Monad.Stateless.html#MonadStateless"><span class="hs-identifier hs-type">MonadStateless</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-924"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/constraints-0.14.2-ff824dad83d629e0fa70449d98d0e80ecc50be2f324c7bd62638caa7179948ea/share/doc/html/src/Data.Constraint.Forall.html/Data.Constraint.Forall.html#Forall"><span class="hs-identifier hs-type">LA.Forall</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-async-0.10.2.5-7453f3a39fe1c149b1fdd3dbcd3716b82112049f5f698aafbd6eb5b568cc41a4/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html/Control.Concurrent.Async.Lifted.Safe.html#Pure"><span class="hs-identifier hs-type">LA.Pure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-925"></span><span>    </span><span class="annot"><a href="Hasura.Server.Auth.html#UserAuthentication"><span class="hs-identifier hs-type">UserAuthentication</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-926"></span><span>    </span><span class="annot"><a href="Hasura.Server.Logging.html#HttpLog"><span class="hs-identifier hs-type">HttpLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-927"></span><span>    </span><span class="annot"><a href="Hasura.App.State.html#HasAppEnv"><span class="hs-identifier hs-type">HasAppEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-928"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html#HasCacheStaticConfig"><span class="hs-identifier hs-type">HasCacheStaticConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-929"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#ConsoleRenderer"><span class="hs-identifier hs-type">ConsoleRenderer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-930"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadVersionAPIWithExtraData"><span class="hs-identifier hs-type">MonadVersionAPIWithExtraData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-931"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadMetadataApiAuthorization"><span class="hs-identifier hs-type">MonadMetadataApiAuthorization</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-932"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Common.html#MonadGQLExecutionCheck"><span class="hs-identifier hs-type">MonadGQLExecutionCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-933"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadConfigApiHandler"><span class="hs-identifier hs-type">MonadConfigApiHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-934"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Logging.QueryLog.html#MonadQueryLog"><span class="hs-identifier hs-type">MonadQueryLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-935"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Logging.ExecutionLog.html#MonadExecutionLog"><span class="hs-identifier hs-type">MonadExecutionLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-936"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#MonadWSLog"><span class="hs-identifier hs-type">WS.MonadWSLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-937"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier hs-type">MonadExecuteQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-938"></span><span>    </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-939"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-940"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-941"></span><span>    </span><span class="annot"><a href="Hasura.QueryTags.html#MonadQueryTags"><span class="hs-identifier hs-type">MonadQueryTags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-942"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html#MonadEventLogCleanup"><span class="hs-identifier hs-type">MonadEventLogCleanup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-943"></span><span>    </span><span class="annot"><a href="Hasura.Services.html#ProvidesHasuraServices"><span class="hs-identifier hs-type">ProvidesHasuraServices</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-944"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.Class.html#MonadTrace"><span class="hs-identifier hs-type">MonadTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-945"></span><span>    </span><span class="annot"><a href="Hasura.Server.Types.html#MonadGetPolicies"><span class="hs-identifier hs-type">MonadGetPolicies</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-946"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadGQLApiHandler"><span class="hs-identifier hs-type">MonadGQLApiHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-947"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-948"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier hs-type">AppStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070544"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/Spock-core-0.14.0.1-4c65b572f2f596b4a392ab1f1cae578fb470ab4a2fb29ebadb96683fd9592f48/share/doc/html/src/Web.Spock.Core.html/Web.Spock.Core.html#SpockT"><span class="hs-identifier hs-type">Spock.SpockT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-949"></span><span>  </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier hs-type">AppStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070544"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-950"></span><span>  </span><span class="annot"><span class="hs-comment">-- | start time</span></span><span>
</span><span id="line-951"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-952"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A hook which can be called to indicate when the server is started succesfully</span></span><span>
</span><span id="line-953"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-954"></span><span>  </span><span class="annot"><a href="Hasura.Server.App.html#ConsoleType"><span class="hs-identifier hs-type">ConsoleType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-955"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.html/System.Metrics.html#Store"><span class="hs-identifier hs-type">EKG.Store</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.html/System.Metrics.html#EmptyMetrics"><span class="hs-identifier hs-type">EKG.EmptyMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-956"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070539"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-957"></span><span id="runHGEServer"><span class="annot"><span class="annottext">runHGEServer :: forall (m :: * -&gt; *) impl.
(MonadIO m, MonadFail m, MonadFix m, MonadMask m,
 MonadStateless IO m, Forall (Pure m), UserAuthentication m,
 HttpLog m, HasAppEnv m, HasCacheStaticConfig m, ConsoleRenderer m,
 MonadVersionAPIWithExtraData m, MonadMetadataApiAuthorization m,
 MonadGQLExecutionCheck m, MonadConfigApiHandler m, MonadQueryLog m,
 MonadExecutionLog m, MonadWSLog m, MonadExecuteQuery m,
 HasResourceLimits m, MonadMetadataStorage m, MonadResolveSource m,
 MonadQueryTags m, MonadEventLogCleanup m, ProvidesHasuraServices m,
 MonadTrace m, MonadGetPolicies m, MonadGQLApiHandler m) =&gt;
(AppStateRef impl -&gt; SpockT m ())
-&gt; AppStateRef impl
-&gt; UTCTime
-&gt; Maybe (IO ())
-&gt; ConsoleType m
-&gt; Store EmptyMetrics
-&gt; ManagedT m ()
</span><a href="Hasura.App.html#runHGEServer"><span class="hs-identifier hs-var hs-var">runHGEServer</span></a></span></span><span> </span><span id="local-6989586621688072715"><span class="annot"><span class="annottext">AppStateRef impl -&gt; SpockT m ()
</span><a href="#local-6989586621688072715"><span class="hs-identifier hs-var">setupHook</span></a></span></span><span> </span><span id="local-6989586621688072716"><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621688072716"><span class="hs-identifier hs-var">appStateRef</span></a></span></span><span> </span><span id="local-6989586621688072717"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688072717"><span class="hs-identifier hs-var">initTime</span></a></span></span><span> </span><span id="local-6989586621688072718"><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621688072718"><span class="hs-identifier hs-var">startupStatusHook</span></a></span></span><span> </span><span id="local-6989586621688072719"><span class="annot"><span class="annottext">ConsoleType m
</span><a href="#local-6989586621688072719"><span class="hs-identifier hs-var">consoleType</span></a></span></span><span> </span><span id="local-6989586621688072720"><span class="annot"><span class="annottext">Store EmptyMetrics
</span><a href="#local-6989586621688072720"><span class="hs-identifier hs-var">ekgStore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-958"></span><span>  </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688072721"><span id="local-6989586621688072722"><span id="local-6989586621688072723"><span id="local-6989586621688072724"><span id="local-6989586621688072725"><span id="local-6989586621688072726"><span id="local-6989586621688072727"><span id="local-6989586621688072728"><span id="local-6989586621688072729"><span id="local-6989586621688072730"><span id="local-6989586621688072731"><span id="local-6989586621688072732"><span id="local-6989586621688072733"><span id="local-6989586621688072734"><span id="local-6989586621688072735"><span id="local-6989586621688072736"><span id="local-6989586621688072737"><span id="local-6989586621688072738"><span id="local-6989586621688072739"><span id="local-6989586621688072740"><span id="local-6989586621688072741"><span id="local-6989586621688072742"><span id="local-6989586621688072743"><span id="local-6989586621688072744"><span id="local-6989586621688072745"><span id="local-6989586621688072746"><span id="local-6989586621688072747"><span id="local-6989586621688072748"><span id="local-6989586621688072749"><span id="local-6989586621688072750"><span id="local-6989586621688072751"><span id="local-6989586621688072752"><span id="local-6989586621688072753"><span id="local-6989586621688072754"><span id="local-6989586621688072755"><span class="annot"><a href="Hasura.App.State.html#appEnvPort"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m AppEnv -&gt; ManagedT m AppEnv
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ManagedT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">m AppEnv
forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-959"></span><span>  </span><span id="local-6989586621688072756"><span class="annot"><a href="#local-6989586621688072756"><span class="hs-identifier hs-var">waiApplication</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.App.html#mkHGEServer"><span class="hs-identifier hs-type">mkHGEServer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072715"><span class="hs-identifier hs-type">setupHook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072716"><span class="hs-identifier hs-type">appStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072719"><span class="hs-identifier hs-type">consoleType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072720"><span class="hs-identifier hs-type">ekgStore</span></a></span><span>
</span><span id="line-960"></span><span>
</span><span id="line-961"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688072757"><span class="annot"><a href="#local-6989586621688072757"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Loggers -&gt; Logger Hasura
</span><a href="Hasura.App.State.html#_lsLogger"><span class="hs-identifier hs-var">_lsLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Loggers
</span><a href="#local-6989586621688072726"><span class="hs-identifier hs-var">appEnvLoggers</span></a></span><span>
</span><span id="line-962"></span><span>  </span><span class="hs-comment">-- `startupStatusHook`: add `Service started successfully` message to config_status</span><span>
</span><span id="line-963"></span><span>  </span><span class="hs-comment">-- table when a tenant starts up in multitenant</span><span>
</span><span id="line-964"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621688072759"><span class="hs-identifier hs-type">warpSettings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.Settings.html/Network.Wai.Handler.Warp.Settings.html#Settings"><span class="hs-identifier hs-type">Warp.Settings</span></a></span><span>
</span><span id="line-965"></span><span>      </span><span id="local-6989586621688072759"><span class="annot"><a href="#local-6989586621688072759"><span class="hs-identifier hs-var hs-var">warpSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-966"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; Settings -&gt; Settings
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.html/Network.Wai.Handler.Warp.html#setPort"><span class="hs-identifier hs-var">Warp.setPort</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Port -&gt; Int
</span><a href="Hasura.Server.Init.Config.html#_getPort"><span class="hs-identifier hs-var">_getPort</span></a></span><span> </span><span class="annot"><span class="annottext">Port
</span><a href="#local-6989586621688072721"><span class="hs-identifier hs-var">appEnvPort</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HostPreference -&gt; Settings -&gt; Settings
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.html/Network.Wai.Handler.Warp.html#setHost"><span class="hs-identifier hs-var">Warp.setHost</span></a></span><span> </span><span class="annot"><span class="annottext">HostPreference
</span><a href="#local-6989586621688072722"><span class="hs-identifier hs-var">appEnvHost</span></a></span><span>
</span><span id="line-968"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Settings -&gt; Settings
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.html/Network.Wai.Handler.Warp.html#setGracefulShutdownTimeout"><span class="hs-identifier hs-var">Warp.setGracefulShutdownTimeout</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">30</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- 30s graceful shutdown</span><span>
</span><span id="line-969"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; Settings -&gt; Settings
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.html/Network.Wai.Handler.Warp.html#setInstallShutdownHandler"><span class="hs-identifier hs-var">Warp.setInstallShutdownHandler</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
</span><a href="#local-6989586621688072765"><span class="hs-identifier hs-var">shutdownHandler</span></a></span><span>
</span><span id="line-970"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Settings -&gt; Settings
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.html/Network.Wai.Handler.Warp.html#setBeforeMainLoop"><span class="hs-identifier hs-var">Warp.setBeforeMainLoop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (IO ()) -&gt; (IO () -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621688072718"><span class="hs-identifier hs-var">startupStatusHook</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-971"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Settings -&gt; Settings
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.html/Network.Wai.Handler.Warp.html#setServerName"><span class="hs-identifier hs-var">Warp.setServerName</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-972"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Settings
</span><a href="#local-6989586621688072769"><span class="hs-identifier hs-var">setForkIOWithMetrics</span></a></span><span>
</span><span id="line-973"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Settings -&gt; Settings
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.html/Network.Wai.Handler.Warp.html#setMaxTotalHeaderLength"><span class="hs-identifier hs-var">Warp.setMaxTotalHeaderLength</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688072751"><span class="hs-identifier hs-var">appEnvMaxTotalHeaderLength</span></a></span><span>
</span><span id="line-974"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.Settings.html/Network.Wai.Handler.Warp.Settings.html#defaultSettings"><span class="hs-identifier hs-var">Warp.defaultSettings</span></a></span><span>
</span><span id="line-975"></span><span>
</span><span id="line-976"></span><span>      </span><span class="annot"><a href="#local-6989586621688072769"><span class="hs-identifier hs-type">setForkIOWithMetrics</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.Settings.html/Network.Wai.Handler.Warp.Settings.html#Settings"><span class="hs-identifier hs-type">Warp.Settings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.Settings.html/Network.Wai.Handler.Warp.Settings.html#Settings"><span class="hs-identifier hs-type">Warp.Settings</span></a></span><span>
</span><span id="line-977"></span><span>      </span><span id="local-6989586621688072769"><span class="annot"><a href="#local-6989586621688072769"><span class="hs-identifier hs-var hs-var">setForkIOWithMetrics</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(((forall a. IO a -&gt; IO a) -&gt; IO ()) -&gt; IO ())
-&gt; Settings -&gt; Settings
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.html/Network.Wai.Handler.Warp.html#setFork"><span class="hs-identifier hs-var">Warp.setFork</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688072773"><span class="annot"><span class="annottext">(forall a. IO a -&gt; IO a) -&gt; IO ()
</span><a href="#local-6989586621688072773"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-978"></span><span>        </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span>
</span><span id="line-979"></span><span>          </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((forall a. IO a -&gt; IO a) -&gt; IO ()) -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">C.forkIOWithUnmask</span></span><span>
</span><span id="line-980"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688072775"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621688072775"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-981"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO () -&gt; IO ()
forall a b c. IO a -&gt; IO b -&gt; IO c -&gt; IO c
</span><span class="hs-identifier hs-var">bracket_</span></span><span>
</span><span id="line-982"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-983"></span><span>                      </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.Gauge.html/System.Metrics.Gauge.html#inc"><span class="hs-identifier hs-var">EKG.Gauge.inc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smWarpThreads"><span class="hs-identifier hs-var">smWarpThreads</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688072733"><span class="hs-identifier hs-var">appEnvServerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-984"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionsGauge -&gt; IO ()
</span><a href="Hasura.Server.Prometheus.html#incWarpThreads"><span class="hs-identifier hs-var">incWarpThreads</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; ConnectionsGauge
</span><a href="Hasura.Server.Prometheus.html#pmConnections"><span class="hs-identifier hs-var">pmConnections</span></a></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688072736"><span class="hs-identifier hs-var">appEnvPrometheusMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-985"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-986"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-987"></span><span>                      </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.Gauge.html/System.Metrics.Gauge.html#dec"><span class="hs-identifier hs-var">EKG.Gauge.dec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smWarpThreads"><span class="hs-identifier hs-var">smWarpThreads</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688072733"><span class="hs-identifier hs-var">appEnvServerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-988"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionsGauge -&gt; IO ()
</span><a href="Hasura.Server.Prometheus.html#decWarpThreads"><span class="hs-identifier hs-var">decWarpThreads</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; ConnectionsGauge
</span><a href="Hasura.Server.Prometheus.html#pmConnections"><span class="hs-identifier hs-var">pmConnections</span></a></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688072736"><span class="hs-identifier hs-var">appEnvPrometheusMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-989"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall a. IO a -&gt; IO a) -&gt; IO ()
</span><a href="#local-6989586621688072773"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621688072775"><span class="hs-identifier hs-var">unmask</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-991"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-992"></span><span>
</span><span id="line-993"></span><span>      </span><span class="annot"><a href="#local-6989586621688072765"><span class="hs-identifier hs-type">shutdownHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-994"></span><span>      </span><span id="local-6989586621688072765"><span class="annot"><a href="#local-6989586621688072765"><span class="hs-identifier hs-var hs-var">shutdownHandler</span></a></span></span><span> </span><span id="local-6989586621688072780"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688072780"><span class="hs-identifier hs-var">closeSocket</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-995"></span><span>        </span><span class="annot"><span class="annottext">Async () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; Async a -&gt; m ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-async-0.10.2.5-7453f3a39fe1c149b1fdd3dbcd3716b82112049f5f698aafbd6eb5b568cc41a4/share/doc/html/src/Control.Concurrent.Async.Lifted.html/Control.Concurrent.Async.Lifted.html#link"><span class="hs-identifier hs-var">LA.link</span></a></span><span> </span><span class="annot"><span class="annottext">(Async () -&gt; IO ()) -&gt; IO (Async ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, Forall (Pure m)) =&gt;
m a -&gt; m (Async a)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-async-0.10.2.5-7453f3a39fe1c149b1fdd3dbcd3716b82112049f5f698aafbd6eb5b568cc41a4/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html/Control.Concurrent.Async.Lifted.Safe.html#async"><span class="hs-identifier hs-var">LA.async</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-996"></span><span>          </span><span class="annot"><span class="annottext">ShutdownLatch -&gt; IO ()
</span><a href="Hasura.ShutdownLatch.html#waitForShutdown"><span class="hs-identifier hs-var">waitForShutdown</span></a></span><span> </span><span class="annot"><span class="annottext">ShutdownLatch
</span><a href="#local-6989586621688072734"><span class="hs-identifier hs-var">appEnvShutdownLatch</span></a></span><span>
</span><span id="line-997"></span><span>          </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688072757"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;server&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;gracefully shutting down server&quot;</span></span><span>
</span><span id="line-998"></span><span>          </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688072780"><span class="hs-identifier hs-var">closeSocket</span></a></span><span>
</span><span id="line-999"></span><span>
</span><span id="line-1000"></span><span>  </span><span id="local-6989586621688072785"><span class="annot"><a href="#local-6989586621688072785"><span class="hs-identifier hs-var">finishTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Clock.getCurrentTime</span></span><span>
</span><span id="line-1001"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688072786"><span class="annot"><a href="#local-6989586621688072786"><span class="hs-identifier hs-var hs-var">apiInitTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; Double
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; Double) -&gt; NominalDiffTime -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">Clock.diffUTCTime</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688072785"><span class="hs-identifier hs-var">finishTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688072717"><span class="hs-identifier hs-var">initTime</span></a></span><span>
</span><span id="line-1002"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span>
</span><span id="line-1003"></span><span>    </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Logging.html#unLoggerTracing"><span class="hs-identifier hs-var">unLoggerTracing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072757"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1004"></span><span>    </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-type">mkGenericLog</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-type">LevelInfo</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;server&quot;</span></span><span>
</span><span id="line-1005"></span><span>    </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Logging.html#StartupTimeInfo"><span class="hs-identifier hs-type">StartupTimeInfo</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;starting API server&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621688072786"><span class="hs-identifier hs-type">apiInitTime</span></a></span><span>
</span><span id="line-1006"></span><span>
</span><span id="line-1007"></span><span>  </span><span class="hs-comment">-- Here we block until the shutdown latch 'MVar' is filled, and then</span><span>
</span><span id="line-1008"></span><span>  </span><span class="hs-comment">-- shut down the server. Once this blocking call returns, we'll tidy up</span><span>
</span><span id="line-1009"></span><span>  </span><span class="hs-comment">-- any resources using the finalizers attached using 'ManagedT' above.</span><span>
</span><span id="line-1010"></span><span>  </span><span class="hs-comment">-- Structuring things using the shutdown latch in this way lets us decide</span><span>
</span><span id="line-1011"></span><span>  </span><span class="hs-comment">-- elsewhere exactly how we want to control shutdown.</span><span>
</span><span id="line-1012"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/warp-3.3.30-9235ef03279ed255afaea3b1ffafc36452ee9c1488b5d8a2b552e3da69c2f28a/share/doc/html/src/Network.Wai.Handler.Warp.Run.html/Network.Wai.Handler.Warp.Run.html#runSettings"><span class="hs-identifier hs-type">Warp.runSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072759"><span class="hs-identifier hs-type">warpSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688072756"><span class="hs-identifier hs-type">waiApplication</span></a></span><span>
</span><span id="line-1013"></span><span>
</span><span id="line-1014"></span><span class="hs-comment">-- | Part of a factorization of 'runHGEServer' to expose the constructed WAI</span><span>
</span><span id="line-1015"></span><span class="hs-comment">-- application for testing purposes. See 'runHGEServer' for documentation.</span><span>
</span><span id="line-1016"></span><span class="annot"><a href="Hasura.App.html#mkHGEServer"><span class="hs-identifier hs-type">mkHGEServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1017"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688070558"><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688070559"><span class="annot"><a href="#local-6989586621688070559"><span class="hs-identifier hs-type">impl</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1018"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1019"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- only due to https://gitlab.haskell.org/ghc/ghc/-/issues/15681</span><span>
</span><span id="line-1020"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadFix</span></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1021"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1022"></span><span>    </span><span class="annot"><a href="Control.Monad.Stateless.html#MonadStateless"><span class="hs-identifier hs-type">MonadStateless</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1023"></span><span>    </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/constraints-0.14.2-ff824dad83d629e0fa70449d98d0e80ecc50be2f324c7bd62638caa7179948ea/share/doc/html/src/Data.Constraint.Forall.html/Data.Constraint.Forall.html#Forall"><span class="hs-identifier hs-type">LA.Forall</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/lifted-async-0.10.2.5-7453f3a39fe1c149b1fdd3dbcd3716b82112049f5f698aafbd6eb5b568cc41a4/share/doc/html/src/Control.Concurrent.Async.Lifted.Safe.html/Control.Concurrent.Async.Lifted.Safe.html#Pure"><span class="hs-identifier hs-type">LA.Pure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1024"></span><span>    </span><span class="annot"><a href="Hasura.Server.Auth.html#UserAuthentication"><span class="hs-identifier hs-type">UserAuthentication</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1025"></span><span>    </span><span class="annot"><a href="Hasura.Server.Logging.html#HttpLog"><span class="hs-identifier hs-type">HttpLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1026"></span><span>    </span><span class="annot"><a href="Hasura.App.State.html#HasAppEnv"><span class="hs-identifier hs-type">HasAppEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1027"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html#HasCacheStaticConfig"><span class="hs-identifier hs-type">HasCacheStaticConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1028"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#ConsoleRenderer"><span class="hs-identifier hs-type">ConsoleRenderer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1029"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadVersionAPIWithExtraData"><span class="hs-identifier hs-type">MonadVersionAPIWithExtraData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1030"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadMetadataApiAuthorization"><span class="hs-identifier hs-type">MonadMetadataApiAuthorization</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1031"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Common.html#MonadGQLExecutionCheck"><span class="hs-identifier hs-type">MonadGQLExecutionCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1032"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadConfigApiHandler"><span class="hs-identifier hs-type">MonadConfigApiHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1033"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Logging.QueryLog.html#MonadQueryLog"><span class="hs-identifier hs-type">MonadQueryLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1034"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Logging.ExecutionLog.html#MonadExecutionLog"><span class="hs-identifier hs-type">MonadExecutionLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1035"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#MonadWSLog"><span class="hs-identifier hs-type">WS.MonadWSLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1036"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier hs-type">MonadExecuteQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1037"></span><span>    </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1038"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1039"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1040"></span><span>    </span><span class="annot"><a href="Hasura.QueryTags.html#MonadQueryTags"><span class="hs-identifier hs-type">MonadQueryTags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1041"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.EventTrigger.html#MonadEventLogCleanup"><span class="hs-identifier hs-type">MonadEventLogCleanup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1042"></span><span>    </span><span class="annot"><a href="Hasura.Services.html#ProvidesHasuraServices"><span class="hs-identifier hs-type">ProvidesHasuraServices</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1043"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.Class.html#MonadTrace"><span class="hs-identifier hs-type">MonadTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1044"></span><span>    </span><span class="annot"><a href="Hasura.Server.Types.html#MonadGetPolicies"><span class="hs-identifier hs-type">MonadGetPolicies</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1045"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadGQLApiHandler"><span class="hs-identifier hs-type">MonadGQLApiHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1046"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1047"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier hs-type">AppStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070559"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/Spock-core-0.14.0.1-4c65b572f2f596b4a392ab1f1cae578fb470ab4a2fb29ebadb96683fd9592f48/share/doc/html/src/Web.Spock.Core.html/Web.Spock.Core.html#SpockT"><span class="hs-identifier hs-type">Spock.SpockT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1048"></span><span>  </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier hs-type">AppStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070559"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1049"></span><span>  </span><span class="annot"><a href="Hasura.Server.App.html#ConsoleType"><span class="hs-identifier hs-type">ConsoleType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1050"></span><span>  </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.html/System.Metrics.html#Store"><span class="hs-identifier hs-type">EKG.Store</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/ekg-core-0.1.1.7-62d888937f8158f3cbcbf29ac5f17459148bc6a441073803ab6e587a2df6bfd8/share/doc/html/src/System.Metrics.html/System.Metrics.html#EmptyMetrics"><span class="hs-identifier hs-type">EKG.EmptyMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1051"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/wai-3.2.4-f1faaa95aed979d4a132d2900aa502afdcfa02c1b7b8106923106c2a2a52f9c3/share/doc/html/src/Network.Wai.html/Network.Wai.html#Application"><span class="hs-identifier hs-type">Application</span></a></span><span>
</span><span id="line-1052"></span><span id="mkHGEServer"><span class="annot"><span class="annottext">mkHGEServer :: forall (m :: * -&gt; *) impl.
(MonadIO m, MonadFail m, MonadFix m, MonadMask m,
 MonadStateless IO m, Forall (Pure m), UserAuthentication m,
 HttpLog m, HasAppEnv m, HasCacheStaticConfig m, ConsoleRenderer m,
 MonadVersionAPIWithExtraData m, MonadMetadataApiAuthorization m,
 MonadGQLExecutionCheck m, MonadConfigApiHandler m, MonadQueryLog m,
 MonadExecutionLog m, MonadWSLog m, MonadExecuteQuery m,
 HasResourceLimits m, MonadMetadataStorage m, MonadResolveSource m,
 MonadQueryTags m, MonadEventLogCleanup m, ProvidesHasuraServices m,
 MonadTrace m, MonadGetPolicies m, MonadGQLApiHandler m) =&gt;
(AppStateRef impl -&gt; SpockT m ())
-&gt; AppStateRef impl
-&gt; ConsoleType m
-&gt; Store EmptyMetrics
-&gt; ManagedT m Application
</span><a href="Hasura.App.html#mkHGEServer"><span class="hs-identifier hs-var hs-var">mkHGEServer</span></a></span></span><span> </span><span id="local-6989586621688073119"><span class="annot"><span class="annottext">AppStateRef impl -&gt; SpockT m ()
</span><a href="#local-6989586621688073119"><span class="hs-identifier hs-var">setupHook</span></a></span></span><span> </span><span id="local-6989586621688073120"><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621688073120"><span class="hs-identifier hs-var">appStateRef</span></a></span></span><span> </span><span id="local-6989586621688073121"><span class="annot"><span class="annottext">ConsoleType m
</span><a href="#local-6989586621688073121"><span class="hs-identifier hs-var">consoleType</span></a></span></span><span> </span><span id="local-6989586621688073122"><span class="annot"><span class="annottext">Store EmptyMetrics
</span><a href="#local-6989586621688073122"><span class="hs-identifier hs-var">ekgStore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1053"></span><span>  </span><span class="hs-comment">-- Comment this to enable expensive assertions from &quot;GHC.AssertNF&quot;. These</span><span>
</span><span id="line-1054"></span><span>  </span><span class="hs-comment">-- will log lines to STDOUT containing &quot;not in normal form&quot;. In the future we</span><span>
</span><span id="line-1055"></span><span>  </span><span class="hs-comment">-- could try to integrate this into our tests. For now this is a development</span><span>
</span><span id="line-1056"></span><span>  </span><span class="hs-comment">-- tool.</span><span>
</span><span id="line-1057"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-1058"></span><span>  </span><span class="hs-comment">-- NOTE: be sure to compile WITHOUT code coverage, for this to work properly.</span><span>
</span><span id="line-1059"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; ManagedT m ()
forall a. IO a -&gt; ManagedT m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/GHC.AssertNF.CPP.html/GHC.AssertNF.CPP.html#disableAssertNF"><span class="hs-identifier hs-var">disableAssertNF</span></a></span><span>
</span><span id="line-1060"></span><span>  </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688073124"><span id="local-6989586621688073125"><span id="local-6989586621688073126"><span id="local-6989586621688073127"><span id="local-6989586621688073128"><span id="local-6989586621688073129"><span id="local-6989586621688073130"><span id="local-6989586621688073131"><span id="local-6989586621688073132"><span id="local-6989586621688073133"><span id="local-6989586621688073134"><span id="local-6989586621688073135"><span id="local-6989586621688073136"><span id="local-6989586621688073137"><span id="local-6989586621688073138"><span id="local-6989586621688073139"><span id="local-6989586621688073140"><span id="local-6989586621688073141"><span id="local-6989586621688073142"><span id="local-6989586621688073143"><span id="local-6989586621688073144"><span id="local-6989586621688073145"><span id="local-6989586621688073146"><span id="local-6989586621688073147"><span id="local-6989586621688073148"><span id="local-6989586621688073149"><span id="local-6989586621688073150"><span id="local-6989586621688073151"><span id="local-6989586621688073152"><span id="local-6989586621688073153"><span id="local-6989586621688073154"><span id="local-6989586621688073155"><span id="local-6989586621688073156"><span id="local-6989586621688073157"><span id="local-6989586621688073158"><span class="annot"><a href="Hasura.App.State.html#appEnvPort"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m AppEnv -&gt; ManagedT m AppEnv
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ManagedT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">m AppEnv
forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-1061"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.App.State.html#Loggers"><span class="hs-identifier hs-type">Loggers</span></a></span><span> </span><span id="local-6989586621688073159"><span class="annot"><a href="#local-6989586621688073159"><span class="hs-identifier hs-var">loggerCtx</span></a></span></span><span> </span><span id="local-6989586621688073160"><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688073129"><span class="hs-identifier hs-type">appEnvLoggers</span></a></span><span>
</span><span id="line-1062"></span><span>
</span><span id="line-1063"></span><span>  </span><span id="local-6989586621688073161"><span class="annot"><a href="#local-6989586621688073161"><span class="hs-identifier hs-var">wsServerEnv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WSServerApp.html#createWSServerEnv"><span class="hs-identifier hs-type">WS.createWSServerEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span>
</span><span id="line-1064"></span><span>
</span><span id="line-1065"></span><span>  </span><span class="annot"><a href="Hasura.Server.App.html#HasuraApp"><span class="hs-identifier hs-type">HasuraApp</span></a></span><span> </span><span id="local-6989586621688073164"><span class="annot"><a href="#local-6989586621688073164"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621688073165"><span class="annot"><a href="#local-6989586621688073165"><span class="hs-identifier hs-var">actionSubState</span></a></span></span><span> </span><span id="local-6989586621688073166"><span class="annot"><a href="#local-6989586621688073166"><span class="hs-identifier hs-var">stopWsServer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1066"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span>
</span><span id="line-1067"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.App.html#mkWaiApp"><span class="hs-identifier hs-type">mkWaiApp</span></a></span><span>
</span><span id="line-1068"></span><span>        </span><span class="annot"><a href="#local-6989586621688073119"><span class="hs-identifier hs-type">setupHook</span></a></span><span>
</span><span id="line-1069"></span><span>        </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span>
</span><span id="line-1070"></span><span>        </span><span class="annot"><a href="#local-6989586621688073121"><span class="hs-identifier hs-type">consoleType</span></a></span><span>
</span><span id="line-1071"></span><span>        </span><span class="annot"><a href="#local-6989586621688073122"><span class="hs-identifier hs-type">ekgStore</span></a></span><span>
</span><span id="line-1072"></span><span>        </span><span class="annot"><a href="#local-6989586621688073161"><span class="hs-identifier hs-type">wsServerEnv</span></a></span><span>
</span><span id="line-1073"></span><span>
</span><span id="line-1074"></span><span>  </span><span class="hs-comment">-- Log Warning if deprecated environment variables are used</span><span>
</span><span id="line-1075"></span><span>  </span><span id="local-6989586621688073168"><span class="annot"><a href="#local-6989586621688073168"><span class="hs-identifier hs-var">sources</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-type">getSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1076"></span><span>  </span><span class="hs-comment">-- TODO: naveen: send IO to logDeprecatedEnvVars</span><span>
</span><span id="line-1077"></span><span>  </span><span class="annot"><a href="Hasura.App.State.html#AppContext"><span class="hs-identifier hs-type">AppContext</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688073171"><span id="local-6989586621688073172"><span id="local-6989586621688073173"><span id="local-6989586621688073174"><span id="local-6989586621688073175"><span id="local-6989586621688073176"><span id="local-6989586621688073177"><span id="local-6989586621688073178"><span id="local-6989586621688073179"><span id="local-6989586621688073180"><span id="local-6989586621688073181"><span id="local-6989586621688073182"><span id="local-6989586621688073183"><span id="local-6989586621688073184"><span id="local-6989586621688073185"><span id="local-6989586621688073186"><span id="local-6989586621688073187"><span id="local-6989586621688073188"><span id="local-6989586621688073189"><span id="local-6989586621688073190"><span id="local-6989586621688073191"><span id="local-6989586621688073192"><span class="annot"><a href="Hasura.App.State.html#acAuthMode"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-type">getAppContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span>
</span><span id="line-1078"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html#logDeprecatedEnvVars"><span class="hs-identifier hs-type">logDeprecatedEnvVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073176"><span class="hs-identifier hs-type">acEnvironment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073168"><span class="hs-identifier hs-type">sources</span></a></span><span>
</span><span id="line-1079"></span><span>
</span><span id="line-1080"></span><span>  </span><span class="hs-comment">-- log inconsistent schema objects</span><span>
</span><span id="line-1081"></span><span>  </span><span id="local-6989586621688073216"><span class="annot"><a href="#local-6989586621688073216"><span class="hs-identifier hs-var">inconsObjs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#scInconsistentObjs"><span class="hs-identifier hs-var">scInconsistentObjs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-type">getSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1082"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#logInconsistentMetadata"><span class="hs-identifier hs-type">logInconsistentMetadata</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073216"><span class="hs-identifier hs-type">inconsObjs</span></a></span><span>
</span><span id="line-1083"></span><span>
</span><span id="line-1084"></span><span>  </span><span class="hs-comment">-- NOTE: `newLogTVar` is being used to make sure that the metadata logger runs only once</span><span>
</span><span id="line-1085"></span><span>  </span><span class="hs-comment">--       while logging errors or any `inconsistent_metadata` logs.</span><span>
</span><span id="line-1086"></span><span>  </span><span id="local-6989586621688073219"><span class="annot"><a href="#local-6989586621688073219"><span class="hs-identifier hs-var">newLogTVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-1087"></span><span>
</span><span id="line-1088"></span><span>  </span><span class="hs-comment">-- Start a background thread for processing schema sync event present in the '_sscSyncEventRef'</span><span>
</span><span id="line-1089"></span><span>  </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncProcessorThread"><span class="hs-identifier hs-type">startSchemaSyncProcessorThread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073219"><span class="hs-identifier hs-type">newLogTVar</span></a></span><span>
</span><span id="line-1090"></span><span>
</span><span id="line-1091"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621688073134"><span class="hs-identifier hs-type">appEnvEventingMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1092"></span><span>    </span><span class="annot"><span class="annottext">EventingMode
</span><a href="Hasura.Server.Types.html#EventingEnabled"><span class="hs-identifier hs-var">EventingEnabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1093"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura -&gt; LockedEventsCtx -&gt; ManagedT m ()
</span><a href="#local-6989586621688073222"><span class="hs-identifier hs-var">startEventTriggerPollerThread</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073160"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073142"><span class="hs-identifier hs-var">appEnvLockedEventsCtx</span></a></span><span>
</span><span id="line-1094"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; LockedEventsCtx -&gt; AsyncActionSubscriptionState -&gt; ManagedT m ()
</span><a href="#local-6989586621688073223"><span class="hs-identifier hs-var">startAsyncActionsPollerThread</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073160"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073142"><span class="hs-identifier hs-var">appEnvLockedEventsCtx</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688073165"><span class="hs-identifier hs-var">actionSubState</span></a></span><span>
</span><span id="line-1095"></span><span>
</span><span id="line-1096"></span><span>      </span><span class="hs-comment">-- Create logger for logging the statistics of fetched cron triggers</span><span>
</span><span id="line-1097"></span><span>      </span><span id="local-6989586621688073224"><span class="annot"><a href="#local-6989586621688073224"><span class="hs-identifier hs-var">fetchedCronTriggerStatsLogger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1098"></span><span>        </span><span class="annot"><span class="annottext">m FetchedCronTriggerStatsLogger
-&gt; (FetchedCronTriggerStatsLogger -&gt; m ())
-&gt; ManagedT m FetchedCronTriggerStatsLogger
forall (m :: * -&gt; *) a b.
MonadBaseControl IO m =&gt;
m a -&gt; (a -&gt; m b) -&gt; ManagedT m a
</span><a href="Control.Monad.Trans.Managed.html#allocate"><span class="hs-identifier hs-var">allocate</span></a></span><span>
</span><span id="line-1099"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger Hasura -&gt; m FetchedCronTriggerStatsLogger
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; m FetchedCronTriggerStatsLogger
</span><a href="Hasura.Eventing.ScheduledTrigger.html#createFetchedCronTriggerStatsLogger"><span class="hs-identifier hs-var">createFetchedCronTriggerStatsLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073160"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1100"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger Hasura -&gt; FetchedCronTriggerStatsLogger -&gt; m ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; FetchedCronTriggerStatsLogger -&gt; m ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#closeFetchedCronTriggersStatsLogger"><span class="hs-identifier hs-var">closeFetchedCronTriggersStatsLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073160"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1101"></span><span>
</span><span id="line-1102"></span><span>      </span><span class="hs-comment">-- start a background thread to create new cron events</span><span>
</span><span id="line-1103"></span><span>      </span><span id="local-6989586621688073227"><span class="annot"><a href="#local-6989586621688073227"><span class="hs-identifier hs-var">_cronEventsThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1104"></span><span>        </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-type">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;runCronEventsGenerator&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1105"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.ScheduledTrigger.html#runCronEventsGenerator"><span class="hs-identifier hs-type">runCronEventsGenerator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073224"><span class="hs-identifier hs-type">fetchedCronTriggerStatsLogger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-type">getSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1106"></span><span>
</span><span id="line-1107"></span><span>      </span><span class="annot"><a href="#local-6989586621688073229"><span class="hs-identifier hs-type">startScheduledEventsPollerThread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073142"><span class="hs-identifier hs-type">appEnvLockedEventsCtx</span></a></span><span>
</span><span id="line-1108"></span><span>    </span><span class="annot"><span class="annottext">EventingMode
</span><a href="Hasura.Server.Types.html#EventingDisabled"><span class="hs-identifier hs-var">EventingDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1109"></span><span>      </span><span class="annot"><span class="annottext">m () -&gt; ManagedT m ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ManagedT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; ManagedT m ()) -&gt; m () -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadTraceContext m, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLoggerTracing"><span class="hs-identifier hs-var">unLoggerTracing</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073160"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; m ()) -&gt; StartupLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;server&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;starting in eventing disabled mode&quot;</span></span><span>
</span><span id="line-1110"></span><span>
</span><span id="line-1111"></span><span>  </span><span class="hs-comment">-- start a background thread to check for updates</span><span>
</span><span id="line-1112"></span><span>  </span><span id="local-6989586621688073231"><span class="annot"><a href="#local-6989586621688073231"><span class="hs-identifier hs-var">_updateThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1113"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-type">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;checkForUpdates&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1114"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span>
</span><span id="line-1115"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.CheckUpdates.html#checkForUpdates"><span class="hs-identifier hs-type">checkForUpdates</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073159"><span class="hs-identifier hs-type">loggerCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073128"><span class="hs-identifier hs-type">appEnvManager</span></a></span><span>
</span><span id="line-1116"></span><span>
</span><span id="line-1117"></span><span>  </span><span class="hs-comment">-- Start a background thread for source pings</span><span>
</span><span id="line-1118"></span><span>  </span><span id="local-6989586621688073232"><span class="annot"><a href="#local-6989586621688073232"><span class="hs-identifier hs-var">_sourcePingPoller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1119"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-type">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;sourcePingPoller&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1120"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073233"><span class="annot"><a href="#local-6989586621688073233"><span class="hs-identifier hs-var hs-var">pingLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1121"></span><span>            </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073160"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; (String -&gt; StartupLog) -&gt; String -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;sources-ping&quot;</span></span><span>
</span><span id="line-1122"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span>
</span><span id="line-1123"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.PingSources.html#runPingSources"><span class="hs-identifier hs-type">runPingSources</span></a></span><span>
</span><span id="line-1124"></span><span>            </span><span class="annot"><a href="#local-6989586621688073176"><span class="hs-identifier hs-type">acEnvironment</span></a></span><span>
</span><span id="line-1125"></span><span>            </span><span class="annot"><a href="#local-6989586621688073233"><span class="hs-identifier hs-type">pingLog</span></a></span><span>
</span><span id="line-1126"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#scSourcePingConfig"><span class="hs-identifier hs-var">scSourcePingConfig</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-type">getSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1127"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-1128"></span><span>
</span><span id="line-1129"></span><span>  </span><span class="hs-comment">-- initialise the websocket connection reaper thread</span><span>
</span><span id="line-1130"></span><span>  </span><span id="local-6989586621688073236"><span class="annot"><a href="#local-6989586621688073236"><span class="hs-identifier hs-var">_websocketConnectionReaperThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1131"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-type">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;websocket connection reaper thread&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1132"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span>
</span><span id="line-1133"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#websocketConnectionReaper"><span class="hs-identifier hs-type">WS.websocketConnectionReaper</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073238"><span class="hs-identifier hs-type">getLatestConfigForWSServer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073239"><span class="hs-identifier hs-type">getSchemaCache'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Types.html#_wseServer"><span class="hs-identifier hs-var">_wseServer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073161"><span class="hs-identifier hs-type">wsServerEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1134"></span><span>
</span><span id="line-1135"></span><span>  </span><span id="local-6989586621688073241"><span class="annot"><a href="#local-6989586621688073241"><span class="hs-identifier hs-var">dbUid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1136"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#getMetadataDbUid"><span class="hs-identifier hs-type">getMetadataDbUid</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#onLeftM"><span class="hs-operator hs-type">`onLeftM`</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#throwErrJExit"><span class="hs-identifier hs-type">throwErrJExit</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#DatabaseMigrationError"><span class="hs-identifier hs-type">DatabaseMigrationError</span></a></span><span>
</span><span id="line-1137"></span><span>  </span><span id="local-6989586621688073243"><span class="annot"><a href="#local-6989586621688073243"><span class="hs-identifier hs-var">pgVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1138"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">runExceptT</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#runTx"><span class="hs-identifier hs-type">PG.runTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073126"><span class="hs-identifier hs-type">appEnvMetadataDbPool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#ReadCommitted"><span class="hs-identifier hs-type">PG.ReadCommitted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.html#getPgVersion"><span class="hs-identifier hs-type">getPgVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1139"></span><span>      </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#onLeftM"><span class="hs-operator hs-type">`onLeftM`</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#throwErrJExit"><span class="hs-identifier hs-type">throwErrJExit</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#DatabaseMigrationError"><span class="hs-identifier hs-type">DatabaseMigrationError</span></a></span><span>
</span><span id="line-1140"></span><span>
</span><span id="line-1141"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="Hasura.Logging.html#unLoggerTracing"><span class="hs-identifier hs-var">unLoggerTracing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-type">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-type">LevelInfo</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;telemetry&quot;</span></span><span> </span><span class="annot"><a href="Hasura.App.html#telemetryNotice"><span class="hs-identifier hs-type">telemetryNotice</span></a></span><span>
</span><span id="line-1142"></span><span>
</span><span id="line-1143"></span><span>  </span><span id="local-6989586621688073246"><span class="annot"><a href="#local-6989586621688073246"><span class="hs-identifier hs-var">computeResources</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Hasura.Server.ResourceChecker.html#getServerResources"><span class="hs-identifier hs-type">getServerResources</span></a></span><span>
</span><span id="line-1144"></span><span>
</span><span id="line-1145"></span><span>  </span><span class="hs-comment">-- start a background thread for telemetry</span><span>
</span><span id="line-1146"></span><span>  </span><span id="local-6989586621688073247"><span class="annot"><a href="#local-6989586621688073247"><span class="hs-identifier hs-var">_telemetryThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1147"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-type">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;runTelemetry&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1148"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Telemetry.html#runTelemetry"><span class="hs-identifier hs-type">runTelemetry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073241"><span class="hs-identifier hs-type">dbUid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073243"><span class="hs-identifier hs-type">pgVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073246"><span class="hs-identifier hs-type">computeResources</span></a></span><span>
</span><span id="line-1149"></span><span>
</span><span id="line-1150"></span><span>  </span><span class="hs-comment">-- forking a dedicated polling thread to dynamically get the latest JWK settings</span><span>
</span><span id="line-1151"></span><span>  </span><span class="hs-comment">-- set by the user and update the JWK accordingly. This will help in applying the</span><span>
</span><span id="line-1152"></span><span>  </span><span class="hs-comment">-- updates without restarting HGE.</span><span>
</span><span id="line-1153"></span><span>  </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1154"></span><span>    </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-type">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;update JWK&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1155"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.App.html#updateJwkCtxThread"><span class="hs-identifier hs-type">updateJwkCtxThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-type">getAppContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688073128"><span class="hs-identifier hs-type">appEnvManager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073160"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1156"></span><span>
</span><span id="line-1157"></span><span>  </span><span class="hs-comment">-- These cleanup actions are not directly associated with any</span><span>
</span><span id="line-1158"></span><span>  </span><span class="hs-comment">-- resource, but we still need to make sure we clean them up here.</span><span>
</span><span id="line-1159"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#allocate_"><span class="hs-identifier hs-type">allocate_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688073166"><span class="hs-identifier hs-type">stopWsServer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621688073164"><span class="hs-identifier hs-type">app</span></a></span><span>
</span><span id="line-1162"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1163"></span><span>    </span><span id="local-6989586621688073257"><span class="annot"><span class="annottext">isRetryRequired :: p -&gt; Either QErr b -&gt; m Bool
</span><a href="#local-6989586621688073257"><span class="hs-identifier hs-var hs-var">isRetryRequired</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688073258"><span class="annot"><span class="annottext">Either QErr b
</span><a href="#local-6989586621688073258"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1164"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr b
</span><a href="#local-6989586621688073258"><span class="hs-identifier hs-var">resp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1165"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1166"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688073259"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688073259"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#qeCode"><span class="hs-identifier hs-var">qeCode</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688073259"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#ConcurrentUpdate"><span class="hs-identifier hs-var">ConcurrentUpdate</span></a></span><span>
</span><span id="line-1167"></span><span>
</span><span id="line-1168"></span><span>    </span><span id="local-6989586621688073238"><span class="annot"><span class="annottext">getLatestConfigForWSServer :: IO
  (AuthMode, AllowListStatus, CorsPolicy, SQLGenCtx,
   HashSet ExperimentalFeature, NamingCase)
</span><a href="#local-6989586621688073238"><span class="hs-identifier hs-var hs-var">getLatestConfigForWSServer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1169"></span><span>      </span><span class="annot"><span class="annottext">(AppContext
 -&gt; (AuthMode, AllowListStatus, CorsPolicy, SQLGenCtx,
     HashSet ExperimentalFeature, NamingCase))
-&gt; IO AppContext
-&gt; IO
     (AuthMode, AllowListStatus, CorsPolicy, SQLGenCtx,
      HashSet ExperimentalFeature, NamingCase)
forall a b. (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span>
</span><span id="line-1170"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688073262"><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621688073262"><span class="hs-identifier hs-var">appCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppContext -&gt; AuthMode
</span><a href="Hasura.App.State.html#acAuthMode"><span class="hs-identifier hs-var">acAuthMode</span></a></span><span> </span><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621688073262"><span class="hs-identifier hs-var">appCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; AllowListStatus
</span><a href="Hasura.App.State.html#acEnableAllowlist"><span class="hs-identifier hs-var">acEnableAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621688073262"><span class="hs-identifier hs-var">appCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; CorsPolicy
</span><a href="Hasura.App.State.html#acCorsPolicy"><span class="hs-identifier hs-var">acCorsPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621688073262"><span class="hs-identifier hs-var">appCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; SQLGenCtx
</span><a href="Hasura.App.State.html#acSQLGenCtx"><span class="hs-identifier hs-var">acSQLGenCtx</span></a></span><span> </span><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621688073262"><span class="hs-identifier hs-var">appCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; HashSet ExperimentalFeature
</span><a href="Hasura.App.State.html#acExperimentalFeatures"><span class="hs-identifier hs-var">acExperimentalFeatures</span></a></span><span> </span><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621688073262"><span class="hs-identifier hs-var">appCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; NamingCase
</span><a href="Hasura.App.State.html#acDefaultNamingConvention"><span class="hs-identifier hs-var">acDefaultNamingConvention</span></a></span><span> </span><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621688073262"><span class="hs-identifier hs-var">appCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppStateRef impl -&gt; IO AppContext
forall impl. AppStateRef impl -&gt; IO AppContext
</span><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-var">getAppContext</span></a></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621688073120"><span class="hs-identifier hs-var">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1172"></span><span>    </span><span id="local-6989586621688073239"><span class="annot"><span class="annottext">getSchemaCache' :: IO SchemaCache
</span><a href="#local-6989586621688073239"><span class="hs-identifier hs-var hs-var">getSchemaCache'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppStateRef impl -&gt; IO SchemaCache
forall impl. AppStateRef impl -&gt; IO SchemaCache
</span><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-var">getSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621688073120"><span class="hs-identifier hs-var">appStateRef</span></a></span><span>
</span><span id="line-1173"></span><span>
</span><span id="line-1174"></span><span>    </span><span id="local-6989586621688073314"><span class="annot"><span class="annottext">prepareScheduledEvents :: Logger impl -&gt; m ()
</span><a href="#local-6989586621688073314"><span class="hs-identifier hs-var hs-var">prepareScheduledEvents</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#LoggerTracing"><span class="hs-identifier hs-type">LoggerTracing</span></a></span><span> </span><span id="local-6989586621688073316"><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(ToEngineLog a impl, MonadTraceContext m, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688073316"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1175"></span><span>      </span><span class="annot"><span class="annottext">StartupLog -&gt; m ()
forall a (m :: * -&gt; *).
(ToEngineLog a impl, MonadTraceContext m, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688073316"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; m ()) -&gt; StartupLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;scheduled_triggers&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;preparing data&quot;</span></span><span>
</span><span id="line-1176"></span><span>      </span><span id="local-6989586621688073317"><span class="annot"><a href="#local-6989586621688073317"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RetryPolicyM m
-&gt; (RetryStatus -&gt; Either QErr () -&gt; m Bool)
-&gt; (RetryStatus -&gt; m (Either QErr ()))
-&gt; m (Either QErr ())
forall (m :: * -&gt; *) b.
MonadIO m =&gt;
RetryPolicyM m
-&gt; (RetryStatus -&gt; b -&gt; m Bool) -&gt; (RetryStatus -&gt; m b) -&gt; m b
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/retry-0.9.3.1-2b36dff8cf59a85fca7a5dd6eae26e5f9b0efcf71e66a890cbec749b1a21fcbb/share/doc/html/src/Control.Retry.html/Control.Retry.html#retrying"><span class="hs-identifier hs-var">Retry.retrying</span></a></span><span> </span><span class="annot"><span class="annottext">RetryPolicyM m
forall (m :: * -&gt; *). Monad m =&gt; RetryPolicyM m
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/retry-0.9.3.1-2b36dff8cf59a85fca7a5dd6eae26e5f9b0efcf71e66a890cbec749b1a21fcbb/share/doc/html/src/Control.Retry.html/Control.Retry.html#retryPolicyDefault"><span class="hs-identifier hs-var">Retry.retryPolicyDefault</span></a></span><span> </span><span class="annot"><span class="annottext">RetryStatus -&gt; Either QErr () -&gt; m Bool
forall {m :: * -&gt; *} {p} {b}.
Monad m =&gt;
p -&gt; Either QErr b -&gt; m Bool
</span><a href="#local-6989586621688073257"><span class="hs-identifier hs-var">isRetryRequired</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; RetryStatus -&gt; m (Either QErr ())
forall a. a -&gt; RetryStatus -&gt; a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">m (Either QErr ())
forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; m (Either QErr ())
</span><a href="Hasura.Metadata.Class.html#unlockAllLockedScheduledEvents"><span class="hs-identifier hs-var">unlockAllLockedScheduledEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1177"></span><span>      </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-type">onLeft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073317"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688073320"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688073320"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StartupLog -&gt; m ()
forall a (m :: * -&gt; *).
(ToEngineLog a impl, MonadTraceContext m, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688073316"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; m ()) -&gt; StartupLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">LevelError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;scheduled_triggers&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; Text -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#qeError"><span class="hs-identifier hs-var">qeError</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688073320"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1178"></span><span>
</span><span id="line-1179"></span><span>    </span><span class="annot"><a href="#local-6989586621688073321"><span class="hs-identifier hs-type">getProcessingScheduledEventsCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1180"></span><span>    </span><span id="local-6989586621688073321"><span class="annot"><span class="annottext">getProcessingScheduledEventsCount :: LockedEventsCtx -&gt; IO Int
</span><a href="#local-6989586621688073321"><span class="hs-identifier hs-var hs-var">getProcessingScheduledEventsCount</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688073322"><span id="local-6989586621688073323"><span id="local-6989586621688073324"><span id="local-6989586621688073325"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set CronEventId))
TVar (Set CronEventId)
leCronEvents :: TVar (Set CronEventId)
leOneOffEvents :: TVar (Set CronEventId)
leEvents :: TVar (HashMap SourceName (Set CronEventId))
leActionEvents :: TVar (Set CronEventId)
leActionEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leEvents :: LockedEventsCtx -&gt; TVar (HashMap SourceName (Set CronEventId))
leOneOffEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leCronEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
</span><a href="#local-6989586621688073322"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1181"></span><span>      </span><span id="local-6989586621688073330"><span class="annot"><a href="#local-6989586621688073330"><span class="hs-identifier hs-var">processingCronEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId) -&gt; IO (Set CronEventId)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId)
</span><a href="#local-6989586621688073322"><span class="hs-identifier hs-var">leCronEvents</span></a></span><span>
</span><span id="line-1182"></span><span>      </span><span id="local-6989586621688073332"><span class="annot"><a href="#local-6989586621688073332"><span class="hs-identifier hs-var">processingOneOffEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readTVarIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688073323"><span class="hs-identifier hs-type">leOneOffEvents</span></a></span><span>
</span><span id="line-1183"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="annot"><a href="#local-6989586621688073332"><span class="hs-identifier hs-type">processingOneOffEvents</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="annot"><a href="#local-6989586621688073330"><span class="hs-identifier hs-type">processingCronEvents</span></a></span><span>
</span><span id="line-1184"></span><span>
</span><span id="line-1185"></span><span>    </span><span class="annot"><a href="#local-6989586621688073334"><span class="hs-identifier hs-type">shutdownEventTriggerEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1186"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Source.html#BackendSourceInfo"><span class="hs-identifier hs-type">BackendSourceInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1187"></span><span>      </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1188"></span><span>      </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1189"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1190"></span><span>    </span><span id="local-6989586621688073334"><span class="annot"><span class="annottext">shutdownEventTriggerEvents :: [AnyBackend SourceInfo]
-&gt; Logger Hasura -&gt; LockedEventsCtx -&gt; IO ()
</span><a href="#local-6989586621688073334"><span class="hs-identifier hs-var hs-var">shutdownEventTriggerEvents</span></a></span></span><span> </span><span id="local-6989586621688073336"><span class="annot"><span class="annottext">[AnyBackend SourceInfo]
</span><a href="#local-6989586621688073336"><span class="hs-identifier hs-var">sources</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span id="local-6989586621688073337"><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688073337"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688073338"><span id="local-6989586621688073339"><span id="local-6989586621688073340"><span id="local-6989586621688073341"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set CronEventId))
TVar (Set CronEventId)
leActionEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leEvents :: LockedEventsCtx -&gt; TVar (HashMap SourceName (Set CronEventId))
leOneOffEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leCronEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leCronEvents :: TVar (Set CronEventId)
leOneOffEvents :: TVar (Set CronEventId)
leEvents :: TVar (HashMap SourceName (Set CronEventId))
leActionEvents :: TVar (Set CronEventId)
</span><a href="Hasura.Eventing.Common.html#leActionEvents"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1191"></span><span>      </span><span class="hs-comment">-- TODO: is this correct?</span><span>
</span><span id="line-1192"></span><span>      </span><span class="hs-comment">-- event triggers should be tied to the life cycle of a source</span><span>
</span><span id="line-1193"></span><span>      </span><span id="local-6989586621688073342"><span class="annot"><a href="#local-6989586621688073342"><span class="hs-identifier hs-var">lockedEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set CronEventId))
-&gt; IO (HashMap SourceName (Set CronEventId))
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set CronEventId))
</span><a href="#local-6989586621688073340"><span class="hs-identifier hs-var">leEvents</span></a></span><span>
</span><span id="line-1194"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">forM_</span></span><span> </span><span class="annot"><a href="#local-6989586621688073336"><span class="hs-identifier hs-type">sources</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688073344"><span class="annot"><span class="annottext">AnyBackend SourceInfo
</span><a href="#local-6989586621688073344"><span class="hs-identifier hs-var">backendSourceInfo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1195"></span><span>        </span><span class="annot"><span class="annottext">forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceInfo
</span><a href="#local-6989586621688073344"><span class="hs-identifier hs-var">backendSourceInfo</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688073387"><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688073389"><span id="local-6989586621688073390"><span id="local-6989586621688073391"><span id="local-6989586621688073392"><span id="local-6989586621688073393"><span id="local-6989586621688073394"><span id="local-6989586621688073395"><span id="local-6989586621688073396"><span id="local-6989586621688073397"><span id="local-6989586621688073398"><span id="local-6989586621688073399"><span class="annot"><span class="annottext">Maybe QueryTagsConfig
TableCache b
FunctionCache b
StoredProcedureCache b
NativeQueryCache b
LogicalModelCache b
BackendSourceKind b
SourceName
SourceConfig b
ResolvedSourceCustomization
DBObjectsIntrospection b
_siName :: SourceName
_siSourceKind :: BackendSourceKind b
_siTables :: TableCache b
_siFunctions :: FunctionCache b
_siNativeQueries :: NativeQueryCache b
_siStoredProcedures :: StoredProcedureCache b
_siLogicalModels :: LogicalModelCache b
_siConfiguration :: SourceConfig b
_siQueryTagsConfig :: Maybe QueryTagsConfig
_siCustomization :: ResolvedSourceCustomization
_siDbObjectsIntrospection :: DBObjectsIntrospection b
_siDbObjectsIntrospection :: forall (b :: BackendType). SourceInfo b -&gt; DBObjectsIntrospection b
_siCustomization :: forall (b :: BackendType).
SourceInfo b -&gt; ResolvedSourceCustomization
_siQueryTagsConfig :: forall (b :: BackendType). SourceInfo b -&gt; Maybe QueryTagsConfig
_siConfiguration :: forall (b :: BackendType). SourceInfo b -&gt; SourceConfig b
_siLogicalModels :: forall (b :: BackendType). SourceInfo b -&gt; LogicalModelCache b
_siStoredProcedures :: forall (b :: BackendType). SourceInfo b -&gt; StoredProcedureCache b
_siNativeQueries :: forall (b :: BackendType). SourceInfo b -&gt; NativeQueryCache b
_siFunctions :: forall (b :: BackendType). SourceInfo b -&gt; FunctionCache b
_siTables :: forall (b :: BackendType). SourceInfo b -&gt; TableCache b
_siSourceKind :: forall (b :: BackendType). SourceInfo b -&gt; BackendSourceKind b
_siName :: forall (b :: BackendType). SourceInfo b -&gt; SourceName
</span><a href="#local-6989586621688073389"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073387"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1196"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073411"><span class="annot"><span class="annottext">sourceNameText :: Text
</span><a href="#local-6989586621688073411"><span class="hs-identifier hs-var hs-var hs-var">sourceNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Text
</span><a href="Hasura.RQL.Types.Common.html#sourceNameToText"><span class="hs-identifier hs-var">sourceNameToText</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688073389"><span class="hs-identifier hs-var">_siName</span></a></span><span>
</span><span id="line-1197"></span><span>          </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688073337"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; Text -&gt; StartupLog
forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event_triggers&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; StartupLog) -&gt; Text -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unlocking events of source: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073411"><span class="hs-identifier hs-var">sourceNameText</span></a></span><span>
</span><span id="line-1198"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Set CronEventId) -&gt; (Set CronEventId -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; HashMap SourceName (Set CronEventId) -&gt; Maybe (Set CronEventId)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#lookup"><span class="hs-identifier hs-var">HashMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688073389"><span class="hs-identifier hs-var">_siName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set CronEventId)
</span><a href="#local-6989586621688073342"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Set CronEventId -&gt; IO ()) -&gt; IO ())
-&gt; (Set CronEventId -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688073414"><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688073414"><span class="hs-identifier hs-var">sourceLockedEvents</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1199"></span><span>            </span><span class="hs-comment">-- No need to execute unlockEventsTx when events are not present</span><span>
</span><span id="line-1200"></span><span>            </span><span class="annot"><span class="annottext">Maybe (NESet CronEventId) -&gt; (NESet CronEventId -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CronEventId -&gt; Maybe (NESet CronEventId)
forall a. Set a -&gt; Maybe (NESet a)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/nonempty-containers-0.3.4.5-6253a3619bd9831a5ebd2c53914ef0d1fa73c0ede58b91c10cd19aef7728ba79/share/doc/html/src/Data.Set.NonEmpty.Internal.html/Data.Set.NonEmpty.Internal.html#nonEmptySet"><span class="hs-identifier hs-var">NE.nonEmptySet</span></a></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688073414"><span class="hs-identifier hs-var">sourceLockedEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((NESet CronEventId -&gt; IO ()) -&gt; IO ())
-&gt; (NESet CronEventId -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688073416"><span class="annot"><span class="annottext">NESet CronEventId
</span><a href="#local-6989586621688073416"><span class="hs-identifier hs-var">nonEmptyLockedEvents</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1201"></span><span>              </span><span id="local-6989586621688073417"><span class="annot"><a href="#local-6989586621688073417"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RetryPolicyM IO
-&gt; (RetryStatus -&gt; Either QErr Int -&gt; IO Bool)
-&gt; (RetryStatus -&gt; IO (Either QErr Int))
-&gt; IO (Either QErr Int)
forall (m :: * -&gt; *) b.
MonadIO m =&gt;
RetryPolicyM m
-&gt; (RetryStatus -&gt; b -&gt; m Bool) -&gt; (RetryStatus -&gt; m b) -&gt; m b
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/retry-0.9.3.1-2b36dff8cf59a85fca7a5dd6eae26e5f9b0efcf71e66a890cbec749b1a21fcbb/share/doc/html/src/Control.Retry.html/Control.Retry.html#retrying"><span class="hs-identifier hs-var">Retry.retrying</span></a></span><span> </span><span class="annot"><span class="annottext">RetryPolicyM IO
forall (m :: * -&gt; *). Monad m =&gt; RetryPolicyM m
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/retry-0.9.3.1-2b36dff8cf59a85fca7a5dd6eae26e5f9b0efcf71e66a890cbec749b1a21fcbb/share/doc/html/src/Control.Retry.html/Control.Retry.html#retryPolicyDefault"><span class="hs-identifier hs-var">Retry.retryPolicyDefault</span></a></span><span> </span><span class="annot"><span class="annottext">RetryStatus -&gt; Either QErr Int -&gt; IO Bool
forall {m :: * -&gt; *} {p} {b}.
Monad m =&gt;
p -&gt; Either QErr b -&gt; m Bool
</span><a href="#local-6989586621688073257"><span class="hs-identifier hs-var">isRetryRequired</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Either QErr Int) -&gt; RetryStatus -&gt; IO (Either QErr Int)
forall a. a -&gt; RetryStatus -&gt; a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr Int) -&gt; RetryStatus -&gt; IO (Either QErr Int))
-&gt; IO (Either QErr Int) -&gt; RetryStatus -&gt; IO (Either QErr Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b -&gt; NESet CronEventId -&gt; m (Either QErr Int)
</span><a href="Hasura.Eventing.Backend.html#unlockEventsInSource"><span class="hs-identifier hs-var">unlockEventsInSource</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688073387"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688073396"><span class="hs-identifier hs-var">_siConfiguration</span></a></span><span> </span><span class="annot"><span class="annottext">NESet CronEventId
</span><a href="#local-6989586621688073416"><span class="hs-identifier hs-var">nonEmptyLockedEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1202"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621688073417"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1203"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688073419"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688073419"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1204"></span><span>                  </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688073337"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-1205"></span><span>                    </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; Text -&gt; StartupLog
forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">LevelWarn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event_trigger&quot;</span></span><span>
</span><span id="line-1206"></span><span>                    </span><span class="annot"><span class="annottext">(Text -&gt; StartupLog) -&gt; Text -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Error while unlocking event trigger events of source: &quot;</span></span><span>
</span><span id="line-1207"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073411"><span class="hs-identifier hs-var">sourceNameText</span></a></span><span>
</span><span id="line-1208"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; error:&quot;</span></span><span>
</span><span id="line-1209"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#showQErr"><span class="hs-identifier hs-var">showQErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688073419"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1210"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621688073421"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688073421"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1211"></span><span>                  </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688073337"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-1212"></span><span>                    </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; Text -&gt; StartupLog
forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event_trigger&quot;</span></span><span>
</span><span id="line-1213"></span><span>                    </span><span class="annot"><span class="annottext">(Text -&gt; StartupLog) -&gt; Text -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688073421"><span class="hs-identifier hs-var">count</span></a></span><span>
</span><span id="line-1214"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; events of source &quot;</span></span><span>
</span><span id="line-1215"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073411"><span class="hs-identifier hs-var">sourceNameText</span></a></span><span>
</span><span id="line-1216"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; were successfully unlocked&quot;</span></span><span>
</span><span id="line-1217"></span><span>
</span><span id="line-1218"></span><span>    </span><span class="annot"><a href="#local-6989586621688073423"><span class="hs-identifier hs-type">shutdownAsyncActions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1219"></span><span>      </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1220"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070558"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1221"></span><span>    </span><span id="local-6989586621688073423"><span class="annot"><span class="annottext">shutdownAsyncActions :: LockedEventsCtx -&gt; ExceptT QErr m ()
</span><a href="#local-6989586621688073423"><span class="hs-identifier hs-var hs-var">shutdownAsyncActions</span></a></span></span><span> </span><span id="local-6989586621688073424"><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073424"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1222"></span><span>      </span><span id="local-6989586621688073425"><span class="annot"><a href="#local-6989586621688073425"><span class="hs-identifier hs-var">lockedActionEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Set CronEventId) -&gt; ExceptT QErr m (Set CronEventId)
forall a. IO a -&gt; ExceptT QErr m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Set CronEventId) -&gt; ExceptT QErr m (Set CronEventId))
-&gt; IO (Set CronEventId) -&gt; ExceptT QErr m (Set CronEventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId) -&gt; IO (Set CronEventId)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">(TVar (Set CronEventId) -&gt; IO (Set CronEventId))
-&gt; TVar (Set CronEventId) -&gt; IO (Set CronEventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; TVar (Set CronEventId)
</span><a href="Hasura.Eventing.Common.html#leActionEvents"><span class="hs-identifier hs-var">leActionEvents</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073424"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span>
</span><span id="line-1223"></span><span>      </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-type">liftEitherM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html#setProcessingActionLogsToPending"><span class="hs-identifier hs-type">setProcessingActionLogsToPending</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Action.html#LockedActionIdArray"><span class="hs-identifier hs-type">LockedActionIdArray</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">toList</span></span><span> </span><span class="annot"><a href="#local-6989586621688073425"><span class="hs-identifier hs-type">lockedActionEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1224"></span><span>
</span><span id="line-1225"></span><span>    </span><span class="hs-comment">-- This function is a helper function to do couple of things:</span><span>
</span><span id="line-1226"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1227"></span><span>    </span><span class="hs-comment">-- 1. When the value of the `graceful-shutdown-timeout` &gt; 0, we poll</span><span>
</span><span id="line-1228"></span><span>    </span><span class="hs-comment">--    the in-flight events queue we maintain using the `processingEventsCountAction`</span><span>
</span><span id="line-1229"></span><span>    </span><span class="hs-comment">--    number of in-flight processing events, in case of actions it is the</span><span>
</span><span id="line-1230"></span><span>    </span><span class="hs-comment">--    actions which are in 'processing' state and in scheduled events</span><span>
</span><span id="line-1231"></span><span>    </span><span class="hs-comment">--    it is the events which are in 'locked' state. The in-flight events queue is polled</span><span>
</span><span id="line-1232"></span><span>    </span><span class="hs-comment">--    every 5 seconds until either the graceful shutdown time is exhausted</span><span>
</span><span id="line-1233"></span><span>    </span><span class="hs-comment">--    or the number of in-flight processing events is 0.</span><span>
</span><span id="line-1234"></span><span>    </span><span class="hs-comment">-- 2. After step 1, we unlock all the events which were attempted to process by the current</span><span>
</span><span id="line-1235"></span><span>    </span><span class="hs-comment">--    graphql-engine instance that are still in the processing</span><span>
</span><span id="line-1236"></span><span>    </span><span class="hs-comment">--    state. In actions, it means to set the status of such actions to 'pending'</span><span>
</span><span id="line-1237"></span><span>    </span><span class="hs-comment">--    and in scheduled events, the status will be set to 'unlocked'.</span><span>
</span><span id="line-1238"></span><span>    </span><span class="annot"><a href="#local-6989586621688073429"><span class="hs-identifier hs-type">waitForProcessingAction</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1239"></span><span>      </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1240"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1241"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1242"></span><span>      </span><span class="annot"><a href="Hasura.App.html#ShutdownAction"><span class="hs-identifier hs-type">ShutdownAction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1243"></span><span>      </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Data.Time.Clock.Units.html/Data.Time.Clock.Units.html#Seconds"><span class="hs-identifier hs-type">Seconds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1244"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1245"></span><span>    </span><span id="local-6989586621688073429"><span class="annot"><span class="annottext">waitForProcessingAction :: Logger Hasura
-&gt; String -&gt; IO Int -&gt; ShutdownAction -&gt; Seconds -&gt; IO ()
</span><a href="#local-6989586621688073429"><span class="hs-identifier hs-var hs-var">waitForProcessingAction</span></a></span></span><span> </span><span id="local-6989586621688073430"><span class="annot"><span class="annottext">l :: Logger Hasura
</span><a href="#local-6989586621688073430"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span id="local-6989586621688073431"><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688073431"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688073432"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688073432"><span class="hs-identifier hs-var">actionType</span></a></span></span><span> </span><span id="local-6989586621688073433"><span class="annot"><span class="annottext">IO Int
</span><a href="#local-6989586621688073433"><span class="hs-identifier hs-var">processingEventsCountAction'</span></a></span></span><span> </span><span id="local-6989586621688073434"><span class="annot"><span class="annottext">ShutdownAction
</span><a href="#local-6989586621688073434"><span class="hs-identifier hs-var">shutdownAction</span></a></span></span><span> </span><span id="local-6989586621688073435"><span class="annot"><span class="annottext">Seconds
</span><a href="#local-6989586621688073435"><span class="hs-identifier hs-var">maxTimeout</span></a></span></span><span>
</span><span id="line-1246"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Seconds
</span><a href="#local-6989586621688073435"><span class="hs-identifier hs-var">maxTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">Seconds -&gt; Seconds -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Seconds
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1247"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ShutdownAction
</span><a href="#local-6989586621688073434"><span class="hs-identifier hs-var">shutdownAction</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1248"></span><span>            </span><span class="annot"><a href="Hasura.App.html#EventTriggerShutdownAction"><span class="hs-identifier hs-type">EventTriggerShutdownAction</span></a></span><span> </span><span id="local-6989586621688073437"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688073437"><span class="hs-identifier hs-var">userDBShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688073437"><span class="hs-identifier hs-var">userDBShutdownAction</span></a></span><span>
</span><span id="line-1249"></span><span>            </span><span class="annot"><a href="Hasura.App.html#MetadataDBShutdownAction"><span class="hs-identifier hs-type">MetadataDBShutdownAction</span></a></span><span> </span><span id="local-6989586621688073438"><span class="annot"><span class="annottext">ExceptT QErr IO ()
</span><a href="#local-6989586621688073438"><span class="hs-identifier hs-var">metadataDBShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1250"></span><span>              </span><span class="annot"><span class="annottext">ExceptT QErr IO () -&gt; IO (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO ()
</span><a href="#local-6989586621688073438"><span class="hs-identifier hs-var">metadataDBShutdownAction</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; (Either QErr () -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1251"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688073439"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688073439"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1252"></span><span>                  </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688073431"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-1253"></span><span>                    </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; Text -&gt; StartupLog
forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">LevelWarn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688073432"><span class="hs-identifier hs-var">actionType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1254"></span><span>                    </span><span class="annot"><span class="annottext">(Text -&gt; StartupLog) -&gt; Text -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Error while unlocking the processing  &quot;</span></span><span>
</span><span id="line-1255"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688073432"><span class="hs-identifier hs-var">actionType</span></a></span><span>
</span><span id="line-1256"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; err - &quot;</span></span><span>
</span><span id="line-1257"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#showQErr"><span class="hs-identifier hs-var">showQErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688073439"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1258"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1259"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1260"></span><span>          </span><span id="local-6989586621688073440"><span class="annot"><a href="#local-6989586621688073440"><span class="hs-identifier hs-var">processingEventsCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int
</span><a href="#local-6989586621688073433"><span class="hs-identifier hs-var">processingEventsCountAction'</span></a></span><span>
</span><span id="line-1261"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688073440"><span class="hs-identifier hs-type">processingEventsCount</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1262"></span><span>            </span><span class="hs-keyword">then</span><span>
</span><span id="line-1263"></span><span>              </span><span class="annot"><a href="#local-6989586621688073431"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1264"></span><span>                </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-type">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-type">LevelInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.pack</span></span><span> </span><span class="annot"><a href="#local-6989586621688073432"><span class="hs-identifier hs-type">actionType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1265"></span><span>                </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;All in-flight events have finished processing&quot;</span></span><span>
</span><span id="line-1266"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688073440"><span class="hs-identifier hs-type">processingEventsCount</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1267"></span><span>              </span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-type">C.sleep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-number">5</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- sleep for 5 seconds and then repeat</span><span>
</span><span id="line-1268"></span><span>              </span><span class="annot"><a href="#local-6989586621688073429"><span class="hs-identifier hs-type">waitForProcessingAction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073430"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073432"><span class="hs-identifier hs-type">actionType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073433"><span class="hs-identifier hs-type">processingEventsCountAction'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073434"><span class="hs-identifier hs-type">shutdownAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621688073435"><span class="hs-identifier hs-type">maxTimeout</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Data.Time.Clock.Units.html/Data.Time.Clock.Units.html#Seconds"><span class="hs-identifier hs-type">Seconds</span></a></span><span> </span><span class="annot"><span class="hs-number">5</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1269"></span><span>
</span><span id="line-1270"></span><span>    </span><span id="local-6989586621688073222"><span class="annot"><span class="annottext">startEventTriggerPollerThread :: Logger Hasura -&gt; LockedEventsCtx -&gt; ManagedT m ()
</span><a href="#local-6989586621688073222"><span class="hs-identifier hs-var hs-var">startEventTriggerPollerThread</span></a></span></span><span> </span><span id="local-6989586621688073443"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073443"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688073444"><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073444"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1271"></span><span>      </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688073445"><span id="local-6989586621688073446"><span id="local-6989586621688073447"><span id="local-6989586621688073448"><span id="local-6989586621688073449"><span id="local-6989586621688073450"><span id="local-6989586621688073451"><span id="local-6989586621688073452"><span id="local-6989586621688073453"><span id="local-6989586621688073454"><span id="local-6989586621688073455"><span id="local-6989586621688073456"><span id="local-6989586621688073457"><span id="local-6989586621688073458"><span id="local-6989586621688073459"><span id="local-6989586621688073460"><span id="local-6989586621688073461"><span id="local-6989586621688073462"><span id="local-6989586621688073463"><span id="local-6989586621688073464"><span id="local-6989586621688073465"><span id="local-6989586621688073466"><span id="local-6989586621688073467"><span id="local-6989586621688073468"><span id="local-6989586621688073469"><span id="local-6989586621688073470"><span id="local-6989586621688073471"><span id="local-6989586621688073472"><span id="local-6989586621688073473"><span id="local-6989586621688073474"><span id="local-6989586621688073475"><span id="local-6989586621688073476"><span id="local-6989586621688073477"><span id="local-6989586621688073478"><span id="local-6989586621688073479"><span class="annot"><a href="Hasura.App.State.html#appEnvPort"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m AppEnv -&gt; ManagedT m AppEnv
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ManagedT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">m AppEnv
forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-1272"></span><span>      </span><span id="local-6989586621688073480"><span class="annot"><a href="#local-6989586621688073480"><span class="hs-identifier hs-var">schemaCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-type">getSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span>
</span><span id="line-1273"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073481"><span class="annot"><a href="#local-6989586621688073481"><span class="hs-identifier hs-var hs-var">allSources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceCache -&gt; [AnyBackend SourceInfo]
forall k v. HashMap k v -&gt; [v]
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/unordered-containers-0.2.20-6d56f9b3abc6011ddb6e237c415126423ab5ceb5c078221bba2ff80dbe921009/share/doc/html/src/Data.HashMap.Internal.html/Data.HashMap.Internal.html#elems"><span class="hs-identifier hs-var">HashMap.elems</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceCache -&gt; [AnyBackend SourceInfo])
-&gt; SourceCache -&gt; [AnyBackend SourceInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688073480"><span class="hs-identifier hs-var">schemaCache</span></a></span><span>
</span><span id="line-1274"></span><span>      </span><span id="local-6989586621688073483"><span class="annot"><a href="#local-6989586621688073483"><span class="hs-identifier hs-var">activeEventProcessingThreads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">newTVarIO</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-1275"></span><span>      </span><span id="local-6989586621688073484"><span class="annot"><a href="#local-6989586621688073484"><span class="hs-identifier hs-var">appCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-type">getAppContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span>
</span><span id="line-1276"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073485"><span class="annot"><a href="#local-6989586621688073485"><span class="hs-identifier hs-var hs-var">fetchInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventEngineCtx -&gt; DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxFetchInterval"><span class="hs-identifier hs-var">_eeCtxFetchInterval</span></a></span><span> </span><span class="annot"><span class="annottext">(EventEngineCtx -&gt; DiffTime) -&gt; EventEngineCtx -&gt; DiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; EventEngineCtx
</span><a href="Hasura.App.State.html#acEventEngineCtx"><span class="hs-identifier hs-var">acEventEngineCtx</span></a></span><span> </span><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621688073484"><span class="hs-identifier hs-var">appCtx</span></a></span><span>
</span><span id="line-1277"></span><span>          </span><span id="local-6989586621688073487"><span class="annot"><a href="#local-6989586621688073487"><span class="hs-identifier hs-var hs-var">fetchBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventEngineCtx -&gt; Refined NonNegative Int
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxFetchSize"><span class="hs-identifier hs-var">_eeCtxFetchSize</span></a></span><span> </span><span class="annot"><span class="annottext">(EventEngineCtx -&gt; Refined NonNegative Int)
-&gt; EventEngineCtx -&gt; Refined NonNegative Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AppContext -&gt; EventEngineCtx
</span><a href="Hasura.App.State.html#acEventEngineCtx"><span class="hs-identifier hs-var">acEventEngineCtx</span></a></span><span> </span><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621688073484"><span class="hs-identifier hs-var">appCtx</span></a></span><span>
</span><span id="line-1278"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/refined-0.8.2-0dcf4cad4ded3c586f9b24c73216dddc25503a45bf2f48d52c9d10964a9a8deb/share/doc/html/src/Refined.html/Refined.html#unrefine"><span class="hs-identifier hs-type">unrefine</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073487"><span class="hs-identifier hs-type">fetchBatchSize</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="#local-6989586621688073485"><span class="hs-identifier hs-type">fetchInterval</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1279"></span><span>        </span><span class="hs-comment">-- Initialise the event processing thread</span><span>
</span><span id="line-1280"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073490"><span class="annot"><a href="#local-6989586621688073490"><span class="hs-identifier hs-var hs-var">eventsGracefulShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1281"></span><span>              </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; String -&gt; IO Int -&gt; ShutdownAction -&gt; Seconds -&gt; IO ()
</span><a href="#local-6989586621688073429"><span class="hs-identifier hs-var">waitForProcessingAction</span></a></span><span>
</span><span id="line-1282"></span><span>                </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073443"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-1283"></span><span>                </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;event_triggers&quot;</span></span><span>
</span><span id="line-1284"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap SourceName (Set CronEventId) -&gt; Int
forall a. HashMap SourceName a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName (Set CronEventId) -&gt; Int)
-&gt; IO (HashMap SourceName (Set CronEventId)) -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set CronEventId))
-&gt; IO (HashMap SourceName (Set CronEventId))
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; TVar (HashMap SourceName (Set CronEventId))
</span><a href="Hasura.Eventing.Common.html#leEvents"><span class="hs-identifier hs-var">leEvents</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073444"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1285"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; ShutdownAction
</span><a href="Hasura.App.html#EventTriggerShutdownAction"><span class="hs-identifier hs-var">EventTriggerShutdownAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[AnyBackend SourceInfo]
-&gt; Logger Hasura -&gt; LockedEventsCtx -&gt; IO ()
</span><a href="#local-6989586621688073334"><span class="hs-identifier hs-var">shutdownEventTriggerEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[AnyBackend SourceInfo]
</span><a href="#local-6989586621688073481"><span class="hs-identifier hs-var">allSources</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073443"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073444"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1286"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Refined NonNegative Seconds -&gt; Seconds
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/refined-0.8.2-0dcf4cad4ded3c586f9b24c73216dddc25503a45bf2f48d52c9d10964a9a8deb/share/doc/html/src/Refined.html/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Seconds
</span><a href="#local-6989586621688073471"><span class="hs-identifier hs-var">appEnvGracefulShutdownTimeout</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1287"></span><span>
</span><span id="line-1288"></span><span>        </span><span class="hs-comment">-- Create logger for logging the statistics of events fetched</span><span>
</span><span id="line-1289"></span><span>        </span><span id="local-6989586621688073491"><span class="annot"><a href="#local-6989586621688073491"><span class="hs-identifier hs-var">fetchedEventsStatsLogger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1290"></span><span>          </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#allocate"><span class="hs-identifier hs-type">allocate</span></a></span><span>
</span><span id="line-1291"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#createFetchedEventsStatsLogger"><span class="hs-identifier hs-type">createFetchedEventsStatsLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073443"><span class="hs-identifier hs-type">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1292"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#closeFetchedEventsStatsLogger"><span class="hs-identifier hs-type">closeFetchedEventsStatsLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073443"><span class="hs-identifier hs-type">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1293"></span><span>
</span><span id="line-1294"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Logging.html#unLoggerTracing"><span class="hs-identifier hs-var">unLoggerTracing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073443"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Logging.html#mkGenericLog"><span class="hs-identifier hs-type">mkGenericLog</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-type">LevelInfo</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;event_triggers&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;starting workers&quot;</span></span><span>
</span><span id="line-1295"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span>
</span><span id="line-1296"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedTWithGracefulShutdown"><span class="hs-identifier hs-type">C.forkManagedTWithGracefulShutdown</span></a></span><span>
</span><span id="line-1297"></span><span>            </span><span class="annot"><span class="hs-string">&quot;processEventQueue&quot;</span></span><span>
</span><span id="line-1298"></span><span>            </span><span class="annot"><a href="#local-6989586621688073443"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1299"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-type">C.ThreadShutdown</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688073490"><span class="hs-identifier hs-type">eventsGracefulShutdownAction</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1300"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier hs-type">processEventQueue</span></a></span><span>
</span><span id="line-1301"></span><span>            </span><span class="annot"><a href="#local-6989586621688073443"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1302"></span><span>            </span><span class="annot"><a href="#local-6989586621688073491"><span class="hs-identifier hs-type">fetchedEventsStatsLogger</span></a></span><span>
</span><span id="line-1303"></span><span>            </span><span class="annot"><a href="#local-6989586621688073449"><span class="hs-identifier hs-type">appEnvManager</span></a></span><span>
</span><span id="line-1304"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-type">getSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1305"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.State.html#acEventEngineCtx"><span class="hs-identifier hs-var">acEventEngineCtx</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-type">getAppContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1306"></span><span>            </span><span class="annot"><a href="#local-6989586621688073483"><span class="hs-identifier hs-type">activeEventProcessingThreads</span></a></span><span>
</span><span id="line-1307"></span><span>            </span><span class="annot"><a href="#local-6989586621688073444"><span class="hs-identifier hs-type">lockedEventsCtx</span></a></span><span>
</span><span id="line-1308"></span><span>            </span><span class="annot"><a href="#local-6989586621688073457"><span class="hs-identifier hs-type">appEnvServerMetrics</span></a></span><span>
</span><span id="line-1309"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Prometheus.html#pmEventTriggerMetrics"><span class="hs-identifier hs-var">pmEventTriggerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073460"><span class="hs-identifier hs-type">appEnvPrometheusMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1310"></span><span>            </span><span class="annot"><a href="#local-6989586621688073453"><span class="hs-identifier hs-type">appEnvEnableMaintenanceMode</span></a></span><span>
</span><span id="line-1311"></span><span>            </span><span class="annot"><a href="#local-6989586621688073476"><span class="hs-identifier hs-type">appEnvTriggersErrorLogLevelStatus</span></a></span><span>
</span><span id="line-1312"></span><span>
</span><span id="line-1313"></span><span>    </span><span id="local-6989586621688073223"><span class="annot"><span class="annottext">startAsyncActionsPollerThread :: Logger Hasura
-&gt; LockedEventsCtx -&gt; AsyncActionSubscriptionState -&gt; ManagedT m ()
</span><a href="#local-6989586621688073223"><span class="hs-identifier hs-var hs-var">startAsyncActionsPollerThread</span></a></span></span><span> </span><span id="local-6989586621688073498"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073498"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688073499"><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073499"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span id="local-6989586621688073500"><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688073500"><span class="hs-identifier hs-var">actionSubState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1314"></span><span>      </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688073501"><span id="local-6989586621688073502"><span id="local-6989586621688073503"><span id="local-6989586621688073504"><span id="local-6989586621688073505"><span id="local-6989586621688073506"><span id="local-6989586621688073507"><span id="local-6989586621688073508"><span id="local-6989586621688073509"><span id="local-6989586621688073510"><span id="local-6989586621688073511"><span id="local-6989586621688073512"><span id="local-6989586621688073513"><span id="local-6989586621688073514"><span id="local-6989586621688073515"><span id="local-6989586621688073516"><span id="local-6989586621688073517"><span id="local-6989586621688073518"><span id="local-6989586621688073519"><span id="local-6989586621688073520"><span id="local-6989586621688073521"><span id="local-6989586621688073522"><span id="local-6989586621688073523"><span id="local-6989586621688073524"><span id="local-6989586621688073525"><span id="local-6989586621688073526"><span id="local-6989586621688073527"><span id="local-6989586621688073528"><span id="local-6989586621688073529"><span id="local-6989586621688073530"><span id="local-6989586621688073531"><span id="local-6989586621688073532"><span id="local-6989586621688073533"><span id="local-6989586621688073534"><span id="local-6989586621688073535"><span class="annot"><a href="Hasura.App.State.html#appEnvPort"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m AppEnv -&gt; ManagedT m AppEnv
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ManagedT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">m AppEnv
forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-1315"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073538"><span class="annot"><a href="#local-6989586621688073538"><span class="hs-keyword hs-var hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;asyncActionsProcessor&quot;</span></span><span>
</span><span id="line-1316"></span><span>          </span><span id="local-6989586621688073539"><span class="annot"><a href="#local-6989586621688073539"><span class="hs-identifier hs-var hs-var">asyncActionGracefulShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1317"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">((forall a. m a -&gt; IO a) -&gt; IO ()) -&gt; m ()
forall c. ((forall a. m a -&gt; IO a) -&gt; IO c) -&gt; m c
forall (b :: * -&gt; *) (m :: * -&gt; *) c.
MonadStateless b m =&gt;
((forall a. m a -&gt; b a) -&gt; b c) -&gt; m c
</span><a href="Control.Monad.Stateless.html#liftWithStateless"><span class="hs-identifier hs-var">liftWithStateless</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688073541"><span class="annot"><span class="annottext">forall a. m a -&gt; IO a
</span><a href="#local-6989586621688073541"><span class="hs-identifier hs-var">lowerIO</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1318"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; String -&gt; IO Int -&gt; ShutdownAction -&gt; Seconds -&gt; IO ()
</span><a href="#local-6989586621688073429"><span class="hs-identifier hs-var">waitForProcessingAction</span></a></span><span>
</span><span id="line-1319"></span><span>                    </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073498"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-1320"></span><span>                    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;async_actions&quot;</span></span><span>
</span><span id="line-1321"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CronEventId -&gt; Int
forall a. Set a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">(Set CronEventId -&gt; Int) -&gt; IO (Set CronEventId) -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId) -&gt; IO (Set CronEventId)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; TVar (Set CronEventId)
</span><a href="Hasura.Eventing.Common.html#leActionEvents"><span class="hs-identifier hs-var">leActionEvents</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073499"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1322"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT QErr IO () -&gt; ShutdownAction
</span><a href="Hasura.App.html#MetadataDBShutdownAction"><span class="hs-identifier hs-var">MetadataDBShutdownAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall a. m a -&gt; IO a) -&gt; ExceptT QErr m () -&gt; ExceptT QErr IO ()
forall {k} (t :: (* -&gt; *) -&gt; k -&gt; *) (m :: * -&gt; *) (n :: * -&gt; *)
       (b :: k).
(MFunctor t, Monad m) =&gt;
(forall a. m a -&gt; n a) -&gt; t m b -&gt; t n b
forall (m :: * -&gt; *) (n :: * -&gt; *) b.
Monad m =&gt;
(forall a. m a -&gt; n a) -&gt; ExceptT QErr m b -&gt; ExceptT QErr n b
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/mmorph-1.2.0-4c0f8c8ac6cf3be26d81218d98eb81405af8960badca054b02f2e270f75a44c0/share/doc/html/src/Control.Monad.Morph.html/Control.Monad.Morph.html#hoist"><span class="hs-identifier hs-var">hoist</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; IO a
forall a. m a -&gt; IO a
</span><a href="#local-6989586621688073541"><span class="hs-identifier hs-var">lowerIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; ExceptT QErr m ()
</span><a href="#local-6989586621688073423"><span class="hs-identifier hs-var">shutdownAsyncActions</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073499"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1323"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Refined NonNegative Seconds -&gt; Seconds
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/refined-0.8.2-0dcf4cad4ded3c586f9b24c73216dddc25503a45bf2f48d52c9d10964a9a8deb/share/doc/html/src/Refined.html/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Seconds
</span><a href="#local-6989586621688073527"><span class="hs-identifier hs-var">appEnvGracefulShutdownTimeout</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1324"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-1325"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-1326"></span><span>
</span><span id="line-1327"></span><span>      </span><span class="hs-comment">-- start a background thread to handle async actions</span><span>
</span><span id="line-1328"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span>
</span><span id="line-1329"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedTWithGracefulShutdown"><span class="hs-identifier hs-type">C.forkManagedTWithGracefulShutdown</span></a></span><span>
</span><span id="line-1330"></span><span>          </span><span class="annot"><a href="#local-6989586621688073538"><span class="hs-keyword hs-type">label</span></a></span><span>
</span><span id="line-1331"></span><span>          </span><span class="annot"><a href="#local-6989586621688073498"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1332"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-type">C.ThreadShutdown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073539"><span class="hs-identifier hs-type">asyncActionGracefulShutdownAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1333"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Action.html#asyncActionsProcessor"><span class="hs-identifier hs-type">asyncActionsProcessor</span></a></span><span>
</span><span id="line-1334"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.State.html#acEnvironment"><span class="hs-identifier hs-var">acEnvironment</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-type">getAppContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1335"></span><span>          </span><span class="annot"><a href="#local-6989586621688073498"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1336"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-type">getSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1337"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.State.html#acAsyncActionsFetchInterval"><span class="hs-identifier hs-var">acAsyncActionsFetchInterval</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-type">getAppContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1338"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.Common.html#leActionEvents"><span class="hs-identifier hs-var">leActionEvents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073499"><span class="hs-identifier hs-type">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1339"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-1340"></span><span>          </span><span class="annot"><a href="#local-6989586621688073533"><span class="hs-identifier hs-type">appEnvAsyncActionsFetchBatchSize</span></a></span><span>
</span><span id="line-1341"></span><span>
</span><span id="line-1342"></span><span>      </span><span class="hs-comment">-- start a background thread to handle async action live queries</span><span>
</span><span id="line-1343"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span>
</span><span id="line-1344"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-type">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;asyncActionSubscriptionsProcessor&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621688073498"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1345"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Action.Subscription.html#asyncActionSubscriptionsProcessor"><span class="hs-identifier hs-type">asyncActionSubscriptionsProcessor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073500"><span class="hs-identifier hs-type">actionSubState</span></a></span><span>
</span><span id="line-1346"></span><span>
</span><span id="line-1347"></span><span>    </span><span id="local-6989586621688073229"><span class="annot"><span class="annottext">startScheduledEventsPollerThread :: Logger Hasura -&gt; LockedEventsCtx -&gt; ManagedT m ()
</span><a href="#local-6989586621688073229"><span class="hs-identifier hs-var hs-var">startScheduledEventsPollerThread</span></a></span></span><span> </span><span id="local-6989586621688073544"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073544"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688073545"><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073545"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1348"></span><span>      </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688073546"><span id="local-6989586621688073547"><span id="local-6989586621688073548"><span id="local-6989586621688073549"><span id="local-6989586621688073550"><span id="local-6989586621688073551"><span id="local-6989586621688073552"><span id="local-6989586621688073553"><span id="local-6989586621688073554"><span id="local-6989586621688073555"><span id="local-6989586621688073556"><span id="local-6989586621688073557"><span id="local-6989586621688073558"><span id="local-6989586621688073559"><span id="local-6989586621688073560"><span id="local-6989586621688073561"><span id="local-6989586621688073562"><span id="local-6989586621688073563"><span id="local-6989586621688073564"><span id="local-6989586621688073565"><span id="local-6989586621688073566"><span id="local-6989586621688073567"><span id="local-6989586621688073568"><span id="local-6989586621688073569"><span id="local-6989586621688073570"><span id="local-6989586621688073571"><span id="local-6989586621688073572"><span id="local-6989586621688073573"><span id="local-6989586621688073574"><span id="local-6989586621688073575"><span id="local-6989586621688073576"><span id="local-6989586621688073577"><span id="local-6989586621688073578"><span id="local-6989586621688073579"><span id="local-6989586621688073580"><span class="annot"><a href="Hasura.App.State.html#appEnvPort"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m AppEnv -&gt; ManagedT m AppEnv
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ManagedT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">m AppEnv
forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-1349"></span><span>      </span><span class="hs-comment">-- prepare scheduled triggers</span><span>
</span><span id="line-1350"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">lift</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621688073314"><span class="hs-identifier hs-type">prepareScheduledEvents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073544"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1351"></span><span>
</span><span id="line-1352"></span><span>      </span><span class="hs-comment">-- Create logger for logging the statistics of scheduled events fetched</span><span>
</span><span id="line-1353"></span><span>      </span><span id="local-6989586621688073581"><span class="annot"><a href="#local-6989586621688073581"><span class="hs-identifier hs-var">scheduledEventsStatsLogger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1354"></span><span>        </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#allocate"><span class="hs-identifier hs-type">allocate</span></a></span><span>
</span><span id="line-1355"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.ScheduledTrigger.html#createFetchedScheduledEventsStatsLogger"><span class="hs-identifier hs-type">createFetchedScheduledEventsStatsLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073544"><span class="hs-identifier hs-type">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1356"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.ScheduledTrigger.html#closeFetchedScheduledEventsStatsLogger"><span class="hs-identifier hs-type">closeFetchedScheduledEventsStatsLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073544"><span class="hs-identifier hs-type">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1357"></span><span>
</span><span id="line-1358"></span><span>      </span><span class="hs-comment">-- start a background thread to deliver the scheduled events</span><span>
</span><span id="line-1359"></span><span>      </span><span class="hs-comment">-- _scheduledEventsThread &lt;- do</span><span>
</span><span id="line-1360"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073584"><span class="annot"><a href="#local-6989586621688073584"><span class="hs-identifier hs-var hs-var">scheduledEventsGracefulShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1361"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">((forall a. m a -&gt; IO a) -&gt; IO ()) -&gt; m ()
forall c. ((forall a. m a -&gt; IO a) -&gt; IO c) -&gt; m c
forall (b :: * -&gt; *) (m :: * -&gt; *) c.
MonadStateless b m =&gt;
((forall a. m a -&gt; b a) -&gt; b c) -&gt; m c
</span><a href="Control.Monad.Stateless.html#liftWithStateless"><span class="hs-identifier hs-var">liftWithStateless</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688073585"><span class="annot"><span class="annottext">forall a. m a -&gt; IO a
</span><a href="#local-6989586621688073585"><span class="hs-identifier hs-var">lowerIO</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1362"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; String -&gt; IO Int -&gt; ShutdownAction -&gt; Seconds -&gt; IO ()
</span><a href="#local-6989586621688073429"><span class="hs-identifier hs-var">waitForProcessingAction</span></a></span><span>
</span><span id="line-1363"></span><span>                    </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688073544"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-1364"></span><span>                    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scheduled_events&quot;</span></span><span>
</span><span id="line-1365"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; IO Int
</span><a href="#local-6989586621688073321"><span class="hs-identifier hs-var">getProcessingScheduledEventsCount</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688073545"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1366"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT QErr IO () -&gt; ShutdownAction
</span><a href="Hasura.App.html#MetadataDBShutdownAction"><span class="hs-identifier hs-var">MetadataDBShutdownAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT QErr IO (Either QErr ()) -&gt; ExceptT QErr IO ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html/Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr IO (Either QErr ()) -&gt; ExceptT QErr IO ())
-&gt; ExceptT QErr IO (Either QErr ()) -&gt; ExceptT QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(forall a. m a -&gt; IO a)
-&gt; ExceptT QErr m (Either QErr ())
-&gt; ExceptT QErr IO (Either QErr ())
forall {k} (t :: (* -&gt; *) -&gt; k -&gt; *) (m :: * -&gt; *) (n :: * -&gt; *)
       (b :: k).
(MFunctor t, Monad m) =&gt;
(forall a. m a -&gt; n a) -&gt; t m b -&gt; t n b
forall (m :: * -&gt; *) (n :: * -&gt; *) b.
Monad m =&gt;
(forall a. m a -&gt; n a) -&gt; ExceptT QErr m b -&gt; ExceptT QErr n b
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/mmorph-1.2.0-4c0f8c8ac6cf3be26d81218d98eb81405af8960badca054b02f2e270f75a44c0/share/doc/html/src/Control.Monad.Morph.html/Control.Monad.Morph.html#hoist"><span class="hs-identifier hs-var">hoist</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; IO a
forall a. m a -&gt; IO a
</span><a href="#local-6989586621688073585"><span class="hs-identifier hs-var">lowerIO</span></a></span><span> </span><span class="annot"><span class="annottext">ExceptT QErr m (Either QErr ())
forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; m (Either QErr ())
</span><a href="Hasura.Metadata.Class.html#unlockAllLockedScheduledEvents"><span class="hs-identifier hs-var">unlockAllLockedScheduledEvents</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1367"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Refined NonNegative Seconds -&gt; Seconds
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/refined-0.8.2-0dcf4cad4ded3c586f9b24c73216dddc25503a45bf2f48d52c9d10964a9a8deb/share/doc/html/src/Refined.html/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Seconds
</span><a href="#local-6989586621688073572"><span class="hs-identifier hs-var">appEnvGracefulShutdownTimeout</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1368"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-1369"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-1370"></span><span>
</span><span id="line-1371"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">void</span></span><span>
</span><span id="line-1372"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#forkManagedTWithGracefulShutdown"><span class="hs-identifier hs-type">C.forkManagedTWithGracefulShutdown</span></a></span><span>
</span><span id="line-1373"></span><span>          </span><span class="annot"><span class="hs-string">&quot;processScheduledTriggers&quot;</span></span><span>
</span><span id="line-1374"></span><span>          </span><span class="annot"><a href="#local-6989586621688073544"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1375"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-type">C.ThreadShutdown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073584"><span class="hs-identifier hs-type">scheduledEventsGracefulShutdownAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1376"></span><span>        </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.ScheduledTrigger.html#processScheduledTriggers"><span class="hs-identifier hs-type">processScheduledTriggers</span></a></span><span>
</span><span id="line-1377"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.State.html#acEnvironment"><span class="hs-identifier hs-var">acEnvironment</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-type">getAppContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1378"></span><span>          </span><span class="annot"><a href="#local-6989586621688073544"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1379"></span><span>          </span><span class="annot"><a href="#local-6989586621688073581"><span class="hs-identifier hs-type">scheduledEventsStatsLogger</span></a></span><span>
</span><span id="line-1380"></span><span>          </span><span class="annot"><a href="#local-6989586621688073550"><span class="hs-identifier hs-type">appEnvManager</span></a></span><span>
</span><span id="line-1381"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Prometheus.html#pmScheduledTriggerMetrics"><span class="hs-identifier hs-var">pmScheduledTriggerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073561"><span class="hs-identifier hs-type">appEnvPrometheusMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1382"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getSchemaCache"><span class="hs-identifier hs-type">getSchemaCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073120"><span class="hs-identifier hs-type">appStateRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1383"></span><span>          </span><span class="annot"><a href="#local-6989586621688073545"><span class="hs-identifier hs-type">lockedEventsCtx</span></a></span><span>
</span><span id="line-1384"></span><span>          </span><span class="annot"><a href="#local-6989586621688073577"><span class="hs-identifier hs-type">appEnvTriggersErrorLogLevelStatus</span></a></span><span>
</span><span id="line-1385"></span><span>
</span><span id="line-1386"></span><span id="local-6989586621688070506"><span class="annot"><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-type">runInSeparateTx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1387"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxE"><span class="hs-identifier hs-type">PG.TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070506"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1388"></span><span>  </span><span class="annot"><a href="Hasura.App.html#AppM"><span class="hs-identifier hs-type">AppM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688070506"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1389"></span><span id="runInSeparateTx"><span class="annot"><span class="annottext">runInSeparateTx :: forall a. TxE QErr a -&gt; AppM (Either QErr a)
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var hs-var">runInSeparateTx</span></a></span></span><span> </span><span id="local-6989586621688073595"><span class="annot"><span class="annottext">TxE QErr a
</span><a href="#local-6989586621688073595"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1390"></span><span>  </span><span id="local-6989586621688073596"><span class="annot"><a href="#local-6989586621688073596"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AppEnv -&gt; PGPool) -&gt; AppM PGPool
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AppEnv -&gt; PGPool
</span><a href="Hasura.App.State.html#appEnvMetadataDbPool"><span class="hs-identifier hs-var">appEnvMetadataDbPool</span></a></span><span>
</span><span id="line-1391"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">runExceptT</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#runTx"><span class="hs-identifier hs-type">PG.runTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073596"><span class="hs-identifier hs-type">pool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#RepeatableRead"><span class="hs-identifier hs-type">PG.RepeatableRead</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688073595"><span class="hs-identifier hs-type">tx</span></a></span><span>
</span><span id="line-1392"></span><span>
</span><span id="line-1393"></span><span class="annot"><a href="Hasura.App.html#notifySchemaCacheSyncTx"><span class="hs-identifier hs-type">notifySchemaCacheSyncTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheInvalidations"><span class="hs-identifier hs-type">CacheInvalidations</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxE"><span class="hs-identifier hs-type">PG.TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1394"></span><span id="notifySchemaCacheSyncTx"><span class="annot"><span class="annottext">notifySchemaCacheSyncTx :: MetadataResourceVersion
-&gt; InstanceId -&gt; CacheInvalidations -&gt; TxE QErr ()
</span><a href="Hasura.App.html#notifySchemaCacheSyncTx"><span class="hs-identifier hs-var hs-var">notifySchemaCacheSyncTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span id="local-6989586621688073599"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621688073599"><span class="hs-identifier hs-var">resourceVersion</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688073600"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688073600"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span id="local-6989586621688073601"><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688073601"><span class="hs-identifier hs-var">invalidations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1395"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#Discard"><span class="hs-identifier hs-type">PG.Discard</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1396"></span><span>    </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr)
-&gt; Query
-&gt; (ViaJSON CacheInvalidations, Int64, InstanceId)
-&gt; Bool
-&gt; TxET QErr IO Discard
forall (m :: * -&gt; *) a r e.
(MonadIO m, FromRes a, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#withQE"><span class="hs-identifier hs-var">PG.withQE</span></a></span><span>
</span><span id="line-1397"></span><span>      </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-1398"></span><span>      </span><span class="annot"><span class="">[PG.sql|
      INSERT INTO hdb_catalog.hdb_schema_notifications(id, notification, resource_version, instance_id)
      VALUES (1, $1::json, $2, $3::uuid)
      ON CONFLICT (id) DO UPDATE SET
        notification = $1::json,
        resource_version = $2,
        instance_id = $3::uuid
    |]</span></span><span>
</span><span id="line-1406"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CacheInvalidations -&gt; ViaJSON CacheInvalidations
forall a. a -&gt; ViaJSON a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#ViaJSON"><span class="hs-identifier hs-var">PG.ViaJSON</span></a></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688073601"><span class="hs-identifier hs-var">invalidations</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621688073599"><span class="hs-identifier hs-var">resourceVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688073600"><span class="hs-identifier hs-var">instanceId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1407"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1408"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1409"></span><span>
</span><span id="line-1410"></span><span class="annot"><a href="Hasura.App.html#getCatalogStateTx"><span class="hs-identifier hs-type">getCatalogStateTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxE"><span class="hs-identifier hs-type">PG.TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#CatalogState"><span class="hs-identifier hs-type">CatalogState</span></a></span><span>
</span><span id="line-1411"></span><span id="getCatalogStateTx"><span class="annot"><span class="annottext">getCatalogStateTx :: TxE QErr CatalogState
</span><a href="Hasura.App.html#getCatalogStateTx"><span class="hs-identifier hs-var hs-var">getCatalogStateTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1412"></span><span>  </span><span class="annot"><span class="annottext">(Text, ViaJSON Value, ViaJSON Value) -&gt; CatalogState
</span><a href="#local-6989586621688073606"><span class="hs-identifier hs-var">mkCatalogState</span></a></span><span>
</span><span id="line-1413"></span><span>    </span><span class="annot"><span class="annottext">((Text, ViaJSON Value, ViaJSON Value) -&gt; CatalogState)
-&gt; (SingleRow (Text, ViaJSON Value, ViaJSON Value)
    -&gt; (Text, ViaJSON Value, ViaJSON Value))
-&gt; SingleRow (Text, ViaJSON Value, ViaJSON Value)
-&gt; CatalogState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SingleRow (Text, ViaJSON Value, ViaJSON Value)
-&gt; (Text, ViaJSON Value, ViaJSON Value)
forall a. SingleRow a -&gt; a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#getRow"><span class="hs-identifier hs-var">PG.getRow</span></a></span><span>
</span><span id="line-1414"></span><span>    </span><span class="annot"><span class="annottext">(SingleRow (Text, ViaJSON Value, ViaJSON Value) -&gt; CatalogState)
-&gt; TxET QErr IO (SingleRow (Text, ViaJSON Value, ViaJSON Value))
-&gt; TxE QErr CatalogState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr)
-&gt; Query
-&gt; ()
-&gt; Bool
-&gt; TxET QErr IO (SingleRow (Text, ViaJSON Value, ViaJSON Value))
forall (m :: * -&gt; *) a r e.
(MonadIO m, FromRes a, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#withQE"><span class="hs-identifier hs-var">PG.withQE</span></a></span><span>
</span><span id="line-1415"></span><span>      </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-1416"></span><span>      </span><span class="annot"><span class="">[PG.sql|
    SELECT hasura_uuid::text, cli_state::json, console_state::json
      FROM hdb_catalog.hdb_version
  |]</span></span><span>
</span><span id="line-1420"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1421"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1422"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1423"></span><span>    </span><span id="local-6989586621688073606"><span class="annot"><span class="annottext">mkCatalogState :: (Text, ViaJSON Value, ViaJSON Value) -&gt; CatalogState
</span><a href="#local-6989586621688073606"><span class="hs-identifier hs-var hs-var">mkCatalogState</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688073608"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073608"><span class="hs-identifier hs-var">dbId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#ViaJSON"><span class="hs-identifier hs-type">PG.ViaJSON</span></a></span><span> </span><span id="local-6989586621688073609"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688073609"><span class="hs-identifier hs-var">cliState</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#ViaJSON"><span class="hs-identifier hs-type">PG.ViaJSON</span></a></span><span> </span><span id="local-6989586621688073610"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688073610"><span class="hs-identifier hs-var">consoleState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1424"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Value -&gt; Value -&gt; CatalogState
</span><a href="Hasura.RQL.Types.Metadata.Common.html#CatalogState"><span class="hs-identifier hs-var">CatalogState</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073608"><span class="hs-identifier hs-var">dbId</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688073609"><span class="hs-identifier hs-var">cliState</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688073610"><span class="hs-identifier hs-var">consoleState</span></a></span><span>
</span><span id="line-1425"></span><span>
</span><span id="line-1426"></span><span class="annot"><a href="Hasura.App.html#setCatalogStateTx"><span class="hs-identifier hs-type">setCatalogStateTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Common.html#CatalogStateType"><span class="hs-identifier hs-type">CatalogStateType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.Internal.html/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#TxE"><span class="hs-identifier hs-type">PG.TxE</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1427"></span><span id="setCatalogStateTx"><span class="annot"><span class="annottext">setCatalogStateTx :: CatalogStateType -&gt; Value -&gt; TxE QErr ()
</span><a href="Hasura.App.html#setCatalogStateTx"><span class="hs-identifier hs-var hs-var">setCatalogStateTx</span></a></span></span><span> </span><span id="local-6989586621688073612"><span class="annot"><span class="annottext">CatalogStateType
</span><a href="#local-6989586621688073612"><span class="hs-identifier hs-var">stateTy</span></a></span></span><span> </span><span id="local-6989586621688073613"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688073613"><span class="hs-identifier hs-var">stateValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1428"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CatalogStateType
</span><a href="#local-6989586621688073612"><span class="hs-identifier hs-var">stateTy</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1429"></span><span>    </span><span class="annot"><span class="annottext">CatalogStateType
</span><a href="Hasura.RQL.Types.Metadata.Common.html#CSTCli"><span class="hs-identifier hs-var">CSTCli</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1430"></span><span>      </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr)
-&gt; Query -&gt; Identity (ViaJSON Value) -&gt; Bool -&gt; TxE QErr ()
forall (m :: * -&gt; *) r e.
(MonadIO m, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#unitQE"><span class="hs-identifier hs-var">PG.unitQE</span></a></span><span>
</span><span id="line-1431"></span><span>        </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-1432"></span><span>        </span><span class="annot"><span class="">[PG.sql|
        UPDATE hdb_catalog.hdb_version
           SET cli_state = $1
      |]</span></span><span>
</span><span id="line-1436"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ViaJSON Value -&gt; Identity (ViaJSON Value)
forall a. a -&gt; Identity a
</span><span class="hs-identifier hs-var">Identity</span></span><span> </span><span class="annot"><span class="annottext">(ViaJSON Value -&gt; Identity (ViaJSON Value))
-&gt; ViaJSON Value -&gt; Identity (ViaJSON Value)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; ViaJSON Value
forall a. a -&gt; ViaJSON a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#ViaJSON"><span class="hs-identifier hs-var">PG.ViaJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688073613"><span class="hs-identifier hs-var">stateValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1437"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1438"></span><span>    </span><span class="annot"><span class="annottext">CatalogStateType
</span><a href="Hasura.RQL.Types.Metadata.Common.html#CSTConsole"><span class="hs-identifier hs-var">CSTConsole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1439"></span><span>      </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr)
-&gt; Query -&gt; Identity (ViaJSON Value) -&gt; Bool -&gt; TxE QErr ()
forall (m :: * -&gt; *) r e.
(MonadIO m, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html/Database.PG.Query.Transaction.html#unitQE"><span class="hs-identifier hs-var">PG.unitQE</span></a></span><span>
</span><span id="line-1440"></span><span>        </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-1441"></span><span>        </span><span class="annot"><span class="">[PG.sql|
        UPDATE hdb_catalog.hdb_version
           SET console_state = $1
      |]</span></span><span>
</span><span id="line-1445"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ViaJSON Value -&gt; Identity (ViaJSON Value)
forall a. a -&gt; Identity a
</span><span class="hs-identifier hs-var">Identity</span></span><span> </span><span class="annot"><span class="annottext">(ViaJSON Value -&gt; Identity (ViaJSON Value))
-&gt; ViaJSON Value -&gt; Identity (ViaJSON Value)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; ViaJSON Value
forall a. a -&gt; ViaJSON a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Class.html/Database.PG.Query.Class.html#ViaJSON"><span class="hs-identifier hs-var">PG.ViaJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688073613"><span class="hs-identifier hs-var">stateValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1446"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1447"></span><span>
</span><span id="line-1448"></span><span class="hs-comment">--- helper functions ---</span><span>
</span><span id="line-1449"></span><span>
</span><span id="line-1450"></span><span class="annot"><a href="Hasura.App.html#mkConsoleHTML"><span class="hs-identifier hs-type">mkConsoleHTML</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1451"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1452"></span><span>  </span><span class="annot"><a href="Hasura.Server.Auth.html#AuthMode"><span class="hs-identifier hs-type">AuthMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1453"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#TelemetryStatus"><span class="hs-identifier hs-type">TelemetryStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1454"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1455"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1456"></span><span>  </span><span class="annot"><a href="Hasura.Server.App.html#CEConsoleType"><span class="hs-identifier hs-type">CEConsoleType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1457"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-1458"></span><span id="mkConsoleHTML"><span class="annot"><span class="annottext">mkConsoleHTML :: Text
-&gt; AuthMode
-&gt; TelemetryStatus
-&gt; Maybe Text
-&gt; Maybe Text
-&gt; CEConsoleType
-&gt; Either String Text
</span><a href="Hasura.App.html#mkConsoleHTML"><span class="hs-identifier hs-var hs-var">mkConsoleHTML</span></a></span></span><span> </span><span id="local-6989586621688073618"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073618"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621688073619"><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688073619"><span class="hs-identifier hs-var">authMode</span></a></span></span><span> </span><span id="local-6989586621688073620"><span class="annot"><span class="annottext">TelemetryStatus
</span><a href="#local-6989586621688073620"><span class="hs-identifier hs-var">enableTelemetry</span></a></span></span><span> </span><span id="local-6989586621688073621"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688073621"><span class="hs-identifier hs-var">consoleAssetsDir</span></a></span></span><span> </span><span id="local-6989586621688073622"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688073622"><span class="hs-identifier hs-var">consoleSentryDsn</span></a></span></span><span> </span><span id="local-6989586621688073623"><span class="annot"><span class="annottext">CEConsoleType
</span><a href="#local-6989586621688073623"><span class="hs-identifier hs-var">ceConsoleType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1459"></span><span>  </span><span class="annot"><span class="annottext">Template -&gt; Value -&gt; Either String Text
</span><a href="Hasura.Server.App.html#renderHtmlTemplate"><span class="hs-identifier hs-var">renderHtmlTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Template
</span><a href="#local-6989586621688073625"><span class="hs-identifier hs-var">consoleTmplt</span></a></span><span>
</span><span id="line-1460"></span><span>    </span><span class="annot"><span class="annottext">(Value -&gt; Either String Text) -&gt; Value -&gt; Either String Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1461"></span><span>    </span><span class="hs-comment">-- variables required to render the template</span><span>
</span><span id="line-1462"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.Internal.html/Data.Aeson.Types.Internal.html#object"><span class="hs-identifier hs-var">J.object</span></a></span><span>
</span><span id="line-1463"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;isAdminSecretSet&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">AuthMode -&gt; Text
</span><a href="Hasura.Server.App.html#isAdminSecretSet"><span class="hs-identifier hs-var">isAdminSecretSet</span></a></span><span> </span><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688073619"><span class="hs-identifier hs-var">authMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1464"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;consolePath&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073627"><span class="hs-identifier hs-var">consolePath</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1465"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;enableTelemetry&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Text
</span><a href="Hasura.Server.App.html#boolToText"><span class="hs-identifier hs-var">boolToText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TelemetryStatus -&gt; Bool
</span><a href="Hasura.Server.Init.Config.html#isTelemetryEnabled"><span class="hs-identifier hs-var">isTelemetryEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">TelemetryStatus
</span><a href="#local-6989586621688073620"><span class="hs-identifier hs-var">enableTelemetry</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1466"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;cdnAssets&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Text
</span><a href="Hasura.Server.App.html#boolToText"><span class="hs-identifier hs-var">boolToText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Text -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688073621"><span class="hs-identifier hs-var">consoleAssetsDir</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1467"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;consoleSentryDsn&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text -&gt; Text
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688073622"><span class="hs-identifier hs-var">consoleSentryDsn</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1468"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;assetsVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.Server.Version.html#consoleAssetsVersion"><span class="hs-identifier hs-var">consoleAssetsVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1469"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;serverVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Version -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Hasura.Server.Version.html#currentVersion"><span class="hs-identifier hs-var">currentVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1470"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;consoleType&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; String -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">CEConsoleType -&gt; String
</span><a href="Hasura.Server.App.html#ceConsoleTypeIdentifier"><span class="hs-identifier hs-var">ceConsoleTypeIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">CEConsoleType
</span><a href="#local-6989586621688073623"><span class="hs-identifier hs-var">ceConsoleType</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- TODO(awjchen): This is a kludge that will be removed when the entitlement service is fully implemented.</span><span>
</span><span id="line-1471"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;consoleSentryDsn&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-1472"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-1473"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1474"></span><span>    </span><span id="local-6989586621688073627"><span class="annot"><span class="annottext">consolePath :: Text
</span><a href="#local-6989586621688073627"><span class="hs-identifier hs-var hs-var">consolePath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073618"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1475"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;/console&quot;</span></span><span>
</span><span id="line-1476"></span><span>      </span><span id="local-6989586621688073634"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073634"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;/console/&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688073634"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1477"></span><span>
</span><span id="line-1478"></span><span>    </span><span id="local-6989586621688073625"><span class="annot"><span class="annottext">consoleTmplt :: Template
</span><a href="#local-6989586621688073625"><span class="hs-identifier hs-var hs-var">consoleTmplt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/file-embed-0.0.15.0-515808e58f03d959385c4d19dcff901545fbbb17eb4c8312a46b66f913b925ab/share/doc/html/src/Data.FileEmbed.html/Data.FileEmbed.html#makeRelativeToProject"><span class="hs-identifier hs-type">makeRelativeToProject</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;src-rsr/console.html&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/mustache-2.4.2-3271fd39a3b991c41148584525840a94e2833955ca4e6a2a51c074e7efb812a4/share/doc/html/src/Text.Mustache.Compile.html/Text.Mustache.Compile.html#embedSingleTemplate"><span class="hs-identifier hs-type">M.embedSingleTemplate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1479"></span><span>
</span><span id="line-1480"></span><span class="annot"><a href="Hasura.App.html#telemetryNotice"><span class="hs-identifier hs-type">telemetryNotice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-1481"></span><span id="telemetryNotice"><span class="annot"><span class="annottext">telemetryNotice :: Text
</span><a href="Hasura.App.html#telemetryNotice"><span class="hs-identifier hs-var hs-var">telemetryNotice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1482"></span><span>  </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Help us improve Hasura! The graphql-engine server collects anonymized &quot;</span></span><span>
</span><span id="line-1483"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;usage stats which allows us to keep improving Hasura at warp speed. &quot;</span></span><span>
</span><span id="line-1484"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;To read more or opt-out, visit https://hasura.io/docs/latest/graphql/core/guides/telemetry.html&quot;</span></span><span>
</span><span id="line-1485"></span><span>
</span><span id="line-1486"></span><span class="annot"><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier hs-type">mkPgSourceResolver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#PGLogger"><span class="hs-identifier hs-type">PG.PGLogger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceResolver"><span class="hs-identifier hs-type">SourceResolver</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1487"></span><span id="mkPgSourceResolver"><span class="annot"><span class="annottext">mkPgSourceResolver :: PGLogger -&gt; SourceResolver ('Postgres 'Vanilla)
</span><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier hs-var hs-var">mkPgSourceResolver</span></a></span></span><span> </span><span id="local-6989586621688073642"><span class="annot"><span class="annottext">PGLogger
</span><a href="#local-6989586621688073642"><span class="hs-identifier hs-var">pgLogger</span></a></span></span><span> </span><span id="local-6989586621688073643"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688073643"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621688073644"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688073644"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621688073645"><span class="annot"><span class="annottext">SourceConnConfiguration ('Postgres 'Vanilla)
</span><a href="#local-6989586621688073645"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO PGSourceConfig -&gt; IO (Either QErr PGSourceConfig)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1488"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#PostgresSourceConnInfo"><span class="hs-identifier hs-type">PostgresSourceConnInfo</span></a></span><span> </span><span id="local-6989586621688073646"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688073646"><span class="hs-identifier hs-var hs-var">urlConf</span></a></span></span><span> </span><span id="local-6989586621688073647"><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
</span><a href="#local-6989586621688073647"><span class="hs-identifier hs-var hs-var">poolSettings</span></a></span></span><span> </span><span id="local-6989586621688073648"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688073648"><span class="hs-identifier hs-var hs-var">allowPrepare</span></a></span></span><span> </span><span id="local-6989586621688073649"><span class="annot"><span class="annottext">TxIsolation
</span><a href="#local-6989586621688073649"><span class="hs-identifier hs-var hs-var">isoLevel</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (PGClientCerts CertVar CertVar)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PostgresConnConfiguration -&gt; PostgresSourceConnInfo
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#pccConnectionInfo"><span class="hs-identifier hs-var">pccConnectionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConnConfiguration ('Postgres 'Vanilla)
PostgresConnConfiguration
</span><a href="#local-6989586621688073645"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-1489"></span><span>  </span><span class="hs-comment">-- If the user does not provide values for the pool settings, then use the default values</span><span>
</span><span id="line-1490"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688073650"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688073650"><span class="hs-identifier hs-var hs-var">maxConns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688073651"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688073651"><span class="hs-identifier hs-var hs-var">idleTimeout</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688073652"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688073652"><span class="hs-identifier hs-var hs-var">retries</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
-&gt; DefaultPostgresPoolSettings -&gt; (Int, Int, Int)
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#getDefaultPGPoolSettingIfNotExists"><span class="hs-identifier hs-var">getDefaultPGPoolSettingIfNotExists</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
</span><a href="#local-6989586621688073647"><span class="hs-identifier hs-var">poolSettings</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultPostgresPoolSettings
</span><a href="Hasura.Backends.Postgres.Connection.Settings.html#defaultPostgresPoolSettings"><span class="hs-identifier hs-var">defaultPostgresPoolSettings</span></a></span><span>
</span><span id="line-1491"></span><span>  </span><span id="local-6989586621688073655"><span class="annot"><a href="#local-6989586621688073655"><span class="hs-identifier hs-var">connDetails</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Environment -&gt; UrlConf -&gt; ExceptT QErr IO ConnDetails
forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m) =&gt;
Environment -&gt; UrlConf -&gt; m ConnDetails
</span><a href="Hasura.RQL.Types.Common.html#resolveUrlConf"><span class="hs-identifier hs-var">resolveUrlConf</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688073643"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688073646"><span class="hs-identifier hs-var">urlConf</span></a></span><span>
</span><span id="line-1492"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073656"><span class="annot"><a href="#local-6989586621688073656"><span class="hs-identifier hs-var hs-var">connInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ConnDetails -&gt; ConnInfo
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html/Database.PG.Query.Connection.html#ConnInfo"><span class="hs-identifier hs-var">PG.ConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688073652"><span class="hs-identifier hs-var">retries</span></a></span><span> </span><span class="annot"><span class="annottext">ConnDetails
</span><a href="#local-6989586621688073655"><span class="hs-identifier hs-var">connDetails</span></a></span><span>
</span><span id="line-1493"></span><span>      </span><span id="local-6989586621688073657"><span class="annot"><a href="#local-6989586621688073657"><span class="hs-identifier hs-var hs-var">connParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1494"></span><span>        </span><span class="annot"><span class="annottext">ConnParams
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#defaultConnParams"><span class="hs-identifier hs-var">PG.defaultConnParams</span></a></span><span>
</span><span id="line-1495"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#cpIdleTime"><span class="hs-identifier hs-var">PG.cpIdleTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688073651"><span class="hs-identifier hs-type">idleTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1496"></span><span>            </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#cpConns"><span class="hs-identifier hs-var">PG.cpConns</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688073650"><span class="hs-identifier hs-type">maxConns</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1497"></span><span>            </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#cpAllowPrepare"><span class="hs-identifier hs-var">PG.cpAllowPrepare</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621688073648"><span class="hs-identifier hs-type">allowPrepare</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1498"></span><span>            </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#cpMbLifetime"><span class="hs-identifier hs-var">PG.cpMbLifetime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#ppsConnectionLifetime"><span class="hs-identifier hs-var">ppsConnectionLifetime</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">=&lt;&lt;</span></span><span> </span><span class="annot"><a href="#local-6989586621688073647"><span class="hs-identifier hs-type">poolSettings</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1499"></span><span>            </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#cpTimeout"><span class="hs-identifier hs-var">PG.cpTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#ppsPoolTimeout"><span class="hs-identifier hs-var">ppsPoolTimeout</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">=&lt;&lt;</span></span><span> </span><span class="annot"><a href="#local-6989586621688073647"><span class="hs-identifier hs-type">poolSettings</span></a></span><span>
</span><span id="line-1500"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1501"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073666"><span class="annot"><a href="#local-6989586621688073666"><span class="hs-identifier hs-var hs-var">context</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.Internal.html/Data.Aeson.Types.Internal.html#object"><span class="hs-identifier hs-var">J.object</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; SourceName -&gt; Pair
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
forall e kv v. (KeyValue e kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="file:///root/.local/state/cabal/store/ghc-9.10.1-inplace/aeson-2.2.3.0-5d7ee246cfa338f30d154e06f34dc50b9af0797ae9abbdeb4efa1326ac8786e5/share/doc/html/src/Data.Aeson.Types.ToJSON.html/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688073644"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1502"></span><span>  </span><span id="local-6989586621688073667"><span class="annot"><a href="#local-6989586621688073667"><span class="hs-identifier hs-var">pgPool</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.10.1/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html/Database.PG.Query.Pool.html#initPGPool"><span class="hs-identifier hs-type">Q.initPGPool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073656"><span class="hs-identifier hs-type">connInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073666"><span class="hs-identifier hs-type">context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073657"><span class="hs-identifier hs-type">connParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073642"><span class="hs-identifier hs-type">pgLogger</span></a></span><span>
</span><span id="line-1503"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073668"><span class="annot"><a href="#local-6989586621688073668"><span class="hs-identifier hs-var hs-var">pgExecCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxIsolation -&gt; PGPool -&gt; ResizePoolStrategy -&gt; PGExecCtx
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#mkPGExecCtx"><span class="hs-identifier hs-var">mkPGExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">TxIsolation
</span><a href="#local-6989586621688073649"><span class="hs-identifier hs-var">isoLevel</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688073667"><span class="hs-identifier hs-var">pgPool</span></a></span><span> </span><span class="annot"><span class="annottext">ResizePoolStrategy
</span><a href="Hasura.RQL.Types.ResizePool.html#NeverResizePool"><span class="hs-identifier hs-var">NeverResizePool</span></a></span><span>
</span><span id="line-1504"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Execute.Types.html#PGSourceConfig"><span class="hs-identifier hs-type">PGSourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073668"><span class="hs-identifier hs-type">pgExecCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073656"><span class="hs-identifier hs-type">connInfo</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#pccExtensionsSchema"><span class="hs-identifier hs-var">pccExtensionsSchema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073645"><span class="hs-identifier hs-type">config</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Execute.Types.html#ConnTemplate_NotApplicable"><span class="hs-identifier hs-type">ConnTemplate_NotApplicable</span></a></span><span>
</span><span id="line-1505"></span><span>
</span><span id="line-1506"></span><span class="annot"><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier hs-type">mkMSSQLSourceResolver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceResolver"><span class="hs-identifier hs-type">SourceResolver</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.BackendType.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span>
</span><span id="line-1507"></span><span id="mkMSSQLSourceResolver"><span class="annot"><span class="annottext">mkMSSQLSourceResolver :: SourceResolver 'MSSQL
</span><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier hs-var hs-var">mkMSSQLSourceResolver</span></a></span></span><span> </span><span id="local-6989586621688073673"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688073673"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621688073674"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688073674"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLConnConfiguration"><span class="hs-identifier hs-type">MSSQLConnConfiguration</span></a></span><span> </span><span id="local-6989586621688073676"><span class="annot"><span class="annottext">MSSQLConnectionInfo
</span><a href="#local-6989586621688073676"><span class="hs-identifier hs-var">connInfo</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty MSSQLConnectionInfo)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO MSSQLSourceConfig
-&gt; IO (Either QErr MSSQLSourceConfig)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1508"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLConnectionInfo"><span class="hs-identifier hs-type">MSSQLConnectionInfo</span></a></span><span> </span><span id="local-6989586621688073678"><span class="annot"><span class="annottext">InputConnectionString
</span><a href="#local-6989586621688073678"><span class="hs-identifier hs-var hs-var">iConnString</span></a></span></span><span> </span><span id="local-6989586621688073679"><span class="annot"><span class="annottext">MSSQLPoolSettings
</span><a href="#local-6989586621688073679"><span class="hs-identifier hs-var hs-var">poolSettings</span></a></span></span><span> </span><span id="local-6989586621688073680"><span class="annot"><span class="annottext">TxIsolation
</span><a href="#local-6989586621688073680"><span class="hs-identifier hs-var hs-var">isolationLevel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MSSQLConnectionInfo
</span><a href="#local-6989586621688073676"><span class="hs-identifier hs-var">connInfo</span></a></span><span>
</span><span id="line-1509"></span><span>      </span><span id="local-6989586621688073681"><span class="annot"><span class="annottext">connOptions :: ConnectionOptions
</span><a href="#local-6989586621688073681"><span class="hs-identifier hs-var hs-var hs-var">connOptions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MSSQLPoolSettings
</span><a href="#local-6989586621688073679"><span class="hs-identifier hs-var">poolSettings</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1510"></span><span>        </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLPoolSettingsPool"><span class="hs-identifier hs-type">MSSQLPoolSettingsPool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLPoolConnectionSettings"><span class="hs-identifier hs-type">MSSQLPoolConnectionSettings</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688073684"><span id="local-6989586621688073685"><span id="local-6989586621688073686"><span class="annot"><span class="annottext">Int
Maybe Int
mpsMaxConnections :: Maybe Int
mpsTotalMaxConnections :: Maybe Int
mpsIdleTimeout :: Int
mpsIdleTimeout :: MSSQLPoolConnectionSettings -&gt; Int
mpsTotalMaxConnections :: MSSQLPoolConnectionSettings -&gt; Maybe Int
mpsMaxConnections :: MSSQLPoolConnectionSettings -&gt; Maybe Int
</span><a href="#local-6989586621688073684"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1511"></span><span>          </span><span class="annot"><span class="annottext">PoolOptions -&gt; ConnectionOptions
</span><a href="Database.MSSQL.Pool.html#ConnectionOptionsPool"><span class="hs-identifier hs-var">MSPool.ConnectionOptionsPool</span></a></span><span>
</span><span id="line-1512"></span><span>            </span><span class="annot"><span class="annottext">(PoolOptions -&gt; ConnectionOptions)
-&gt; PoolOptions -&gt; ConnectionOptions
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Database.MSSQL.Pool.html#PoolOptions"><span class="hs-identifier hs-type">MSPool.PoolOptions</span></a></span><span>
</span><span id="line-1513"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">poConnections :: Int
</span><a href="#local-6989586621688073692"><span class="hs-identifier hs-var">poConnections</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Hasura.Backends.MSSQL.Connection.html#defaultMSSQLMaxConnections"><span class="hs-identifier hs-var">defaultMSSQLMaxConnections</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688073684"><span class="hs-identifier hs-var">mpsMaxConnections</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1514"></span><span>                </span><span class="annot"><span class="annottext">poStripes :: Int
</span><a href="#local-6989586621688073694"><span class="hs-identifier hs-var">poStripes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span>
</span><span id="line-1515"></span><span>                </span><span class="annot"><span class="annottext">poIdleTime :: Int
</span><a href="#local-6989586621688073695"><span class="hs-identifier hs-var">poIdleTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688073686"><span class="hs-identifier hs-var">mpsIdleTimeout</span></a></span><span>
</span><span id="line-1516"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-1517"></span><span>        </span><span class="annot"><span class="annottext">MSSQLPoolSettings
</span><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLPoolSettingsNoPool"><span class="hs-identifier hs-var">MSSQLPoolSettingsNoPool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionOptions
</span><a href="Database.MSSQL.Pool.html#ConnectionOptionsNoPool"><span class="hs-identifier hs-var">MSPool.ConnectionOptionsNoPool</span></a></span><span>
</span><span id="line-1518"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688073698"><span class="annot"><a href="#local-6989586621688073698"><span class="hs-identifier hs-var">connString</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688073699"><span class="annot"><a href="#local-6989586621688073699"><span class="hs-identifier hs-var">mssqlPool</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InputConnectionString
-&gt; ConnectionOptions
-&gt; Environment
-&gt; ExceptT QErr IO (ConnectionString, MSSQLPool)
forall (m :: * -&gt; *).
(MonadIO m, QErrM m) =&gt;
InputConnectionString
-&gt; ConnectionOptions
-&gt; Environment
-&gt; m (ConnectionString, MSSQLPool)
</span><a href="Hasura.Backends.MSSQL.Connection.html#createMSSQLPool"><span class="hs-identifier hs-var">createMSSQLPool</span></a></span><span> </span><span class="annot"><span class="annottext">InputConnectionString
</span><a href="#local-6989586621688073678"><span class="hs-identifier hs-var">iConnString</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionOptions
</span><a href="#local-6989586621688073681"><span class="hs-identifier hs-var">connOptions</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688073673"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1519"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688073701"><span class="annot"><a href="#local-6989586621688073701"><span class="hs-identifier hs-var hs-var">mssqlExecCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxIsolation -&gt; MSSQLPool -&gt; ResizePoolStrategy -&gt; MSSQLExecCtx
</span><a href="Hasura.Backends.MSSQL.Connection.html#mkMSSQLExecCtx"><span class="hs-identifier hs-var">mkMSSQLExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">TxIsolation
</span><a href="#local-6989586621688073680"><span class="hs-identifier hs-var">isolationLevel</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLPool
</span><a href="#local-6989586621688073699"><span class="hs-identifier hs-var">mssqlPool</span></a></span><span> </span><span class="annot"><span class="annottext">ResizePoolStrategy
</span><a href="Hasura.RQL.Types.ResizePool.html#NeverResizePool"><span class="hs-identifier hs-var">NeverResizePool</span></a></span><span>
</span><span id="line-1520"></span><span>      </span><span id="local-6989586621688073704"><span class="annot"><a href="#local-6989586621688073704"><span class="hs-identifier hs-var hs-var">numReadReplicas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1521"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073698"><span class="hs-identifier hs-type">connString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073701"><span class="hs-identifier hs-type">mssqlExecCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688073704"><span class="hs-identifier hs-type">numReadReplicas</span></a></span><span>
</span><span id="line-1522"></span></pre></body></html>